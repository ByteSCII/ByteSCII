<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byte - Foro (Todo en Uno)</title>
    <link rel="icon" type="image/x-icon" href="./images/logo.ico">
    <meta name="description" content="Aplicación de foro completa de Byte con autenticación, todo en una sola página para discusiones sobre SEO, marketing digital y visibilidad online.">
    <meta name="keywords" content="Byte, foro, discusión, temas, SEO, marketing digital, visibilidad online, comunidad, autenticación, registro, iniciar sesión">
    <meta property="og:title" content="Byte - Foro (Todo en Uno)">
    <meta property="og:description" content="Aplicación de foro completa de Byte con autenticación, todo en una sola página para discusiones sobre SEO, marketing digital y visibilidad online.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Custom Tailwind CSS Configuration - Must be loaded before other styles */
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                        navigation: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        'byte-dark-bg': '#0A0A1A',
                        'byte-accent-cyan': '#00FFFF',
                        'byte-light-bg': '#F8FAFC', /* Casi blanco */
                        'byte-text-dark': '#374151',
                        'byte-text-light': '#F9FAFB', /* Blanco para texto principal */
                        'byte-secondary-dark': '#1A202C', /* Fondo oscuro para elementos */
                        'whatsapp-green': '#25D366',
                        'whatsapp-dark-green': '#128C7E',
                        'red-error': '#EF4444', /* Rojo para mensajes de error */
                        'green-500': '#22C55E', /* Tailwind green-500 */
                        'red-500': '#EF4444',   /* Tailwind red-500 */
                        'gray-500': '#6B7280',  /* Tailwind gray-500 */
                        'blue-500': '#3B82F6', /* Tailwind blue-500 for likes */
                    }
                }
            }
        };

        /* Box-Sizing universal para un modelo de caja consistente */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Estilos base para HTML y Body */
        html {
            height: 100%;
            width: 100%;
        }
        body {
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            background-color: #0A0A1A; /* Color de fondo base */
            font-family: 'Inter', sans-serif; /* Aplicando Inter como fuente principal */
            color: #F9FAFB;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }

        /* Estilos para el video de fondo (solo en la sección de autenticación) */
        #video-background {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -1; /* Envía el video al fondo */
            background-size: cover;
            filter: brightness(0.4); /* Oscurece el video para que el contenido sea legible */
        }

        /* Estilos para encabezados (h1-h6) */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif; /* Aplicando Montserrat para encabezados */
            color: #00FFFF;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }

        /* Estilo de contorno de texto */
        .text-stroke-cyan {
            -webkit-text-stroke: 1.5px #00FFFF;
            text-stroke: 1.5px #00FFFF;
            color: #FFFFFF;
            text-shadow: none;
        }

        /* Estilo de enlace deshabilitado */
        .disabled-link {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Estilos para deshabilitar la selección de texto y eventos de puntero en imágenes */
        img {
            pointer-events: none;
        }
        p, h1, h2, h3, h4, h5, h6, span, div:not(.map-container):not(.payment-card) {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        /* Estilos para el botón de "Volver arriba" */
        #scroll-to-top-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00FFFF; /* Cian */
            color: #0A0A1A; /* Texto oscuro de Byte */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, transform 0.2s ease;
            z-index: 9999;
        }

        #scroll-to-top-button.show {
            opacity: 1;
            visibility: visible;
        }

        #scroll-to-top-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 255, 255, 0.25);
        }

        /* Estilos para el encabezado que se oculta/muestra */
        .main-header {
            background-color: #0A0A1A; /* Fondo oscuro */
            color: #F9FAFB; /* Texto claro */
            padding: 0.5rem 0; /* Relleno */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Sombra ligera */
            position: fixed; /* Fijo en la parte superior */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50; /* Asegura que esté por encima del contenido */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; /* Transición suave */
        }

        .main-header.header-hide {
            transform: translateY(-100%); /* Desliza hacia arriba para ocultar */
            opacity: 0; /* Desvanece */
        }

        /* Estilos para la sección de autenticación */
        .auth-container {
            background: rgb(26, 32, 44); /* Fondo sólido byte-secondary-dark para mejor contraste */
            border-radius: 1.5rem; /* Bordes más redondeados */
            padding: 2rem;
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.3); /* Sombra más pronunciada y cian */
            border: 1px solid rgba(0, 255, 255, 0.4);
            max-width: 500px; /* Ancho máximo para el formulario */
            width: 90%;
            margin: auto; /* Centrar el contenedor */
            position: relative; /* Para z-index si es necesario */
            z-index: 10;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .tab-button.active {
            border-color: #00FFFF; /* Cian */
            color: #00FFFF;
        }

        /* Estilos para las etiquetas de los formularios */
        .auth-container label {
            color: #00FFFF; /* Cian para las etiquetas para que sean más visibles */
        }

        /* ESTILO PARA INPUTS Y SELECTS: ASEGURAR FONDO Y TEXTO */
        .auth-container input[type="email"],
        .auth-container input[type="password"],
        .auth-container input[type="text"],
        .auth-container input[type="tel"],
        .auth-container input[type="number"],
        .auth-container input[type="file"], /* Añadido para el input de archivo */
        .auth-container select,
        /* Corregido: Input URL para imagen y video ahora usan este estilo */
        #post-image-url,
        #post-video-url,
        textarea {
            background-color: #1A202C !important; /* Fuerza el fondo oscuro de Byte */
            color: #F9FAFB !important; /* Fuerza el color de texto claro de Byte */
            border: 1px solid #00FFFF !important; /* Fuerza el borde cian */
        }
        /* Fin de nuevo estilo */

        /* Estilos para la barra de seguridad de contraseña */
        #password-strength-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
            margin-top: 0.5rem;
        }
        .strength-weak { background-color: #FF0000; width: 33%; }
        .strength-medium { background-color: #FFA500; width: 66%; }
        .strength-strong { background-color: #25D366; width: 100%; }

        /* Estilos para el mensaje de verificación */
        .verification-message {
            background: rgb(26, 32, 44);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.4);
            max-width: 500px;
            width: 90%;
            margin: auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Asegura que tenga un tamaño mínimo */
        }
        .verification-message .fa-check-circle {
            font-size: 4rem; /* Icono grande */
            color: #25D366; /* Verde */
            margin-bottom: 1rem;
        }

        /* Estilos específicos para la sección del foro */
        .forum-section {
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 5xl; /* Tailwind max-w-5xl */
            margin-left: auto; /* Centrar */
            margin-right: auto; /* Centrar */
        }

        .forum-topic-card {
            background-color: #1A202C; /* byte-secondary-dark */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 255, 255, 0.15);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .forum-topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 255, 255, 0.25);
        }

        /* Estilos para la barra lateral de usuarios online */
        #online-users-sidebar {
            position: fixed; /* Fixed position */
            top: 4rem; /* Adjust this if the header changes height */
            right: 0;
            width: 16rem; /* Fixed width for the sidebar */
            z-index: 40; /* Ensure it's above main content, but below header */
            height: calc(100vh - 4rem - 4rem); /* Height: 100vh - header height - bottom space */
            overflow-y: auto; /* Allows scrolling if many users */
            padding: 1rem; /* Padding inside the sidebar */
            transition: transform 0.3s ease-out; /* Transition to show/hide */
            background-color: rgba(10, 10, 26, 0.95); /* Slightly more opaque dark background */
            background-image: linear-gradient(to bottom right, rgba(10, 10, 26, 0.95), rgba(26, 32, 44, 0.95)); /* Subtle gradient */
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #online-users-sidebar.hidden-sidebar {
            transform: translateX(100%); /* Hide to the right */
        }

        /* Nuevo estilo para botones principales */
        .main-action-button {
            background-color: #00FFFF; /* byte-accent-cyan */
            color: #0A0A1A; /* byte-dark-bg */
            font-weight: bold;
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: background-color 0.3s ease, transform 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .main-action-button:hover {
            background-color: #00E5E5; /* Un cian ligeramente más oscuro al pasar el ratón */
            transform: scale(1.05);
        }

        /* Nuevo estilo para botones de cabecera con solo icono */
        .icon-action-button {
            background-color: #00FFFF; /* byte-accent-cyan */
            color: #0A0A1A; /* byte-dark-bg */
            font-weight: bold;
            padding: 0.75rem; /* Reduced padding for icon only */
            border-radius: 50%; /* Make it round */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: background-color 0.3s ease, transform 0.3s ease;
            display: flex; /* To center the icon */
            align-items: center;
            justify-content: center;
            width: 40px; /* Fixed size for circular button */
            height: 40px;
        }

        .icon-action-button:hover {
            background-color: #00E5E5; /* Un cian ligeramente más oscuro al pasar el ratón */
            transform: scale(1.1); /* Slightly more prominent scale for icons */
        }

        /* Estilo para el botón de "Volver al inicio" con color amarillo */
        .back-to-home-button {
            background-color: #FFD700; /* Yellow-500 equivalent */
            color: #0A0A1A; /* Dark text */
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease;
            white-space: nowrap;
        }

        .back-to-home-button:hover {
            background-color: #E6C200; /* Darker yellow on hover */
            transform: scale(1.05);
        }


        /* Nuevo estilo para botón de acción destructiva (Cerrar Sesión) */
        .destructive-action-button {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .destructive-action-button:hover {
            background-color: #DC2626; /* Un rojo más oscuro */
            transform: scale(1.02);
        }

        /* Estilos para el botón de perfil/ajustes */
        .profile-button {
            background-color: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            position: relative;
            z-index: 60; /* Asegura que esté por encima del header */
        }

        .profile-button img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #00FFFF; /* Borde cian */
            transition: border-color 0.2s ease-in-out;
        }

        .profile-button:hover img {
            border-color: #F8FAFC; /* Borde claro al pasar el ratón */
        }

        .profile-button .dropdown-arrow {
            /* Eliminado: la flecha desplegable se elimina visualmente */
            display: none;
        }

        /* Estilos para el menú desplegable */
        .profile-dropdown-menu {
            position: absolute;
            top: calc(100% + 10px); /* Debajo del botón de perfil */
            right: 0;
            background-color: #1A202C; /* Fondo oscuro */
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 180px;
            z-index: 70; /* Por encima de todo */
            padding: 0.5rem 0;
            display: none; /* Oculto por defecto */
        }

        .profile-dropdown-menu.show {
            display: block;
        }

        /* Estilos para botones directamente dentro del menú desplegable */
        .profile-dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            color: #F9FAFB;
            font-size: 0.9rem;
            background-color: transparent; /* Ensures background is transparent by default */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-radius: 0; /* Remove border-radius for full width within dropdown */
            box-shadow: none; /* Remove shadow */
        }

        .profile-dropdown-menu button:hover {
            background-color: rgba(0, 255, 255, 0.1); /* Cyan transparent hover */
            transform: none; /* No scale transform */
        }

        /* Specific override for the destructive action button within the dropdown */
        .profile-dropdown-menu .destructive-action-button {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
            margin: 0.5rem auto; /* Center it and add vertical margin */
            display: block; /* Make it a block element to take full width within its own context */
            width: calc(100% - 1rem); /* Full width minus combined horizontal margin */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .profile-dropdown-menu .destructive-action-button:hover {
            background-color: #DC2626; /* darker red on hover */
            transform: scale(1.02);
        }


        /* Ajustes específicos para móviles */
        @media (max-width: 767px) { /* Para pantallas menores a 'md' (768px) */
            .auth-container, .verification-message, .forum-section {
                padding: 1.5rem;
            }
            .main-header img {
                height: 48px; /* Tamaño del logo en móviles, h-12 en Tailwind */
            }
            .main-header .main-action-button {
                padding: 0.5rem 0.75rem; /* Reducir padding del botón */
                font-size: 0.875rem; /* Reducir tamaño de fuente del botón (text-sm) */
            }
            .verification-message .fa-check-circle {
                font-size: 3rem;
            }
            /* En móvil, la barra lateral se oculta */
            #online-users-sidebar {
                display: none;
            }
            /* En móvil, la sección de foro toma el ancho completo */
            .forum-section {
                flex-direction: column; /* Apilar columnas en móviles */
                width: 100%;
                max-width: none; /* Sin ancho máximo para móviles */
            }
            /* Las publicaciones en móvil ocupan todo el ancho */
            .lg\:w-3\/4 {
                width: 100%; /* Ocupar todo el ancho en móviles */
            }
        }
        /* Ajustes de botones en la cabecera para todas las resoluciones */
        .header-buttons-group {
            flex-direction: column; /* Siempre apilar verticalmente */
            align-items: flex-end; /* Alinear a la derecha */
        }
        .header-buttons-group > div,
        .header-buttons-group > a {
            margin-bottom: 0.5rem; /* Espaciado entre elementos apilados */
        }
        .header-buttons-group > div:last-child,
        .header-buttons-group > a:last-child {
            margin-bottom: 0; /* Eliminar margen inferior del último elemento */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Video de fondo (inicialmente oculto, solo se muestra con auth-section) -->
    <video autoplay muted loop id="video-background" class="hidden">
        <source src="./images/fondo.mp4" type="video/mp4">
        Tu navegador no soporta el tag de video.
    </video>

    <header id="main-header" class="main-header">
        <div class="w-full px-4 sm:px-6 md:px-8 flex justify-between items-center">
            <div class="flex items-center justify-start">
                <img src="./images/logo.ico" alt="Logo de Byte" class="h-12 sm:h-16 w-auto object-contain">
            </div>

            <!-- Grupo de botones en el encabezado -->
            <div class="flex flex-col items-end header-buttons-group">
                <!-- Mensaje de Bienvenida / Iniciar Sesión / Registrarse -->
                <div class="flex items-center mb-2">
                    <span id="welcome-message" class="text-byte-accent-cyan font-semibold text-sm sm:text-base hidden mr-4"></span>
                    <a id="login-register-link" href="#" class="inline-block main-action-button hidden"
                                            onclick="showAuthSection(); return false;">
                        Iniciar Sesión / Registrarse
                    </a>
                </div>

                <!-- Volver al inicio, siempre visible y amarillo -->
                <a href="index.html" class="inline-block back-to-home-button mb-2">
                    Volver al inicio
                </a>

                <!-- Contenedor para "Conectados", "Notificaciones" y "Perfil/Ajustes" -->
                <div class="flex items-center space-x-2">
                    <!-- Botón para Usuarios Conectados (solo icono) -->
                    <button id="toggle-online-users-btn" class="icon-action-button hidden">
                        <i class="fas fa-users"></i>
                    </button>
                    <!-- Botón de Notificaciones (solo icono) -->
                    <button id="notifications-button" class="icon-action-button hidden" onclick="window.showMessage('La sección de notificaciones está en desarrollo.', 'blue');">
                        <i class="fas fa-bell"></i>
                    </button>
                    <!-- Botón de perfil/ajustes con dropdown (imagen de perfil como símbolo) -->
                    <div id="profile-settings-container" class="relative hidden">
                        <button id="profile-settings-button" class="profile-button">
                            <img id="profile-pic-img" src="${DEFAULT_PROFILE_PIC}" alt="Foto de perfil">
                        </button>
                        <div id="profile-dropdown-menu" class="profile-dropdown-menu">
                            <button onclick="window.showMessage('Ajustes de perfil en desarrollo.', 'blue');">Ajustes de Perfil</button>
                            <button id="logout-button" class="destructive-action-button" onclick="handleLogout()">Cerrar Sesión</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex items-center justify-center p-4 md:p-8 relative pt-16"> <!-- Added pt-16 for header spacing -->
        <!-- Sección de Autenticación -->
        <div id="auth-section" class="hidden flex flex-col items-center justify-center w-full min-h-[calc(100vh-100px)]">
             <!-- Contenedor principal de autenticación -->
            <div id="auth-forms-container" class="auth-container">
                <div class="flex justify-center mb-6">
                    <button id="login-tab" class="tab-button active text-byte-text-light">Iniciar Sesión</button>
                    <button id="register-tab" class="tab-button text-byte-text-light">Registrarse</button>
                </div>

                <!-- Formulario de Iniciar Sesión -->
                <form id="login-form" class="space-y-4">
                    <h2 class="text-2xl font-bold text-center mb-4">Iniciar Sesión</h2>
                    <div>
                        <label for="login-email" class="block text-sm font-semibold mb-2">Correo Electrónico:</label>
                        <input type="email" id="login-email" name="email"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="tu@ejemplo.com" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-semibold mb-2">Contraseña:</label>
                        <input type="password" id="login-password" name="password"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Tu contraseña" required>
                    </div>
                    <button type="submit"
                            class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full
                                   shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                        Iniciar Sesión
                    </button>
                    <button type="button" id="forgot-password-link" class="text-byte-accent-cyan hover:underline text-sm mt-2 block text-center">¿Olvidaste tu contraseña?</button>
                </form>

                <!-- Formulario de Registro (oculto por defecto) -->
                <form id="register-form" class="space-y-4 hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">Registrarse</h2>
                    <div>
                        <label for="register-name" class="block text-sm font-semibold mb-2">Nombre:</label>
                        <input type="text" id="register-name" name="name"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Tu nombre" required>
                    </div>
                    <div>
                        <label for="register-lastname" class="block text-sm font-semibold mb-2">Apellido:</label>
                        <input type="text" id="register-lastname" name="lastname"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Tu apellido" required>
                    </div>
                    <div>
                        <label for="register-phone" class="block text-sm font-semibold mb-2">Número Telefónico:</label>
                        <input type="tel" id="register-phone" name="phone"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="+58 (XXX) XXX-XX-XX" required>
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-semibold mb-2">Correo Electrónico:</label>
                        <input type="email" id="register-email" name="email"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="tu@ejemplo.com" required>
                    </div>
                    <div>
                        <label for="register-age" class="block text-sm font-semibold mb-2">Edad:</label>
                        <input type="number" id="register-age" name="age"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Ej: 25" min="18" max="120" required> <!-- Max 120 años -->
                    </div>
                    <div>
                        <label for="register-role" class="block text-sm font-semibold mb-2">Rol:</label>
                        <select id="register-role" name="role"
                                class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                       text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                                required>
                            <option value="" class="text-gray-500">Selecciona un rol</option> <!-- Placeholder con color -->
                            <option value="cliente" class="text-byte-text-light">Cliente</option>
                            <option value="instructor" class="text-byte-text-light">Instructor</option>
                            <option value="aprendiz" class="text-byte-text-light">Aprendiz</option>
                        </select>
                    </div>
                    <div>
                        <label for="profile_pic_url" class="block text-sm font-semibold mb-2">URL de Foto de Perfil:</label>
                        <input type="url" id="profile_pic_url" name="profile_pic_url"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="https://ejemplo.com/tu-foto.jpg">
                               <!-- Campo de foto de perfil (URL) - No obligatorio por ahora -->
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-semibold mb-2">Contraseña:</label>
                        <input type="password" id="register-password" name="password"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Crea tu contraseña" required>
                        <div id="password-strength-bar" class="w-0"></div>
                    </div>
                    <button type="submit"
                            class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full
                                   shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                        Registrarse
                    </button>
                </form>
            </div>

            <!-- Pantalla de verificación (oculta por defecto) -->
            <div id="verification-screen" class="verification-message hidden">
                <i class="fas fa-check-circle"></i>
                <h2 class="text-3xl font-bold text-center mb-4 text-byte-accent-cyan">¡VERIFICADO!</h2>
                <p class="text-lg text-byte-text-light text-center">Revisa tu correo electrónico para verificar tu cuenta.</p>
                <p class="text-sm text-gray-400 text-center mt-2">Revisa la bandeja de entrada o la carpeta de spam.</p>
                <button id="go-to-login-btn" class="mt-8 bg-yellow-500 text-black font-bold py-3 px-6 rounded-full
                                            shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                    Volver a Iniciar Sesión
                </button>
            </div>
        </div>


        <!-- Contenido del foro, inicialmente oculto -->
        <section id="forum-content" class="forum-section hidden max-w-7xl mx-auto"> <!-- Added max-w-7xl and mx-auto -->
            <!-- Columna Principal del Foro (posts, comments) -->
            <div class="w-full">
                <h1 class="text-2xl sm:text-3xl md:text-5xl font-extrabold text-center mb-8 md:mb-10 text-stroke-cyan">Bienvenido al Foro de Byte</h1>
                <p class="text-center text-lg text-byte-text-light mb-8">
                    Aquí puedes discutir temas de SEO, marketing digital, visibilidad online y mucho más.
                    ¡Comparte tus conocimientos, haz preguntas y conecta con la comunidad!
                </p>

                <!-- Formulario para crear nuevas publicaciones -->
                <div class="bg-byte-secondary-dark rounded-xl p-6 mb-6 border border-byte-accent-cyan shadow-lg">
                    <h3 class="text-xl font-bold text-byte-accent-cyan mb-4">Crear Nueva Publicación</h3>
                    <form id="create-post-form" class="space-y-4">
                        <div>
                            <textarea id="post-content" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" rows="4" placeholder="¿Qué tienes en mente?" required></textarea>
                        </div>
                        <div>
                            <label for="post-image-url" class="block text-sm font-semibold mb-2 text-byte-text-light">URL de la imagen (opcional):</label>
                            <input type="url" id="post-image-url" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                        <div>
                            <label for="post-video-url" class="block text-sm font-semibold mb-2 text-byte-text-light">URL del video (opcional):</label>
                            <input type="url" id="post-video-url" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="https://ejemplo.com/video.mp4 o URL de YouTube">
                        </div>
                        <button type="submit" class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                            Publicar
                        </button>
                    </form>
                </div>

                <!-- Lista de Publicaciones -->
                <div id="posts-list" class="space-y-6">
                    <!-- Las publicaciones se cargarán aquí dinámicamente -->
                    <div class="forum-topic-card">
                        <div class="flex items-center mb-4">
                            <img src="https://placehold.co/100x100/374151/F9FAFB?text=BYTE" alt="Foto de perfil de Usuario Anónimo" class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-byte-accent-cyan">
                            <div>
                                <h3 class="text-xl font-bold text-byte-accent-cyan">Cargando publicaciones...</h3>
                                <p class="text-gray-400 text-sm">Publicado por: <span class="font-semibold">Cargando...</span></p>
                            </div>
                        </div>
                        <p class="text-byte-text-light text-base mb-4">Las publicaciones del foro aparecerán aquí.</p>
                        <div class="text-gray-400 text-xs mt-3 flex justify-between items-center">
                            <span><i class="fas fa-clock mr-1"></i> --/--/----</span>
                            <span><i class="fas fa-comment-dots mr-1"></i> 0 comentarios</span>
                            <span><i class="fas fa-thumbs-up mr-1"></i> 0</span>
                        </div>
                        <div class="comments-section mt-6 p-4 bg-byte-dark-bg rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-byte-accent-cyan mb-3">Comentarios:</h4>
                            <div class="space-y-3 mb-4">
                                <p class="text-gray-400 text-sm italic">No hay comentarios aún.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Botón de estado del Foro (Firebase) -->
        <button id="firebase-status-button"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-500 text-white font-bold py-2 px-4 rounded-full
                       shadow-lg transition duration-300 transform hover:scale-105">
            FORO (Cargando...)
        </button>
    </main>

    <!-- Barra Lateral Derecha para Usuarios Online (Fixed y oculta por defecto) -->
    <aside id="online-users-sidebar" class="fixed right-0 bg-byte-secondary-dark rounded-xl p-6 border border-byte-accent-cyan shadow-lg h-[calc(100vh-8rem)] overflow-y-auto hidden-sidebar lg:block">
        <h3 class="text-xl font-bold text-byte-accent-cyan mb-4">Usuarios Online</h3>
        <ul id="online-users-list" class="space-y-3">
            <!-- Los usuarios online se cargarán aquí dinámicamente -->
            <li class="flex items-center text-gray-400 text-sm italic">Cargando usuarios...</li>
        </ul>
    </aside>

    <button id="scroll-to-top-button">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="footer bg-byte-secondary-dark text-byte-text-light py-6 sm:py-8">
        <div class="container mx-auto px-4 sm:px-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
            <div class="md:col-span-3 flex justify-center space-x-4 mt-3">
                <a href="https://www.instagram.com/byteweb_design?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
                    <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <radialGradient id="yOrnnhliCrdS2gy~4tD8ma-footer" cx="19.38" cy="42.035" r="44.899" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fd5"/><stop offset=".328" stop-color="#ff543f"/><stop offset=".348" stop-color="#fc5245"/><stop offset=".504" stop-color="#e64771"/><stop offset=".643" stop-color="#d53e91"/><stop offset=".761" stop-color="#cc39a4"/><stop offset=".841" stop-color="#c837ab"/></radialGradient><path fill="url(#yOrnnhliCrdS2gy~4tD8ma-footer)" d="M34.017,41.99l-20,0.019c-4.4,0.004-8.003-3.592-8.008-7.992l-0.019-20	c-0.004-4.4,3.592-8.003,7.992-8.008l20-0.019c4.4-0.004,8.003,3.592,8.008,7.992l0.019,20	C42.014,38.383,38.417,41.986,34.017,41.99z"/><radialGradient id="yOrnnhliCrdS2gy~4tD8mb-footer" cx="11.786" cy="5.54" r="29.813" gradientTransform="matrix(1 0 0 .6663 0 1.849)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#4168c9"/><stop offset=".999" stop-color="#4168c9" stop-opacity="0"/></radialGradient><path fill="url(#yOrnnhliCrdS2gy~4tD8mb-footer)" d="M34.017,41.99l-20,0.019c-4.4,0.004-8.003-3.592-8.008-7.992l-0.019-20	c-0.004-4.4,3.592-8.003,7.992-8.008l20-0.019c4.4-0.004,8.003,3.592,8.008,7.992l0.019,20	C42.014,38.383,38.417,41.986,34.017,41.99z"/><path fill="#fff" d="M24,31c-3.859,0-7-3.14-7-7s3.141-7,7-7s7,3.14,7,7S27.859,31,24,31z M24,19c-2.757,0-5,2.243-5,5	s2.243,5,5,5s5-2.243,5-5S26.757,19,24,19z"/><circle cx="31.5" cy="16.5" r="1.5" fill="#fff"/><path fill="#fff" d="M30,37H18c-3.859,0-7-3.14-7-7V18c0-3.86,3.141-7,7-7h12c3.859,0,7,3.14,7,7v12	C37,33.86,33.859,37,30,37z M18,13c-2.757,0-5,2.243-5,5v12c0,2.757,2.243,5,5,5h12c2.757,0,5-2.243,5-5V18c0-2.757-2.243-5-5-5H18z"/>
                    </svg>
                </a>
                <a href="https://wa.me/584125646608" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
                    <i class="fab fa-whatsapp footer-social-icon text-byte-text-light"></i>
                </a>
            </div>
        </div>
        <div class="container mx-auto px-4 sm:px-6 text-center text-xs sm:text-sm text-gray-400 mt-6 sm:mt-8 border-t border-gray-700 pt-4">
            <p class="mb-2">
                Al navegar en la página de Byte, aceptas nuestros
                <a href="#" class="text-byte-accent-cyan hover:underline disabled-link">Términos de Servicio</a> y
                <a href="#" class="text-byte-accent-cyan hover:underline disabled-link">Condiciones</a>.
            </p>
            <p>© 2025 Byte. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        // Importa las funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importa docChanges para actualizaciones más eficientes
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tus datos de configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDjUNln-KyOvyOKfzm7077Lv8tGtKwtFTE",
            authDomain: "byte-21d48.firebaseapp.com",
            projectId: "byte-21d48",
            storageBucket: "byte-21d48.firebasestorage.app",
            messagingSenderId: "647326645291",
            appId: "1:647326645291:web:6013f0179f525f288f3e6e"
        };

        const appId = firebaseConfig.appId.split(':')[2];

        let app;
        let auth;
        let db;
        let currentUserData = null; // Para almacenar los datos del perfil del usuario logueado
        let onlineUsersInterval; // Intervalo para actualizar el estado online
        let firebaseStatusButtonElement = null; // Variable global para el botón de estado

        const DEFAULT_PROFILE_PIC = "https://placehold.co/100x100/374151/F9FAFB?text=BYTE"; // URL de imagen de perfil por defecto

        /*
         * REGLAS DE SEGURIDAD DE FIRESTORE (PARA TU CONSOLA DE FIREBASE)
         *
         * ¡IMPORTANTЕ! Para que la función de eliminar publicaciones funcione correctamente,
         * debes COPIAR Y PEGAR estas reglas en la sección "Rules" de tu base de datos Firestore
         * en la consola de Firebase. Sin estas reglas, Firebase por defecto no permitirá
         * operaciones de eliminación, ya que los permisos de escritura son limitados.
         *
         * Asegúrate de que las reglas para 'artifacts/{appId}/public/data/posts/{postId}'
         * permitan la eliminación solo si el usuario autenticado (request.auth.uid)
         * es el mismo que el 'authorId' guardado en el documento (resource.data.authorId).
         *
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         * // Permite a cualquier usuario autenticado crear, leer, actualizar y eliminar su propio perfil
         * match /artifacts/{appId}/users/{userId} {
         * allow read, create: if request.auth != null;
         * allow update, delete: if request.auth != null && request.auth.uid == userId;
         * }
         *
         * // Permite a cualquier usuario autenticado leer las publicaciones
         * // Permite crear publicaciones si el usuario está autenticado
         * // Permite actualizar y eliminar publicaciones solo si el usuario es el autor
         * match /artifacts/{appId}/public/data/posts/{postId} {
         * allow read: if request.auth != null;
         * allow create: if request.auth != null;
         * // Regla crucial: solo el autor puede actualizar o eliminar su publicación
         * allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
         *
         * // Reglas para los comentarios de una publicación específica
         * match /comments/{commentId} {
         * allow read: if request.auth != null;
         * allow create: if request.auth != null;
         * // Solo el autor del comentario puede actualizarlo o eliminarlo
         * allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
         * }
         * }
         * }
         * }
         */

        // Función para mostrar mensajes temporales (declarada globalmente para ser accesible)
        window.showMessage = function(msg, type = 'blue') {
            const messageEl = document.createElement('div');
            messageEl.textContent = msg;
            let bgColor;
            switch (type) {
                case 'red': bgColor = '#EF4444'; break;
                case 'green': bgColor = '#25D366'; break;
                case 'blue': bgColor = '#00FFFF'; break;
                default: bgColor = '#00FFFF';
            }
            messageEl.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background-color: ${bgColor}; color: #0A0A1A; padding: 10px 20px;
                border-radius: 8px; z-index: 10000; opacity: 0; transition: opacity 0.3s ease-in-out;
            `;
            document.body.appendChild(messageEl);
            setTimeout(() => messageEl.style.opacity = '1', 10);
            setTimeout(() => messageEl.style.opacity = '0', 3000);
            setTimeout(() => messageEl.remove(), 3300);
        };

        // Función para cerrar sesión (declarada globalmente para ser accesible desde onclick)
        window.handleLogout = async function() {
            try {
                if (auth.currentUser && db) {
                    // Establecer lastSeen a null al cerrar sesión
                    const userProfileRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
                    await updateDoc(userProfileRef, { lastSeen: null });
                }
                clearInterval(onlineUsersInterval); // Detener la actualización de lastSeen

                await signOut(auth);
                window.showMessage('Sesión cerrada exitosamente.', 'green');
                
                // Ocultar elementos del foro y mostrar la sección de autenticación
                const forumContent = document.getElementById('forum-content');
                const authSection = document.getElementById('auth-section');
                const videoBackground = document.getElementById('video-background');
                const loginRegisterLink = document.getElementById('login-register-link');
                const welcomeMessage = document.getElementById('welcome-message');
                const onlineUsersSidebar = document.getElementById('online-users-sidebar');
                const toggleOnlineUsersBtn = document.getElementById('toggle-online-users-btn');
                const notificationsButton = document.getElementById('notifications-button');
                const profileSettingsContainer = document.getElementById('profile-settings-container');
                const profileDropdownMenu = document.getElementById('profile-dropdown-menu');

                if (forumContent) forumContent.classList.add('hidden');
                if (authSection) authSection.classList.remove('hidden');
                if (videoBackground) videoBackground.classList.remove('hidden');
                if (loginRegisterLink) loginRegisterLink.classList.remove('hidden');
                if (welcomeMessage) welcomeMessage.classList.add('hidden');
                if (onlineUsersSidebar) onlineUsersSidebar.classList.add('hidden-sidebar');
                if (toggleOnlineUsersBtn) toggleOnlineUsersBtn.classList.add('hidden');
                if (notificationsButton) notificationsButton.classList.add('hidden');
                if (profileSettingsContainer) profileSettingsContainer.classList.add('hidden');
                if (profileDropdownMenu) profileDropdownMenu.classList.remove('show');
                
                if (firebaseStatusButtonElement) {
                    firebaseStatusButtonElement.textContent = 'FORO (Inactivo)';
                    firebaseStatusButtonElement.classList.remove('bg-green-500');
                    firebaseStatusButtonElement.classList.add('bg-red-500');
                }
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const loginTab = document.getElementById('login-tab');
                const registerTab = document.getElementById('register-tab');

                if(loginForm) loginForm.classList.remove('hidden');
                if(registerForm) registerForm.classList.add('hidden');
                if(loginTab) loginTab.classList.add('active');
                if(registerTab) registerTab.classList.remove('active');
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                window.showMessage('Error al cerrar sesión. Intenta de nuevo.', 'red');
            }
        };

        // Función para mostrar la sección de autenticación (para el botón "Iniciar Sesión / Registrarse")
        window.showAuthSection = function() {
            const authSection = document.getElementById('auth-section');
            const forumContent = document.getElementById('forum-content');
            const videoBackground = document.getElementById('video-background');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const onlineUsersSidebar = document.getElementById('online-users-sidebar');
            const toggleOnlineUsersBtn = document.getElementById('toggle-online-users-btn');
            const notificationsButton = document.getElementById('notifications-button');
            const profileSettingsContainer = document.getElementById('profile-settings-container');

            if (authSection) authSection.classList.remove('hidden');
            if (forumContent) forumContent.classList.add('hidden');
            if (videoBackground) videoBackground.classList.remove('hidden');
            if (onlineUsersSidebar) onlineUsersSidebar.classList.add('hidden-sidebar');
            if (toggleOnlineUsersBtn) toggleOnlineUsersBtn.classList.add('hidden');
            if (notificationsButton) notificationsButton.classList.add('hidden');
            if (profileSettingsContainer) profileSettingsContainer.classList.add('hidden');

            if (loginForm) loginForm.classList.remove('hidden');
            if (registerForm) registerForm.classList.add('hidden');
            if (loginTab) loginTab.classList.add('active');
            if (registerTab) registerTab.classList.remove('active');
        };

        // Función para actualizar el timestamp de 'última vez visto'
        async function updateLastSeen() {
            if (auth.currentUser && db) {
                const userProfileRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
                try {
                    await updateDoc(userProfileRef, { lastSeen: serverTimestamp() });
                } catch (error) {
                    console.error("Error al actualizar lastSeen:", error);
                }
            }
        }

        // Función placeholder para crear un nuevo tema (declarada globalmente)
        window.handleCreateNewTopic = function() {
            window.showMessage('Por favor, usa el formulario superior para crear una nueva publicación.', 'blue');
        };

        // Función para eliminar una publicación
        window.deletePost = async function(postId, authorId) {
            console.log("Depuración de eliminación de publicación:");
            console.log("UID del usuario actual:", auth.currentUser ? auth.currentUser.uid : "No autenticado");
            console.log("Author ID de la publicación:", authorId);
            console.log("¿Coinciden los IDs?", auth.currentUser && auth.currentUser.uid === authorId);

            if (!auth.currentUser || auth.currentUser.uid !== authorId) {
                window.showMessage('No tienes permiso para eliminar esta publicación.', 'red');
                return;
            }

            // Usar una función de confirmación personalizada en un escenario real
            // Por ahora, se usa un confirm de navegador para la demostración de la lógica
            if (window.confirm('¿Estás seguro de que quieres eliminar esta publicación? Esto también eliminará todos sus comentarios.')) {
                try {
                    // Eliminar la publicación principal
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/posts`, postId));
                    window.showMessage('Publicación eliminada exitosamente.', 'green');
                } catch (error) {
                    console.error('Error al eliminar publicación:', error);
                    window.showMessage('Error al eliminar la publicación. Intenta de nuevo. Asegúrate de tener los permisos de seguridad de Firebase configurados correctamente.', 'red');
                }
            }
        };

        // Función para cargar y mostrar publicaciones (refactorizada para evitar "shaking")
        async function loadPosts() {
            const postsList = document.getElementById('posts-list');
            if (!postsList) return;

            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
            // Ordenar por fecha de creación descendente para que las nuevas publicaciones aparezcan arriba
            const q = query(postsCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, async (snapshot) => {
                // Iterar sobre los cambios en lugar de borrar y re-renderizar todo
                snapshot.docChanges().forEach(async (change) => {
                    const postData = { id: change.doc.id, ...change.doc.data() };
                    let postElement = document.getElementById(`post-${postData.id}`); // ID único para cada post

                    // Obtener datos del autor (nombre y foto de perfil)
                    let authorName = postData.authorEmail || 'Usuario Anónimo';
                    let authorProfilePic = DEFAULT_PROFILE_PIC;
                    if (postData.authorId) {
                        const authorProfileRef = doc(db, `artifacts/${appId}/users`, postData.authorId);
                        const authorProfileSnap = await getDoc(authorProfileRef);
                        if (authorProfileSnap.exists()) {
                            const authorData = authorProfileSnap.data();
                            authorName = authorData.name || authorData.email || authorName;
                            authorProfilePic = authorData.profilePicUrl || DEFAULT_PROFILE_PIC;
                        }
                    }

                    // Formatear la hora de publicación
                    let postedTime = 'Hace un momento';
                    let fullPostedTime = '';
                    if (postData.createdAt) {
                        const date = postData.createdAt.toDate ? postData.createdAt.toDate() : new Date(postData.createdAt);
                        fullPostedTime = new Date(date).toLocaleString();
                        const diffMs = Date.now() - date.getTime();
                        const diffMins = Math.round(diffMs / (1000 * 60));
                        const diffHours = Math.round(diffMs / (1000 * 60 * 60));
                        const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24)); /* Fixed: Changed Math.Round to Math.round */

                        if (diffMins < 1) {
                            postedTime = 'Hace un momento';
                        } else if (diffMins < 60) {
                            postedTime = `${diffMins} min.`;
                        } else if (diffHours < 24) {
                            postedTime = `${diffHours} hr.`;
                        } else {
                            postedTime = `${diffDays} día(s).`;
                        }
                    }

                    // Contenido multimedia
                    let mediaContent = '';
                    if (postData.imageUrl) {
                        mediaContent += `<img src="${postData.imageUrl}" alt="Imagen de la publicación" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96">`;
                    }
                    if (postData.videoUrl) {
                        let embedUrl = postData.videoUrl;
                        if (postData.videoUrl.includes('youtube.com/watch?v=')) {
                            const videoId = postData.videoUrl.split('v=')[1].split('&')[0];
                            embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        } else if (postData.videoUrl.includes('youtu.be/')) {
                            const videoId = postData.videoUrl.split('youtu.be/')[1].split('?')[0];
                            embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        }
                        mediaContent += `
                            <div class="relative w-full overflow-hidden rounded-lg mb-4" style="padding-top: 56.25%;">
                                <iframe class="absolute top-0 left-0 w-full h-full" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        `;
                    }

                    const isAuthor = auth.currentUser && auth.currentUser.uid === postData.authorId;
                    const deleteButtonHtml = isAuthor ?
                        `<button class="text-gray-400 hover:text-red-500 transition duration-200" onclick="deletePost('${postData.id}', '${postData.authorId}')">
                            <i class="fas fa-times text-lg"></i>
                        </button>` : '';

                    // Construcción del HTML de la publicación
                    const postHtml = `
                        <div id="post-${postData.id}" class="forum-topic-card">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <img src="${authorProfilePic}" alt="Foto de perfil de ${authorName}" class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-byte-accent-cyan">
                                    <div>
                                        <p class="font-semibold text-byte-accent-cyan text-base leading-tight">${authorName}</p>
                                        <p class="text-gray-400 text-xs" title="${fullPostedTime}">${postedTime} <i class="fas fa-globe-americas ml-1"></i></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-white transition duration-200" onclick="window.showMessage('Opciones de publicación en desarrollo.', 'blue');">
                                        <i class="fas fa-ellipsis-h text-lg"></i>
                                    </button>
                                    ${deleteButtonHtml}
                                </div>
                            </div>
                            <h3 class="text-xl font-bold text-byte-text-light mb-2">${postData.title || 'Publicación sin título'}</h3>
                            <p class="text-byte-text-light text-base mb-4">${postData.content}</p>
                            ${mediaContent}

                            <!-- Post statistics/meta-info -->
                            <div class="text-gray-400 text-sm mt-3 flex justify-between items-center px-2 py-1 border-b border-gray-700 pb-3">
                                <span class="flex items-center">
                                    <i class="fas fa-thumbs-up mr-1"></i> <span id="likes-count-${postData.id}">${postData.likes ? postData.likes.length : 0}</span>
                                </span>
                                <span class="flex items-center">
                                    <span id="comments-count-${postData.id}">0</span> Comentarios
                                </span>
                            </div>

                            <!-- Interactive Action Buttons -->
                            <div class="flex justify-around items-center pt-3 mt-2 border-t border-gray-700">
                                <button class="flex items-center text-gray-400 hover:text-blue-500 transition duration-200 p-2 rounded-md like-button" data-post-id="${postData.id}">
                                    <i class="fas fa-thumbs-up mr-2"></i> Me gusta
                                </button>
                                <button class="flex items-center text-gray-400 hover:text-byte-accent-cyan transition duration-200 p-2 rounded-md comment-button" data-post-id="${postData.id}">
                                    <i class="fas fa-comment-dots mr-2"></i> Comentar
                                </button>
                                <button class="flex items-center text-gray-400 hover:text-green-500 transition duration-200 p-2 rounded-md share-button" onclick="window.showMessage('Compartir función en desarrollo.', 'blue');">
                                    <i class="fas fa-share mr-2"></i> Compartir
                                </button>
                            </div>

                            <!-- Comments Section -->
                            <div class="comments-section mt-6 p-4 bg-byte-dark-bg rounded-lg border border-gray-700">
                                <h4 class="text-lg font-semibold text-byte-accent-cyan mb-3">Comentarios:</h4>
                                <div id="comments-list-${postData.id}" class="space-y-3 mb-4">
                                    <!-- Los comentarios se cargarán aquí -->
                                </div>
                                <form class="add-comment-form" data-post-id="${postData.id}">
                                    <textarea class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-600 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-byte-accent-cyan text-sm" rows="2" placeholder="Añade un comentario..." required></textarea>
                                    <button type="submit" class="mt-2 bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200 text-sm">Comentar</button>
                                </form>
                            </div>
                        </div>
                    `;

                    if (change.type === 'added') {
                        // Solo añadimos el elemento si no existe, para evitar duplicados en re-renders iniciales
                        if (!postElement) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = postHtml;
                            postElement = tempDiv.firstElementChild;
                            postsList.prepend(postElement); // Añadir al principio para "nuevas publicaciones arriba"
                        }
                    } else if (change.type === 'modified') {
                        if (postElement) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = postHtml;
                            const newPostElement = tempDiv.firstElementChild;
                            postsList.replaceChild(newPostElement, postElement);
                            postElement = newPostElement; // Actualizar referencia
                        }
                    } else if (change.type === 'removed') {
                        if (postElement) {
                            postElement.remove();
                        }
                    }

                    // Después de añadir/modificar, cargar comentarios y configurar likes
                    if (postElement) {
                        loadCommentsForPost(postData.id);
                        setupLikeButton(postData.id, postData.likes || []);

                        // Re-attach event listeners for comment buttons if they were replaced
                        const commentButton = postElement.querySelector(`.comment-button[data-post-id="${postData.id}"]`);
                        if (commentButton) {
                            commentButton.onclick = (e) => { // Use onclick directly for re-attached elements
                                const postId = e.currentTarget.dataset.postId;
                                const commentForm = document.querySelector(`.add-comment-form[data-post-id="${postId}"]`);
                                if (commentForm) {
                                    commentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    commentForm.querySelector('textarea').focus();
                                }
                            };
                        }
                    }
                });
            });
        }

        // Función para cargar y mostrar comentarios de una publicación específica
        async function loadCommentsForPost(postId) {
            const commentsListElement = document.getElementById(`comments-list-${postId}`);
            const commentsCountElement = document.getElementById(`comments-count-${postId}`);
            if (!commentsListElement || !commentsCountElement) return;

            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts/${postId}/comments`);
            const q = query(commentsCollectionRef, orderBy('createdAt', 'asc')); // Ordenar comentarios por fecha ascendente

            onSnapshot(q, async (snapshot) => {
                commentsListElement.innerHTML = ''; // Limpiar y re-renderizar todos los comentarios para esta publicación (menos impactante que en posts)
                commentsCountElement.textContent = snapshot.size;

                const comments = [];
                snapshot.forEach(doc => {
                    comments.push({ id: doc.id, ...doc.data() });
                });

                // No es necesario ordenar aquí si ya se hizo en la consulta (orderBy), pero se mantiene como respaldo.
                // comments.sort((a, b) => {
                //     const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                //     const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                //     return dateA - dateB;
                // });

                for (const comment of comments) {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('flex', 'items-start', 'bg-byte-secondary-dark', 'p-3', 'rounded-md', 'border', 'border-gray-800');

                    let authorName = comment.authorEmail || 'Anónimo';
                    let authorProfilePic = DEFAULT_PROFILE_PIC;

                    if (comment.authorId) {
                        const authorProfileRef = doc(db, `artifacts/${appId}/users`, comment.authorId);
                        const authorProfileSnap = await getDoc(authorProfileRef);
                        if (authorProfileSnap.exists()) {
                            const authorData = authorProfileSnap.data();
                            authorName = authorData.name || authorData.email || authorName;
                            authorProfilePic = authorData.profilePicUrl || DEFAULT_PROFILE_PIC;
                        }
                    }

                    commentElement.innerHTML = `
                        <img src="${authorProfilePic}" alt="Foto de perfil de ${authorName}" class="w-8 h-8 rounded-full mr-3 object-cover border border-gray-700">
                        <div>
                            <p class="font-semibold text-byte-accent-cyan text-sm">${authorName} <span class="text-gray-400 text-xs ml-2">${new Date(comment.createdAt?.toDate ? comment.createdAt.toDate() : comment.createdAt).toLocaleString()}</span></p>
                            <p class="text-byte-text-light text-sm">${comment.content}</p>
                        </div>
                    `;
                    commentsListElement.appendChild(commentElement);
                }
            });
        }

        // Función para configurar el botón de "Me gusta"
        function setupLikeButton(postId, currentLikes) {
            // Target the new interactive "Me gusta" button
            const likeButton = document.querySelector(`.like-button[data-post-id="${postId}"]`);
            // Target the like count span in the meta-info area
            const likesCountSpan = document.getElementById(`likes-count-${postId}`);

            if (!likeButton || !likesCountSpan) return;

            const currentUserId = auth.currentUser ? auth.currentUser.uid : null;
            // No necesitamos userLiked aquí ya que onSnapshot manejará el estado visual directamente

            // Function to update the button style and count
            const updateLikeDisplay = (likesArray) => {
                const updatedUserLiked = likesArray.includes(currentUserId);
                likesCountSpan.textContent = likesArray.length; // Update the numerical count

                // Update the style of the interactive "Me gusta" button
                if (updatedUserLiked) {
                    likeButton.classList.remove('text-gray-400');
                    likeButton.classList.add('text-blue-500');
                } else {
                    likeButton.classList.remove('text-blue-500');
                    likeButton.classList.add('text-gray-400');
                }
            };

            // Initial display update
            updateLikeDisplay(currentLikes);

            // Remove previous event listener to prevent duplicates if post element is replaced
            const oldLikeButton = likeButton.cloneNode(true);
            likeButton.parentNode.replaceChild(oldLikeButton, likeButton);
            const newLikeButton = oldLikeButton; // Use this as the new reference

            // Add the click listener
            newLikeButton.onclick = async () => {
                if (!auth.currentUser) {
                    window.showMessage('Debes iniciar sesión para reaccionar.', 'red');
                    return;
                }

                const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                const postSnap = await getDoc(postRef);
                if (!postSnap.exists()) {
                    console.error("Post no encontrado para dar like:", postId);
                    window.showMessage('Error: la publicación no existe.', 'red');
                    return;
                }
                const currentLikesArray = postSnap.data().likes || [];
                const isCurrentlyLikedByUser = currentLikesArray.includes(currentUserId);

                let newLikesArray;
                if (isCurrentlyLikedByUser) {
                    newLikesArray = currentLikesArray.filter(uid => uid !== currentUserId);
                } else {
                    newLikesArray = [...currentLikesArray, currentUserId];
                }

                try {
                    await updateDoc(postRef, {
                        likes: newLikesArray
                    });
                    // Firestore onSnapshot for this post will handle the UI update
                } catch (error) {
                    console.error('Error al actualizar like:', error);
                    window.showMessage('Error al actualizar la reacción. Intenta de nuevo.', 'red');
                }
            };

            // Set up a listener for real-time updates to likes for this specific post
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            onSnapshot(postRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const updatedLikes = data.likes || [];
                    updateLikeDisplay(updatedLikes); // Update the UI based on new data
                }
            });
        }

        // Función para cargar y mostrar usuarios online
        async function loadOnlineUsers() {
            const onlineUsersList = document.getElementById('online-users-list');
            if (!onlineUsersList) return;

            const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            const q = query(usersCollectionRef); 

            onSnapshot(q, async (snapshot) => {
                onlineUsersList.innerHTML = '';
                const onlineUsers = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData && userData.lastSeen) {
                        const lastSeenDate = userData.lastSeen.toDate ? userData.lastSeen.toDate() : new Date(userData.lastSeen);
                        if (lastSeenDate > fiveMinutesAgo) {
                            onlineUsers.push({ id: doc.id, ...userData });
                        }
                    }
                });

                if (onlineUsers.length === 0) {
                    onlineUsersList.innerHTML = `
                        <li class="text-gray-400 text-sm italic">No hay usuarios online en este momento.</li>
                    `;
                } else {
                    onlineUsers.forEach(user => {
                        const userElement = document.createElement('li');
                        userElement.classList.add('flex', 'items-center', 'text-byte-text-light', 'text-sm');
                        const profilePic = user.profilePicUrl || DEFAULT_PROFILE_PIC;
                        userElement.innerHTML = `
                            <span class="relative flex h-3 w-3 mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </span>
                            <img src="${profilePic}" alt="Foto de perfil de ${user.name || user.email}" class="w-6 h-6 rounded-full mr-2 object-cover border border-green-500">
                            <span>${user.name || user.email}</span>
                        `;
                        onlineUsersList.appendChild(userElement);
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Firebase dentro de DOMContentLoaded
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log('Firebase: Aplicación y servicios inicializados correctamente.');
            } catch (error) {
                console.error("Error crítico al inicializar Firebase:", error);
                window.showMessage('Error crítico: No se pudo inicializar Firebase. Consulta la consola para más detalles.', 'red');
                // Asegurarse de que la página no se vea en blanco si Firebase falla
                const mainContentArea = document.querySelector('main');
                if (mainContentArea) {
                    mainContentArea.innerHTML = `
                        <div class="text-center p-8 bg-red-800 bg-opacity-70 rounded-lg shadow-lg">
                            <p class="text-xl text-white mb-4">No se pudo cargar la aplicación.</p>
                            <p class="text-md text-gray-200 mb-6">Parece que hay un problema con la conexión a Firebase o la configuración.</p>
                            <button onclick="location.reload()" class="bg-yellow-500 text-black font-bold py-2 px-4 rounded-full
                                            shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-110">
                                Recargar Página
                            </button>
                        </div>
                    `;
                }
                return; // Detener la ejecución si Firebase no se inicializa
            }


            const scrollToTopButton = document.getElementById('scroll-to-top-button');
            const mainHeader = document.getElementById('main-header');
            let lastScrollY = 0;

            // Lógica para el botón "Volver arriba" y el encabezado
            if (window) { // Check if window exists (for safety)
                window.addEventListener('scroll', () => {
                    const currentScrollY = window.scrollY;

                    if (currentScrollY > 0) {
                        if (scrollToTopButton) scrollToTopButton.classList.add('show');
                    } else {
                        if (scrollToTopButton) scrollToTopButton.classList.remove('show');
                    }

                    if (currentScrollY > lastScrollY && currentScrollY > 0) {
                        if (mainHeader) mainHeader.classList.add('header-hide');
                    } else if (currentScrollY < lastScrollY || currentScrollY === 0) {
                        if (mainHeader) mainHeader.classList.remove('header-hide');
                    }
                    lastScrollY = currentScrollY;
                });
            }
            if (scrollToTopButton) { // Check if button exists
                scrollToTopButton.addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }


            // Elementos del DOM para autenticación y foro
            const welcomeMessage = document.getElementById('welcome-message');
            const loginRegisterLink = document.getElementById('login-register-link');
            const forumContent = document.getElementById('forum-content');
            const authSection = document.getElementById('auth-section'); // Este ID ahora está en el HTML
            const createTopicButton = document.getElementById('create-topic-button'); // Se usa en comentarios para inhabilitar
            const authFormsContainer = document.getElementById('auth-forms-container');
            const verificationScreen = document.getElementById('verification-screen');
            const videoBackground = document.getElementById('video-background');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const goToLoginBtn = document.getElementById('go-to-login-btn');
            const registerPasswordInput = document.getElementById('register-password');
            const passwordStrengthBar = document.getElementById('password-strength-bar');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const createPostForm = document.getElementById('create-post-form');
            const onlineUsersSidebar = document.getElementById('online-users-sidebar');
            const toggleOnlineUsersBtn = document.getElementById('toggle-online-users-btn');
            const notificationsButton = document.getElementById('notifications-button'); // Nuevo
            const profileSettingsContainer = document.getElementById('profile-settings-container');
            const profilePicImg = document.getElementById('profile-pic-img');
            const profileSettingsButton = document.getElementById('profile-settings-button');
            const profileDropdownMenu = document.getElementById('profile-dropdown-menu');

            // Asegurarse de que el botón de estado de Firebase se obtenga aquí
            firebaseStatusButtonElement = document.getElementById('firebase-status-button');

            // Lógica para alternar la visibilidad de la barra lateral de usuarios online
            if (toggleOnlineUsersBtn) {
                toggleOnlineUsersBtn.addEventListener('click', () => {
                    if (onlineUsersSidebar) {
                        // Toggle the 'hidden-sidebar' class
                        onlineUsersSidebar.classList.toggle('hidden-sidebar');
                        // Ensure 'display' property is correctly set based on class presence
                        if (!onlineUsersSidebar.classList.contains('hidden-sidebar')) {
                             onlineUsersSidebar.style.display = 'block';
                        } else {
                            onlineUsersSidebar.style.display = 'none';
                        }
                    }
                });
            }

            // Lógica para el menú desplegable del perfil/ajustes
            if (profileSettingsButton) {
                profileSettingsButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Evita que el clic en el botón cierre el menú inmediatamente
                    if (profileDropdownMenu) {
                        profileDropdownMenu.classList.toggle('show');
                    }
                });
            }

            // Cerrar el menú desplegable si se hace clic fuera de él
            document.addEventListener('click', (event) => {
                if (profileDropdownMenu && profileSettingsContainer && !profileSettingsContainer.contains(event.target)) {
                    profileDropdownMenu.classList.remove('show');
                }
            });


            // Manejar el estado de autenticación
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Actualizar el timestamp de 'última vez visto' del usuario al iniciar sesión
                    if (db) {
                        const userProfileRef = doc(db, `artifacts/${appId}/users`, user.uid);
                        try {
                            const userSnap = await getDoc(userProfileRef);
                            if (userSnap.exists()) {
                                await updateDoc(userProfileRef, { lastSeen: serverTimestamp() });
                            } else {
                                await setDoc(userProfileRef, {
                                    email: user.email,
                                    name: user.email.split('@')[0],
                                    lastSeen: serverTimestamp(),
                                    profilePicUrl: DEFAULT_PROFILE_PIC
                                }, { merge: true });
                            }
                            clearInterval(onlineUsersInterval);
                            onlineUsersInterval = setInterval(updateLastSeen, 30000);
                        } catch (error) {
                            console.error("Error al establecer/actualizar lastSeen al iniciar sesión:", error);
                        }
                    }

                    if (user.emailVerified) {
                        console.log('Firebase Auth: Usuario autenticado y correo verificado', user.uid);
                        // Mostrar contenido del foro, ocultar elementos de autenticación, ocultar video
                        if (loginRegisterLink) loginRegisterLink.classList.add('hidden');
                        if (welcomeMessage) welcomeMessage.classList.remove('hidden');
                        if (toggleOnlineUsersBtn) toggleOnlineUsersBtn.classList.remove('hidden'); // Mostrar botón "conectados"
                        if (notificationsButton) notificationsButton.classList.remove('hidden'); // Mostrar botón "notificaciones"
                        if (profileSettingsContainer) profileSettingsContainer.classList.remove('hidden'); // Mostrar contenedor de perfil


                        if (forumContent) forumContent.classList.remove('hidden');
                        if (authSection) authSection.classList.add('hidden'); // Usa authSection como contenedor principal
                        if (videoBackground) videoBackground.classList.add('hidden'); // Ocultar el video de fondo
                        // La sidebar se maneja con el botón, pero su estado inicial es hidden-sidebar
                        if (onlineUsersSidebar) onlineUsersSidebar.classList.add('hidden-sidebar');
                        if (onlineUsersSidebar) onlineUsersSidebar.style.display = 'none'; // Ensure it starts hidden

                        if (firebaseStatusButtonElement) {
                            firebaseStatusButtonElement.textContent = 'FORO (Activo)';
                            firebaseStatusButtonElement.classList.remove('bg-red-500', 'bg-gray-500');
                            firebaseStatusButtonElement.classList.add('bg-green-500');
                        }

                        try {
                            const userProfileRef = doc(db, `artifacts/${appId}/users`, user.uid);
                            const userProfileSnap = await getDoc(userProfileRef);

                            if (userProfileSnap.exists()) {
                                currentUserData = userProfileSnap.data();
                                if (welcomeMessage) welcomeMessage.textContent = `Bienvenido, ${currentUserData.name || user.email}!`;
                                if (profilePicImg) profilePicImg.src = currentUserData.profilePicUrl || DEFAULT_PROFILE_PIC; // Actualizar foto de perfil
                            } else {
                                if (welcomeMessage) welcomeMessage.textContent = `Bienvenido, ${user.email}!`;
                                if (profilePicImg) profilePicImg.src = DEFAULT_PROFILE_PIC;
                                await setDoc(userProfileRef, {
                                    email: user.email,
                                    name: user.email.split('@')[0],
                                    lastSeen: serverTimestamp(),
                                    profilePicUrl: DEFAULT_PROFILE_PIC
                                });
                                const updatedUserSnap = await getDoc(userProfileRef);
                                if (updatedUserSnap.exists()) currentUserData = updatedUserSnap.data();
                            }
                        } catch (firestoreError) {
                            console.error('Error al cargar datos del perfil desde Firestore:', firestoreError);
                            window.showMessage('Error al cargar tu perfil.', 'red');
                            if (welcomeMessage) welcomeMessage.textContent = `Bienvenido, ${user.email}!`;
                            if (profilePicImg) profilePicImg.src = DEFAULT_PROFILE_PIC;
                        }

                        if (createTopicButton) {
                            createTopicButton.disabled = false;
                            createTopicButton.classList.remove('opacity-50', 'cursor-not-allowed');
                            createTopicButton.onclick = window.handleCreateNewTopic;
                        }
                        loadPosts();
                        loadOnlineUsers();

                    } else {
                        console.log('Firebase Auth: Usuario autenticado, pero correo NO verificado.', user.uid);
                        // Mostrar pantalla de verificación, ocultar foro y formularios de autenticación, mostrar video
                        if (loginRegisterLink) loginRegisterLink.classList.remove('hidden');
                        if (welcomeMessage) welcomeMessage.classList.add('hidden');
                        if (toggleOnlineUsersBtn) toggleOnlineUsersBtn.classList.add('hidden'); // Ocultar botón "conectados"
                        if (notificationsButton) notificationsButton.classList.add('hidden'); // Ocultar botón "notificaciones"
                        if (profileSettingsContainer) profileSettingsContainer.classList.add('hidden'); // Ocultar contenedor de perfil

                        if (forumContent) forumContent.classList.add('hidden');
                        if (authSection) authSection.classList.remove('hidden'); // Mostrar authSection
                        if (authFormsContainer) authFormsContainer.classList.add('hidden'); // Ocultar formularios dentro
                        if (verificationScreen) {
                            verificationScreen.classList.remove('hidden'); // Mostrar pantalla de verificación
                            if (verificationScreen.querySelector('h2')) verificationScreen.querySelector('h2').textContent = '¡Verifica tu Correo Electrónico!';
                            if (verificationScreen.querySelector('p:nth-of-type(1)')) verificationScreen.querySelector('p:nth-of-type(1)').textContent = 'Necesitas verificar tu dirección de correo electrónico para acceder al foro.';
                            if (verificationScreen.querySelector('p:nth-of-type(2)')) verificationScreen.querySelector('p:nth-of-type(2)').textContent = 'Revisa tu bandeja de entrada o la carpeta de spam para el enlace de verificación.';
                            if (goToLoginBtn) goToLoginBtn.textContent = 'Volver a Iniciar Sesión';
                        }
                        if (videoBackground) videoBackground.classList.remove('hidden');
                        if (onlineUsersSidebar) onlineUsersSidebar.classList.add('hidden-sidebar'); // Ocultar sidebar
                        if (onlineUsersSidebar) onlineUsersSidebar.style.display = 'none'; // Ensure it starts hidden

                        if (firebaseStatusButtonElement) {
                            firebaseStatusButtonElement.textContent = 'FORO (Verifica Email)';
                            firebaseStatusButtonElement.classList.remove('bg-green-500', 'bg-gray-500');
                            firebaseStatusButtonElement.classList.add('bg-red-500');
                        }
                        if (createTopicButton) {
                            createTopicButton.disabled = true;
                            createTopicButton.classList.add('opacity-50', 'cursor-not-allowed');
                            createTopicButton.onclick = () => window.showMessage('Debes verificar tu correo para crear un tema.', 'red');
                        }
                    }

                } else {
                    // Usuario NO autenticado, mostrar la sección de autenticación y ocultar el foro.
                    console.log('Firebase Auth: Usuario no autenticado. Mostrando sección de autenticación.');
                    if (loginRegisterLink) loginRegisterLink.classList.remove('hidden');
                    if (welcomeMessage) welcomeMessage.classList.add('hidden');
                    if (toggleOnlineUsersBtn) toggleOnlineUsersBtn.classList.add('hidden'); // Ocultar botón "conectados"
                    if (notificationsButton) notificationsButton.classList.add('hidden'); // Ocultar botón "notificaciones"
                    if (profileSettingsContainer) profileSettingsContainer.classList.add('hidden'); // Ocultar contenedor de perfil

                    if (forumContent) forumContent.classList.add('hidden');
                    if (authSection) authSection.classList.remove('hidden'); // Mostrar authSection
                    if (authFormsContainer) authFormsContainer.classList.remove('hidden'); // Asegurarse de que el formulario de login/register esté visible
                    if (verificationScreen) verificationScreen.classList.add('hidden'); // Ocultar pantalla de verificación
                    if (videoBackground) videoBackground.classList.remove('hidden');
                    if (onlineUsersSidebar) onlineUsersSidebar.classList.add('hidden-sidebar'); // Ocultar sidebar
                    if (onlineUsersSidebar) onlineUsersSidebar.style.display = 'none'; // Ensure it starts hidden

                    if (firebaseStatusButtonElement) {
                        firebaseStatusButtonElement.textContent = 'FORO (Inactivo)';
                        firebaseStatusButtonElement.classList.remove('bg-green-500', 'bg-gray-500');
                        firebaseStatusButtonElement.classList.add('bg-red-500');
                    }

                    if (createTopicButton) {
                        createTopicButton.disabled = true;
                        createTopicButton.classList.add('opacity-50', 'cursor-not-allowed');
                        createTopicButton.onclick = () => window.showMessage('Debes iniciar sesión para crear un tema.', 'red');
                    }
                    // Asegurarse de que el formulario de inicio de sesión se muestre por defecto
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (registerForm) registerForm.classList.add('hidden');
                    if (loginTab) loginTab.classList.add('active');
                    if (registerTab) registerTab.classList.remove('active');
                }
            });

            // Lógica para alternar entre formularios de Iniciar Sesión y Registro
            const showForm = (formToShow) => {
                if (authFormsContainer) authFormsContainer.classList.remove('hidden');
                if (verificationScreen) verificationScreen.classList.add('hidden');
                if (formToShow === 'login') {
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (registerForm) registerForm.classList.add('hidden');
                    if (loginTab) loginTab.classList.add('active');
                    if (registerTab) registerTab.classList.remove('active');
                } else {
                    if (registerForm) registerForm.classList.remove('hidden');
                    if (loginForm) loginForm.classList.add('hidden');
                    if (registerTab) registerTab.classList.add('active');
                    if (loginTab) loginTab.classList.remove('active');
                }
            };

            // Event listeners para los botones de las pestañas
            if (loginTab) loginTab.addEventListener('click', () => showForm('login'));
            if (registerTab) registerTab.addEventListener('click', () => showForm('register'));
            if (goToLoginBtn) goToLoginBtn.addEventListener('click', () => showForm('login'));

            // Función para evaluar la seguridad de la contraseña
            const checkPasswordStrength = (password) => {
                let strength = 0;
                if (password.length > 7) strength++;
                if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
                if (password.match(/\d/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;

                if (passwordStrengthBar) {
                    passwordStrengthBar.className = '';
                    if (strength === 0) {
                        passwordStrengthBar.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
                        passwordStrengthBar.style.width = '0%';
                    } else if (strength < 2) {
                        passwordStrengthBar.classList.add('strength-weak');
                    } else if (strength < 4) {
                        passwordStrengthBar.classList.add('strength-medium');
                    } else {
                        passwordStrengthBar.classList.add('strength-strong');
                    }
                }
            };

            if (registerPasswordInput) {
                registerPasswordInput.addEventListener('input', (e) => {
                    checkPasswordStrength(e.target.value);
                });
            }

            // Manejo del envío del formulario de REGISTRO
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Intento de envío de formulario de registro.');

                    const email = registerForm.elements['email'].value;
                    const password = registerForm.elements['password'].value;
                    const name = registerForm.elements['name'].value;
                    const lastname = registerForm.elements['lastname'].value;
                    const phone = registerForm.elements['phone'].value;
                    const age = registerForm.elements['age'].value;
                    const role = registerForm.elements['role'].value;
                    const profilePicUrl = registerForm.elements['profile_pic_url'].value;

                    if (!auth || !db) {
                        window.showMessage('Firebase no está inicializado. Por favor, revisa la configuración.', 'red');
                        return;
                    }
                    
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        await sendEmailVerification(user);
                        window.showMessage('¡Registro exitoso! Correo de verificación enviado.', 'green');

                        await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                            email: email,
                            name: name,
                            lastname: lastname,
                            phone: phone,
                            age: parseInt(age),
                            role: role,
                            profilePicUrl: profilePicUrl || DEFAULT_PROFILE_PIC,
                            createdAt: serverTimestamp(),
                            lastSeen: serverTimestamp()
                        });
                        console.log('Datos de usuario guardados en Firestore para:', user.uid);

                        if (authFormsContainer) authFormsContainer.classList.add('hidden');
                        if (verificationScreen) verificationScreen.classList.remove('hidden');

                    } catch (error) {
                        console.error('Error al registrar usuario:', error);
                        let errorMessage = 'Error al registrar usuario. Intenta de nuevo.';
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = 'El correo electrónico ya está registrado.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'El formato del correo electrónico es inválido.';
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = 'La contraseña es demasiado débil (debe tener al menos 6 caracteres).';
                        }
                        window.showMessage(errorMessage, 'red');
                    }
                });
            }

            // Manejo del envío del formulario de INICIAR SESIÓN
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const email = loginForm.elements['email'].value;
                    const password = loginForm.elements['password'].value;

                    if (!auth) {
                        window.showMessage('Firebase no está inicializado. Por favor, revisa la configuración.', 'red');
                        return;
                    }

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        window.showMessage('¡Inicio de sesión exitoso!', 'green');
                        console.log('Usuario ha iniciado sesión.');
                    } catch (error) {
                        console.error('Error al iniciar sesión:', error);
                        let errorMessage = 'Error al iniciar sesión. Verifica tus credenciales.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            errorMessage = 'Correo o contraseña incorrectos.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'El formato del correo electrónico es inválido.';
                        }
                        window.showMessage(errorMessage, 'red');
                    }
                });
            }

            // Lógica para el botón de "Olvidaste tu contraseña"
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', () => {
                    window.showMessage('La función de recuperación de contraseña está en desarrollo.', 'blue');
                });
            }

            // Lógica para publicaciones y comentarios
            if (createPostForm) {
                createPostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!auth.currentUser) {
                        window.showMessage('Debes iniciar sesión para crear una publicación.', 'red');
                        return;
                    }

                    const postContent = createPostForm.elements['post-content'].value;
                    const postImageUrl = createPostForm.elements['post-image-url'].value;
                    const postVideoUrl = createPostForm.elements['post-video-url'].value; // Nuevo campo de video URL

                    if (!postContent.trim()) {
                        window.showMessage('El contenido de la publicación no puede estar vacío.', 'red');
                        return;
                    }

                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), {
                            authorId: auth.currentUser.uid,
                            authorEmail: auth.currentUser.email,
                            content: postContent,
                            imageUrl: postImageUrl.trim() ? postImageUrl : null,
                            videoUrl: postVideoUrl.trim() ? postVideoUrl : null, // Guardar la URL del video
                            createdAt: serverTimestamp(),
                            likes: []
                        });
                        window.showMessage('Publicación creada exitosamente.', 'green');
                        createPostForm.reset();
                    } catch (error) {
                        console.error('Error al crear publicación:', error);
                        window.showMessage('Error al crear publicación. Intenta de nuevo.', 'red');
                    }
                });
            }

            document.addEventListener('submit', async (e) => {
                if (e.target.classList.contains('add-comment-form')) {
                    e.preventDefault();

                    if (!auth.currentUser) {
                        window.showMessage('Debes iniciar sesión para comentar.', 'red');
                        return;
                    }

                    const postId = e.target.dataset.postId;
                    const commentContent = e.target.querySelector('textarea').value;

                    if (!commentContent.trim()) {
                        window.showMessage('El comentario no puede estar vacío.', 'red');
                        return;
                    }

                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/posts/${postId}/comments`), {
                            authorId: auth.currentUser.uid,
                            authorEmail: auth.currentUser.email,
                            content: commentContent,
                            createdAt: serverTimestamp()
                        });
                        window.showMessage('Comentario añadido.', 'green');
                        e.target.reset();
                    } catch (error) {
                        console.error('Error al añadir comentario:', error);
                        window.showMessage('Error al añadir comentario. Intenta de nuevo.', 'red');
                    }
                }
            });
        });
    </script>
</body>
</html>
