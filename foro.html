<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Foro de Byte - Tu comunidad digital</title>
  
  <!-- Ícono y metadatos sociales -->
  <link rel="icon" type="image/png" href="logo.png" />
  <meta name="description" content="Foro oficial de Byte - Conéctate con nuestra comunidad, comparte ideas y obtén soporte." />
  <meta name="keywords" content="Byte, foro, comunidad, soporte, preguntas, respuestas, tecnología, diseño web, Venezuela" />
  <meta name="author" content="Byte" />
  <meta property="og:title" content="Foro de Byte - Comunidad y Soporte" />
  <meta property="og:description" content="Un espacio para discutir, aprender y colaborar con la comunidad de Byte." />
  <meta property="og:type" content="website" />

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'byte-dark-bg'       : '#0A0A1A',
            'byte-secondary-dark': '#1A202C',
            'byte-text-light'    : '#F9FAFB',
            'byte-accent-cyan'   : '#00FFFF'
          }
        }
      }
    }
  </script>

  <!-- FontAwesome (para iconos) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

  <style>
    /*!— Estilos globales —*/
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0A0A1A;
      color: #F9FAFB;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    h1,h2,h3,h4,h5,h6 {
      font-family: 'Montserrat', sans-serif;
      color: #00FFFF;
      text-shadow: 0 0 5px rgba(0,255,255,0.5);
    }
    .text-stroke-cyan {
      -webkit-text-stroke: 1.5px #00FFFF;
      text-stroke: 1.5px #00FFFF;
      color: #FFFFFF;
      text-shadow: none;
    }
    img { pointer-events: none; }
    p,h1,h2,h3,h4,h5,h6,span,div:not(.map-container):not(.payment-card) {
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    /*!— Header ocultable al hacer scroll —*/
    .header-main {
      transition: transform 0.3s ease-out;
    }
    .header-main.header-hidden {
      transform: translateY(-100%);
    }
    /*!— Tarjetas de foro y tópicos —*/
    .forum-category-card {
      background: linear-gradient(145deg,#1A202C,#0A0A1A);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 20px rgba(0,255,255,0.15);
      border: 1px solid rgba(0,255,255,0.2);
      transition: all 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .forum-category-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 12px 30px rgba(0,255,255,0.3);
      border-color: #00FFFF;
    }
    .forum-category-card .icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: #00FFFF;
      text-shadow: 0 0 10px rgba(0,255,255,0.5);
    }
    .forum-category-card h3 {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #F9FAFB;
    }
    .forum-category-card p {
      font-size: 0.9rem;
      color: #CBD5E0;
      line-height: 1.5;
      margin-bottom: 1rem;
    }
    .forum-topic-item {
      background-color: #1A202C;
      border: 1px solid rgba(0,255,255,0.15);
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      margin-bottom: 0.75rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: flex-start;
      transition: background-color 0.2s ease, transform 0.2s ease;
      cursor: pointer;
    }
    .forum-topic-item:hover {
      background-color: #2D3748;
      transform: translateX(5px);
    }
    .forum-topic-item .title {
      font-weight: 600;
      color: #00FFFF;
      font-size: 1.05rem;
      margin-bottom: 0.5rem;
    }
    .forum-topic-item .meta {
      font-size: 0.85rem;
      color: #CBD5E0;
      text-align: left;
      width: 100%;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .forum-topic-item .meta span {
      display: inline-block;
      margin-right: 1rem;
    }
    .new-topic-button {
      background-color: #00FFFF;
      color: #0A0A1A;
      font-weight: bold;
      padding: 0.8rem 2rem;
      border-radius: 9999px;
      box-shadow: 0 5px 15px rgba(0,255,255,0.4);
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .new-topic-button:hover {
      background-color: #00BFFF;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 20px rgba(0,255,255,0.6);
    }
    /*!— Estilos para modales —*/
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .modal-content {
      background-color: #1A202C;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,255,255,0.3);
      border: 1px solid #00FFFF;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-close-button {
      position: absolute;
      top: 1rem; right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #00FFFF;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .modal-close-button:hover {
      color: #00BFFF;
    }
    .modal textarea,
    .modal input[type="text"],
    .modal input[type="email"],
    .modal input[type="password"],
    .modal input[type="url"],
    .modal input[type="tel"],
    .modal input[type="date"],
    .modal input[type="color"] {
      background-color: #1A202C;
      border: 1px solid rgba(0,255,255,0.3);
      color: #F9FAFB;
      padding: 0.75rem;
      border-radius: 0.5rem;
      width: 100%;
      margin-bottom: 1rem;
    }
    .modal button[type="submit"] {
      background-color: #00FFFF;
      color: #0A0A1A;
      font-weight: bold;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      transition: background-color 0.2s ease;
    }
    .modal button[type="submit"]:hover {
      background-color: #00BFFF;
    }
    /*!— Display User ID —*/
    .user-id-display {
      background-color: #1A202C;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      color: #CBD5E0;
      font-size: 0.85rem;
      margin-top: 1rem;
      text-align: center;
      border: 1px solid rgba(0,255,255,0.2);
    }
    /*!— Animaciones de iconos —*/
    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin-slow {
      animation: spin-slow 2s linear infinite;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      10%,30%,50%,70%,90% { transform: translateX(-5px); }
      20%,40%,60%,80% { transform: translateX(5px); }
    }
    .animate-shake {
      animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
    }
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      50% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0.7; }
    }
    .animate-pulse {
      animation: pulse 1.5s infinite ease-in-out;
    }
    /*!— Badge de notificaciones —*/
    .notification-badge {
      position: absolute;
      top: -5px; right: -5px;
      background-color: #EF4444; /* Rojo */
      color: white;
      font-size: 0.75rem;
      font-weight: bold;
      border-radius: 9999px;
      padding: 0.1rem 0.4rem;
      min-width: 1.2rem;
      text-align: center;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <!-- Video de fondo (solo cuando NO haya sesión activa) -->
  <video autoplay loop muted playsinline id="video-background"
         class="absolute inset-0 w-full h-full object-cover z-0">
    <source src="./images/fondo.mp4" type="video/mp4" />
    Tu navegador no soporta el video.
  </video>

  <!-- Modal de autenticación (login / registro) -->
  <div id="auth-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40">
    <div class="bg-byte-secondary-dark p-8 rounded-lg shadow-2xl max-w-md w-full text-center relative border border-byte-accent-cyan/50">
      <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-byte-accent-cyan">Iniciar Sesión</h2>
      <form id="auth-form" class="space-y-4">
        <!-- INPUTS DINÁMICOS SEGÚN MODO (login vs register) -->
        <input type="text" id="auth-name" placeholder="Nombre (obligatorio al registrarse)"
               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan hidden"/>
        <input type="email" id="auth-email" placeholder="Correo Electrónico"
               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" required/>
        <input type="password" id="auth-password" placeholder="Contraseña"
               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" required/>
        <input type="tel" id="auth-phone" placeholder="Número de Teléfono (opcional)"
               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan hidden"/>

        <!-- Checkbox de reglas (solo en registro) -->
        <div class="flex items-center justify-center text-sm text-gray-400 mt-4 hidden">
          <input type="checkbox" id="auth-rules-accept" class="mr-2 rounded text-byte-accent-cyan focus:ring-byte-accent-cyan"/>
          <label for="auth-rules-accept">Acepto las <a href="#" id="auth-rules-link" class="text-byte-accent-cyan hover:underline">Reglas del Foro</a></label>
        </div>

        <!-- Botones / textos -->
        <button type="submit" id="auth-submit-button"
                class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">
          Iniciar Sesión
        </button>

        <p class="text-sm text-gray-400 mt-4">
          <a href="#" id="forgot-password-link" class="text-byte-accent-cyan hover:underline">¿Olvidaste tu contraseña?</a>
        </p>

        <button type="button" id="resend-verification-email-button"
                class="w-full bg-blue-500 text-white py-3 rounded-md font-semibold hover:bg-blue-600 transition duration-200 mt-2 hidden">
          Reenviar Correo de Verificación
        </button>

        <p class="text-sm text-gray-400 mt-4">
          <span id="auth-toggle-text">¿No tienes una cuenta?</span>
          <button type="button" id="auth-toggle-button" class="text-byte-accent-cyan hover:underline ml-1">Regístrate</button>
        </p>

        <p id="auth-message" class="text-red-400 text-sm mt-2 hidden"></p>
      </form>
    </div>
  </div>

  <!-- Header principal (sticky) -->
  <header class="bg-byte-dark-bg text-byte-text-light py-4 shadow-lg sticky top-0 z-50 border-b border-byte-accent-cyan header-main">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-byte-accent-cyan">Foro de Byte</h1>
      <div class="flex space-x-4">
        <button id="rules-button"
                class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-110 text-sm">
          Reglas
        </button>
        <button id="notifications-button" class="hidden bg-purple-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-110 text-sm flex items-center justify-center relative">
          <i class="fas fa-bell text-lg"></i>
          <span id="notification-badge" class="notification-badge hidden">0</span>
        </button>
        <button id="settings-button" class="hidden bg-gray-700 text-white py-2 px-4 rounded-full shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-110 text-sm flex items-center justify-center">
          <i class="fas fa-cog text-lg"></i>
        </button>
        <button id="admin-chat-view-button" class="hidden bg-orange-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-orange-700 transition duration-300 transform hover:scale-110 text-sm">
          <i class="fas fa-eye mr-1"></i> Ver Chats
        </button>
        <button id="logout-button-header" class="hidden bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-110 text-sm">
          Cerrar Sesión
        </button>
      </div>
    </div>
  </header>

  <main class="flex-grow">
    <!-- Contenedor del foro; permanece hidden hasta login + email confirmado -->
    <div id="forum-content-wrapper" class="hidden py-8">
      <!-- Sección de bienvenida / “hero” -->
      <section id="top" class="relative bg-byte-dark-bg text-white py-16 md:py-24 overflow-hidden flex items-center justify-center">
        <div class="container mx-auto px-4 relative z-10 text-center">
          <h1 class="text-3xl md:text-5xl lg:text-4xl font-extrabold leading-tight mb-4 drop-shadow-lg text-stroke-cyan">
            Bienvenido al Foro de Byte
          </h1>
          <p class="text-base md:text-xl lg:text-lg mb-8 max-w-3xl mx-auto text-byte-text-light opacity-90">
            Un espacio para la comunidad de Byte para discutir, compartir ideas y obtener soporte.
          </p>
          <button id="new-topic-button" class="new-topic-button">
            <i class="fas fa-plus-circle mr-2"></i> Crear Nueva Publicación
          </button>
        </div>
      </section>

      <!-- Sección de publicaciones y usuarios en línea -->
      <section id="forum-posts" class="py-12 lg:py-10 bg-byte-dark-bg text-byte-text-light">
        <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">
          
          <!-- Lista de Publicaciones -->
          <div class="md:col-span-3">
            <h2 class="text-2xl md:text-4xl lg:text-3xl font-extrabold text-center mb-10 text-stroke-cyan">Publicaciones Recientes</h2>
            <div id="posts-container" class="max-w-3xl mx-auto">
              <!-- Se reemplaza dinámicamente con JavaScript -->
              <p class="text-center text-gray-400">Cargando publicaciones...</p>
            </div>
          </div>

          <!-- Panel derecho: Usuarios en línea -->
          <div class="md:col-span-1 flex flex-col gap-8">
            <div class="bg-byte-secondary-dark p-6 rounded-lg shadow-xl border border-byte-accent-cyan/30 h-fit">
              <h3 class="text-xl font-bold mb-4 text-byte-accent-cyan text-center">Usuarios en Línea</h3>
              <div id="online-users-container" class="space-y-3">
                <!-- Cargado dinámicamente por JavaScript -->
                <p class="text-sm text-gray-400 text-center">Cargando usuarios...</p>
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </main>

  <footer class="bg-byte-secondary-dark text-byte-text-light py-8 text-center border-t border-byte-accent-cyan">
    <div class="container mx-auto px-4">
      <p>© 2025 Byte Foro. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- ────────── MODALES ────────── -->

  <!-- Modal “Crear Publicación” -->
  <div id="create-post-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="close-create-post-modal">&times;</button>
      <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Crear Nueva Publicación</h2>
      <form id="create-post-form">
        <textarea id="post-content-input" placeholder="Escribe tu publicación aquí..." rows="6"
                  class="w-full p-3 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"></textarea>
        <input type="url" id="post-image-url-input" placeholder="URL de la imagen (opcional)"
               class="w-full p-3 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <input type="url" id="post-video-url-input" placeholder="URL del video (opcional)"
               class="w-full p-3 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <button type="submit"
                class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200 mt-4">
          Publicar
        </button>
      </form>
    </div>
  </div>

  <!-- Modal “Ver Publicación y Comentarios” -->
  <div id="view-post-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="close-view-post-modal">&times;</button>
      <div id="view-post-content" class="mb-6">
        <!-- Contenido de la publicación (cargado por JS) -->
      </div>
      <h3 class="text-lg font-bold mb-3 text-byte-accent-cyan">Comentarios</h3>
      <div id="comments-container"
           class="max-h-60 overflow-y-auto mb-4 p-2 rounded-md bg-gray-900 border border-gray-700">
        <!-- Comentarios cargados por JS -->
      </div>
      <div class="flex">
        <input type="text" id="comment-input" placeholder="Escribe un comentario..."
               class="flex-grow p-2 rounded-l-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <button id="add-comment-button" class="bg-blue-600 text-white px-4 rounded-r-md hover:bg-blue-700 transition duration-200">
          Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal “Ajustes” -->
  <div id="settings-modal" class="modal hidden">
    <div class="modal-content text-center">
      <button class="modal-close-button" id="close-settings-modal">&times;</button>
      <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan">Ajustes</h2>
      <ul class="space-y-4">
        <li><a href="#" id="customize-profile-link"
               class="text-byte-text-light hover:text-byte-accent-cyan transition duration-200 text-lg font-semibold block">
          Personalizar Perfil
        </a></li>
        <li><button id="logout-button-modal"
                    class="bg-red-600 text-white py-2 px-6 rounded-full font-semibold hover:bg-red-700 transition duration-200">
          Cerrar Sesión
        </button></li>
      </ul>
    </div>
  </div>

  <!-- Modal “Ajustes de Perfil” -->
  <div id="profile-settings-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="close-profile-settings-modal">&times;</button>
      <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Ajustes de Perfil</h2>
      <form id="profile-settings-form" class="space-y-4">
        <div class="flex flex-col items-center mb-4">
          <img id="profile-photo-preview"
               src="https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser"
               alt="Vista previa de la foto de perfil"
               class="w-24 h-24 rounded-full object-cover border-2 border-byte-accent-cyan mb-2"/>
          <input type="url" id="profile-photo-url" placeholder="URL de la foto de perfil"
                 class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        </div>
        <input type="text" id="profile-name" placeholder="Nombre"
               class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <input type="email" id="profile-email" placeholder="Correo Electrónico"
               class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <input type="tel" id="profile-phone" placeholder="Número de Teléfono"
               class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <input type="date" id="profile-dob"
               class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <textarea id="profile-note-input" placeholder="Tu nota de perfil (máx. 100 caracteres)"
                  maxlength="100" rows="3"
                  class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"></textarea>
        <div class="flex items-center space-x-2">
          <label for="profile-color-input" class="text-byte-text-light">Color de Perfil:</label>
          <input type="color" id="profile-color-input"
                 class="w-10 h-10 rounded-md border border-byte-accent-cyan/30 cursor-pointer"/>
        </div>
        <button type="submit"
                class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">
          Guardar Cambios
        </button>
        <p id="profile-message" class="text-red-400 text-sm mt-2 hidden"></p>
      </form>
    </div>
  </div>

  <!-- Modal “Reglas” -->
  <div id="rules-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="close-rules-modal">&times;</button>
      <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Reglas del Foro</h2>
      <div class="text-byte-text-light text-sm space-y-3">
        <p>1. Sé respetuoso: Trata a los demás miembros con cortesía y respeto.</p>
        <p>2. No spam: Evita publicar contenido repetitivo o irrelevante.</p>
        <p>3. Sin contenido ofensivo: No se permite lenguaje o imágenes ofensivas, discriminatorias o de odio.</p>
        <p>4. Mantén la privacidad: No compartas información personal tuya o de otros.</p>
        <p>5. No promociones ilegales: No publiques enlaces o contenido relacionado con actividades ilegales.</p>
        <p>6. Reporta el mal comportamiento: Si ves algo inapropiado, repórtalo a los administradores.</p>
        <p>7. Los administradores tienen la última palabra: Las decisiones de los administradores son finales.</p>
      </div>
    </div>
  </div>

  <!-- Modal “Ver Perfil de Usuario” -->
  <div id="view-user-profile-modal" class="modal hidden">
    <div id="view-user-profile-modal-content" class="modal-content text-center">
      <button class="modal-close-button" id="close-view-user-profile-modal">&times;</button>
      <img id="view-user-profile-photo"
           src="https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser"
           alt="Foto de perfil del usuario"
           class="w-24 h-24 rounded-full object-cover border-2 border-white mx-auto mb-4"/>
      <h2 id="view-user-profile-name" class="text-xl font-bold mb-2 text-white">Nombre de Usuario</h2>
      <p id="view-user-profile-note" class="text-sm text-gray-300 mb-4">Nota del usuario.</p>
      <button id="ban-user-button"
              class="hidden bg-red-600 text-white py-2 px-6 rounded-full font-semibold hover:bg-red-700 transition duration-200">
        Banear Usuario
      </button>
    </div>
  </div>

  <!-- Modal “Chat Privado” -->
  <div id="private-chat-modal" class="modal hidden">
    <div class="modal-content flex flex-col h-[80vh]">
      <button class="modal-close-button" id="close-private-chat-modal">&times;</button>
      <h2 id="private-chat-header-name" class="text-xl font-bold mb-4 text-byte-accent-cyan text-center">Chat Privado</h2>
      <div id="private-chat-messages-container"
           class="flex-grow overflow-y-auto p-4 bg-gray-900 rounded-md mb-4 space-y-3 border border-gray-700">
        <!-- Mensajes cargados por JS -->
      </div>
      <div class="flex">
        <input type="text" id="private-chat-input" placeholder="Escribe tu mensaje..."
               class="flex-grow p-2 rounded-l-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"/>
        <button id="send-private-chat-button" class="bg-blue-600 text-white px-4 rounded-r-md hover:bg-blue-700 transition duration-200">
          Enviar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal “Notificaciones” -->
  <div id="notifications-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="close-notifications-modal">&times;</button>
      <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Tus Notificaciones</h2>
      <div id="notifications-list-container"
           class="max-h-80 overflow-y-auto p-2 rounded-md bg-gray-900 border border-gray-700">
        <!-- Notificaciones cargadas por JS -->
      </div>
    </div>
  </div>

  <!-- Modal “Vista Admin de todos los Chats” -->
  <div id="admin-chat-view-modal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close-button" id="close-admin-chat-view-modal">&times;</button>
      <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Todos los Chats Privados (Admin)</h2>
      <div id="admin-chat-list-container"
           class="max-h-80 overflow-y-auto p-2 rounded-md bg-gray-900 border border-gray-700">
        <!-- Lista de todos los chats cargada por JS -->
      </div>
    </div>
  </div>

  <!-- ────────── Scripts de Firebase y Lógica del Foro ────────── -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      sendPasswordResetEmail,
      sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      where,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // —––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // AQUI DEBES PEGAR TU firebaseConfig EXACTO:
    const firebaseConfig = {
      apiKey: "AIzaSyCYpAKjzz-rUBlZYkaEPiZMawfAM8-nQ3Y",
      authDomain: "byteweb-13a12.firebaseapp.com",
      projectId: "byteweb-13a12",
      storageBucket: "byteweb-13a12.appspot.com",
      messagingSenderId: "827941655623",
      appId: "1:827941655623:web:887b7a5220fd416eeccd62"
    };
    // —––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––

    // Initialize Firebase
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Variables globales
    window.currentUserId      = null;
    window.currentUsername    = "Usuario Anónimo";
    window.currentUserProfile = {};
    let activityTimer         = null;

    // Elementos DOM
    const authModalOverlay   = document.getElementById('auth-modal-overlay');
    const authModalTitle     = document.getElementById('auth-modal-title');
    const authForm           = document.getElementById('auth-form');
    const authEmailInput     = document.getElementById('auth-email');
    const authPasswordInput  = document.getElementById('auth-password');
    const authNameInput      = document.getElementById('auth-name');
    const authPhoneInput     = document.getElementById('auth-phone');
    const authRulesAccept    = document.getElementById('auth-rules-accept');
    const authSubmitButton   = document.getElementById('auth-submit-button');
    const authToggleText     = document.getElementById('auth-toggle-text');
    const authToggleButton   = document.getElementById('auth-toggle-button');
    const authMessage        = document.getElementById('auth-message');
    const videoBackground    = document.getElementById('video-background');
    const forumContentWrapper = document.getElementById('forum-content-wrapper');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const resendVerifEmailBtn = document.getElementById('resend-verification-email-button');
    const logoutButtonHeader = document.getElementById('logout-button-header');

    // Header Buttons
    const settingsButton        = document.getElementById('settings-button');
    const notificationsButton   = document.getElementById('notifications-button');
    const rulesButton           = document.getElementById('rules-button');
    const notificationBadge     = document.getElementById('notification-badge');
    const adminChatViewButton   = document.getElementById('admin-chat-view-button');

    // Modal “Ajustes”
    const settingsModal           = document.getElementById('settings-modal');
    const closeSettingsModalBtn   = document.getElementById('close-settings-modal');
    const customizeProfileLink    = document.getElementById('customize-profile-link');
    const logoutButtonModal       = document.getElementById('logout-button-modal');

    // Modal “Perfil”
    const profileSettingsModal      = document.getElementById('profile-settings-modal');
    const closeProfileSettingsBtn   = document.getElementById('close-profile-settings-modal');
    const profileSettingsForm       = document.getElementById('profile-settings-form');
    const profileNameInput          = document.getElementById('profile-name');
    const profileEmailInput         = document.getElementById('profile-email');
    const profilePhoneInput         = document.getElementById('profile-phone');
    const profilePhotoURLInput      = document.getElementById('profile-photo-url');
    const profilePhotoPreview       = document.getElementById('profile-photo-preview');
    const profileDOBInput           = document.getElementById('profile-dob');
    const profileNoteInput          = document.getElementById('profile-note-input');
    const profileColorInput         = document.getElementById('profile-color-input');
    const profileMessage            = document.getElementById('profile-message');

    // Modal “Reglas”
    const rulesModal             = document.getElementById('rules-modal');
    const closeRulesModalButton  = document.getElementById('close-rules-modal');

    // “Usuarios en línea”
    const onlineUsersContainer   = document.getElementById('online-users-container');

    // Modal “Ver Perfil de Usuario”
    const viewUserProfileModal           = document.getElementById('view-user-profile-modal');
    const closeViewUserProfileModalBtn   = document.getElementById('close-view-user-profile-modal');
    const viewUserProfileModalContent    = document.getElementById('view-user-profile-modal-content');
    const viewUserProfilePhoto           = document.getElementById('view-user-profile-photo');
    const viewUserProfileName            = document.getElementById('view-user-profile-name');
    const viewUserProfileNote            = document.getElementById('view-user-profile-note');
    const banUserButton                  = document.getElementById('ban-user-button');

    // Modal “Chat Privado”
    const privateChatModal                 = document.getElementById('private-chat-modal');
    const closePrivateChatModalBtn         = document.getElementById('close-private-chat-modal');
    const privateChatHeaderName            = document.getElementById('private-chat-header-name');
    const privateChatMessagesContainer     = document.getElementById('private-chat-messages-container');
    const privateChatInput                 = document.getElementById('private-chat-input');
    const sendPrivateChatButton            = document.getElementById('send-private-chat-button');
    let currentPrivateChatTargetId         = null;
    let currentPrivateChatId               = null;

    // Modal “Notificaciones”
    const notificationsModal              = document.getElementById('notifications-modal');
    const closeNotificationsModalButton   = document.getElementById('close-notifications-modal');
    const notificationsListContainer      = document.getElementById('notifications-list-container');

    // Modal “Vista Admin - Todos los Chats”
    const adminChatViewModal               = document.getElementById('admin-chat-view-modal');
    const closeAdminChatViewModalBtn       = document.getElementById('close-admin-chat-view-modal');
    const adminChatListContainer           = document.getElementById('admin-chat-list-container');

    // Estado del modo auth (login vs register)
    let isRegisterMode = false;

    // Límites para cambios de perfil
    const NAME_CHANGE_LIMIT_MS  = 25 * 24 * 60 * 60 * 1000; // 25 días
    const EMAIL_CHANGE_LIMIT_MS = 25 * 24 * 60 * 60 * 1000; // 25 días
    const PHONE_CHANGE_LIMIT_MS = 30 * 24 * 60 * 60 * 1000; // 30 días
    const ONLINE_THRESHOLD_MS   = 5 * 60 * 1000;            // 5 minutos

    // Mostrar mensaje de autenticación
    function showAuthMessage(message, isError = true) {
      authMessage.textContent = message;
      authMessage.classList.remove('hidden');
      if (isError) {
        authMessage.classList.add('text-red-400');
        authMessage.classList.remove('text-green-400');
      } else {
        authMessage.classList.add('text-green-400');
        authMessage.classList.remove('text-red-400');
      }
    }

    // Mostrar mensaje en perfil (guardado de cambios)
    function showProfileMessage(message, isError = true) {
      profileMessage.textContent = message;
      profileMessage.classList.remove('hidden');
      if (isError) {
        profileMessage.classList.add('text-red-400');
        profileMessage.classList.remove('text-green-400');
      } else {
        profileMessage.classList.add('text-green-400');
        profileMessage.classList.remove('text-red-400');
      }
    }

    // Alternar entre login y register
    function toggleAuthMode(toRegisterMode) {
      isRegisterMode = toRegisterMode;
      if (isRegisterMode) {
        authModalTitle.textContent = 'Registrarse';
        authSubmitButton.textContent = 'Registrarse';
        authToggleText.textContent = '¿Ya tienes una cuenta?';
        authToggleButton.textContent = 'Inicia Sesión';
        forgotPasswordLink.classList.add('hidden');
        resendVerifEmailBtn.classList.add('hidden');
        authNameInput.classList.remove('hidden');
        authPhoneInput.classList.remove('hidden');
        authRulesAccept.parentElement.classList.remove('hidden');
      } else {
        authModalTitle.textContent = 'Iniciar Sesión';
        authSubmitButton.textContent = 'Iniciar Sesión';
        authToggleText.textContent = '¿No tienes una cuenta?';
        authToggleButton.textContent = 'Regístrate';
        forgotPasswordLink.classList.remove('hidden');
        authNameInput.classList.add('hidden');
        authPhoneInput.classList.add('hidden');
        authRulesAccept.parentElement.classList.add('hidden');
      }
      authMessage.classList.add('hidden');
    }
    authToggleButton.addEventListener('click', () => toggleAuthMode(!isRegisterMode));

    // Procesar login/registro
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value;
      const name  = authNameInput.value.trim();
      const phone = authPhoneInput.value.trim();

      if (!email || !password) {
        showAuthMessage("Por favor, ingresa correo y contraseña.");
        return;
      }
      if (isRegisterMode) {
        if (!name) {
          showAuthMessage("Por favor, ingresa tu nombre.");
          return;
        }
        if (!authRulesAccept.checked) {
          showAuthMessage("Debes aceptar las reglas del foro para registrarte.");
          return;
        }
      }

      authMessage.classList.add('hidden');

      try {
        if (isRegisterMode) {
          // Crear usuario en Firebase Auth
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;

          // Crear perfil en Firestore
          await setDoc(doc(db, "users", user.uid), {
            name                     : name,
            email                    : email,
            phone                    : phone || "",
            photo_url                : "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
            created_at               : new Date().toISOString(),
            last_name_change_timestamp  : new Date().toISOString(),
            last_email_change_timestamp : new Date().toISOString(),
            last_phone_change_timestamp : new Date().toISOString(),
            date_of_birth            : "",
            note                     : "",
            profile_color            : "#00FFFF",
            last_activity            : new Date().toISOString(),
            is_admin                 : false,  // Por defecto usuario normal
            is_banned                : false   // No baneado
          });

          // Enviar correo de verificación
          await sendEmailVerification(user);

          showAuthMessage(
            "Registro exitoso. Revisa tu correo para verificarlo (sino, presiona Reenviar).",
            false
          );
          toggleAuthMode(false);
          authEmailInput.value = email;
          authPasswordInput.value = "";
        } else {
          // Verificar que no esté baneado
          const userQuery = query(collection(db, "users"), where("email", "==", email));
          const querySnapshot = await getDocs(userQuery);
          let isBanned = false;
          querySnapshot.forEach((docSnap) => {
            if (docSnap.exists() && docSnap.data().is_banned) {
              isBanned = true;
            }
          });
          if (isBanned) {
            showAuthMessage("Tu cuenta ha sido baneada. Contacta a un administrador.", true);
            return;
          }

          await signInWithEmailAndPassword(auth, email, password);
          // El resto se maneja en onAuthStateChanged
        }
      } catch (error) {
        console.error("Authentication error:", error);
        let errorMessage = "Ocurrió un error, intenta de nuevo.";
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = "Correo ya en uso. Intenta iniciar sesión o usa otro correo.";
            toggleAuthMode(false);
            authEmailInput.value = email;
            authPasswordInput.value = "";
            break;
          case 'auth/invalid-email':
          case 'auth/user-not-found':
          case 'auth/wrong-password':
            errorMessage = "Correo o contraseña incorrectos.";
            break;
          case 'auth/weak-password':
            errorMessage = "Contraseña muy débil (mínimo 6 caracteres).";
            break;
          case 'auth/network-request-failed':
            errorMessage = "Error de red. Verifica tu conexión.";
            break;
          case 'auth/too-many-requests':
            errorMessage = "Demasiados intentos fallidos. Intenta más tarde.";
            break;
        }
        showAuthMessage(errorMessage);
      }
    });

    // “Olvidé mi contraseña”
    forgotPasswordLink.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = authEmailInput.value.trim();
      if (!email) {
        showAuthMessage("Ingresa tu correo para restablecer la contraseña.");
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        showAuthMessage("Se envió enlace para restablecer contraseña.", false);
      } catch (error) {
        console.error("Password reset error:", error);
        let errorMessage = "Error al enviar enlace. Verifica tu correo.";
        if (error.code === 'auth/user-not-found') {
          errorMessage = "No existe usuario con ese correo.";
        }
        showAuthMessage(errorMessage);
      }
    });

    // “Reenviar correl de verificación”
    resendVerifEmailBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        showAuthMessage("Debes iniciar sesión para reenviar verificación.", true);
        return;
      }
      try {
        await sendEmailVerification(user);
        showAuthMessage("Se envió enlace de verificación. Revisa tu email.", false);
      } catch (error) {
        console.error("Error reenviar verificación:", error);
        showAuthMessage("Error al reenviar verificación, intenta más tarde.", true);
      }
    });

    // Actualizar “última actividad” cada 30 s
    async function updateUserActivity() {
      if (!window.currentUserId) return;
      try {
        await updateDoc(doc(db, "users", window.currentUserId), {
          last_activity: new Date().toISOString()
        });
      } catch (error) {
        console.error("Error updating user activity:", error);
      }
    }

    // Cerrar sesión global
    window.logout = async () => {
      try {
        if (activityTimer) clearInterval(activityTimer);
        await signOut(auth);
      } catch (error) {
        console.error("Error al cerrar sesión:", error);
        alert("Error al cerrar sesión, intenta de nuevo.");
      }
    };

    // Escuchar cambios en Auth
    onAuthStateChanged(auth, async (user) => {
      console.log("Auth State Changed:", user);
      if (user) {
        window.currentUserId = user.uid;

        // Leer perfil de Firestore
        try {
          const userDocRef  = doc(db, "users", user.uid);
          const userDocSnap = await getDoc(userDocRef);
          if (userDocSnap.exists()) {
            window.currentUserProfile = userDocSnap.data();
            // Use “name” de Firestore para el username
            if (window.currentUserProfile.name) {
              window.currentUsername = window.currentUserProfile.name;
            } else {
              window.currentUsername = user.email.split('@')[0];
            }
          } else {
            // Si no existe, creamos perfil básico
            window.currentUserProfile = {
              name      : user.email.split('@')[0],
              email     : user.email,
              phone     : "",
              photo_url : "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
              created_at: new Date().toISOString(),
              last_name_change_timestamp  : new Date().toISOString(),
              last_email_change_timestamp : new Date().toISOString(),
              last_phone_change_timestamp : new Date().toISOString(),
              date_of_birth: "",
              note      : "",
              profile_color: "#00FFFF",
              last_activity : new Date().toISOString(),
              is_admin  : false,
              is_banned : false
            };
            await setDoc(userDocRef, window.currentUserProfile);
          }
        } catch (error) {
          console.error("Error leyendo perfil user:", error);
        }

        // Hardcodeo UID admin: HGFWwRyaG6dkBukA1qefQyn6XfE3
        if (user.uid === "HGFWwRyaG6dkBukA1qefQyn6XfE3") {
          window.currentUserProfile.is_admin = true;
        }

        // Si está baneado, forzamos logout
        if (window.currentUserProfile.is_banned) {
          await signOut(auth);
          authModalOverlay.classList.remove('hidden');
          videoBackground.classList.remove('hidden');
          forumContentWrapper.classList.add('hidden');
          showAuthMessage("Has sido baneado. Contacta a un admin.", true);
          if (activityTimer) clearInterval(activityTimer);
          return;
        }

        // Verificar si el email está confirmado
        if (user.emailVerified) {
          // Ocultar modal de auth, mostrar foro
          authModalOverlay.classList.add('hidden');
          videoBackground.classList.add('hidden');
          forumContentWrapper.classList.remove('hidden');
          resendVerifEmailBtn.classList.add('hidden');
          loadPosts();          // Cargar publicaciones
          loadOnlineUsers();    // Cargar usuarios en línea
          loadNotifications();  // Cargar notificaciones propias

          // Mostrar botones de header
          settingsButton.classList.remove('hidden');
          notificationsButton.classList.remove('hidden');
          logoutButtonHeader.classList.remove('hidden');
          if (window.currentUserProfile.is_admin) {
            adminChatViewButton.classList.remove('hidden');
          } else {
            adminChatViewButton.classList.add('hidden');
          }

          // Iniciar timer para actualizar actividad
          if (activityTimer) clearInterval(activityTimer);
          activityTimer = setInterval(updateUserActivity, 30000);
          updateUserActivity();
        } else {
          // No verificado => mostrar mensaje
          authModalOverlay.classList.remove('hidden');
          videoBackground.classList.remove('hidden');
          forumContentWrapper.classList.add('hidden');
          showAuthMessage("Por favor, verifica tu correo para ingresar.", false);
          resendVerifEmailBtn.classList.remove('hidden');
          settingsButton.classList.add('hidden');
          notificationsButton.classList.add('hidden');
          logoutButtonHeader.classList.add('hidden');
          if (activityTimer) clearInterval(activityTimer);
        }
      } else {
        // Usuario no autenticado
        window.currentUserId      = null;
        window.currentUsername    = "Usuario Anónimo";
        window.currentUserProfile = {};
        authModalOverlay.classList.remove('hidden');
        videoBackground.classList.remove('hidden');
        forumContentWrapper.classList.add('hidden');
        document.getElementById('posts-container').innerHTML =
          '<p class="text-center text-gray-400">Inicia sesión para ver las publicaciones.</p>';
        onlineUsersContainer.innerHTML = '<p class="text-center text-gray-400">Inicia sesión para ver usuarios.</p>';
        notificationBadge.classList.add('hidden');
        settingsButton.classList.add('hidden');
        notificationsButton.classList.add('hidden');
        adminChatViewButton.classList.add('hidden');
        resendVerifEmailBtn.classList.add('hidden');
        logoutButtonHeader.classList.add('hidden');
        if (activityTimer) clearInterval(activityTimer);
      }
    });

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // FUNCIONES PRINCIPALES DEL FORO:
    // – Cargar Publicaciones en tiempo real
    window.loadPosts = () => {
      const postsContainer = document.getElementById('posts-container');
      const postsColRef = collection(db, "posts");
      const postsQuery = query(postsColRef, orderBy("createdAt", "desc"));

      onSnapshot(postsQuery, (snapshot) => {
        postsContainer.innerHTML = "";
        if (snapshot.empty) {
          postsContainer.innerHTML = '<p class="text-center text-gray-400">No hay publicaciones aún. ¡Sé el primero!</p>';
          return;
        }
        snapshot.forEach(async (docSnap) => {
          const post = docSnap.data();
          const postId = docSnap.id;
          const userDisplayName = post.username || `Usuario_${post.userId.substring(0,6)}`;
          const userPhoto = post.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
          const imageUrl = post.imageUrl || "";
          const videoUrl = post.videoUrl || "";

          // Verificar si el autor es admin
          let isAuthorAdmin = false;
          try {
            const userProfileSnap = await getDoc(doc(db, "users", post.userId));
            if (userProfileSnap.exists()) {
              isAuthorAdmin = userProfileSnap.data().is_admin || (post.userId === "HGFWwRyaG6dkBukA1qefQyn6XfE3");
            }
          } catch (e) {
            console.error("Error fetching author profile:", e);
          }
          const usernameClass = isAuthorAdmin ? 'text-red-500' : 'text-byte-text-light';
          const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full">ADMIN</span>' : "";

          let mediaContent = "";
          if (imageUrl) {
            mediaContent = `<img src="${imageUrl}" alt="Imagen" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/F9FAFB?text=Imagen+no+disponible';" />`;
          } else if (videoUrl) {
            mediaContent = `<video controls class="w-full h-auto rounded-lg mb-4 max-h-96 object-cover"><source src="${videoUrl}" type="video/mp4" />Tu navegador no soporta video.</video>`;
          }

          // Construir tarjeta de publicación
          const postElement = document.createElement('div');
          postElement.className = 'bg-byte-secondary-dark p-6 rounded-lg shadow-xl mb-6 border border-byte-accent-cyan/30';
          postElement.innerHTML = `
            <div class="flex items-center mb-4">
              <img src="${userPhoto}" alt="Foto" class="w-10 h-10 rounded-full mr-3 border border-byte-accent-cyan" />
              <div>
                <p class="font-bold ${usernameClass}">${userDisplayName} ${adminTag}</p>
                <p class="text-xs text-gray-500">${new Date(post.createdAt).toLocaleString()}</p>
              </div>
              ${
                (window.currentUserProfile.is_admin || post.userId === window.currentUserId)
                ? `<button class="text-red-500 hover:text-red-700 ml-auto delete-post-button" data-post-id="${postId}" >
                     <i class="fas fa-trash"></i> Eliminar
                   </button>`
                : ""
              }
            </div>
            ${mediaContent}
            <p class="text-byte-text-light mb-4">${post.content}</p>
            <div class="flex items-center justify-between text-gray-400 text-sm">
              <div class="flex items-center space-x-4">
                <button class="flex items-center hover:text-byte-accent-cyan transition duration-200 like-button ${ post.likes?.includes(window.currentUserId) ? 'text-byte-accent-cyan' : '' }"
                        data-post-id="${postId}" data-type="like">
                  <i class="far fa-thumbs-up mr-1"></i>
                  <span>${post.likes?.length || 0}</span>
                </button>
                <button class="flex items-center hover:text-red-400 transition duration-200 dislike-button ${ post.dislikes?.includes(window.currentUserId) ? 'text-red-400' : '' }"
                        data-post-id="${postId}" data-type="dislike">
                  <i class="far fa-thumbs-down mr-1"></i>
                  <span>${post.dislikes?.length || 0}</span>
                </button>
                <button class="flex items-center hover:text-byte-accent-cyan transition duration-200 comment-button" data-post-id="${postId}">
                  <i class="far fa-comment mr-1"></i>
                  <span>${post.commentsCount || 0}</span>
                </button>
              </div>
            </div>
          `;
          postsContainer.appendChild(postElement);
        });

        // Después de renderizar, agregamos listeners a los botones
        document.querySelectorAll('.like-button').forEach(button => {
          button.onclick = (e) => {
            e.stopPropagation();
            toggleReaction(button.dataset.postId, 'like');
          };
        });
        document.querySelectorAll('.dislike-button').forEach(button => {
          button.onclick = (e) => {
            e.stopPropagation();
            toggleReaction(button.dataset.postId, 'dislike');
          };
        });
        document.querySelectorAll('.comment-button').forEach(button => {
          button.onclick = (e) => {
            e.stopPropagation();
            openPostModal(button.dataset.postId);
          };
        });
        document.querySelectorAll('.delete-post-button').forEach(button => {
          button.onclick = (e) => {
            e.stopPropagation();
            deletePost(button.dataset.postId);
          };
        });
      });
    };

    // Crear nueva publicación
    window.createPost = async (content, imageUrl, videoUrl) => {
      if (!db || !window.currentUserId) return;
      if (!content.trim() && !imageUrl.trim() && !videoUrl.trim()) {
        alert("Debes escribir algo o incluir URL de imagen/video.");
        return;
      }
      try {
        await addDoc(collection(db, "posts"), {
          userId      : window.currentUserId,
          username    : window.currentUsername,
          userPhotoURL: window.currentUserProfile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
          content     : content.trim(),
          imageUrl    : imageUrl.trim(),
          videoUrl    : videoUrl.trim(),
          createdAt   : new Date().toISOString(),
          likes       : [],
          dislikes    : [],
          commentsCount: 0
        });
        console.log("Publicación creada.");
      }
      catch (error) {
        console.error("Error al crear publicación:", error);
      }
    };

    // Eliminar publicación (Admin o propio autor)
    async function deletePost(postId) {
      if (!db || !window.currentUserId || !window.currentUserProfile) return;
      if (!confirm("¿Eliminar esta publicación y todos sus comentarios?")) return;
      try {
        // Primero, eliminar comentarios
        const commentsQuery = query(collection(db, "posts", postId, "comments"));
        const commentsSnapshot = await getDocs(commentsQuery);
        const deletePromises = [];
        commentsSnapshot.forEach((cDoc) => {
          deletePromises.push(deleteDoc(doc(db, "posts", postId, "comments", cDoc.id)));
        });
        await Promise.all(deletePromises);

        // Luego, eliminar la publicación
        await deleteDoc(doc(db, "posts", postId));
        console.log("Publicación y comentarios eliminados.");
      } catch (error) {
        console.error("Error eliminando publicación:", error);
      }
    }

    // Toggle “like” / “dislike”
    window.toggleReaction = async (postId, type) => {
      if (!db || !window.currentUserId) return;
      try {
        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);
        if (!postSnap.exists()) return;
        const postData = postSnap.data();
        let updatedLikes    = Array.isArray(postData.likes)    ? [...postData.likes]    : [];
        let updatedDislikes = Array.isArray(postData.dislikes) ? [...postData.dislikes] : [];

        if (type === 'like') {
          if (updatedLikes.includes(window.currentUserId)) {
            updatedLikes = updatedLikes.filter(id => id !== window.currentUserId);
          } else {
            updatedLikes.push(window.currentUserId);
            updatedDislikes = updatedDislikes.filter(id => id !== window.currentUserId);
          }
        } else {
          if (updatedDislikes.includes(window.currentUserId)) {
            updatedDislikes = updatedDislikes.filter(id => id !== window.currentUserId);
          } else {
            updatedDislikes.push(window.currentUserId);
            updatedLikes = updatedLikes.filter(id => id !== window.currentUserId);
          }
        }

        await updateDoc(postRef, {
          likes   : updatedLikes,
          dislikes: updatedDislikes
        });
      } catch (error) {
        console.error("Error toggling reaction:", error);
      }
    };

    // Abrir modal para ver publicación y comentarios
    window.openPostModal = async (postId) => {
      if (!db) return;
      const postRef = doc(db, "posts", postId);
      const postSnap = await getDoc(postRef);
      if (!postSnap.exists()) {
        alert("Publicación no encontrada.");
        return;
      }
      const post = postSnap.data();
      const userDisplayName = post.username || `Usuario_${post.userId.substring(0,6)}`;
      const userPhoto = post.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
      const imageUrl = post.imageUrl || "";
      const videoUrl = post.videoUrl || "";

      // Verificar autor admin
      let isAuthorAdmin = false;
      try {
        const userProfileSnap = await getDoc(doc(db, "users", post.userId));
        if (userProfileSnap.exists()) {
          isAuthorAdmin = userProfileSnap.data().is_admin || (post.userId === "HGFWwRyaG6dkBukA1qefQyn6XfE3");
        }
      } catch (e) {
        console.error("Error fetch author profile:", e);
      }
      const usernameClass = isAuthorAdmin ? 'text-red-500' : 'text-byte-text-light';
      const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full">ADMIN</span>' : "";

      let mediaContent = "";
      if (imageUrl) {
        mediaContent = `<img src="${imageUrl}" alt="Imagen" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/F9FAFB?text=Imagen+no+disponible';" />`;
      } else if (videoUrl) {
        mediaContent = `<video controls class="w-full h-auto rounded-lg mb-4 max-h-96 object-cover"><source src="${videoUrl}" type="video/mp4"/>Tu navegador no soporta video.</video>`;
      }

      // Cargar contenido en modal
      const viewPostContent = document.getElementById('view-post-content');
      viewPostContent.innerHTML = `
        <div class="flex items-center mb-4">
          <img src="${userPhoto}" alt="Foto" class="w-10 h-10 rounded-full mr-3 border border-byte-accent-cyan" />
          <div>
            <p class="font-bold ${usernameClass}">${userDisplayName} ${adminTag}</p>
            <p class="text-xs text-gray-500">${new Date(post.createdAt).toLocaleString()}</p>
          </div>
        </div>
        ${mediaContent}
        <p class="text-byte-text-light mb-4">${post.content}</p>
        <div class="flex items-center space-x-4 text-gray-400 text-sm mb-4">
          <span class="flex items-center"><i class="fas fa-thumbs-up mr-1"></i> ${post.likes.length}</span>
          <span class="flex items-center"><i class="fas fa-thumbs-down mr-1"></i> ${post.dislikes.length}</span>
          <span class="flex items-center"><i class="fas fa-comment mr-1"></i> ${post.commentsCount}</span>
        </div>
      `;

      // Mostrar modal
      document.getElementById('view-post-modal').classList.remove('hidden');
      loadComments(postId);
    };

    // Cerrar modal de ver publicación
    document.getElementById('close-view-post-modal').addEventListener('click', () => {
      document.getElementById('view-post-modal').classList.add('hidden');
      document.getElementById('comments-container').innerHTML = "";
    });
    document.getElementById('view-post-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('view-post-modal')) {
        document.getElementById('view-post-modal').classList.add('hidden');
        document.getElementById('comments-container').innerHTML = "";
      }
    });

    // Cargar comentarios en tiempo real
    function loadComments(postId) {
      const commentsContainer = document.getElementById('comments-container');
      const commentsColRef = collection(db, "posts", postId, "comments");
      const commentsQuery = query(commentsColRef, orderBy("createdAt", "asc"));
      onSnapshot(commentsQuery, (snapshot) => {
        commentsContainer.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const c = docSnap.data();
          const commentId = docSnap.id;
          let commenterInfo = c.username;
          if (c.is_admin) commenterInfo += " (ADMIN)";
          const div = document.createElement('div');
          div.className = 'bg-byte-dark-bg p-2 rounded flex justify-between fade-in';
          let deleteBtnHTML = "";
          if (window.currentUserProfile.is_admin || c.userId === window.currentUserId) {
            deleteBtnHTML = `<button data-post-id="${postId}" data-comment-id="${commentId}" class="delete-comment-btn text-red-500 text-xs ml-2">Borrar</button>`;
          }
          div.innerHTML = `
            <div>
              <span class="font-bold text-byte-accent-cyan">${commenterInfo}:</span>
              <span class="ml-2 text-white">${c.content}</span>
              <span class="text-gray-400 text-xs ml-2">(${ new Date(c.createdAt).toLocaleTimeString() })</span>
            </div>
            ${deleteBtnHTML}
          `;
          commentsContainer.appendChild(div);

          // Agregar listener a “Borrar comentario”
          if (deleteBtnHTML) {
            div.querySelector('.delete-comment-btn').onclick = async (e) => {
              e.stopPropagation();
              if (!confirm("¿Eliminar este comentario?")) return;
              const pid = e.target.dataset.postId;
              const cid = e.target.dataset.commentId;
              try {
                await deleteDoc(doc(db, "posts", pid, "comments", cid));
                // Decrementar contador en la publicación
                const postRef = doc(db, "posts", pid);
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                  const currCount = postSnap.data().commentsCount || 1;
                  await updateDoc(postRef, { commentsCount: Math.max(0, currCount - 1) });
                }
              } catch (error) {
                console.error("Error eliminando comentario:", error);
              }
            };
          }
        });
      });
    }

    // Botón para agregar comentario
    document.getElementById('add-comment-button').addEventListener('click', async () => {
      const input = document.getElementById('comment-input');
      const content = input.value.trim();
      const pid = currentViewedPostId;
      if (!content || !pid) return;
      try {
        const commentRef = await addDoc(collection(db, "posts", pid, "comments"), {
          userId      : window.currentUserId,
          username    : window.currentUsername,
          userPhotoURL: window.currentUserProfile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
          content     : content,
          createdAt   : new Date().toISOString()
        });
        // Incrementar commentsCount en el post
        const postRef = doc(db, "posts", pid);
        const postSnap = await getDoc(postRef);
        if (postSnap.exists()) {
          const currCount = postSnap.data().commentsCount || 0;
          await updateDoc(postRef, { commentsCount: currCount + 1 });
        }

        // Menciones con notificaciones
        const mentionRegex = /@([a-zA-Z0-9_.-]+)/g;
        let match;
        const mentionedUsernames = new Set();
        while ((match = mentionRegex.exec(content)) !== null) {
          mentionedUsernames.add(match[1]);
        }
        for (const mUsername of mentionedUsernames) {
          const usersQuery = query(collection(db, "users"), where("name", "==", mUsername));
          const usersSnapshot = await getDocs(usersQuery);
          if (!usersSnapshot.empty) {
            usersSnapshot.forEach(async (userDoc) => {
              const mentionedUserId = userDoc.id;
              if (mentionedUserId !== window.currentUserId) {
                await addDoc(collection(db, "users", mentionedUserId, "notifications"), {
                  recipientId: mentionedUserId,
                  type       : 'mention',
                  senderId   : window.currentUserId,
                  senderName : window.currentUsername,
                  postId     : pid,
                  commentId  : commentRef.id,
                  content    : content,
                  read       : false,
                  createdAt  : new Date().toISOString()
                });
              }
            });
          }
        }

        input.value = "";
      } catch (error) {
        console.error("Error agregando comentario:", error);
      }
    });

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // Cargar “Usuarios en Línea” (solo consulta users con last_activity reciente)
    function loadOnlineUsers() {
      const nowMs = Date.now();
      const thresholdTime = new Date(nowMs - ONLINE_THRESHOLD_MS).toISOString();
      const usersColRef = collection(db, "users");
      // Solo usuarios con last_activity posterior a thresholdTime
      const q = query(usersColRef, where("last_activity", ">=", thresholdTime), orderBy("last_activity", "desc"));
      onSnapshot(q, (snapshot) => {
        onlineUsersContainer.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.is_banned) return; // Omitir baneados
          const li = document.createElement('div');
          li.className = 'flex items-center justify-between bg-byte-dark-bg p-2 rounded-md';
          const nameSpan = document.createElement('span');
          nameSpan.textContent = data.name + (data.is_admin ? " (ADMIN)" : "");
          nameSpan.className = data.is_admin ? 'text-red-500 font-bold cursor-pointer view-profile-btn' : 'text-byte-text-light cursor-pointer view-profile-btn';
          nameSpan.dataset.uid = docSnap.id;
          nameSpan.onclick = () => viewProfile(docSnap.id);
          li.appendChild(nameSpan);

          const chatBtn = document.createElement('button');
          chatBtn.textContent = 'Chat';
          chatBtn.className = 'bg-byte-accent-cyan text-black px-2 py-1 rounded text-sm hover:bg-cyan-400 transition';
          chatBtn.onclick = () => sendChatRequest(docSnap.id);
          li.appendChild(chatBtn);

          if (window.currentUserProfile.is_admin) {
            const banBtn = document.createElement('button');
            banBtn.textContent = data.is_banned ? 'Desbanear' : 'Banear';
            banBtn.className = data.is_banned
              ? 'bg-green-500 text-white px-2 py-1 rounded text-sm hover:bg-green-600 transition'
              : 'bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600 transition';
            banBtn.onclick = () => toggleBanUser(docSnap.id, data.is_banned);
            li.appendChild(banBtn);
          }

          onlineUsersContainer.appendChild(li);
        });
      });
    }

    // Ver perfil de otro usuario (modal)
    async function viewProfile(userId) {
      try {
        const userDocSnap = await getDoc(doc(db, "users", userId));
        if (!userDocSnap.exists()) {
          alert("Usuario no encontrado.");
          return;
        }
        const data = userDocSnap.data();
        document.getElementById('view-user-profile-photo').src = data.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
        document.getElementById('view-user-profile-name').textContent = data.name + (data.is_admin ? " (ADMIN)" : "");
        document.getElementById('view-user-profile-note').textContent = data.note || "";
        if (window.currentUserProfile.is_admin && userId !== window.currentUserId) {
          banUserButton.classList.remove('hidden');
          banUserButton.textContent = data.is_banned ? "Desbanear Usuario" : "Banear Usuario";
          banUserButton.onclick = () => toggleBanUser(userId, data.is_banned);
        } else {
          banUserButton.classList.add('hidden');
        }
        viewUserProfileModal.classList.remove('hidden');
      } catch (error) {
        console.error("Error al ver perfil:", error);
      }
    }
    closeViewUserProfileModalBtn.addEventListener('click', () => viewUserProfileModal.classList.add('hidden'));
    viewUserProfileModal.addEventListener('click', (e) => {
      if (e.target === viewUserProfileModal) {
        viewUserProfileModal.classList.add('hidden');
      }
    });

    // Función para banear/desbanear
    async function toggleBanUser(userId, currentlyBanned) {
      if (!window.currentUserProfile.is_admin) return;
      try {
        await updateDoc(doc(db, "users", userId), { is_banned: !currentlyBanned });
        viewUserProfileModal.classList.add('hidden');
      } catch (error) {
        console.error("Error cambiando estado de baneo:", error);
      }
    }

    // Solicitar chat privado
    async function sendChatRequest(recipientId) {
      if (!window.currentUserId) {
        alert("Debes iniciar sesión para chatear.");
        return;
      }
      // Crear o actualizar documento en “private_chats” si no existe
      const chatId = [window.currentUserId, recipientId].sort().join("_");
      try {
        const chatRef = doc(db, "private_chats", chatId);
        const chatSnap = await getDoc(chatRef);
        if (!chatSnap.exists()) {
          await setDoc(chatRef, {
            participants: [window.currentUserId, recipientId],
            createdAt: new Date().toISOString()
          });
        }
        openPrivateChat(recipientId, chatId);
      } catch (error) {
        console.error("Error creando chat:", error);
      }
    }

    // Abrir chat privado y cargar mensajes
    function openPrivateChat(partnerId, chatId) {
      currentPrivateChatTargetId = partnerId;
      currentPrivateChatId = chatId;
      // Limpiar contenedor de mensajes
      privateChatMessagesContainer.innerHTML = "";
      // Mostrar encabezado
      privateChatHeaderName.textContent = "Chat con " + partnerId.substring(0,6);
      privateChatModal.classList.remove('hidden');

      // Escuchar mensajes en “private_chats/{chatId}/messages”
      const messagesColRef = collection(db, "private_chats", chatId, "messages");
      const messagesQuery   = query(messagesColRef, orderBy("createdAt", "asc"));
      onSnapshot(messagesQuery, (snapshot) => {
        privateChatMessagesContainer.innerHTML = "";
        snapshot.forEach((msgDoc) => {
          const msg = msgDoc.data();
          const div = document.createElement('div');
          div.className = msg.senderId === window.currentUserId
            ? 'text-right'
            : 'text-left';
          div.innerHTML = `
            <span class="inline-block px-3 py-1 rounded ${ msg.senderId === window.currentUserId
              ? 'bg-byte-accent-cyan text-black'
              : 'bg-byte-secondary-dark text-white'}">
              ${msg.content}
            </span>
          `;
          privateChatMessagesContainer.appendChild(div);
        });
        privateChatMessagesContainer.scrollTop = privateChatMessagesContainer.scrollHeight;
      });
    }

    // Enviar mensaje privado
    sendPrivateChatButton.onclick = async () => {
      const content = privateChatInput.value.trim();
      if (!content || !currentPrivateChatId) return;
      try {
        await addDoc(collection(db, "private_chats", currentPrivateChatId, "messages"), {
          senderId  : window.currentUserId,
          receiverId: currentPrivateChatTargetId,
          content   : content,
          createdAt : new Date().toISOString()
        });
        privateChatInput.value = "";
      } catch (error) {
        console.error("Error enviando mensaje privado:", error);
      }
    };

    // Cerrar modal chat privado
    closePrivateChatModalBtn.addEventListener('click', () => privateChatModal.classList.add('hidden'));
    privateChatModal.addEventListener('click', (e) => {
      if (e.target === privateChatModal) privateChatModal.classList.add('hidden');
    });

    // Cargar notificaciones propias
    function loadNotifications() {
      const notificationsColRef = collection(db, "users", window.currentUserId, "notifications");
      const notificationsQuery  = query(notificationsColRef, orderBy("createdAt", "desc"));
      onSnapshot(notificationsQuery, (snapshot) => {
        const listContainer = notificationsListContainer;
        listContainer.innerHTML = "";
        let unreadCount = 0;
        snapshot.forEach((docSnap) => {
          const n = docSnap.data();
          const li = document.createElement('div');
          li.className = 'bg-byte-dark-bg p-2 mb-1 rounded-md hover:bg-byte-secondary-dark cursor-default';
          li.textContent = n.content + " - " + new Date(n.createdAt).toLocaleString();
          listContainer.appendChild(li);
          if (!n.read) unreadCount++;
        });
        if (unreadCount > 0) {
          notificationBadge.textContent = unreadCount;
          notificationBadge.classList.remove('hidden');
        } else {
          notificationBadge.classList.add('hidden');
        }
      });
    }

    // Mostrar modal notificaciones
    notificationsButton.addEventListener('click', () => {
      notificationsModal.classList.toggle('hidden');
      // Marcar como leídas
      (async () => {
        const notifSnap = await getDocs(collection(db, "users", window.currentUserId, "notifications"));
        notifSnap.forEach(async (docSnap) => {
          const n = docSnap.data();
          if (!n.read) {
            await updateDoc(doc(db, "users", window.currentUserId, "notifications", docSnap.id), { read: true });
          }
        });
      })();
    });
    closeNotificationsModalButton.addEventListener('click', () => notificationsModal.classList.add('hidden'));

    // —––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // Cargar vista “Admin” de todos los chats privados
    adminChatViewButton.addEventListener('click', () => {
      if (!window.currentUserProfile.is_admin) return;
      adminChatViewModal.classList.remove('hidden');
      adminChatListContainer.innerHTML = "";

      // Listar todos los documentos en “private_chats”
      getDocs(collection(db, "private_chats")).then((snapshot) => {
        snapshot.forEach((docSnap) => {
          const chatId = docSnap.id;
          const participants = docSnap.data().participants || [];
          const li = document.createElement('div');
          li.className = 'bg-byte-dark-bg p-2 mb-1 rounded-md hover:bg-byte-secondary-dark cursor-pointer';
          li.textContent = "Chat: " + chatId;
          li.onclick = () => openPrivateChat(participants.find(id => id !== window.currentUserId), chatId);
          adminChatListContainer.appendChild(li);
        });
      }).catch(error => console.error("Error cargando chats admin:", error));
    });
    closeAdminChatViewModalBtn.addEventListener('click', () => adminChatViewModal.classList.add('hidden'));

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // Modal “Crear Publicación” (abrir/cerrar)
    const createPostModal      = document.getElementById('create-post-modal');
    const closeCreatePostModal = document.getElementById('close-create-post-modal');
    const createPostForm       = document.getElementById('create-post-form');
    const postContentInput     = document.getElementById('post-content-input');
    const postImageUrlInput    = document.getElementById('post-image-url-input');
    const postVideoUrlInput    = document.getElementById('post-video-url-input');
    const newTopicButton       = document.getElementById('new-topic-button');
    let currentViewedPostId    = null;

    newTopicButton.addEventListener('click', () => {
      if (!window.currentUserId) {
        alert("Debes iniciar sesión para crear una publicación.");
        return;
      }
      createPostModal.classList.remove('hidden');
      postContentInput.value = "";
      postImageUrlInput.value = "";
      postVideoUrlInput.value = "";
    });
    closeCreatePostModal.addEventListener('click', () => createPostModal.classList.add('hidden'));
    createPostModal.addEventListener('click', (e) => {
      if (e.target === createPostModal) createPostModal.classList.add('hidden');
    });

    createPostForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content  = postContentInput.value.trim();
      const imageUrl = postImageUrlInput.value.trim();
      const videoUrl = postVideoUrlInput.value.trim();
      await window.createPost(content, imageUrl, videoUrl);
      createPostModal.classList.add('hidden');
    });

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // Cerrar modal “Reglas”
    document.getElementById('close-rules-modal').addEventListener('click', () => rulesModal.classList.add('hidden'));
    rulesModal.addEventListener('click', (e) => {
      if (e.target === rulesModal) rulesModal.classList.add('hidden');
    });
    // Abrir modal “Reglas”
    document.getElementById('rules-button').addEventListener('click', () => rulesModal.classList.remove('hidden'));

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
    // “Ajustes” en Header
    settingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
    closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
    logoutButtonModal.addEventListener('click', () => logout());
    customizeProfileLink.addEventListener('click', (e) => {
      e.preventDefault();
      settingsModal.classList.add('hidden');
      profileSettingsModal.classList.remove('hidden');
    });
    // Cerrar modal “Perfil”
    closeProfileSettingsBtn.addEventListener('click', () => profileSettingsModal.classList.add('hidden'));
    profileSettingsModal.addEventListener('click', (e) => {
      if (e.target === profileSettingsModal) profileSettingsModal.classList.add('hidden');
    });

    // Mostrar vista previa de foto de perfil al cambiar URL
    profilePhotoURLInput.addEventListener('input', () => {
      const url = profilePhotoURLInput.value.trim();
      if (url) {
        profilePhotoPreview.src = url;
      } else {
        profilePhotoPreview.src = "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
      }
    });

    // Guardar cambios en perfil
    profileSettingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!window.currentUserId) return;
      const name  = profileNameInput.value.trim();
      const email = profileEmailInput.value.trim();
      const phone = profilePhoneInput.value.trim();
      const photo = profilePhotoURLInput.value.trim();
      const dob   = profileDOBInput.value;
      const note  = profileNoteInput.value.trim();
      const color = profileColorInput.value;
      if (!name || !email) {
        showProfileMessage("Nombre y correo son obligatorios.");
        return;
      }
      try {
        // Opcional: limitar cambios de nombre, email, tel. usando timestamps
        await updateDoc(doc(db, "users", window.currentUserId), {
          name       : name,
          email      : email,
          phone      : phone,
          photo_url  : photo,
          date_of_birth: dob,
          note       : note,
          profile_color: color
        });
        showProfileMessage("Perfil actualizado.", false);
      } catch (error) {
        console.error("Error actualizando perfil:", error);
        showProfileMessage("Error al guardar cambios.", true);
      }
    });

    // –––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
  </script>
</body>
</html>
