<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Byte - Foro (Todo en Uno)</title>
    <link rel="icon" type="image/x-icon" href="./images/logo.ico">
    <meta name="description" content="Aplicación de foro completa de Byte con autenticación, todo en una sola página para discusiones sobre SEO, marketing digital y visibilidad online.">
    <meta name="keywords" content="Byte, foro, discusión, temas, SEO, marketing digital, visibilidad online, comunidad, autenticación, registro, iniciar sesión">
    <meta property="og:title" content="Byte - Foro (Todo en Uno)">
    <meta property="og:description" content="Aplicación de foro completa de Byte con autenticación, todo en una sola página para discusiones sobre SEO, marketing digital y visibilidad online.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Custom Tailwind CSS Configuration - Must be loaded before other styles */
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Montserrat', 'sans-serif'],
                        navigation: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        'byte-dark-bg': '#0A0A1A',
                        'byte-accent-cyan': '#00FFFF',
                        'byte-light-bg': '#F8FAFC', /* Casi blanco */
                        'byte-text-dark': '#374151',
                        'byte-text-light': '#F9FAFB', /* Blanco para texto principal */
                        'byte-secondary-dark': '#1A202C', /* Fondo oscuro para elementos */
                        'whatsapp-green': '#25D366',
                        'whatsapp-dark-green': '#128C7E',
                        'red-error': '#EF4444', /* Rojo para mensajes de error */
                        'green-500': '#22C55E', /* Tailwind green-500 */
                        'red-500': '#EF4444',   /* Tailwind red-500 */
                        'gray-500': '#6B7280',  /* Tailwind gray-500 */
                        'blue-500': '#3B82F6', /* Tailwind blue-500 for likes */
                        'purple-600': '#9333ea', /* Nuevo color para el botón de reglas */
                        'purple-700': '#7e22ce', /* Hover de purple-600 */
                        'orange-600': '#f97316', /* Naranja para actualizar contraseña */
                        'orange-700': '#ea580c', /* Hover de orange-600 */
                    }
                }
            }
        };

        /* Box-Sizing universal para un modelo de caja consistente */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Estilos base para HTML y Body */
        html {
            height: 100%;
            width: 100%;
        }
        body {
            min-height: 100vh;
            width: 100%;
            overflow-x: hidden;
            background-color: #0A0A1A; /* Color de fondo base */
            font-family: 'Inter', sans-serif; /* Aplicando Inter como fuente principal */
            color: #F9FAFB;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }

        /* Estilos para el video de fondo (solo en la sección de autenticación) */
        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            min-width: 100vw; /* Usar 100vw y 100vh para cubrir toda la pantalla */
            min-height: 100vh;
            width: auto;
            height: auto;
            z-index: -1; /* Envía el video al fondo */
            background-size: cover;
            filter: brightness(0.4); /* Oscurece el video para que el contenido sea legible */
            object-fit: cover; /* Asegura que el video cubra el área sin distorsionarse */
        }

        /* Estilos para encabezados (h1-h6) */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif; /* Aplicando Montserrat para encabezados */
            color: #00FFFF;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }

        /* Estilo de contorno de texto */
        .text-stroke-cyan {
            -webkit-text-stroke: 1.5px #00FFFF;
            text-stroke: 1.5px #00FFFF;
            color: #FFFFFF;
            text-shadow: none;
        }

        /* Estilo de enlace deshabilitado */
        .disabled-link {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Estilos para deshabilitar la selección de texto y eventos de puntero en imágenes */
        img {
            pointer-events: none;
        }
        p, h1, h2, h3, h4, h5, h6, span, div:not(.map-container):not(.payment-card) {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        /* Estilos para el botón de "Volver arriba" */
        #scroll-to-top-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #00FFFF; /* Cian */
            color: #0A0A1A; /* Texto oscuro de Byte */
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, transform 0.2s ease;
            z-index: 9999;
        }

        #scroll-to-top-button.show {
            opacity: 1;
            visibility: visible;
        }

        #scroll-to-top-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 255, 255, 0.25);
        }

        /* Estilos para el encabezado */
        .main-header {
            background-color: #0A0A1A; /* Fondo oscuro */
            color: #F9FAFB; /* Texto claro */
            padding: 0.5rem 0; /* Relleno */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Sombra ligera */
            position: fixed; /* Fijo en la parte superior */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50; /* Asegura que esté por encima del contenido */
            transition: transform 0.3s ease-in-out; /* Animación para ocultar/mostrar */
        }

        .main-header.header-hidden {
            transform: translateY(-100%); /* Oculta el encabezado */
        }

        /* Estilos para la sección de autenticación */
        .auth-container {
            background: rgb(26, 32, 44); /* Fondo sólido byte-secondary-dark para mejor contraste */
            border-radius: 1.5rem; /* Bordes más redondeados */
            padding: 2rem;
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.3); /* Sombra más pronunciada y cian */
            border: 1px solid rgba(0, 255, 255, 0.4);
            max-width: 500px; /* Ancho máximo para el formulario */
            width: 90%;
            margin: auto; /* Centrar el contenedor */
            position: relative; /* Para z-index si es necesario */
            z-index: 10;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        .tab-button.active {
            border-color: #00FFFF; /* Cian */
            color: #00FFFF;
        }

        /* Estilos para las etiquetas de los formularios */
        .auth-container label {
            color: #00FFFF; /* Cian para las etiquetas para que sean más visibles */
        }

        /* ESTILO PARA INPUTS Y SELECTS: ASEGURAR FONDO Y TEXTO */
        .auth-container input[type="email"],
        .auth-container input[type="password"],
        .auth-container input[type="text"],
        .auth-container input[type="tel"],
        .auth-container input[type="number"],
        .auth-container input[type="url"],
        .auth-container select,
        /* Corregido: Input URL para imagen y video ahora usan este estilo */
        #post-image-url,
        #post-video-url,
        #post-title, /* Añadido para el título de la publicación */
        textarea,
        /* Nuevos campos de perfil */
        #profile-name,
        #profile-lastname,
        #profile-phone,
        #profile-dob,
        #profile-pic-url-input,
        #profile-current-email,
        #profile-new-email,
        #profile-current-password,
        #profile-current-password-change,
        #profile-new-password,
        #profile-confirm-new-password {
            background-color: #1A202C !important; /* Fuerza el fondo oscuro de Byte */
            color: #F9FAFB !important; /* Fuerza el color de texto claro de Byte */
            border: 1px solid #00FFFF !important; /* Fuerza el borde cian */
        }
        /* Fin de nuevo estilo */

        /* Estilos para la barra de seguridad de contraseña */
        #password-strength-bar, #new-password-strength-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
            margin-top: 0.5rem;
        }
        .strength-weak { background-color: #FF0000; width: 33%; }
        .strength-medium { background-color: #FFA500; width: 66%; }
        .strength-strong { background-color: #25D366; width: 100%; }

        /* Estilos para el mensaje de verificación */
        .verification-message {
            background: rgb(26, 32, 44);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.4);
            max-width: 500px;
            width: 90%;
            margin: auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Asegura que tenga un tamaño mínimo */
        }
        .verification-message .fa-check-circle {
            font-size: 4rem; /* Icono grande */
            color: #25D366; /* Verde */
            margin-bottom: 1rem;
        }

        /* Estilos específicos para la sección del foro */
        .forum-section {
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 4xl; /* Reducido para PC */
            margin-left: auto; /* Centrar */
            margin-right: auto; /* Centrar */
            padding-top: 80px; /* Ajustado para la altura del header fijo */
        }

        .forum-topic-card {
            background-color: #1A202C; /* byte-secondary-dark */
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 255, 255, 0.15);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            /* Añadido para un aspecto más moderno */
            background-image: linear-gradient(to bottom right, #1A202C, #0F131D); /* Degradado sutil */
            backdrop-filter: blur(5px); /* Efecto de desenfoque */
            -webkit-backdrop-filter: blur(5px); /* Compatibilidad con Safari */
        }

        .forum-topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 255, 255, 0.25), 0 0 20px rgba(0, 255, 255, 0.1); /* Sombra y brillo extra */
        }

        /* Estilos para la barra lateral de usuarios online */
        #online-users-sidebar {
            position: fixed; /* Fixed position */
            top: 4rem; /* Adjust this if the header changes height */
            right: 0;
            width: 16rem; /* Fixed width for the sidebar */
            z-index: 40; /* Ensure it's above main content, but below header */
            height: calc(100vh - 4rem - 4rem); /* Height: 100vh - header height - bottom space */
            overflow-y: auto; /* Allows scrolling if many users */
            padding: 1rem; /* Padding inside the sidebar */
            transition: transform 0.3s ease-out; /* Transition to show/hide */
            background-color: rgba(10, 10, 26, 0.95); /* Slightly more opaque dark background */
            background-image: linear-gradient(to bottom right, rgba(10, 10, 26, 0.95), rgba(26, 32, 44, 0.95)); /* Subtle gradient */
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px); /* Efecto de desenfoque */
            -webkit-backdrop-filter: blur(5px); /* Compatibilidad con Safari */
            display: none; /* Oculto por defecto en todas las pantallas */
        }

        #online-users-sidebar.show-sidebar {
            display: block; /* Muestra el sidebar cuando tiene la clase show-sidebar */
            transform: translateX(0%);
        }

        /* Nuevo estilo para botones principales */
        .main-action-button {
            background-color: #00FFFF; /* byte-accent-cyan */
            color: #0A0A1A; /* byte-dark-bg */
            font-weight: bold;
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: background-color 0.3s ease, transform 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping */
            background-image: linear-gradient(to right, #00FFFF, #00E5E5); /* Gradiente */
            border: 1px solid rgba(0, 255, 255, 0.5);
        }

        .main-action-button:hover {
            background-color: #00E5E5; /* Un cian ligeramente más oscuro al pasar el ratón */
            transform: scale(1.05) translateY(-2px); /* Pequeño levantamiento */
            box-shadow: 0 8px 15px rgba(0, 255, 255, 0.3);
        }

        /* Nuevo estilo para botones de cabecera con solo icono */
        .icon-action-button {
            background-color: #00FFFF; /* byte-accent-cyan */
            color: #0A0A1A; /* byte-dark-bg */
            font-weight: bold;
            padding: 0.75rem; /* Reduced padding for icon only */
            border-radius: 50%; /* Make it round */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: background-color 0.3s ease, transform 0.3s ease;
            display: flex; /* To center the icon */
            align-items: center;
            justify-content: center;
            width: 40px; /* Fixed size for circular button */
            height: 40px;
            background-image: linear-gradient(to right, #00FFFF, #00E5E5); /* Gradiente */
            border: 1px solid rgba(0, 255, 255, 0.5);
        }

        .icon-action-button:hover {
            background-color: #00E5E5; /* Un cian ligeramente más oscuro al pasar el ratón */
            transform: scale(1.1); /* Slightly more prominent scale for icons */
            box-shadow: 0 6px 10px rgba(0, 255, 255, 0.3);
        }

        /* Estilo para el botón de "Volver al inicio" con color amarillo */
        .back-to-home-button {
            background-color: #FFD700; /* Yellow-500 equivalent */
            color: #0A0A1A; /* Dark text */
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease;
            white-space: nowrap;
            background-image: linear-gradient(to right, #FFD700, #E6C200);
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .back-to-home-button:hover {
            background-color: #E6C200; /* Darker yellow on hover */
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 15px rgba(255, 215, 0, 0.3);
        }


        /* Nuevo estilo para botón de acción destructiva (Cerrar Sesión) */
        .destructive-action-button {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease;
            background-image: linear-gradient(to right, #EF4444, #DC2626);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .destructive-action-button:hover {
            background-color: #DC2626; /* Un rojo más oscuro */
            transform: scale(1.02) translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* Estilos para el botón de perfil/ajustes */
        .profile-button {
            background-color: transparent;
            border: none;
            padding: 0;
            cursor: pointer;
            position: relative;
            z-index: 60; /* Asegura que esté por encima del header */
        }

        .profile-button img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #00FFFF; /* Borde cian */
            transition: border-color 0.2s ease-in-out;
        }

        .profile-button:hover img {
            border-color: #F8FAFC; /* Borde claro al pasar el ratón */
        }

        .profile-button .dropdown-arrow {
            /* Eliminado: la flecha desplegable se elimina visualmente */
            display: none;
        }

        /* Estilos para el menú desplegable */
        .profile-dropdown-menu {
            position: absolute;
            top: calc(100% + 10px); /* Debajo del botón de perfil */
            right: 0;
            background-color: #1A202C; /* Fondo oscuro */
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 180px;
            z-index: 70; /* Por encima de todo */
            padding: 0.5rem 0;
            display: none; /* Oculto por defecto */
            backdrop-filter: blur(8px); /* Efecto de desenfoque */
            -webkit-backdrop-filter: blur(8px); /* Compatibilidad con Safari */
            background-image: linear-gradient(to bottom right, rgba(26, 32, 44, 0.95), rgba(10, 10, 26, 0.95)); /* Degradado */
        }

        .profile-dropdown-menu.show {
            display: block;
        }

        /* Estilos para botones directamente dentro del menú desplegable */
        .profile-dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            color: #F9FAFB;
            font-size: 0.9rem;
            background-color: transparent; /* Ensures background is transparent by default */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            border-radius: 0; /* Remove border-radius for full width within dropdown */
            box-shadow: none; /* Remove shadow */
        }

        .profile-dropdown-menu button:hover {
            background-color: rgba(0, 255, 255, 0.1); /* Cyan transparent hover */
            transform: none; /* No scale transform */
        }

        /* Specific override for the destructive action button within the dropdown */
        .profile-dropdown-menu .destructive-action-button {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
            margin: 0.5rem auto; /* Center it and add vertical margin */
            display: block; /* Make it a block element to take full width within its own context */
            width: calc(100% - 1rem); /* Full width minus combined horizontal margin */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .profile-dropdown-menu .destructive-action-button:hover {
            background-color: #DC2626; /* darker red on hover */
            transform: scale(1.02);
        }


        /* Ajustes específicos para móviles */
        @media (max-width: 767px) { /* Para pantallas menores a 'md' (768px) */
            .auth-container, .verification-message, .forum-section {
                padding: 1rem; /* Reducir padding en móviles */
                width: 95%; /* Usar más ancho de pantalla */
            }
            .main-header img {
                height: 40px; /* Tamaño del logo en móviles */
            }
            .main-header .back-to-home-button {
                padding: 0.4rem 0.6rem; /* Reducir padding del botón */
                font-size: 0.8rem; /* Reducir tamaño de fuente del botón */
            }
            .verification-message .fa-check-circle {
                font-size: 3rem;
            }
            /* La barra lateral se oculta por defecto y solo se muestra con el botón */
            #online-users-sidebar {
                transform: translateX(100%);
                display: none; /* Fuerza la ocultación inicial */
            }
            #online-users-sidebar.show-sidebar {
                 transform: translateX(0%);
                 display: block;
                 width: 100%; /* Ocupa todo el ancho en móvil */
                 right: 0;
                 left: 0;
                 top: 60px; /* Ajuste para el header más pequeño */
                 height: calc(100vh - 60px);
                 padding-bottom: 80px; /* Espacio para el footer */
            }
            /* En móvil, la sección de foro toma el ancho completo */
            .forum-section {
                flex-direction: column; /* Apilar columnas en móviles */
                width: 100%;
                max-width: none; /* Sin ancho máximo para móviles */
            }
            /* Las publicaciones en móvil ocupan todo el ancho */
            .lg\:w-3\/4 {
                width: 100%; /* Ocupar todo el ancho en móviles */
            }
            /* Ajuste para la nueva barra de acciones en móvil */
            .header-buttons-group {
                flex-direction: row; /* Mantener horizontal en móvil para evitar demasiado espacio vertical */
                justify-content: flex-end; /* Alinear a la derecha */
                gap: 0.5rem; /* Espaciado entre elementos apilados */
                width: 100%;
            }
            .header-buttons-group > div,
            .header-buttons-group > a,
            .header-buttons-group > button {
                margin-bottom: 0; /* Eliminar margen inferior si ya está en gap */
            }
            /* Ajustar el padding superior de main para móviles si la action-bar no es fixed */
            main {
                padding-top: 100px !important; /* Aproximadamente la altura del header en móvil con más botones */
            }
            .forum-topic-card {
                padding: 1rem; /* Menor padding en móvil */
            }
            .comments-section {
                padding: 1rem; /* Menor padding en móvil */
            }
        }
        /* Ajustes de botones en la cabecera para todas las resoluciones */
        .header-buttons-group {
            display: flex; /* Usar flexbox */
            gap: 1rem; /* Espaciado horizontal */
            align-items: center; /* Alinear verticalmente */
        }
        @media (min-width: 768px) { /* Para pantallas 'md' y superiores */
            .header-buttons-group {
                flex-direction: row; /* Horizontal en desktop */
            }
            #online-users-sidebar {
                display: none; /* Asegura que esté oculto en desktop también por defecto */
            }
        }

        /* Asegurar que el contenido principal tenga un padding superior adecuado para la cabecera fija */
        main {
            padding-top: 80px; /* Base, se ajusta en JS para móviles */
        }

        /* Estilos para comentarios anidados */
        .nested-comment {
            margin-left: 20px; /* Indentación para comentarios anidados */
            border-left: 2px solid rgba(0, 255, 255, 0.2); /* Línea de indentación */
            padding-left: 10px;
        }

        /* Estilo para el modal de administrador, perfil y reglas */
        .admin-modal, .profile-settings-modal, .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none; /* Oculto por defecto */
            overflow-y: auto; /* Permite scroll si el contenido es largo */
        }

        .admin-modal-content, .profile-settings-modal-content, .rules-modal-content {
            background-color: #1A202C;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            max-width: 600px;
            width: 90%;
            color: #F9FAFB;
            position: relative;
            max-height: 90vh; /* Altura máxima para el contenido del modal */
            overflow-y: auto; /* Scroll interno si el contenido supera la altura */
            backdrop-filter: blur(10px); /* Efecto de desenfoque */
            -webkit-backdrop-filter: blur(10px); /* Compatibilidad con Safari */
            background-image: linear-gradient(to bottom right, rgba(26, 32, 44, 0.95), rgba(10, 10, 26, 0.95)); /* Degradado */
            border: 1px solid rgba(0, 255, 255, 0.5);
        }

        .admin-modal-close-btn, .profile-settings-modal-close-btn, .rules-modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #F9FAFB;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .admin-modal-close-btn:hover, .profile-settings-modal-close-btn:hover, .rules-modal-close-btn:hover {
            transform: scale(1.2) rotate(90deg);
            color: #00FFFF;
        }
        /* Estilos para las notificaciones */
        #notification-center {
            position: absolute;
            top: calc(100% + 10px); /* Debajo del botón de notificaciones */
            right: 0;
            background-color: #1A202C; /* Fondo oscuro */
            border: 1px solid rgba(0, 255, 255, 0.4);
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 70;
            padding: 0.5rem 0;
            display: none; /* Oculto por defecto */
            backdrop-filter: blur(8px); /* Efecto de desenfoque */
            -webkit-backdrop-filter: blur(8px); /* Compatibilidad con Safari */
            background-image: linear-gradient(to bottom right, rgba(26, 32, 44, 0.95), rgba(10, 10, 26, 0.95)); /* Degradado */
        }

        #notification-center.show {
            display: block;
        }

        .notification-item {
            padding: 0.75rem 1rem;
            color: #F9FAFB;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            transition: background-color 0.2s ease;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background-color: rgba(0, 255, 255, 0.1);
        }

        .notification-item.unread {
            background-color: rgba(0, 255, 255, 0.05);
            font-weight: bold;
        }

        .notification-item .timestamp {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.2rem;
        }

        /* Estilos para las etiquetas de roles */
        .role-tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* text-xs */
            font-weight: bold;
            margin-left: 0.5rem;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .role-admin {
            background-color: #EF4444; /* red-500 */
            color: #FFFFFF; /* white */
        }

        .role-cliente {
            background-color: #22C55E; /* green-500 */
            color: #FFFFFF; /* white */
        }

        .role-aprendiz {
            background-color: #FACC15; /* yellow-400 */
            color: #1A202C; /* black or very dark gray for contrast */
        }

        .role-instructor {
            background-color: #3B82F6; /* blue-500 */
            color: #1A202C; /* black or very dark gray for contrast */
        }

        .role-user {
            background-color: #6B7280; /* gray-500 */
            color: #F9FAFB; /* white */
        }

        /* Reglas: Estilo mejorado para cada sección de regla */
        .rules-modal-content {
            background-color: #1A202C; /* Re-apply the content background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            max-width: 800px; /* Aumentar ancho para reglas */
            width: 95%; /* Más ancho en móvil */
            color: #F9FAFB;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-image: linear-gradient(to bottom right, rgba(26, 32, 44, 0.95), rgba(10, 10, 26, 0.95));
            border: 1px solid rgba(0, 255, 255, 0.5);
        }
        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            background-color: rgba(0, 255, 255, 0.05); /* Cian muy tenue */
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(0, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.05);
        }
        .rule-item .icon {
            font-size: 1.8rem;
            color: #00FFFF; /* Cian brillante para el ícono */
            flex-shrink: 0;
            margin-top: 0.2rem;
        }
        .rule-item h4 {
            font-size: 1.15rem;
            font-weight: 700;
            color: #00FFFF;
            margin-bottom: 0.25rem;
            text-shadow: none; /* Eliminar sombra de texto para reglas */
        }
        .rule-item p {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #F9FAFB;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Video de fondo (inicialmente oculto, solo se muestra con auth-section) -->
    <video autoplay muted loop id="video-background" class="hidden">
        <source src="./images/fondoforo.mp4" type="video/mp4">
        Tu navegador no soporta el tag de video.
    </video>

    <header id="main-header" class="main-header">
        <div class="w-full px-4 sm:px-6 md:px-8 flex flex-col md:flex-row justify-between items-center py-2">
            <!-- Grupo de la izquierda: Logo y Volver al inicio -->
            <div class="flex items-center justify-between w-full md:w-auto mb-2 md:mb-0">
                <!-- Logo de Byte -->
                <img src="./images/logo.ico" alt="Logo de Byte" class="h-12 sm:h-16 w-auto object-contain">
                <!-- Volver al inicio, siempre visible y amarillo -->
                <a href="index.html" class="inline-block back-to-home-button md:ml-4">
                    Volver al inicio
                </a>
            </div>

            <!-- Grupo de la derecha: Botones de acción (action-bar content movido aquí) -->
            <!-- La barra de acciones ahora está directamente en el header -->
            <div id="action-bar" class="flex items-center justify-center flex-wrap gap-4 md:gap-2 lg:gap-4 px-4 hidden">
                <!-- Botón para Usuarios Conectados (solo icono) -->
                <button id="toggle-online-users-btn" class="icon-action-button">
                    <i class="fas fa-users"></i>
                </button>
                <!-- Botón de Notificaciones (solo icono) -->
                <div class="relative">
                    <button id="notifications-button" class="icon-action-button">
                        <i class="fas fa-bell"></i>
                        <span id="unread-notifications-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">
                            0
                        </span>
                    </button>
                    <div id="notification-center" class="profile-dropdown-menu right-0 mt-2 p-0">
                        <!-- Las notificaciones se cargarán aquí -->
                        <div class="notification-item">No hay notificaciones.</div>
                    </div>
                </div>
                <!-- Nuevo botón de Reglas (morado) -->
                <button id="rules-button" class="main-action-button bg-purple-600 hover:bg-purple-700">
                    Reglas
                </button>
                <!-- Botón especial de Admin (visible solo para administradores) -->
                <button id="admin-button" class="main-action-button bg-blue-500 hover:bg-blue-600 hidden" title="Panel de Administrador">
                    <i class="fas fa-crown mr-2"></i> Admin
                </button>
                <!-- Botón de perfil/ajustes con dropdown (imagen de perfil como símbolo) -->
                <div id="profile-settings-container" class="relative">
                    <button id="profile-settings-button" class="profile-button">
                        <img id="profile-pic-img" src="./images/logo.ico" alt="Foto de perfil">
                    </button>
                    <div id="profile-dropdown-menu" class="profile-dropdown-menu">
                        <button id="open-profile-settings-btn">Ajustes de Perfil</button>
                        <button id="logout-button" class="destructive-action-button" onclick="handleLogout()">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-8 relative"> <!-- Padding superior se maneja en .forum-section / JS -->
        <!-- Sección de Autenticación -->
        <div id="auth-section" class="hidden flex flex-col items-center justify-center w-full min-h-[calc(100vh-100px)]">
             <!-- Contenedor principal de autenticación -->
            <div id="auth-forms-container" class="auth-container">
                <div class="flex justify-center mb-6">
                    <button id="login-tab" class="tab-button active text-byte-text-light">Iniciar Sesión</button>
                    <button id="register-tab" class="tab-button text-byte-text-light">Registrarse</button>
                </div>

                <!-- Formulario de Iniciar Sesión -->
                <form id="login-form" class="space-y-4">
                    <h2 class="text-2xl font-bold text-center mb-4">Iniciar Sesión</h2>
                    <div>
                        <label for="login-email" class="block text-sm font-semibold mb-2">Correo Electrónico:</label>
                        <input type="email" id="login-email" name="email"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="tu@ejemplo.com" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-semibold mb-2">Contraseña:</label>
                        <input type="password" id="login-password" name="password"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Tu contraseña" required>
                    </div>
                    <button type="submit"
                            class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full
                                   shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                        Iniciar Sesión
                    </button>
                    <button type="button" id="forgot-password-link" class="text-byte-accent-cyan hover:underline text-sm mt-2 block text-center">¿Olvidaste tu contraseña?</button>
                </form>

                <!-- Formulario de Registro (oculto por defecto) -->
                <form id="register-form" class="space-y-4 hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">Registrarse</h2>
                    <div>
                        <label for="register-name" class="block text-sm font-semibold mb-2">Nombre:</label>
                        <input type="text" id="register-name" name="name"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Tu nombre" required>
                    </div>
                    <div>
                        <label for="register-lastname" class="block text-sm font-semibold mb-2">Apellido:</label>
                        <input type="text" id="register-lastname" name="lastname"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Tu apellido" required>
                    </div>
                    <div>
                        <label for="register-phone" class="block text-sm font-semibold mb-2">Número Telefónico:</label>
                        <input type="tel" id="register-phone" name="phone"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="+58 (XXX) XXX-XX-XX" required>
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-semibold mb-2">Correo Electrónico:</label>
                        <input type="email" id="register-email" name="email"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="tu@ejemplo.com" required>
                    </div>
                    <div>
                        <label for="register-age" class="block text-sm font-semibold mb-2">Edad:</label>
                        <input type="number" id="register-age" name="age"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Ej: 25" min="18" max="120" required> <!-- Max 120 años -->
                    </div>
                    <div>
                        <label for="register-role" class="block text-sm font-semibold mb-2">Rol:</label>
                        <select id="register-role" name="role"
                                class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                       text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                                required>
                            <option value="" class="text-gray-500">Selecciona un rol</option> <!-- Placeholder con color -->
                            <option value="cliente" class="text-byte-text-light">Cliente</option>
                            <option value="instructor" class="text-byte-text-light">Instructor</option>
                            <option value="aprendiz" class="text-byte-text-light">Aprendiz</option>
                        </select>
                    </div>
                    <div>
                        <label for="profile_pic_url" class="block text-sm font-semibold mb-2">URL de Foto de Perfil (Opcional):</label>
                        <input type="url" id="profile_pic_url" name="profile_pic_url"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="https://ejemplo.com/tu-foto.jpg">
                               <!-- Campo de foto de perfil (URL) - No obligatorio por ahora -->
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-semibold mb-2">Contraseña:</label>
                        <input type="password" id="register-password" name="password"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Crea tu contraseña" required>
                        <div id="password-strength-bar" class="w-0"></div>
                    </div>
                    <!-- Nuevo campo para confirmar contraseña -->
                    <div>
                        <label for="register-confirm-password" class="block text-sm font-semibold mb-2">Confirmar Contraseña:</label>
                        <input type="password" id="register-confirm-password" name="confirm_password"
                               class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                      text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"
                               placeholder="Confirma tu contraseña" required>
                    </div>
                    <button type="submit"
                            class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full
                                   shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                        Registrarse
                    </button>
                </form>
            </div>

            <!-- Pantalla de verificación (oculta por defecto) -->
            <div id="verification-screen" class="verification-message hidden">
                <i class="fas fa-check-circle"></i>
                <h2 class="text-3xl font-bold text-center mb-4 text-byte-accent-cyan">¡VERIFICADO!</h2>
                <p class="text-lg text-byte-text-light text-center">Revisa tu correo electrónico para verificar tu cuenta.</p>
                <p class="text-sm text-gray-400 text-center mt-2">Revisa la bandeja de entrada o la carpeta de spam.</p>
                <button id="go-to-login-btn" class="mt-8 bg-yellow-500 text-black font-bold py-3 px-6 rounded-full
                                            shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                    Volver a Iniciar Sesión
                </button>
            </div>
        </div>


        <!-- Contenido del foro, inicialmente oculto -->
        <section id="forum-content" class="forum-section hidden max-w-4xl mx-auto"> <!-- Changed max-w-7xl to max-w-4xl -->
            <!-- Modal de Administrador -->
            <div id="admin-modal" class="admin-modal">
                <div class="admin-modal-content">
                    <button class="admin-modal-close-btn" id="admin-modal-close-btn">&times;</button>
                    <h2 class="text-2xl font-bold mb-4 text-byte-accent-cyan">Panel de Administrador</h2>
                    <div class="space-y-4">
                        <p class="text-lg">Usuarios registrados: <span id="registered-users-count" class="font-bold">0</span></p>

                        <!-- Asignar Rol -->
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Asignar Rol a Usuario</h3>
                            <input type="text" id="admin-target-user-id" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="ID de Usuario">
                            <select id="admin-assign-role-select" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light mt-2">
                                <option value="user">Usuario</option>
                                <option value="admin">Administrador</option>
                                <option value="instructor">Instructor</option>
                                <option value="aprendiz">Aprendiz</option>
                            </select>
                            <button id="admin-assign-role-btn" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Asignar Rol</button>
                            <p class="text-red-500 text-sm mt-1">¡ADVERTENCIA! La asignación de roles del lado del cliente puede ser explotada. En producción, esto DEBE ser manejado por Firebase Cloud Functions.</p>
                        </div>

                        <!-- Banear/Desbanear Usuario -->
                        <div>
                            <h3 class="text-xl font-semibold mb-2">Banear/Desbanear Usuario</h3>
                            <input type="text" id="admin-ban-user-id" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="ID de Usuario a Banear/Desbanear">
                            <button id="admin-toggle-ban-btn" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Alternar Baneo</button>
                            <p class="text-red-500 text-sm mt-1">¡ADVERTENCIA! La modificación del estado de baneo del lado del cliente puede ser explotada. En producción, esto DEBE ser manejado por Firebase Cloud Functions.</p>
                        </div>

                        <!-- Enviar Notificación por Infracción -->
                        <div class="border-t border-gray-700 pt-4 mt-4">
                            <h3 class="text-xl font-semibold mb-2">Enviar Notificación por Infracción</h3>
                            <input type="text" id="admin-notification-user-id" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="ID de Usuario o Email">
                            <textarea id="admin-notification-message" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan mt-2" rows="3" placeholder="Mensaje de infracción..."></textarea>
                            <button id="admin-send-notification-btn" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">Enviar Notificación</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de Ajustes de Perfil -->
            <div id="profile-settings-modal" class="profile-settings-modal">
                <div class="profile-settings-modal-content">
                    <button class="profile-settings-modal-close-btn" id="profile-settings-modal-close-btn">&times;</button>
                    <h2 class="text-2xl font-bold mb-4 text-byte-accent-cyan">Ajustes de Perfil</h2>
                    <form id="profile-settings-form" class="space-y-4">
                        <div>
                            <label for="profile-name" class="block text-sm font-semibold mb-2">Nombre:</label>
                            <input type="text" id="profile-name" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light" required>
                        </div>
                        <div>
                            <label for="profile-lastname" class="block text-sm font-semibold mb-2">Apellido:</label>
                            <input type="text" id="profile-lastname" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light" required>
                        </div>
                        <div>
                            <label for="profile-phone" class="block text-sm font-semibold mb-2">Teléfono:</label>
                            <input type="tel" id="profile-phone" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light" required>
                        </div>
                        <div>
                            <label for="profile-dob" class="block text-sm font-semibold mb-2">Fecha de Nacimiento:</label>
                            <input type="date" id="profile-dob" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light" required>
                        </div>
                        <div>
                            <label for="profile-pic-url-input" class="block text-sm font-semibold mb-2">URL de Foto de Perfil:</label>
                            <input type="url" id="profile-pic-url-input" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light">
                        </div>
                        <button type="submit" class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                            Guardar Cambios
                        </button>
                    </form>

                    <div class="border-t border-gray-700 pt-4 mt-6">
                        <h3 class="text-xl font-semibold mb-2 text-byte-accent-cyan">Cambiar Correo Electrónico</h3>
                        <p class="text-sm text-gray-400 mb-4">Se te pedirá reconfirmar tu contraseña actual.</p>
                        <form id="profile-email-form" class="space-y-4">
                            <div>
                                <label for="profile-current-email" class="block text-sm font-semibold mb-2">Correo Actual:</label>
                                <input type="email" id="profile-current-email" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-gray-700 text-gray-400" readonly>
                            </div>
                            <div>
                                <label for="profile-new-email" class="block text-sm font-semibold mb-2">Nuevo Correo Electrónico:</label>
                                <input type="email" id="profile-new-email" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light" placeholder="nuevo.correo@ejemplo.com" required>
                            </div>
                            <div>
                                <label for="profile-current-password" class="block text-sm font-semibold mb-2">Contraseña Actual para Confirmar:</label>
                                <input type="password" id="profile-current-password" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105">
                                Cambiar Correo
                            </button>
                        </form>
                    </div>

                    <!-- Nueva sección para cambiar contraseña -->
                    <div class="border-t border-gray-700 pt-4 mt-6">
                        <h3 class="text-xl font-semibold mb-2 text-byte-accent-cyan">Cambiar Contraseña</h3>
                        <p class="text-sm text-gray-400 mb-4">Se te pedirá tu contraseña actual para confirmar el cambio.</p>
                        <form id="profile-password-form" class="space-y-4">
                            <div>
                                <label for="profile-current-password-change" class="block text-sm font-semibold mb-2">Contraseña Actual:</label>
                                <input type="password" id="profile-current-password-change"
                                       class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                              text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" required>
                            </div>
                            <div>
                                <label for="profile-new-password" class="block text-sm font-semibold mb-2">Nueva Contraseña:</label>
                                <input type="password" id="profile-new-password"
                                       class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                              text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" required>
                                <div id="new-password-strength-bar" class="w-0"></div>
                            </div>
                            <div>
                                <label for="profile-confirm-new-password" class="block text-sm font-semibold mb-2">Confirmar Nueva Contraseña:</label>
                                <input type="password" id="profile-confirm-new-password"
                                       class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan
                                              text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" required>
                            </div>
                            <button type="submit"
                                    class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-full
                                           shadow-lg hover:bg-orange-700 transition duration-300 transform hover:scale-105">
                                Actualizar Contraseña
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal de Reglas del Foro -->
            <div id="rules-modal" class="rules-modal">
                <div class="rules-modal-content">
                    <button class="rules-modal-close-btn" id="rules-modal-close-btn">&times;</button>
                    <h2 class="text-2xl font-bold mb-6 text-center text-byte-accent-cyan">Reglas del Foro de Byte</h2>
                    <p class="text-center text-byte-text-light mb-8">Para asegurar un ambiente constructivo y respetuoso, la participación en el foro de Byte se rige por las siguientes directrices:</p>
                    <div id="rules-list" class="space-y-6">
                        <!-- Rule 1: Veracidad de la Información -->
                        <div class="rule-item">
                            <i class="fas fa-check-circle icon"></i>
                            <div>
                                <h4>1. Veracidad de la Información</h4>
                                <p>Es imperativo que toda la información compartida sea precisa, verificable y basada en fuentes confiables. La difusión intencional de datos falsos o engañosos, así como la tergiversación de hechos, está estrictamente prohibida y puede resultar en la suspensión permanente de la cuenta.</p>
                            </div>
                        </div>
                        <!-- Rule 2: Respeto y Profesionalismo -->
                        <div class="rule-item">
                            <i class="fas fa-handshake icon"></i>
                            <div>
                                <h4>2. Respeto y Profesionalismo</h4>
                                <p>Mantenga un tono cortés, profesional y constructivo en todas sus interacciones. Los comentarios ofensivos, difamatorios, discriminatorios, sexistas, racistas o que atenten contra la integridad y dignidad de otros usuarios o marcas no serán tolerados. La crítica debe ser objetiva y fundamentada, siempre con el objetivo de enriquecer el debate.</p>
                            </div>
                        </div>
                        <!-- Rule 3: Relevancia del Contenido -->
                        <div class="rule-item">
                            <i class="fas fa-tag icon"></i>
                            <div>
                                <h4>3. Relevancia del Contenido</h4>
                                <p>Asegúrese de que sus publicaciones y comentarios sean directamente relevantes para el tema de discusión. Evite el "off-topic" (fuera de tema), el spam, el contenido promocional excesivo no autorizado o la publicación de mensajes duplicados. Se prioriza el valor agregado al conocimiento colectivo.</p>
                            </div>
                        </div>
                        <!-- Rule 4: Propiedad Intelectual -->
                        <div class="rule-item">
                            <i class="fas fa-lightbulb icon"></i>
                            <div>
                                <h4>4. Propiedad Intelectual</h4>
                                <p>No comparta material protegido por derechos de autor, patentes o secretos comerciales sin la debida autorización o atribución explícita. El contenido debe ser original, creado por usted, o debidamente citado y referenciado. El plagio y el uso no autorizado de material de terceros son estrictamente prohibidos.</p>
                            </div>
                        </div>
                        <!-- Rule 5: Confidencialidad y Privacidad -->
                        <div class="rule-item">
                            <i class="fas fa-user-secret icon"></i>
                            <div>
                                <h4>5. Confidencialidad y Privacidad</h4>
                                <p>Evite divulgar información personal sensible, tanto propia como de terceros, incluyendo direcciones, números de teléfono, correos electrónicos privados o datos financieros. La privacidad de todos los miembros de la comunidad es primordial y debe ser respetada en todo momento.</p>
                            </div>
                        </div>
                        <!-- Rule 6: Colaboración Constructiva -->
                        <div class="rule-item">
                            <i class="fas fa-users-cog icon"></i>
                            <div>
                                <h4>6. Colaboración Constructiva</h4>
                                <p>Fomente un espíritu de colaboración, intercambio de conocimientos y aprendizaje mutuo. Participe activamente en debates saludables y brinde retroalimentación constructiva. Las discusiones deben buscar soluciones y nuevas perspectivas, no la confrontación.</p>
                            </div>
                        </div>
                         <!-- Rule 7: Moderación y Sanciones -->
                        <div class="rule-item">
                            <i class="fas fa-gavel icon"></i>
                            <div>
                                <h4>7. Moderación y Sanciones</h4>
                                <p>La administración del foro se reserva el derecho de editar, mover o eliminar cualquier contenido que incumpla estas reglas. Las infracciones recurrentes o graves pueden resultar en advertencias, suspensiones temporales o el baneo permanente de la cuenta. Las decisiones de moderación son finales y no negociables.</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-byte-text-light mt-8">Al participar en este foro, usted acepta cumplir con estas reglas y contribuir a una comunidad enriquecedora para todos.</p>
                </div>
            </div>

            <!-- Columna Principal del Foro (posts, comments) -->
            <div class="w-full">
                <h1 class="text-2xl sm:text-3xl md:text-5xl font-extrabold text-center mb-8 md:mb-10 text-stroke-cyan">Bienvenido al Foro de Byte</h1>
                <p class="text-center text-lg text-byte-text-light mb-8">
                    Aquí puedes discutir temas de SEO, marketing digital, visibilidad online y mucho más.
                    ¡Comparte tus conocimientos, haz preguntas y conecta con la comunidad!
                </p>

                <!-- Formulario para crear nuevas publicaciones -->
                <div class="bg-byte-secondary-dark rounded-xl p-6 mb-6 border border-byte-accent-cyan shadow-lg">
                    <h3 class="text-xl font-bold text-byte-accent-cyan mb-4">Crear Nueva Publicación</h3>
                    <form id="create-post-form" class="space-y-4">
                        <div>
                            <label for="post-title" class="block text-sm font-semibold mb-2 text-byte-text-light">Título de la Publicación:</label>
                            <input type="text" id="post-title" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="Un título para tu publicación..." required>
                        </div>
                        <div>
                            <textarea id="post-content" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-gray-700 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" rows="4" placeholder="¿Qué tienes en mente?" required></textarea>
                        </div>
                        <div>
                            <label for="post-image-url" class="block text-sm font-semibold mb-2 text-byte-text-light">URL de la imagen (opcional):</label>
                            <input type="url" id="post-image-url" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="https://ejemplo.com/imagen.jpg">
                        </div>
                        <div>
                            <label for="post-video-url" class="block text-sm font-semibold mb-2 text-byte-text-light">URL del video (opcional):</label>
                            <input type="url" id="post-video-url" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="https://youtube.com/watch?v=VIDEO_ID o URL directa">
                        </div>
                        <button type="submit" class="w-full bg-yellow-500 text-black font-bold py-3 px-4 rounded-full shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-105">
                            Publicar
                        </button>
                    </form>
                </div>

                <!-- Lista de Publicaciones -->
                <div id="posts-list" class="space-y-6">
                    <!-- Las publicaciones se cargarán aquí dinámicamente -->
                </div>
            </div>
        </section>
        <!-- Botón de estado del Foro (Firebase) -->
        <button id="firebase-status-button"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-500 text-white font-bold py-2 px-4 rounded-full
                       shadow-lg transition duration-300 transform hover:scale-105">
            FORO (Cargando...)
        </button>
    </main>

    <!-- Barra Lateral Derecha para Usuarios Online (Fixed y oculta por defecto) -->
    <aside id="online-users-sidebar" class="fixed right-0 bg-byte-secondary-dark rounded-xl p-6 border border-byte-accent-cyan shadow-lg h-[calc(100vh-8rem)] overflow-y-auto hidden-sidebar">
        <h3 class="text-xl font-bold text-byte-accent-cyan mb-4">Usuarios Online</h3>
        <ul id="online-users-list" class="space-y-3">
            <!-- Los usuarios online se cargarán aquí dinámicamente -->
            <li class="flex items-center text-gray-400 text-sm italic">Cargando usuarios...</li>
        </ul>
    </aside>

    <button id="scroll-to-top-button">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="footer bg-byte-secondary-dark text-byte-text-light py-6 sm:py-8">
        <div class="container mx-auto px-4 sm:px-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
            <div class="md:col-span-3 flex justify-center space-x-4 mt-3">
                <a href="https://www.instagram.com/byteweb_design?utm_source=ig_web_button_share_sheet&igsh=ZDNlZDc0MzIxNw==" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
                    <svg class="footer-social-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                        <radialGradient id="yOrnnhliCrdS2gy~4tD8ma-footer" cx="19.38" cy="42.035" r="44.899" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fd5"/><stop offset=".328" stop-color="#ff543f"/><stop offset=".348" stop-color="#fc5245"/><stop offset=".504" stop-color="#e64771"/><stop offset=".643" stop-color="#d53e91"/><stop offset=".761" stop-color="#cc39a4"/><stop offset=".841" stop-color="#c837ab"/></radialGradient><path fill="url(#yOrnnhliCrdS2gy~4tD8ma-footer)" d="M34.017,41.99l-20,0.019c-4.4,0.004-8.003-3.592-8.008-7.992l-0.019-20	c-0.004-4.4,3.592-8.003,7.992-8.008l20-0.019c4.4-0.004,8.003,3.592,8.008,7.992l0.019,20	C42.014,38.383,38.417,41.986,34.017,41.99z"/><radialGradient id="yOrnnhliCrdS2gy~4tD8mb-footer" cx="11.786" cy="5.54" r="29.813" gradientTransform="matrix(1 0 0 .6663 0 1.849)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#4168c9"/><stop offset=".999" stop-color="#4168c9" stop-opacity="0"/></radialGradient><path fill="url(#yOrnnhliCrdS2gy~4tD8mb-footer)" d="M34.017,41.99l-20,0.019c-4.4,0.004-8.003-3.592-8.008-7.992l-0.019-20	c-0.004-4.4,3.592-8.003,7.992-8.008l20-0.019c4.4-0.004,8.003,3.592,8.008,7.992l0.019,20	C42.014,38.383,38.417,41.986,34.017,41.99z"/><path fill="#fff" d="M24,31c-3.859,0-7-3.14-7-7s3.141-7,7-7s7,3.14,7,7S27.859,31,24,31z M24,19c-2.757,0-5,2.243-5,5	s2.243,5,5,5s5-2.243,5-5S26.757,19,24,19z"/><circle cx="31.5" cy="16.5" r="1.5" fill="#fff"/><path fill="#fff" d="M30,37H18c-3.859,0-7-3.14-7-7V18c0-3.86,3.141-7,7-7h12c3.859,0,7,3.14,7,7v12	C37,33.86,33.859,37,30,37z M18,13c-2.757,0-5,2.243-5,5v12c0,2.757,2.243,5,5,5h12c2.757,0,5-2.243,5-5V18c0-2.757-2.243-5-5-5H18z"/>
                    </svg>
                </a>
                <a href="https://wa.me/584125646608" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
                    <i class="fab fa-whatsapp footer-social-icon text-byte-text-light"></i>
                </a>
            </div>
        </div>
        <div class="container mx-auto px-4 sm:px-6 text-center text-xs sm:text-sm text-gray-400 mt-6 sm:mt-8 border-t border-gray-700 pt-4">
            <p class="mb-2">
                Al navegar en la página de Byte, aceptas nuestros
                <a href="#" class="text-byte-accent-cyan hover:underline disabled-link">Términos de Servicio</a> y
                <a href="#" class="text-byte-accent-cyan hover:underline disabled-link">Condiciones</a>.
            </p>
            <p>© 2025 Byte. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        // Importa las funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signInWithEmailAndPassword, signOut, reauthenticateWithCredential, EmailAuthProvider, updateEmail, updatePassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importa docChanges para actualizaciones más eficientes
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp, updateDoc, deleteDoc, orderBy, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tus datos de configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDjUNln-KyOvyOKfzm7077Lv8tGtKwtFTE",
            authDomain: "byte-21d48.firebaseapp.com",
            projectId: "byte-21d48",
            storageBucket: "byte-21d48.appspot.com",
            messagingSenderId: "647326645291",
            appId: "1:647326645291:web:6013f0179f525f288f3e6e"
        };

        const appId = firebaseConfig.appId.split(':')[2];

        let app;
        let auth;
        let db;
        let currentUserData = null; // Para almacenar los datos del perfil del usuario logueado
        let onlineUsersInterval; // Intervalo para actualizar el estado online
        let firebaseStatusButtonElement = null; // Variable global para el botón de estado

        const DEFAULT_PROFILE_PIC = "./images/logo.ico"; // URL de imagen de perfil por defecto

        /*
         * REGLAS DE SEGURIDAD DE FIRESTORE (PARA TU CONSOLA DE FIREBASE)
         *
         * ¡IMPORTANTE! Para que las funciones de administración y eliminación funcionen correctamente,
         * debes COPIAR Y PEGAR estas reglas en la sección "Rules" de tu base de datos Firestore
         * en la consola de Firebase. Sin estas reglas, Firebase por defecto no permitirá
         * operaciones de eliminación o modificación de roles/baneos.
         *
         * Asegúrate de que las reglas para 'artifacts/{appId}/public/data/posts/{postId}'
         * permitan la eliminación solo si el usuario autenticado (request.auth.uid)
         * es el mismo que el 'authorId' guardado en el documento (resource.data.authorId),
         * O si el usuario autenticado tiene el rol de 'admin'.
         *
         * También, las reglas para 'artifacts/{appId}/users/{userId}' deben permitir
         * a los administradores actualizar cualquier perfil de usuario (para banear o asignar roles).
         *
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         *
         * // User Profiles:
         * // Any authenticated user can create their own profile.
         * // Users can read and update their own profile.
         * // Admins can read, update, and ban/unban any user.
         * match /artifacts/{appId}/users/{userId} {
         * allow read, create: if request.auth != null;
         * allow update: if request.auth != null && request.auth.uid == userId; // Users can update their own profile
         * allow delete: if false; // Users cannot delete their own profile directly
         *
         * // Admin specific rules for users:
         * // Admins can read all user profiles, and update 'isBanned' and 'role' fields for any user.
         * // Note: 'request.resource.data.keys().hasAny' is a security measure to restrict what fields an admin can change
         * // when updating another user's profile to prevent privilege escalation.
         * // For full role management via admin, you might need Cloud Functions for robust security.
         * allow update: if request.auth != null
         * && get(/databases/$(database)/documents/artifacts/$(appId)/users/$(request.auth.uid)).data.role == 'admin'
         * && (request.resource.data.keys().hasOnly(['isBanned']) || request.resource.data.keys().hasOnly(['role']));
         * }
         *
         * // Public Posts:
         * // Any authenticated user can read posts.
         * // Any authenticated user can create posts.
         * // Only the author or an admin can update or delete a post.
         * match /artifacts/{appId}/public/data/posts/{postId} {
         * allow read: if request.auth != null;
         * allow create: if request.auth != null;
         * allow update, delete: if request.auth != null && (request.auth.uid == resource.data.authorId || get(/databases/$(database)/documents/artifacts/$(appId)/users/$(request.auth.uid)).data.role == 'admin');
         *
         * // Comments on Posts:
         * // Any authenticated user can read comments.
         * // Any authenticated user can create comments.
         * // Only the author of the comment or an admin can update or delete a comment.
         * match /comments/{commentId} {
         * allow read: if request.auth != null;
         * allow create: if request.auth != null;
         * allow update, delete: if request.auth != null && (request.auth.uid == resource.data.authorId || get(/databases/$(database)/documents/artifacts/$(appId)/users/$(request.auth.uid)).data.role == 'admin');
         * }
         * }
         *
         * // Notifications (private per user):
         * // Only the owner of the notification can read/write their own notifications.
         * match /artifacts/{appId}/users/{userId}/notifications/{notificationId} {
         * allow read, write: if request.auth != null && request.auth.uid == userId;
         * }
         * }
         * }
         */

        // Función para mostrar mensajes temporales (declarada globalmente para ser accesible)
        window.showMessage = function(msg, type = 'blue') {
            const messageEl = document.createElement('div');
            messageEl.textContent = msg;
            let bgColor;
            let textColor = '#0A0A1A'; // Default dark text for cyan/yellow/green backgrounds
            switch (type) {
                case 'red': bgColor = '#EF4444'; break;
                case 'green': bgColor = '#25D366'; break;
                case 'blue': bgColor = '#00FFFF'; break;
                case 'purple': bgColor = '#9333ea'; textColor = '#F9FAFB'; break; // White text for purple
                default: bgColor = '#00FFFF';
            }
            messageEl.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background-color: ${bgColor}; color: ${textColor}; padding: 10px 20px;
                border-radius: 8px; z-index: 10000; opacity: 0; transition: opacity 0.3s ease-in-out;
            `;
            document.body.appendChild(messageEl);
            setTimeout(() => messageEl.style.opacity = '1', 10);
            setTimeout(() => messageEl.style.opacity = '0', 3000);
            setTimeout(() => messageEl.remove(), 3300);
        };

        // Función para cerrar sesión (declarada globalmente para ser accesible desde onclick)
        window.handleLogout = async function() {
            try {
                if (auth.currentUser && db) {
                    // Establecer lastSeen a null al cerrar sesión
                    const userProfileRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
                    await updateDoc(userProfileRef, { lastSeen: null });
                }
                clearInterval(onlineUsersInterval); // Detener la actualización de lastSeen

                await signOut(auth);
                window.showMessage('Sesión cerrada exitosamente.', 'green');
                
                // Ocultar elementos del foro y mostrar la sección de autenticación
                const forumContent = document.getElementById('forum-content');
                const authSection = document.getElementById('auth-section');
                const videoBackground = document.getElementById('video-background');
                const actionBar = document.getElementById('action-bar'); // Nueva referencia
                const onlineUsersSidebar = document.getElementById('online-users-sidebar');
                const adminButton = document.getElementById('admin-button'); // Botón de admin
                const notificationCenter = document.getElementById('notification-center'); // Centro de notificaciones
                const profileSettingsModal = document.getElementById('profile-settings-modal'); // Modal de perfil
                const rulesModal = document.getElementById('rules-modal'); // Modal de reglas
                const mainHeader = document.getElementById('main-header'); // Header
                mainHeader.classList.remove('header-hidden'); // Asegurarse de que el header esté visible al cerrar sesión

                if (forumContent) forumContent.classList.add('hidden');
                if (authSection) authSection.classList.remove('hidden');
                if (videoBackground) videoBackground.classList.remove('hidden'); // Mostrar video
                if (actionBar) actionBar.classList.add('hidden'); // Ocultar la barra de acciones
                if (onlineUsersSidebar) {
                    onlineUsersSidebar.classList.remove('show-sidebar'); // Ocultar sidebar
                    onlineUsersSidebar.style.display = 'none'; // Asegurarse de que esté realmente oculto
                }
                if (adminButton) adminButton.classList.add('hidden'); // Ocultar botón de admin
                if (notificationCenter) notificationCenter.classList.remove('show'); // Ocultar notificaciones
                if (profileSettingsModal) profileSettingsModal.style.display = 'none'; // Ocultar modal de perfil
                if (rulesModal) rulesModal.style.display = 'none'; // Ocultar modal de reglas

                const mainEl = document.querySelector('main');
                if (mainEl) {
                    mainEl.classList.add('flex', 'items-center', 'justify-content', 'w-full', 'h-screen');
                    mainEl.style.padding = '0';
                    mainEl.style.overflow = 'hidden';
                }

                if (firebaseStatusButtonElement) {
                    firebaseStatusButtonElement.textContent = 'FORO (Inactivo)';
                    firebaseStatusButtonElement.classList.remove('bg-green-500');
                    firebaseStatusButtonElement.classList.add('bg-red-500');
                }
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                const loginTab = document.getElementById('login-tab');
                const registerTab = document.getElementById('register-tab');

                if(loginForm) loginForm.classList.remove('hidden');
                if(registerForm) registerForm.classList.add('hidden');
                if(loginTab) loginTab.classList.add('active');
                if(registerTab) registerTab.classList.remove('active');
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                window.showMessage('Error al cerrar sesión. Intenta de nuevo.', 'red');
            }
        };

        // Función para mostrar la sección de autenticación (para el botón "Iniciar Sesión / Registrarse")
        window.showAuthSection = function() {
            const authSection = document.getElementById('auth-section');
            const forumContent = document.getElementById('forum-content');
            const videoBackground = document.getElementById('video-background');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const onlineUsersSidebar = document.getElementById('online-users-sidebar');
            const actionBar = document.getElementById('action-bar');
            const adminButton = document.getElementById('admin-button'); // Botón de admin
            const notificationCenter = document.getElementById('notification-center'); // Centro de notificaciones
            const profileSettingsModal = document.getElementById('profile-settings-modal'); // Modal de perfil
            const rulesModal = document.getElementById('rules-modal'); // Modal de reglas
            const mainHeader = document.getElementById('main-header'); // Header
            mainHeader.classList.remove('header-hidden'); // Asegurarse de que el header esté visible al cambiar de vista


            if (authSection) authSection.classList.remove('hidden');
            if (forumContent) forumContent.classList.add('hidden');
            if (videoBackground) videoBackground.classList.remove('hidden'); // Mostrar video
            if (onlineUsersSidebar) {
                onlineUsersSidebar.classList.remove('show-sidebar'); // Ocultar sidebar
                onlineUsersSidebar.style.display = 'none'; // Asegurarse de que esté realmente oculto
            }
            if (actionBar) actionBar.classList.add('hidden'); // Ocultar la barra de acciones
            if (adminButton) adminButton.classList.add('hidden'); // Ocultar botón de admin
            if (notificationCenter) notificationCenter.classList.remove('show'); // Ocultar notificaciones
            if (profileSettingsModal) profileSettingsModal.style.display = 'none'; // Ocultar modal de perfil
            if (rulesModal) rulesModal.style.display = 'none'; // Ocultar modal de reglas


            const mainEl = document.querySelector('main');
            if (mainEl) {
                mainEl.classList.add('flex', 'items-center', 'justify-content', 'w-full', 'h-screen');
                mainEl.style.padding = '0';
                mainEl.style.overflow = 'hidden';
            }

            if (loginForm) loginForm.classList.remove('hidden');
            if (registerForm) registerForm.classList.add('hidden');
            if (loginTab) loginTab.classList.add('active');
            if (registerTab) registerTab.classList.remove('active');
        };

        // Función para actualizar el timestamp de 'última vez visto'
        async function updateLastSeen() {
            if (auth.currentUser && db) {
                const userProfileRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
                try {
                    await updateDoc(userProfileRef, { lastSeen: serverTimestamp() });
                } catch (error) {
                    console.error("Error al actualizar lastSeen:", error);
                }
            }
        }

        // Función placeholder para crear un nuevo tema (declarada globalmente)
        window.handleCreateNewTopic = function() {
            window.showMessage('Por favor, usa el formulario superior para crear una nueva publicación.', 'blue');
        };

        // Función para eliminar una publicación (ahora con chequeo de admin)
        window.deletePost = async function(postId, authorId) {
            if (!auth.currentUser) {
                window.showMessage('Debes iniciar sesión para realizar esta acción.', 'red');
                return;
            }

            // Obtener el rol del usuario actual
            const userProfileRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
            const userProfileSnap = await getDoc(userProfileRef);
            const userRole = userProfileSnap.exists() ? userProfileSnap.data().role : 'user';

            // Solo el autor o un administrador pueden eliminar la publicación
            if (auth.currentUser.uid !== authorId && userRole !== 'admin') {
                window.showMessage('No tienes permiso para eliminar esta publicación.', 'red');
                return;
            }

            // Usar un modal en lugar de confirm()
            const confirmDeleteModal = document.createElement('div');
            confirmDeleteModal.className = 'admin-modal';
            confirmDeleteModal.innerHTML = `
                <div class="admin-modal-content">
                    <h3 class="text-xl font-bold mb-4 text-byte-accent-cyan">Confirmar Eliminación</h3>
                    <p class="mb-6 text-byte-text-light">¿Estás seguro de que quieres eliminar esta publicación? Esto también eliminará todos sus comentarios.</p>
                    <div class="flex justify-end gap-4">
                        <button id="cancel-delete-btn" class="main-action-button bg-gray-600 hover:bg-gray-700">Cancelar</button>
                        <button id="confirm-delete-btn" class="destructive-action-button">Eliminar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDeleteModal);
            confirmDeleteModal.style.display = 'flex'; // Mostrar el modal

            document.getElementById('cancel-delete-btn').onclick = () => {
                confirmDeleteModal.remove();
            };

            document.getElementById('confirm-delete-btn').onclick = async () => {
                confirmDeleteModal.remove();
                try {
                    // Eliminar la publicación principal
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/posts`, postId));
                    window.showMessage('Publicación eliminada exitosamente.', 'green');
                } catch (error) {
                    console.error('Error al eliminar publicación:', error);
                    window.showMessage('Error al eliminar la publicación. Intenta de nuevo. Asegúrate de tener los permisos de seguridad de Firebase configurados correctamente.', 'red');
                }
            };
        };

        // Función para editar una publicación
        window.editPost = async function(postId) {
            if (!auth.currentUser) {
                window.showMessage('Debes iniciar sesión para editar publicaciones.', 'red');
                return;
            }

            const postElement = document.getElementById(`post-${postId}`);
            if (!postElement) return;

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            const postSnap = await getDoc(postRef);

            if (!postSnap.exists()) {
                window.showMessage('Publicación no encontrada.', 'red');
                return;
            }

            const postData = postSnap.data();
            const isAuthor = auth.currentUser.uid === postData.authorId;
            const isAdmin = currentUserData && currentUserData.role === 'admin';

            if (!isAuthor && !isAdmin) {
                window.showMessage('No tienes permiso para editar esta publicación.', 'red');
                return;
            }

            // Get existing elements
            const titleElement = postElement.querySelector('h3');
            const contentElement = postElement.querySelector('p:not(.text-gray-400)'); // Avoid selecting timestamp
            const mediaContainer = postElement.querySelector('.post-media-content'); // New element to hold media

            // Store original content to restore on cancel
            const originalTitle = titleElement ? titleElement.textContent : '';
            const originalContent = contentElement ? contentElement.textContent : '';
            const originalImageUrl = postData.imageUrl || '';
            const originalVideoUrl = postData.videoUrl || '';

            // Replace elements with input fields and textareas
            if (titleElement) {
                titleElement.outerHTML = `<input type="text" id="edit-title-${postId}" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light text-xl font-bold mb-2" value="${originalTitle.replace(/"/g, '&quot;')}" required>`;
            }
            if (contentElement) {
                contentElement.outerHTML = `<textarea id="edit-content-${postId}" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light text-base mb-4" rows="4" required>${originalContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>`;
            }

            // Replace media content with inputs
            if (mediaContainer) {
                mediaContainer.innerHTML = `
                    <label for="edit-image-url-${postId}" class="block text-sm font-semibold mb-1 text-byte-text-light">URL Imagen (opcional):</label>
                    <input type="url" id="edit-image-url-${postId}" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light mb-2" placeholder="URL de la imagen" value="${originalImageUrl.replace(/"/g, '&quot;')}" />
                    <label for="edit-video-url-${postId}" class="block text-sm font-semibold mb-1 text-byte-text-light">URL Video (opcional):</label>
                    <input type="url" id="edit-video-url-${postId}" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light mb-4" placeholder="URL del video (YouTube o directo)" value="${originalVideoUrl.replace(/"/g, '&quot;')}" />
                `;
            } else {
                // If no media container exists, add the inputs just before the stats section
                const statsDiv = postElement.querySelector('.text-gray-400.text-sm.mt-3.flex');
                if (statsDiv) {
                    const tempDiv = document.createElement('div');
                    tempDiv.classList.add('post-media-content'); // Add this class to recognize it later
                    tempDiv.innerHTML = `
                        <label for="edit-image-url-${postId}" class="block text-sm font-semibold mb-1 text-byte-text-light">URL Imagen (opcional):</label>
                        <input type="url" id="edit-image-url-${postId}" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light mb-2" placeholder="URL de la imagen" value="${originalImageUrl.replace(/"/g, '&quot;')}" />
                        <label for="edit-video-url-${postId}" class="block text-sm font-semibold mb-1 text-byte-text-light">URL Video (opcional):</label>
                        <input type="url" id="edit-video-url-${postId}" class="w-full p-2 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan text-byte-text-light mb-4" placeholder="URL del video (YouTube o directo)" value="${originalVideoUrl.replace(/"/g, '&quot;')}" />
                    `;
                    statsDiv.parentNode.insertBefore(tempDiv, statsDiv);
                }
            }


            // Hide existing action buttons (edit, delete, share) and add save/cancel
            const actionsDiv = postElement.querySelector('.flex.justify-around.items-center.pt-3.mt-2.border-t.border-gray-700');
            if (actionsDiv) {
                actionsDiv.innerHTML = `
                    <button class="flex items-center bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition duration-200" onclick="savePost('${postId}')">
                        <i class="fas fa-save mr-2"></i> Guardar
                    </button>
                    <button class="flex items-center bg-gray-600 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-700 transition duration-200" onclick="cancelEdit('${postId}', '${originalTitle.replace(/'/g, '&apos;').replace(/"/g, '&quot;')}', '${originalContent.replace(/'/g, '&apos;').replace(/"/g, '&quot;')}', '${originalImageUrl.replace(/'/g, '&apos;').replace(/"/g, '&quot;')}', '${originalVideoUrl.replace(/'/g, '&apos;').replace(/"/g, '&quot;')}')">
                        <i class="fas fa-times mr-2"></i> Cancelar
                    </button>
                `;
            }

            // Hide the edit button that was just clicked
            const editButton = postElement.querySelector(`[onclick="editPost('${postId}')"]`);
            if (editButton) editButton.classList.add('hidden');
        };

        // Función para guardar los cambios de una publicación editada
        window.savePost = async function(postId) {
            const postElement = document.getElementById(`post-${postId}`);
            if (!postElement) return;

            const editedTitle = postElement.querySelector(`#edit-title-${postId}`).value;
            const editedContent = postElement.querySelector(`#edit-content-${postId}`).value;
            const editedImageUrl = postElement.querySelector(`#edit-image-url-${postId}`) ? postElement.querySelector(`#edit-image-url-${postId}`).value : null;
            const editedVideoUrl = postElement.querySelector(`#edit-video-url-${postId}`) ? postElement.querySelector(`#edit-video-url-${postId}`).value : null;

            if (!editedTitle.trim()) {
                window.showMessage('El título no puede estar vacío.', 'red');
                return;
            }
            if (!editedContent.trim()) {
                window.showMessage('El contenido no puede estar vacío.', 'red');
                return;
            }

            try {
                const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                await updateDoc(postRef, {
                    title: editedTitle,
                    content: editedContent,
                    imageUrl: editedImageUrl.trim() ? editedImageUrl : null,
                    videoUrl: editedVideoUrl.trim() ? editedVideoUrl : null,
                    lastEditedAt: serverTimestamp() // Añadir timestamp de última edición
                });
                window.showMessage('Publicación actualizada exitosamente.', 'green');
                // The onSnapshot listener will re-render the post with updated content,
                // so no need to manually restore the view mode here.
            } catch (error) {
                console.error('Error al actualizar publicación:', error);
                window.showMessage('Error al actualizar la publicación. Intenta de nuevo.', 'red');
            }
        };

        // Función para cancelar la edición de una publicación
        window.cancelEdit = function(postId, originalTitle, originalContent, originalImageUrl, originalVideoUrl) {
            // Simply trigger a re-render of the post by updating a dummy field or re-fetching
            // A more robust way without re-fetching would be to revert the DOM manually
            // For now, we will rely on the onSnapshot to re-render, by performing a dummy update if nothing else changed.
            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            updateDoc(postRef, { __dummyUpdate: Date.now() })
                .then(() => {
                    window.showMessage('Edición cancelada.', 'blue');
                })
                .catch(error => {
                    console.error('Error al cancelar edición:', error);
                    window.showMessage('Error al cancelar edición. Recarga la página si el problema persiste.', 'red');
                });
        };

        // Función para eliminar un comentario (con chequeo de admin)
        window.deleteComment = async function(postId, commentId, authorId) {
            if (!auth.currentUser) {
                window.showMessage('Debes iniciar sesión para realizar esta acción.', 'red');
                return;
            }

            // Obtener el rol del usuario actual
            const userProfileRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
            const userProfileSnap = await getDoc(userProfileRef);
            const userRole = userProfileSnap.exists() ? userProfileSnap.data().role : 'user';

            // Solo el autor del comentario o un administrador pueden eliminarlo
            if (auth.currentUser.uid !== authorId && userRole !== 'admin') {
                window.showMessage('No tienes permiso para eliminar este comentario.', 'red');
                return;
            }

            // Usar un modal en lugar de confirm()
            const confirmDeleteModal = document.createElement('div');
            confirmDeleteModal.className = 'admin-modal';
            confirmDeleteModal.innerHTML = `
                <div class="admin-modal-content">
                    <h3 class="text-xl font-bold mb-4 text-byte-accent-cyan">Confirmar Eliminación</h3>
                    <p class="mb-6 text-byte-text-light">¿Estás seguro de que quieres eliminar este comentario?</p>
                    <div class="flex justify-end gap-4">
                        <button id="cancel-comment-delete-btn" class="main-action-button bg-gray-600 hover:bg-gray-700">Cancelar</button>
                        <button id="confirm-comment-delete-btn" class="destructive-action-button">Eliminar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDeleteModal);
            confirmDeleteModal.style.display = 'flex'; // Mostrar el modal

            document.getElementById('cancel-comment-delete-btn').onclick = () => {
                confirmDeleteModal.remove();
            };

            document.getElementById('confirm-comment-delete-btn').onclick = async () => {
                confirmDeleteModal.remove();
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/posts/${postId}/comments`, commentId));
                    window.showMessage('Comentario eliminado exitosamente.', 'green');
                } catch (error) {
                    console.error('Error al eliminar comentario:', error);
                    window.showMessage('Error al eliminar el comentario. Intenta de nuevo.', 'red');
                }
            };
        };

        // Función para cargar y mostrar publicaciones (refactorizada para evitar "shaking")
        async function loadPosts() {
            const postsList = document.getElementById('posts-list');
            if (!postsList) return;

            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
            // Ordenar por fecha de creación descendente para que las nuevas publicaciones aparezcan arriba
            const q = query(postsCollectionRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, async (snapshot) => {
                // Get current post IDs to manage removals cleanly
                const existingPostIds = new Set();
                postsList.querySelectorAll('.forum-topic-card').forEach(card => {
                    existingPostIds.add(card.id.replace('post-', ''));
                });

                // Clear posts if the snapshot is empty (no posts yet) or if a post was explicitly removed
                if (snapshot.empty && existingPostIds.size > 0) {
                     postsList.innerHTML = '';
                } else if (snapshot.empty) {
                    // Display a message if there are genuinely no posts
                    postsList.innerHTML = `
                        <div class="forum-topic-card text-center text-gray-400 italic">
                            No hay publicaciones todavía. ¡Sé el primero en publicar!
                        </div>
                    `;
                }

                snapshot.docChanges().forEach(async (change) => {
                    const postData = { id: change.doc.id, ...change.doc.data() };
                    let postElement = document.getElementById(`post-${postData.id}`); // ID único para cada post

                    // Check if post data exists before rendering (useful if a doc was deleted before being fully processed)
                    if (!postData.title && !postData.content && change.type !== 'removed') {
                        if (postElement) postElement.remove(); // Remove if incomplete
                        return;
                    }

                    // Obtener datos del autor (nombre, foto de perfil, y ROL)
                    let authorName = postData.authorEmail || 'Usuario Anónimo';
                    let authorProfilePic = DEFAULT_PROFILE_PIC;
                    let authorRole = ''; // Default role
                    let roleTagHtml = ''; // HTML for the role tag

                    if (postData.authorId) {
                        const authorProfileRef = doc(db, `artifacts/${appId}/users`, postData.authorId);
                        const authorProfileSnap = await getDoc(authorProfileRef);
                        if (authorProfileSnap.exists()) {
                            const authorData = authorProfileSnap.data();
                            authorName = authorData.name || authorData.email || authorName;
                            authorProfilePic = authorData.profilePicUrl || DEFAULT_PROFILE_PIC;
                            authorRole = authorData.role ? authorData.role : 'user'; // Get actual role
                            
                            // Generate role tag HTML
                            const roleDisplay = authorRole.charAt(0).toUpperCase() + authorRole.slice(1);
                            roleTagHtml = `<span class="role-tag role-${authorRole.toLowerCase()}">${roleDisplay}</span>`;
                        }
                    }

                    // Formatear la hora de publicación
                    let postedTime = 'Hace un momento';
                    let fullPostedTime = '';
                    if (postData.createdAt) {
                        const date = postData.createdAt.toDate ? postData.createdAt.toDate() : new Date(postData.createdAt);
                        fullPostedTime = new Date(date).toLocaleString();
                        const diffMs = Date.now() - date.getTime();
                        const diffMins = Math.round(diffMs / (1000 * 60));
                        const diffHours = Math.round(diffMs / (1000 * 60 * 60));
                        const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

                        if (diffMins < 1) {
                            postedTime = 'Hace un momento';
                        } else if (diffMins < 60) {
                            postedTime = `${diffMins} min.`;
                        } else if (diffHours < 24) {
                            postedTime = `${diffHours} hr.`;
                        } else {
                            postedTime = `${diffDays} día(s).`;
                        }
                    }

                    // Contenido multimedia
                    let mediaContent = '';
                    if (postData.imageUrl) {
                        mediaContent += `<img src="${postData.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/FF0000/FFFFFF?text=IMAGEN+NO+CARGADA';" alt="Imagen de la publicación" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96">`;
                    }
                    if (postData.videoUrl) {
                        let embedUrl = postData.videoUrl;
                        // Basic YouTube URL parsing
                        if (postData.videoUrl.includes('youtube.com/watch?v=')) {
                            const videoId = postData.videoUrl.split('v=')[1].split('&')[0];
                            embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        } else if (postData.videoUrl.includes('youtu.be/')) {
                            const videoId = postData.videoUrl.split('youtu.be/')[1].split('?')[0];
                            embedUrl = `https://www.youtube.com/embed/${videoId}`;
                        }
                        mediaContent += `
                            <div class="relative w-full overflow-hidden rounded-lg mb-4" style="padding-top: 56.25%;">
                                <iframe class="absolute top-0 left-0 w-full h-full" src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        `;
                    }

                    const isAuthor = auth.currentUser && auth.currentUser.uid === postData.authorId;
                    const isAdmin = currentUserData && currentUserData.role === 'admin';

                    const deleteButtonHtml = (isAuthor || isAdmin) ?
                        `<button class="text-gray-400 hover:text-red-500 transition duration-200" onclick="deletePost('${postData.id}', '${postData.authorId}')">
                            <i class="fas fa-times text-lg"></i>
                        </button>` : '';
                    
                    const editButtonHtml = (isAuthor || isAdmin) ?
                        `<button class="text-gray-400 hover:text-orange-500 transition duration-200 ml-2" onclick="editPost('${postData.id}')">
                            <i class="fas fa-edit text-lg"></i>
                        </button>` : '';

                    // Construcción del HTML de la publicación
                    const postHtml = `
                        <div id="post-${postData.id}" class="forum-topic-card" data-author-id="${postData.authorId}">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center">
                                    <img src="${authorProfilePic}" alt="Foto de perfil de ${authorName}" class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-byte-accent-cyan">
                                    <div>
                                        <p class="font-semibold text-byte-accent-cyan text-base leading-tight">
                                            ${authorName}${roleTagHtml}
                                        </p>
                                        <p class="text-gray-400 text-xs" title="${fullPostedTime}">${postedTime} <i class="fas fa-globe-americas ml-1"></i></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="text-gray-400 hover:text-white transition duration-200" onclick="window.showMessage('Opciones de publicación en desarrollo.', 'blue');">
                                        <i class="fas fa-ellipsis-h text-lg"></i>
                                    </button>
                                    ${editButtonHtml}
                                    ${deleteButtonHtml}
                                </div>
                            </div>
                            <h3 class="text-xl font-bold text-byte-text-light mb-2">${postData.title || 'Publicación sin título'}</h3>
                            <p class="text-byte-text-light text-base mb-4">${postData.content}</p>
                            <div class="post-media-content">
                                ${mediaContent}
                            </div>

                            <!-- Post statistics/meta-info -->
                            <div class="text-gray-400 text-sm mt-3 flex justify-between items-center px-2 py-1 border-b border-gray-700 pb-3">
                                <span class="flex items-center">
                                    <i class="fas fa-thumbs-up mr-1"></i> <span id="likes-count-${postData.id}">${postData.likes ? postData.likes.length : 0}</span>
                                </span>
                                <span class="flex items-center">
                                    <span id="comments-count-${postData.id}">0</span> Comentarios
                                </span>
                            </div>

                            <!-- Interactive Action Buttons -->
                            <div class="flex justify-around items-center pt-3 mt-2 border-t border-gray-700">
                                <button class="flex items-center text-gray-400 hover:text-blue-500 transition duration-200 p-2 rounded-md like-button" data-post-id="${postData.id}">
                                    <i class="fas fa-thumbs-up mr-2"></i> Me gusta
                                </button>
                                <button class="flex items-center text-gray-400 hover:text-byte-accent-cyan transition duration-200 p-2 rounded-md comment-button" data-post-id="${postData.id}">
                                    <i class="fas fa-comment-dots mr-2"></i> Comentar
                                </button>
                                <button class="flex items-center text-gray-400 hover:text-green-500 transition duration-200 p-2 rounded-md share-button" onclick="window.showMessage('Compartir función en desarrollo.', 'blue');">
                                    <i class="fas fa-share mr-2"></i> Compartir
                                </button>
                            </div>

                            <!-- Comments Section -->
                            <div class="comments-section mt-6 p-4 bg-byte-dark-bg rounded-lg border border-gray-700">
                                <h4 class="text-lg font-semibold text-byte-accent-cyan mb-3">Comentarios:</h4>
                                <div id="comments-list-${postData.id}" class="space-y-3 mb-4">
                                    <!-- Los comentarios se cargarán aquí -->
                                </div>
                                <!-- Formulario para añadir comentario principal -->
                                <form class="add-comment-form" data-post-id="${postData.id}">
                                    <textarea class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-600 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-byte-accent-cyan text-sm" rows="2" placeholder="Añade un comentario..." required></textarea>
                                    <button type="submit" class="mt-2 bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200 text-sm">Comentar</button>
                                </form>
                            </div>
                        </div>
                    `;

                    if (change.type === 'added') {
                        if (!postElement) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = postHtml;
                            postElement = tempDiv.firstElementChild;
                            postsList.prepend(postElement); // Prepend to add new posts at the top
                        }
                    } else if (change.type === 'modified') {
                        if (postElement) {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = postHtml;
                            const newPostElement = tempDiv.firstElementChild;
                            postsList.replaceChild(newPostElement, postElement);
                            postElement = newPostElement;
                        }
                    } else if (change.type === 'removed') {
                        if (postElement) {
                            postElement.remove();
                        }
                    }

                    if (postElement) {
                        loadCommentsForPost(postData.id);
                        setupLikeButton(postData.id, postData.likes || []);

                        const commentButton = postElement.querySelector(`.comment-button[data-post-id="${postData.id}"]`);
                        if (commentButton) {
                            commentButton.onclick = (e) => {
                                const postId = e.currentTarget.dataset.postId;
                                const commentForm = document.querySelector(`.add-comment-form[data-post-id="${postId}"]`);
                                if (commentForm) {
                                    commentForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    commentForm.querySelector('textarea').focus();
                                }
                            };
                        }
                    }
                });
            });
        }

        // Función para cargar y mostrar comentarios de una publicación específica, ahora con replies anidados
        async function loadCommentsForPost(postId) {
            const commentsListElement = document.getElementById(`comments-list-${postId}`);
            const commentsCountElement = document.getElementById(`comments-count-${postId}`);
            if (!commentsListElement || !commentsCountElement) return;

            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts/${postId}/comments`);
            const q = query(commentsCollectionRef, orderBy('createdAt', 'asc'));

            onSnapshot(q, async (snapshot) => {
                commentsListElement.innerHTML = '';
                let allComments = [];
                snapshot.forEach(doc => {
                    allComments.push({ id: doc.id, ...doc.data() });
                });

                // Construir una estructura de árbol de comentarios (con 'parentId')
                const commentMap = new Map();
                allComments.forEach(comment => commentMap.set(comment.id, { ...comment, replies: [] }));

                const rootComments = [];
                allComments.forEach(comment => {
                    if (comment.parentId && commentMap.has(comment.parentId)) {
                        commentMap.get(comment.parentId).replies.push(commentMap.get(comment.id));
                    } else {
                        rootComments.push(commentMap.get(comment.id));
                    }
                });

                commentsCountElement.textContent = allComments.length; // Count all comments including replies

                const renderComment = async (comment, indentLevel = 0) => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('flex', 'items-start', 'bg-byte-secondary-dark', 'p-3', 'rounded-md', 'border', 'border-gray-800');
                    if (indentLevel > 0) {
                        commentElement.classList.add('nested-comment');
                    }

                    let authorName = comment.authorEmail || 'Anónimo';
                    let authorProfilePic = DEFAULT_PROFILE_PIC;
                    let authorRole = '';
                    let roleTagHtml = '';

                    if (comment.authorId) {
                        const authorProfileRef = doc(db, `artifacts/${appId}/users`, comment.authorId);
                        const authorProfileSnap = await getDoc(authorProfileRef);
                        if (authorProfileSnap.exists()) {
                            const authorData = authorProfileSnap.data();
                            authorName = authorData.name || authorData.email || authorName;
                            authorProfilePic = authorData.profilePicUrl || DEFAULT_PROFILE_PIC;
                            authorRole = authorData.role ? authorData.role : 'user'; // Get actual role
                            
                            // Generate role tag HTML
                            const roleDisplay = authorRole.charAt(0).toUpperCase() + authorRole.slice(1);
                            roleTagHtml = `<span class="role-tag role-${authorRole.toLowerCase()}">${roleDisplay}</span>`;
                        }
                    }

                    const isAdmin = currentUserData && currentUserData.role === 'admin';
                    const isAuthor = auth.currentUser && auth.currentUser.uid === comment.authorId;
                    const deleteCommentButtonHtml = (isAuthor || isAdmin) ?
                        `<button class="text-gray-400 hover:text-red-500 transition duration-200 ml-2" onclick="deleteComment('${postId}', '${comment.id}', '${comment.authorId}')">
                            <i class="fas fa-times text-sm"></i>
                        </button>` : '';

                    commentElement.innerHTML = `
                        <img src="${authorProfilePic}" alt="Foto de perfil de ${authorName}" class="w-8 h-8 rounded-full mr-3 object-cover border border-gray-700">
                        <div class="flex-1">
                            <p class="font-semibold text-byte-accent-cyan text-sm">
                                ${authorName}${roleTagHtml}
                                <span class="text-gray-400 text-xs ml-2">${new Date(comment.createdAt?.toDate ? comment.createdAt.toDate() : comment.createdAt).toLocaleString()}</span>
                                ${deleteCommentButtonHtml}
                            </p>
                            <p class="text-byte-text-light text-sm mt-1">${comment.content}</p>
                            <button class="text-blue-400 text-xs mt-2 hover:underline reply-button" data-post-id="${postId}" data-comment-id="${comment.id}" data-author-id="${comment.authorId}">Responder</button>
                            <div id="reply-form-container-${comment.id}" class="mt-2 hidden">
                                <form class="add-comment-form" data-post-id="${postId}" data-parent-id="${comment.id}">
                                    <textarea class="w-full p-2 rounded-md bg-byte-secondary-dark border border-gray-600 text-byte-text-light placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-byte-accent-cyan text-sm" rows="1" placeholder="Tu respuesta..." required></textarea>
                                    <button type="submit" class="mt-1 bg-green-600 text-white font-bold py-1 px-3 rounded-md hover:bg-green-700 transition duration-200 text-xs">Responder</button>
                                </form>
                            </div>
                        </div>
                    `;
                    commentsListElement.appendChild(commentElement);

                    // Añadir event listener para el botón de responder
                    const replyButton = commentElement.querySelector(`.reply-button[data-comment-id="${comment.id}"]`);
                    if (replyButton) {
                        replyButton.addEventListener('click', (e) => {
                            const replyFormContainer = document.getElementById(`reply-form-container-${comment.id}`);
                            if (replyFormContainer) {
                                replyFormContainer.classList.toggle('hidden');
                                if (!replyFormContainer.classList.contains('hidden')) {
                                    replyFormContainer.querySelector('textarea').focus();
                                }
                            }
                        });
                    }

                    // Renderizar las respuestas anidadas
                    for (const reply of comment.replies) {
                        await renderComment(reply, indentLevel + 1);
                    }
                };

                for (const comment of rootComments) {
                    await renderComment(comment, 0);
                }
            });
        }

        // Función para configurar el botón de "Me gusta"
        function setupLikeButton(postId, currentLikes) {
            const likeButton = document.querySelector(`.like-button[data-post-id="${postId}"]`);
            const likesCountSpan = document.getElementById(`likes-count-${postId}`);

            if (!likeButton || !likesCountSpan) return;

            const currentUserId = auth.currentUser ? auth.currentUser.uid : null;

            const updateLikeDisplay = (likesArray) => {
                const updatedUserLiked = likesArray.includes(currentUserId);
                likesCountSpan.textContent = likesArray.length;

                if (updatedUserLiked) {
                    likeButton.classList.remove('text-gray-400');
                    likeButton.classList.add('text-blue-500');
                } else {
                    likeButton.classList.remove('text-blue-500');
                    likeButton.classList.add('text-gray-400');
                }
            };

            updateLikeDisplay(currentLikes);

            const oldLikeButton = likeButton.cloneNode(true);
            likeButton.parentNode.replaceChild(oldLikeButton, likeButton);
            const newLikeButton = oldLikeButton;

            newLikeButton.onclick = async () => {
                if (!auth.currentUser) {
                    window.showMessage('Debes iniciar sesión para reaccionar.', 'red');
                    return;
                }

                const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                const postSnap = await getDoc(postRef);
                if (!postSnap.exists()) {
                    console.error("Post no encontrado para dar like:", postId);
                    window.showMessage('Error: la publicación no existe.', 'red');
                    return;
                }
                const currentLikesArray = postSnap.data().likes || [];
                const isCurrentlyLikedByUser = currentLikesArray.includes(currentUserId);

                let newLikesArray;
                if (isCurrentlyLikedByUser) {
                    newLikesArray = currentLikesArray.filter(uid => uid !== currentUserId);
                } else {
                    newLikesArray = [...currentLikesArray, currentUserId];
                }

                try {
                    await updateDoc(postRef, {
                        likes: newLikesArray
                    });
                } catch (error) {
                    console.error('Error al actualizar like:', error);
                    window.showMessage('Error al actualizar la reacción. Intenta de nuevo.', 'red');
                }
            };

            const postRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
            onSnapshot(postRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const updatedLikes = data.likes || [];
                    updateLikeDisplay(updatedLikes);
                }
            });
        }

        // Función para cargar y mostrar usuarios online
        async function loadOnlineUsers() {
            const onlineUsersList = document.getElementById('online-users-list');
            if (!onlineUsersList) return;

            const usersCollectionRef = collection(db, `artifacts/${appId}/users`);
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            const q = query(usersCollectionRef); 

            onSnapshot(q, async (snapshot) => {
                onlineUsersList.innerHTML = '';
                const onlineUsers = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData && userData.lastSeen) {
                        const lastSeenDate = userData.lastSeen.toDate ? userData.lastSeen.toDate() : new Date(userData.lastSeen);
                        if (lastSeenDate > fiveMinutesAgo) {
                            onlineUsers.push({ id: doc.id, ...userData });
                        }
                    }
                });

                if (onlineUsers.length === 0) {
                    onlineUsersList.innerHTML = `
                        <li class="text-gray-400 text-sm italic">No hay usuarios online en este momento.</li>
                    `;
                } else {
                    onlineUsers.forEach(user => {
                        const userElement = document.createElement('li');
                        userElement.classList.add('flex', 'items-center', 'text-byte-text-light', 'text-sm');
                        const profilePic = user.profilePicUrl || DEFAULT_PROFILE_PIC;
                        
                        const roleDisplay = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : '';
                        const roleTagHtml = user.role ? `<span class="role-tag role-${user.role.toLowerCase()}">${roleDisplay}</span>` : '';

                        userElement.innerHTML = `
                            <span class="relative flex h-3 w-3 mr-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </span>
                            <img src="${profilePic}" alt="Foto de perfil de ${user.name || user.email}" class="w-6 h-6 rounded-full mr-2 object-cover border border-green-500">
                            <span>${user.name || user.email}${roleTagHtml}</span>
                        `;
                        onlineUsersList.appendChild(userElement);
                    });
                }
            });
        }

        // Función para cargar las notificaciones del usuario
        async function loadNotifications() {
            const notificationCenter = document.getElementById('notification-center');
            const unreadCountSpan = document.getElementById('unread-notifications-count');

            if (!auth.currentUser || !notificationCenter || !unreadCountSpan) {
                if (unreadCountSpan) unreadCountSpan.textContent = '0';
                return;
            }

            const notificationsRef = collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/notifications`);
            const q = query(notificationsRef, orderBy('createdAt', 'desc')); // Ordenar por las más recientes

            onSnapshot(q, (snapshot) => {
                notificationCenter.innerHTML = ''; // Limpiar notificaciones existentes
                let unreadCount = 0;

                if (snapshot.empty) {
                    notificationCenter.innerHTML = '<div class="notification-item">No hay notificaciones.</div>';
                    unreadCountSpan.textContent = '0';
                    return;
                }

                snapshot.forEach(docSnap => {
                    const notification = docSnap.data();
                    const notificationId = docSnap.id;

                    if (!notification.read) {
                        unreadCount++;
                    }

                    const notificationItem = document.createElement('div');
                    notificationItem.classList.add('notification-item');
                    if (!notification.read) {
                        notificationItem.classList.add('unread');
                    }
                    notificationItem.innerHTML = `
                        <p>${notification.message}</p>
                        <p class="timestamp">${new Date(notification.createdAt?.toDate ? notification.createdAt.toDate() : notification.createdAt).toLocaleString()}</p>
                    `;
                    notificationItem.addEventListener('click', async () => {
                        // Marcar como leído al hacer clic
                        await updateDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/notifications`, notificationId), {
                            read: true
                        });
                        // Podrías redirigir al comentario/post relevante aquí
                        // window.location.href = `/post.html?postId=${notification.postId}#comment-${notification.commentId}`;
                        window.showMessage('Notificación marcada como leída.', 'blue');
                    });
                    notificationCenter.appendChild(notificationItem);
                });
                unreadCountSpan.textContent = unreadCount.toString();
            });
        }

        // Función para enviar una notificación (para cuando se responda a un comentario o por admin)
        async function sendNotification(targetUserId, message, postId = null, commentId = null) {
            if (!db) return; // Asegurarse de que Firebase esté inicializado

            const notificationsCollectionRef = collection(db, `artifacts/${appId}/users/${targetUserId}/notifications`);
            try {
                await addDoc(notificationsCollectionRef, {
                    message: message,
                    postId: postId,
                    commentId: commentId,
                    read: false,
                    createdAt: serverTimestamp()
                });
                console.log(`Notificación enviada a ${targetUserId}`);
            } catch (error) {
                console.error("Error al enviar notificación:", error);
                window.showMessage(`Error al enviar notificación a ${targetUserId}.`, 'red');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Firebase dentro de DOMContentLoaded
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log('Firebase: Aplicación y servicios inicializados correctamente.');
            } catch (error) {
                console.error("Error crítico al inicializar Firebase:", error);
                window.showMessage('Error crítico: No se pudo inicializar Firebase. Consulta la consola para más detalles.', 'red');
                // Asegurarse de que la página no se vea en blanco si Firebase falla
                const mainContentArea = document.querySelector('main');
                if (mainContentArea) {
                    mainContentArea.innerHTML = `
                        <div class="text-center p-8 bg-red-800 bg-opacity-70 rounded-lg shadow-lg">
                            <p class="text-xl text-white mb-4">No se pudo cargar la aplicación.</p>
                            <p class="text-md text-gray-200 mb-6">Parece que hay un problema con la conexión a Firebase o la configuración.</p>
                            <button onclick="location.reload()" class="bg-yellow-500 text-black font-bold py-2 px-4 rounded-full
                                            shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-110">
                                Recargar Página
                            </button>
                        </div>
                    `;
                }
                return; // Detener la ejecución si Firebase no se inicializa
            }


            const scrollToTopButton = document.getElementById('scroll-to-top-button');
            const mainHeader = document.getElementById('main-header');
            const actionBar = document.getElementById('action-bar');
            const mainEl = document.querySelector('main');

            // Lógica para el botón "Volver arriba"
            if (window) {
                window.addEventListener('scroll', () => {
                    const currentScrollY = window.scrollY;
                    if (currentScrollY > 0) {
                        if (scrollToTopButton) scrollToTopButton.classList.add('show');
                    } else {
                        if (scrollToTopButton) scrollToTopButton.classList.remove('show');
                    }
                });
            }
            if (scrollToTopButton) {
                scrollToTopButton.addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }

            // Function to toggle main's centering and padding for auth/forum views
            function toggleMainLayout(isAuthView) {
                if (mainEl) {
                    if (isAuthView) {
                        mainEl.classList.add('flex', 'items-center', 'justify-content', 'w-full', 'h-screen');
                        mainEl.style.padding = '0';
                        mainEl.style.overflow = 'hidden';
                    } else {
                        mainEl.classList.remove('flex', 'items-center', 'justify-content', 'w-full', 'h-screen');
                        // Adjust padding based on header height, especially for mobile
                        const headerHeight = mainHeader ? mainHeader.offsetHeight : 0;
                        mainEl.style.padding = '1rem'; // Default padding
                        mainEl.style.paddingTop = `${headerHeight + 20}px`; // Add some extra space
                        mainEl.style.overflow = '';
                    }
                }
            }


            // Elementos del DOM para autenticación y foro
            const forumContent = document.getElementById('forum-content');
            const authSection = document.getElementById('auth-section');
            const authFormsContainer = document.getElementById('auth-forms-container');
            const verificationScreen = document.getElementById('verification-screen');
            const videoBackground = document.getElementById('video-background');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const goToLoginBtn = document.getElementById('go-to-login-btn');
            const registerPasswordInput = document.getElementById('register-password');
            const registerConfirmPasswordInput = document.getElementById('register-confirm-password'); // New
            const passwordStrengthBar = document.getElementById('password-strength-bar');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const createPostForm = document.getElementById('create-post-form');
            const onlineUsersSidebar = document.getElementById('online-users-sidebar');
            const toggleOnlineUsersBtn = document.getElementById('toggle-online-users-btn');
            const notificationsButton = document.getElementById('notifications-button');
            const profileSettingsContainer = document.getElementById('profile-settings-container');
            const profilePicImg = document.getElementById('profile-pic-img');
            const profileSettingsButton = document.getElementById('profile-settings-button');
            const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
            const rulesButton = document.getElementById('rules-button');
            const adminButton = document.getElementById('admin-button'); // Botón de Admin
            const adminModal = document.getElementById('admin-modal'); // Modal de Admin
            const adminModalCloseBtn = document.getElementById('admin-modal-close-btn'); // Botón para cerrar modal
            const registeredUsersCountSpan = document.getElementById('registered-users-count'); // Contador de usuarios
            const adminAssignRoleBtn = document.getElementById('admin-assign-role-btn');
            const adminTargetUserIdInput = document.getElementById('admin-target-user-id');
            const adminAssignRoleSelect = document.getElementById('admin-assign-role-select');
            const adminToggleBanBtn = document.getElementById('admin-toggle-ban-btn');
            const adminBanUserIdInput = document.getElementById('admin-ban-user-id');
            const notificationCenter = document.getElementById('notification-center'); // Centro de notificaciones
            const unreadNotificationsCount = document.getElementById('unread-notifications-count'); // Contador de notificaciones

            // New profile settings elements
            const openProfileSettingsBtn = document.getElementById('open-profile-settings-btn');
            const profileSettingsModal = document.getElementById('profile-settings-modal');
            const profileSettingsModalCloseBtn = document.getElementById('profile-settings-modal-close-btn');
            const profileSettingsForm = document.getElementById('profile-settings-form');
            const profileNameInput = document.getElementById('profile-name');
            const profileLastnameInput = document.getElementById('profile-lastname');
            const profilePhoneInput = document.getElementById('profile-phone');
            const profileDobInput = document.getElementById('profile-dob');
            const profilePicUrlInput = document.getElementById('profile-pic-url-input');
            const profileEmailForm = document.getElementById('profile-email-form');
            const profileCurrentEmailInput = document.getElementById('profile-current-email');
            const profileNewEmailInput = document.getElementById('profile-new-email');
            const profileCurrentPasswordInput = document.getElementById('profile-current-password');
            const adminNotificationUserIdInput = document.getElementById('admin-notification-user-id');
            const adminNotificationMessageInput = document.getElementById('admin-notification-message');
            const adminSendNotificationBtn = document.getElementById('admin-send-notification-btn');

            // New password change elements
            const profilePasswordForm = document.getElementById('profile-password-form');
            const profileCurrentPasswordChangeInput = document.getElementById('profile-current-password-change');
            const profileNewPasswordInput = document.getElementById('profile-new-password');
            const profileConfirmNewPasswordInput = document.getElementById('profile-confirm-new-password');
            const newPasswordStrengthBar = document.getElementById('new-password-strength-bar');


            // Rules modal elements
            const rulesModal = document.getElementById('rules-modal');
            const rulesModalCloseBtn = document.getElementById('rules-modal-close-btn');

            // Video URL input (reverted from file upload)
            const postVideoUrlInput = document.getElementById('post-video-url');


            // Asegurarse de que el botón de estado de Firebase se obtenga aquí
            firebaseStatusButtonElement = document.getElementById('firebase-status-button');

            // Lógica para alternar la visibilidad de la barra lateral de usuarios online
            if (toggleOnlineUsersBtn) {
                toggleOnlineUsersBtn.addEventListener('click', () => {
                    if (onlineUsersSidebar) {
                        onlineUsersSidebar.classList.toggle('show-sidebar');
                        // Asegurarse de que el display esté en 'block' cuando se muestra y 'none' cuando se oculta
                        if (onlineUsersSidebar.classList.contains('show-sidebar')) {
                            onlineUsersSidebar.style.display = 'block';
                        } else {
                            onlineUsersSidebar.style.display = 'none';
                        }
                    }
                });
            }

            // Lógica para el menú desplegable del perfil/ajustes
            if (profileSettingsButton) {
                profileSettingsButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (profileDropdownMenu) {
                        profileDropdownMenu.classList.toggle('show');
                        // Asegurarse de que el centro de notificaciones y otros modales estén ocultos
                        if (notificationCenter) notificationCenter.classList.remove('show');
                        if (adminModal) adminModal.style.display = 'none';
                        if (rulesModal) rulesModal.style.display = 'none';
                        if (onlineUsersSidebar) { // Ocultar sidebar si está abierto
                            onlineUsersSidebar.classList.remove('show-sidebar');
                            onlineUsersSidebar.style.display = 'none';
                        }
                    }
                });
            }

            // Lógica para el botón de Notificaciones
            if (notificationsButton) {
                notificationsButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (notificationCenter) {
                        notificationCenter.classList.toggle('show');
                        // Asegurarse de que el menú de perfil y otros modales estén ocultos
                        if (profileDropdownMenu) profileDropdownMenu.classList.remove('show');
                        if (adminModal) adminModal.style.display = 'none';
                        if (rulesModal) rulesModal.style.display = 'none';
                        if (profileSettingsModal) profileSettingsModal.style.display = 'none';
                        if (onlineUsersSidebar) { // Ocultar sidebar si está abierto
                            onlineUsersSidebar.classList.remove('show-sidebar');
                            onlineUsersSidebar.style.display = 'none';
                        }
                    }
                });
            }

            // Cerrar menús desplegables y modales si se hace clic fuera de ellos
            document.addEventListener('click', (event) => {
                if (profileDropdownMenu && profileSettingsContainer && !profileSettingsContainer.contains(event.target)) {
                    profileDropdownMenu.classList.remove('show');
                }
                if (notificationCenter && notificationsButton && !notificationsButton.contains(event.target) && !notificationCenter.contains(event.target)) {
                    notificationCenter.classList.remove('show');
                }
                // Close modals if click outside
                if (adminModal && event.target === adminModal) {
                    adminModal.style.display = 'none';
                }
                if (profileSettingsModal && event.target === profileSettingsModal) {
                    profileSettingsModal.style.display = 'none';
                }
                 if (rulesModal && event.target === rulesModal) {
                    rulesModal.style.display = 'none';
                }
                 if (onlineUsersSidebar && !toggleOnlineUsersBtn.contains(event.target) && !onlineUsersSidebar.contains(event.target)) {
                    onlineUsersSidebar.classList.remove('show-sidebar');
                    onlineUsersSidebar.style.display = 'none';
                }
            });

            // Lógica para el botón de Admin
            if (adminButton) {
                adminButton.addEventListener('click', async () => {
                    if (adminModal) {
                        adminModal.style.display = 'flex'; // Mostrar el modal
                        // Ocultar otros menús/modales
                        if (profileDropdownMenu) profileDropdownMenu.classList.remove('show');
                        if (notificationCenter) notificationCenter.classList.remove('show');
                        if (rulesModal) rulesModal.style.display = 'none';
                        if (profileSettingsModal) profileSettingsModal.style.display = 'none';
                        if (onlineUsersSidebar) { // Ocultar sidebar si está abierto
                            onlineUsersSidebar.classList.remove('show-sidebar');
                            onlineUsersSidebar.style.display = 'none';
                        }

                        // Cargar el conteo de usuarios registrados
                        try {
                            const usersSnapshot = await getDocs(collection(db, `artifacts/${appId}/users`));
                            if (registeredUsersCountSpan) {
                                registeredUsersCountSpan.textContent = usersSnapshot.size;
                            }
                        } catch (error) {
                            console.error("Error al obtener el conteo de usuarios:", error);
                            window.showMessage("Error al cargar el conteo de usuarios.", "red");
                        }
                    }
                });
            }

            // Cerrar el modal de Admin
            if (adminModalCloseBtn) {
                adminModalCloseBtn.addEventListener('click', () => {
                    if (adminModal) {
                        adminModal.style.display = 'none';
                    }
                });
            }

            // Funcionalidad de Banear/Desbanear usuario para Admin
            if (adminToggleBanBtn) {
                adminToggleBanBtn.addEventListener('click', async () => {
                    const targetUserId = adminBanUserIdInput.value.trim();
                    if (!targetUserId) {
                        window.showMessage("Por favor, introduce un ID de usuario.", "red");
                        return;
                    }

                    if (!auth.currentUser || currentUserData.role !== 'admin') {
                        window.showMessage("No tienes permisos de administrador para realizar esta acción.", "red");
                        return;
                    }

                    if (targetUserId === auth.currentUser.uid) {
                        window.showMessage("No puedes banearte a ti mismo.", "red");
                        return;
                    }

                    try {
                        const targetUserRef = doc(db, `artifacts/${appId}/users`, targetUserId);
                        const targetUserSnap = await getDoc(targetUserRef);

                        if (!targetUserSnap.exists()) {
                            window.showMessage("Usuario no encontrado.", "red");
                            return;
                        }

                        const currentBanStatus = targetUserSnap.data().isBanned || false;
                        await updateDoc(targetUserRef, { isBanned: !currentBanStatus });
                        window.showMessage(`Usuario ${targetUserId} ha sido ${!currentBanStatus ? 'baneado' : 'desbaneado'} con éxito.`, "green");
                    } catch (error) {
                        console.error("Error al alternar baneo:", error);
                        window.showMessage("Error al alternar el estado de baneo.", "red");
                    }
                });
            }

            // Funcionalidad de Asignar Rol para Admin
            if (adminAssignRoleBtn) {
                adminAssignRoleBtn.addEventListener('click', async () => {
                    const targetUserId = adminTargetUserIdInput.value.trim();
                    const newRole = adminAssignRoleSelect.value;

                    if (!targetUserId) {
                        window.showMessage("Por favor, introduce un ID de usuario.", "red");
                        return;
                    }

                    if (!auth.currentUser || currentUserData.role !== 'admin') {
                        window.showMessage("No tienes permisos de administrador para realizar esta acción.", "red");
                        return;
                    }

                    if (targetUserId === auth.currentUser.uid) {
                        window.showMessage("No puedes cambiar tu propio rol a través de este panel.", "red");
                        return;
                    }

                    try {
                        const targetUserRef = doc(db, `artifacts/${appId}/users`, targetUserId);
                        const targetUserSnap = await getDoc(targetUserRef);

                        if (!targetUserSnap.exists()) {
                            window.showMessage("Usuario no encontrado.", "red");
                            return;
                        }

                        await updateDoc(targetUserRef, { role: newRole });
                        window.showMessage(`Rol de ${targetUserId} actualizado a ${newRole} con éxito.`, "green");
                    } catch (error) {
                        console.error("Error al asignar rol:", error);
                        window.showMessage("Error al asignar el rol.", "red");
                    }
                });
            }

            // Funcionalidad para que el admin envíe notificaciones por infracción
            if (adminSendNotificationBtn) {
                adminSendNotificationBtn.addEventListener('click', async () => {
                    const targetUserInput = adminNotificationUserIdInput.value.trim();
                    const notificationMessage = adminNotificationMessageInput.value.trim();

                    if (!targetUserInput || !notificationMessage) {
                        window.showMessage("ID/Email de usuario y mensaje son obligatorios.", "red");
                        return;
                    }

                    if (!auth.currentUser || currentUserData.role !== 'admin') {
                        window.showMessage("No tienes permisos de administrador para enviar notificaciones.", "red");
                        return;
                    }

                    let targetUserId = targetUserInput;
                    // Si el input parece un email, intentar encontrar el UID
                    if (targetUserInput.includes('@')) {
                        const usersRef = collection(db, `artifacts/${appId}/users`);
                        const q = query(usersRef, where("email", "==", targetUserInput));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            targetUserId = querySnapshot.docs[0].id;
                        } else {
                            window.showMessage("Usuario con ese correo electrónico no encontrado.", "red");
                            return;
                        }
                    }

                    try {
                        await sendNotification(targetUserId, `Notificación de Infracción: ${notificationMessage}`);
                        window.showMessage(`Notificación de infracción enviada a ${targetUserInput}.`, 'green');
                        adminNotificationUserIdInput.value = '';
                        adminNotificationMessageInput.value = '';
                    } catch (error) {
                        console.error("Error al enviar notificación de infracción:", error);
                        window.showMessage("Error al enviar notificación de infracción.", "red");
                    }
                });
            }

            // Lógica para el modal de Ajustes de Perfil
            if (openProfileSettingsBtn) {
                openProfileSettingsBtn.addEventListener('click', () => {
                    if (profileSettingsModal) {
                        profileSettingsModal.style.display = 'flex';
                        // Ocultar otros menús/modales
                        if (profileDropdownMenu) profileDropdownMenu.classList.remove('show');
                        if (notificationCenter) notificationCenter.classList.remove('show');
                        if (adminModal) adminModal.style.display = 'none';
                        if (rulesModal) rulesModal.style.display = 'none';
                        if (onlineUsersSidebar) { // Ocultar sidebar si está abierto
                            onlineUsersSidebar.classList.remove('show-sidebar');
                            onlineUsersSidebar.style.display = 'none';
                        }

                        // Rellenar el formulario con los datos actuales del usuario
                        if (currentUserData) {
                            profileNameInput.value = currentUserData.name || '';
                            profileLastnameInput.value = currentUserData.lastname || '';
                            profilePhoneInput.value = currentUserData.phone || '';
                            profilePicUrlInput.value = currentUserData.profilePicUrl || '';
                            profileCurrentEmailInput.value = currentUserData.email || '';
                            profileNewEmailInput.value = currentUserData.email || ''; // Initialize new email with current email
                            
                            // Formatear la fecha de nacimiento para el input type="date"
                            if (currentUserData.dob && currentUserData.dob.toDate) {
                                const dobDate = currentUserData.dob.toDate();
                                profileDobInput.value = dobDate.toISOString().split('T')[0];
                            } else if (currentUserData.dob) { // If it's already a string, assume it's inYYYY-MM-DD format
                                profileDobInput.value = currentUserData.dob;
                            }
                        }
                        // Limpiar campos de contraseña cada vez que se abre el modal
                        profileCurrentPasswordChangeInput.value = '';
                        profileNewPasswordInput.value = '';
                        profileConfirmNewPasswordInput.value = '';
                        if (newPasswordStrengthBar) newPasswordStrengthBar.style.width = '0%';
                    }
                });
            }

            if (profileSettingsModalCloseBtn) {
                profileSettingsModalCloseBtn.addEventListener('click', () => {
                    if (profileSettingsModal) {
                        profileSettingsModal.style.display = 'none';
                    }
                });
            }

            // Manejar el envío del formulario de Ajustes de Perfil
            if (profileSettingsForm) {
                profileSettingsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!auth.currentUser || !db) return;

                    const userId = auth.currentUser.uid;
                    const userProfileRef = doc(db, `artifacts/${appId}/users`, userId);

                    const updatedData = {
                        name: profileNameInput.value.trim(),
                        lastname: profileLastnameInput.value.trim(),
                        phone: profilePhoneInput.value.trim(),
                        profilePicUrl: profilePicUrlInput.value.trim() || DEFAULT_PROFILE_PIC,
                    };

                    // Handle date of birth: ensure it's stored consistently
                    const dobValue = profileDobInput.value.trim();
                    if (dobValue) {
                        updatedData.dob = dobValue; // Store asYYYY-MM-DD string
                    } else {
                        updatedData.dob = null; // Clear if empty
                    }

                    try {
                        await updateDoc(userProfileRef, updatedData);
                        // Update the currentUserData in memory for consistency
                        currentUserData = { ...currentUserData, ...updatedData };
                        window.showMessage('Perfil actualizado exitosamente.', 'green');
                        // Update profile picture in header immediately
                        if (profilePicImg) profilePicImg.src = updatedData.profilePicUrl;
                    } catch (error) {
                        console.error('Error al actualizar perfil:', error);
                        window.showMessage('Error al actualizar perfil. Intenta de nuevo.', 'red');
                    }
                });
            }

            // Manejar el envío del formulario de Cambio de Correo Electrónico
            if (profileEmailForm) {
                profileEmailForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!auth.currentUser || !db) return;

                    const user = auth.currentUser;
                    const newEmail = profileNewEmailInput.value.trim();
                    const currentPassword = profileCurrentPasswordInput.value;

                    if (!newEmail || !currentPassword) {
                        window.showMessage('Todos los campos son obligatorios.', 'red');
                        return;
                    }

                    if (newEmail === user.email) {
                        window.showMessage('El nuevo correo es el mismo que el actual.', 'blue');
                        return;
                    }

                    try {
                        // 1. Re-autenticar al usuario
                        const credential = EmailAuthProvider.credential(user.email, currentPassword);
                        await reauthenticateWithCredential(user, credential);
                        
                        // 2. Actualizar el correo electrónico
                        await updateEmail(user, newEmail);
                        
                        // 3. Enviar correo de verificación al nuevo email
                        await sendEmailVerification(user);

                        // 4. Actualizar el email en Firestore también
                        const userProfileRef = doc(db, `artifacts/${appId}/users`, user.uid);
                        await updateDoc(userProfileRef, { email: newEmail });

                        window.showMessage('Correo electrónico actualizado. Por favor, verifica tu nuevo correo.', 'green');
                        profileCurrentPasswordInput.value = ''; // Limpiar campo de contraseña
                        profileCurrentEmailInput.value = newEmail; // Actualizar el campo de correo actual
                        profileNewEmailInput.value = newEmail; // Resetear el campo del nuevo correo
                    } catch (error) {
                        console.error('Error al cambiar correo electrónico:', error);
                        let errorMessage = 'Error al cambiar correo electrónico.';
                        if (error.code === 'auth/wrong-password') {
                            errorMessage = 'Contraseña actual incorrecta.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'El nuevo correo electrónico es inválido.';
                        } else if (error.code === 'auth/email-already-in-use') {
                            errorMessage = 'El nuevo correo electrónico ya está en uso.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            errorMessage = 'Por favor, cierra sesión y vuelve a iniciar sesión para cambiar tu correo.';
                        }
                        window.showMessage(errorMessage, 'red');
                    }
                });
            }

            // Manejar el envío del formulario de Cambio de Contraseña
            if (profilePasswordForm) {
                profilePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!auth.currentUser || !db) return;

                    const user = auth.currentUser;
                    const currentPassword = profileCurrentPasswordChangeInput.value;
                    const newPassword = profileNewPasswordInput.value;
                    const confirmNewPassword = profileConfirmNewPasswordInput.value;

                    if (!currentPassword || !newPassword || !confirmNewPassword) {
                        window.showMessage('Todos los campos son obligatorios.', 'red');
                        return;
                    }

                    if (newPassword !== confirmNewPassword) {
                        window.showMessage('La nueva contraseña y su confirmación no coinciden.', 'red');
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        window.showMessage('La nueva contraseña debe tener al menos 6 caracteres.', 'red');
                        return;
                    }

                    try {
                        // 1. Re-autenticar al usuario
                        const credential = EmailAuthProvider.credential(user.email, currentPassword);
                        await reauthenticateWithCredential(user, credential);
                        
                        // 2. Actualizar la contraseña
                        await updatePassword(user, newPassword);

                        window.showMessage('Contraseña actualizada exitosamente.', 'green');
                        // Limpiar campos de contraseña
                        profileCurrentPasswordChangeInput.value = '';
                        profileNewPasswordInput.value = '';
                        profileConfirmNewPasswordInput.value = '';
                        if (newPasswordStrengthBar) newPasswordStrengthBar.style.width = '0%';
                    } catch (error) {
                        console.error('Error al cambiar contraseña:', error);
                        let errorMessage = 'Error al cambiar contraseña.';
                        if (error.code === 'auth/wrong-password') {
                            errorMessage = 'Contraseña actual incorrecta.';
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = 'La nueva contraseña es demasiado débil.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            errorMessage = 'Por favor, cierra sesión y vuelve a iniciar sesión para cambiar tu contraseña.';
                        }
                        window.showMessage(errorMessage, 'red');
                    }
                });

                // Añadir evento para la barra de seguridad de la nueva contraseña
                if (profileNewPasswordInput) {
                    profileNewPasswordInput.addEventListener('input', (e) => {
                        checkPasswordStrength(e.target.value, newPasswordStrengthBar);
                    });
                }
            }


            // Lógica para el modal de Reglas del Foro
            if (rulesButton) {
                rulesButton.addEventListener('click', () => {
                    if (rulesModal) {
                        rulesModal.style.display = 'flex';
                        // Ocultar otros menús/modales
                        if (profileDropdownMenu) profileDropdownMenu.classList.remove('show');
                        if (notificationCenter) notificationCenter.classList.remove('show');
                        if (adminModal) adminModal.style.display = 'none';
                        if (profileSettingsModal) profileSettingsModal.style.display = 'none';
                        if (onlineUsersSidebar) { // Ocultar sidebar si está abierto
                            onlineUsersSidebar.classList.remove('show-sidebar');
                            onlineUsersSidebar.style.display = 'none';
                        }
                    }
                });
            }
            if (rulesModalCloseBtn) {
                rulesModalCloseBtn.addEventListener('click', () => {
                    if (rulesModal) {
                        rulesModal.style.display = 'none';
                    }
                });
            }


            // Manejar el estado de autenticación
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Cargar los datos del perfil del usuario, incluyendo el rol y el estado de baneo
                    if (db) {
                        const userProfileRef = doc(db, `artifacts/${appId}/users`, user.uid);
                        try {
                            const userSnap = await getDoc(userProfileRef);
                            if (userSnap.exists()) {
                                currentUserData = userSnap.data();
                                // Si el usuario está baneado, cerrar sesión inmediatamente y mostrar mensaje
                                if (currentUserData.isBanned) {
                                    window.showMessage('Tu cuenta ha sido baneada. Contacta al administrador.', 'red');
                                    handleLogout(); // Cerrar sesión
                                    return; // Detener la ejecución
                                }
                                await updateDoc(userProfileRef, { lastSeen: serverTimestamp() });
                            } else {
                                // Crear un perfil básico si no existe, con rol por defecto 'user'
                                currentUserData = {
                                    email: user.email,
                                    name: user.email.split('@')[0],
                                    lastname: '', // Default empty
                                    phone: '', // Default empty
                                    dob: null, // Default empty
                                    lastSeen: serverTimestamp(),
                                    profilePicUrl: DEFAULT_PROFILE_PIC,
                                    role: 'user', // Rol por defecto
                                    isBanned: false // Estado de baneo por defecto
                                };
                                await setDoc(userProfileRef, currentUserData, { merge: true });
                            }
                            clearInterval(onlineUsersInterval);
                            onlineUsersInterval = setInterval(updateLastSeen, 30000);
                        } catch (error) {
                            console.error("Error al establecer/actualizar lastSeen o cargar perfil al iniciar sesión:", error);
                            window.showMessage("Error al cargar tu perfil de usuario.", "red");
                            // Si hay un error grave al cargar el perfil, es posible que el usuario no pueda continuar
                            handleLogout();
                            return;
                        }
                    }

                    if (user.emailVerified) {
                        console.log('Firebase Auth: Usuario autenticado y correo verificado', user.uid);
                        
                        toggleMainLayout(false); // Ajustar layout para el foro
                        if (forumContent) forumContent.classList.remove('hidden');
                        if (authSection) authSection.classList.add('hidden'); // Usa authSection como contenedor principal
                        if (videoBackground) videoBackground.classList.add('hidden'); // Ocultar el video de fondo
                        
                        if (actionBar) actionBar.classList.remove('hidden'); // Mostrar la barra de acciones
                        // onlineUsersSidebar should stay hidden until clicked
                        if (onlineUsersSidebar) onlineUsersSidebar.classList.remove('show-sidebar'); // Ensure it's hidden on login
                        if (onlineUsersSidebar) onlineUsersSidebar.style.display = 'none';

                        // Mostrar botón de Admin si el rol es 'admin'
                        if (adminButton && currentUserData && currentUserData.role === 'admin') {
                            adminButton.classList.remove('hidden');
                        } else if (adminButton) {
                            adminButton.classList.add('hidden');
                        }

                        if (profilePicImg) profilePicImg.src = currentUserData.profilePicUrl || DEFAULT_PROFILE_PIC; // Actualizar foto de perfil

                        if (firebaseStatusButtonElement) {
                            firebaseStatusButtonElement.textContent = 'FORO (Activo)';
                            firebaseStatusButtonElement.classList.remove('bg-red-500', 'bg-gray-500');
                            firebaseStatusButtonElement.classList.add('bg-green-500');
                        }

                        loadPosts();
                        loadOnlineUsers();
                        loadNotifications(); // Cargar notificaciones al iniciar sesión

                    } else {
                        console.log('Firebase Auth: Usuario autenticado, pero correo NO verificado.', user.uid);
                        toggleMainLayout(true); // Ajustar layout para autenticación
                        if (forumContent) forumContent.classList.add('hidden');
                        if (authSection) authSection.classList.remove('hidden'); // Mostrar authSection
                        if (authFormsContainer) authFormsContainer.classList.add('hidden'); // Ocultar formularios dentro
                        if (verificationScreen) {
                            verificationScreen.classList.remove('hidden'); // Mostrar pantalla de verificación
                            if (verificationScreen.querySelector('h2')) verificationScreen.querySelector('h2').textContent = '¡Verifica tu Correo Electrónico!';
                            if (verificationScreen.querySelector('p:nth-of-type(1)')) verificationScreen.querySelector('p:nth-of-type(1)').textContent = 'Necesitas verificar tu dirección de correo electrónico para acceder al foro.';
                            if (verificationScreen.querySelector('p:nth-of-type(2)')) verificationScreen.querySelector('p:nth-of-type(2)').textContent = 'Revisa tu bandeja de entrada o la carpeta de spam para el enlace de verificación.';
                            if (goToLoginBtn) goToLoginBtn.textContent = 'Volver a Iniciar Sesión';
                        }
                        if (videoBackground) videoBackground.classList.remove('hidden'); // Mostrar video
                        
                        if (actionBar) actionBar.classList.add('hidden'); // Ocultar la barra de acciones
                        if (onlineUsersSidebar) { // Ocultar sidebar
                            onlineUsersSidebar.classList.remove('show-sidebar');
                            onlineUsersSidebar.style.display = 'none';
                        }
                        if (adminButton) adminButton.classList.add('hidden'); // Ocultar botón de admin
                        if (notificationCenter) notificationCenter.classList.remove('show'); // Ocultar notificaciones


                        if (firebaseStatusButtonElement) {
                            firebaseStatusButtonElement.textContent = 'FORO (Verifica Email)';
                            firebaseStatusButtonElement.classList.remove('bg-green-500', 'bg-gray-500');
                            firebaseStatusButtonElement.classList.add('bg-red-500');
                        }
                    }

                } else {
                    // Usuario NO autenticado, mostrar la sección de autenticación y ocultar el foro.
                    console.log('Firebase Auth: Usuario no autenticado. Mostrando sección de autenticación.');
                    toggleMainLayout(true); // Ajustar layout para autenticación

                    if (forumContent) forumContent.classList.add('hidden');
                    if (authSection) authSection.classList.remove('hidden'); // Mostrar authSection
                    if (authFormsContainer) authFormsContainer.classList.remove('hidden'); // Asegurarse de que el formulario de login/register esté visible
                    if (verificationScreen) verificationScreen.classList.add('hidden'); // Ocultar pantalla de verificación
                    if (videoBackground) videoBackground.classList.remove('hidden'); // Mostrar video

                    if (actionBar) actionBar.classList.add('hidden'); // Ocultar la barra de acciones
                    if (onlineUsersSidebar) { // Ocultar sidebar
                        onlineUsersSidebar.classList.remove('show-sidebar');
                        onlineUsersSidebar.style.display = 'none';
                    }
                    if (adminButton) adminButton.classList.add('hidden'); // Ocultar botón de admin
                    if (notificationCenter) notificationCenter.classList.remove('show'); // Ocultar notificaciones


                    if (firebaseStatusButtonElement) {
                        firebaseStatusButtonElement.textContent = 'FORO (Inactivo)';
                        firebaseStatusButtonElement.classList.remove('bg-green-500', 'bg-gray-500');
                        firebaseStatusButtonElement.classList.add('bg-red-500');
                    }

                    // Asegurarse de que el formulario de inicio de sesión se muestre por defecto
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (registerForm) registerForm.classList.add('hidden');
                    if (loginTab) loginTab.classList.add('active');
                    if (registerTab) registerTab.classList.remove('active');
                }
            });

            // Lógica para alternar entre formularios de Iniciar Sesión y Registro
            const showForm = (formToShow) => {
                if (authFormsContainer) authFormsContainer.classList.remove('hidden');
                if (verificationScreen) verificationScreen.classList.add('hidden');
                if (formToShow === 'login') {
                    if (loginForm) loginForm.classList.remove('hidden');
                    if (registerForm) registerForm.classList.add('hidden');
                    if (loginTab) loginTab.classList.add('active');
                    if (registerTab) registerTab.classList.remove('active');
                } else {
                    if (registerForm) registerForm.classList.remove('hidden');
                    if (loginForm) loginForm.classList.add('hidden');
                    if (registerTab) registerTab.classList.add('active');
                    if (loginTab) loginTab.classList.remove('active');
                }
            };

            // Event listeners para los botones de las pestañas
            if (loginTab) loginTab.addEventListener('click', () => showForm('login'));
            if (registerTab) registerTab.addEventListener('click', () => showForm('register'));
            if (goToLoginBtn) goToLoginBtn.addEventListener('click', () => showForm('login'));

            // Función para evaluar la seguridad de la contraseña
            const checkPasswordStrength = (password, strengthBarElement) => {
                let strength = 0;
                if (password.length > 7) strength++;
                if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
                if (password.match(/\d/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;

                if (strengthBarElement) {
                    strengthBarElement.className = '';
                    if (strength === 0) {
                        strengthBarElement.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
                        strengthBarElement.style.width = '0%';
                    } else if (strength < 2) {
                        strengthBarElement.classList.add('strength-weak');
                    } else if (strength < 4) {
                        strengthBarElement.classList.add('strength-medium');
                    } else {
                        strengthBarElement.classList.add('strength-strong');
                    }
                }
            };

            if (registerPasswordInput) {
                registerPasswordInput.addEventListener('input', (e) => {
                    checkPasswordStrength(e.target.value, passwordStrengthBar);
                });
            }

            // Manejo del envío del formulario de REGISTRO
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log('Intento de envío de formulario de registro.');

                    const email = registerForm.elements['email'].value;
                    const password = registerForm.elements['password'].value;
                    const confirmPassword = registerForm.elements['confirm_password'].value; // New
                    const name = registerForm.elements['name'].value;
                    const lastname = registerForm.elements['lastname'].value;
                    const phone = registerForm.elements['phone'].value;
                    const age = registerForm.elements['age'].value;
                    const role = registerForm.elements['role'].value;
                    const profilePicUrl = registerForm.elements['profile_pic_url'].value; // Ahora es opcional URL

                    if (password !== confirmPassword) {
                        window.showMessage('Las contraseñas no coinciden.', 'red');
                        return; // Prevent form submission
                    }

                    if (!auth || !db) {
                        window.showMessage('Firebase no está inicializado. Por favor, revisa la configuración.', 'red');
                        return;
                    }
                    
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        await sendEmailVerification(user);
                        window.showMessage('¡Registro exitoso! Correo de verificación enviado.', 'green');

                        // Por defecto el primer usuario registrado es 'admin', los demás son 'user'
                        const usersRef = collection(db, `artifacts/${appId}/users`);
                        const usersSnapshot = await getDocs(usersRef);
                        const isFirstUser = usersSnapshot.empty;
                        const assignedRole = isFirstUser ? 'admin' : (role.trim() ? role : 'user'); // Si no elige rol, es 'user'

                        await setDoc(doc(db, `artifacts/${appId}/users`, user.uid), {
                            email: email,
                            name: name,
                            lastname: lastname,
                            phone: phone,
                            age: parseInt(age),
                            role: assignedRole, // Asignar el rol
                            profilePicUrl: profilePicUrl.trim() ? profilePicUrl : DEFAULT_PROFILE_PIC, // Usa URL o el default
                            createdAt: serverTimestamp(),
                            lastSeen: serverTimestamp(),
                            isBanned: false // Por defecto no está baneado
                        });
                        console.log('Datos de usuario guardados en Firestore para:', user.uid);

                        if (authFormsContainer) authFormsContainer.classList.add('hidden');
                        if (verificationScreen) verificationScreen.classList.remove('hidden');

                    } catch (error) {
                        console.error('Error al registrar usuario:', error);
                        let errorMessage = 'Error al registrar usuario. Intenta de nuevo.';
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage = 'El correo electrónico ya está registrado.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'El formato del correo electrónico es inválido.';
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage = 'La contraseña es demasiado débil (debe tener al menos 6 caracteres).';
                        }
                        window.showMessage(errorMessage, 'red');
                    }
                });
            }

            // Manejo del envío del formulario de INICIAR SESIÓN
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const email = loginForm.elements['email'].value;
                    const password = loginForm.elements['password'].value;

                    if (!auth) {
                        window.showMessage('Firebase no está inicializado. Por favor, revisa la configuración.', 'red');
                        return;
                    }

                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;

                        // Verificar si el usuario está baneado después de iniciar sesión
                        const userProfileRef = doc(db, `artifacts/${appId}/users`, user.uid);
                        const userProfileSnap = await getDoc(userProfileRef);
                        if (userProfileSnap.exists() && userProfileSnap.data().isBanned) {
                            await signOut(auth); // Cerrar sesión si está baneado
                            window.showMessage('Tu cuenta ha sido baneada. Contacta al administrador.', 'red');
                            return;
                        }

                        window.showMessage('¡Inicio de sesión exitoso!', 'green');
                        console.log('Usuario ha iniciado sesión.');
                    } catch (error) {
                        console.error('Error al iniciar sesión:', error);
                        let errorMessage = 'Error al iniciar sesión. Verifica tus credenciales.';
                        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            errorMessage = 'Correo o contraseña incorrectos.';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage = 'El formato del correo electrónico es inválido.';
                        }
                        window.showMessage(errorMessage, 'red');
                    }
                });
            }

            // Lógica para el botón de "Olvidaste tu contraseña"
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', () => {
                    window.showMessage('La función de recuperación de contraseña está en desarrollo.', 'blue');
                });
            }

            // Lógica para publicaciones y comentarios
            if (createPostForm) {
                createPostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!auth.currentUser) {
                        window.showMessage('Debes iniciar sesión para crear una publicación.', 'red');
                        return;
                    }

                    const postTitle = createPostForm.elements['post-title'].value; // Nuevo campo de título
                    const postContent = createPostForm.elements['post-content'].value;
                    const postImageUrl = createPostForm.elements['post-image-url'].value;
                    const postVideoUrl = postVideoUrlInput.value; // Obtener la URL del campo de video

                    if (!postTitle.trim()) {
                        window.showMessage('El título de la publicación no puede estar vacío.', 'red');
                        return;
                    }
                    if (!postContent.trim()) {
                        window.showMessage('El contenido de la publicación no puede estar vacío.', 'red');
                        return;
                    }

                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), {
                            authorId: auth.currentUser.uid,
                            authorEmail: auth.currentUser.email,
                            title: postTitle, // Guardar el título
                            content: postContent,
                            imageUrl: postImageUrl.trim() ? postImageUrl : null,
                            videoUrl: postVideoUrl.trim() ? postVideoUrl : null, // Guardar la URL del video
                            createdAt: serverTimestamp(),
                            likes: []
                        });
                        window.showMessage('Publicación creada exitosamente.', 'green');
                        createPostForm.reset();
                    } catch (error) {
                        console.error('Error al crear publicación:', error);
                        window.showMessage('Error al crear publicación. Intenta de nuevo.', 'red');
                    }
                });
            }

            // Delegación de eventos para los formularios de comentarios (incluyendo respuestas anidadas)
            document.addEventListener('submit', async (e) => {
                if (e.target.classList.contains('add-comment-form')) {
                    e.preventDefault();

                    if (!auth.currentUser) {
                        window.showMessage('Debes iniciar sesión para comentar.', 'red');
                        return;
                    }

                    const postId = e.target.dataset.postId;
                    const parentId = e.target.dataset.parentId || null; // Si es una respuesta, tendrá parentId
                    const commentContent = e.target.querySelector('textarea').value;

                    if (!commentContent.trim()) {
                        window.showMessage('El comentario no puede estar vacío.', 'red');
                        return;
                    }

                    try {
                        const newCommentRef = await addDoc(collection(db, `artifacts/${appId}/public/data/posts/${postId}/comments`), {
                            authorId: auth.currentUser.uid,
                            authorEmail: auth.currentUser.email,
                            content: commentContent,
                            createdAt: serverTimestamp(),
                            parentId: parentId // Almacenar el parentId para comentarios anidados
                        });
                        window.showMessage('Comentario añadido.', 'green');
                        e.target.reset();

                        // Si es una respuesta a un comentario, enviar notificación al autor del comentario padre
                        if (parentId) {
                            const parentCommentRef = doc(db, `artifacts/${appId}/public/data/posts/${postId}/comments`, parentId);
                            const parentCommentSnap = await getDoc(parentCommentRef);
                            if (parentCommentSnap.exists()) {
                                const parentCommentAuthorId = parentCommentSnap.data().authorId;
                                const parentCommentAuthorEmail = parentCommentSnap.data().authorEmail;

                                // Asegurarse de no enviarse una notificación a sí mismo
                                if (parentCommentAuthorId !== auth.currentUser.uid) {
                                    const notificationMessage = `${auth.currentUser.email.split('@')[0]} respondió a tu comentario en "${postId}"`;
                                    sendNotification(parentCommentAuthorId, notificationMessage, postId, parentId);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error al añadir comentario:', error);
                        window.showMessage('Error al añadir comentario. Intenta de nuevo.', 'red');
                    }
                }
            });

            // Update main's padding-top on window resize and initial load
            const updateMainPadding = () => {
                if (mainEl && mainHeader) {
                    const headerHeight = mainHeader.offsetHeight;
                    // Adjusted padding for mobile responsiveness
                    if (window.innerWidth < 768) { // Assuming 768px is the mobile breakpoint
                        mainEl.style.paddingTop = `${headerHeight + 20}px`;
                        mainEl.style.paddingLeft = '1rem';
                        mainEl.style.paddingRight = '1rem';
                    } else {
                        mainEl.style.paddingTop = `${headerHeight + 20}px`; // Default for desktop
                        mainEl.style.paddingLeft = '2rem';
                        mainEl.style.paddingRight = '2rem';
                    }
                }
            };

            // Call on initial load
            updateMainPadding();
            // Call on window resize
            window.addEventListener('resize', updateMainPadding);

            // Lógica para la barra de navegación dinámica (ocultar/mostrar al desplazar)
            let lastScrollY = 0;
            const headerHeight = mainHeader.offsetHeight; // Altura del encabezado

            window.addEventListener('scroll', () => {
                if (mainHeader) {
                    const currentScrollY = window.scrollY;

                    // Detectar dirección de desplazamiento
                    if (currentScrollY > lastScrollY && currentScrollY > headerHeight) {
                        // Desplazándose hacia abajo y ya pasó la altura del encabezado
                        mainHeader.classList.add('header-hidden');
                    } else if (currentScrollY < lastScrollY) {
                        // Desplazándose hacia arriba
                        mainHeader.classList.remove('header-hidden');
                    }
                    lastScrollY = currentScrollY;
                }
            });
        });
    </script>
</body>
</html>
