<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foro de Byte - Tu comunidad digital</title>

    <link rel="icon" type="image/png" href="logo.png">
    <meta name="description" content="Foro oficial de Byte - Conéctate con nuestra comunidad, comparte ideas y obtén soporte.">
    <meta name="keywords" content="Byte, foro, comunidad, soporte, preguntas, respuestas, tecnología, diseño web, Venezuela">
    <meta name="author" content="Byte">
    <meta property="og:title" content="Foro de Byte - Comunidad y Soporte">
    <meta property="og:description" content="Un espacio para discutir, aprender y colaborar con la comunidad de Byte.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'byte-dark-bg': '#0A0A1A',
                        'byte-secondary-dark': '#1A202C',
                        'byte-text-light': '#F9FAFB',
                        'byte-accent-cyan': '#00FFFF',
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A0A1A;
            color: #F9FAFB;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            color: #00FFFF;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        .text-stroke-cyan {
            -webkit-text-stroke: 1.5px #00FFFF;
            text-stroke: 1.5px #00FFFF;
            color: #FFFFFF;
            text-shadow: none;
        }
        img {
            pointer-events: none;
        }
        p, h1, h2, h3, h4, h5, h6, span, div:not(.map-container):not(.payment-card) {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        /* Header styles */
        .header-main {
            transition: transform 0.3s ease-out;
        }
        .header-main.header-hidden {
            transform: translateY(-100%);
        }

        /* Forum specific styles */
        .forum-category-card {
            background: linear-gradient(145deg, #1A202C, #0A0A1A);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .forum-category-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 30px rgba(0, 255, 255, 0.3);
            border-color: #00FFFF;
        }

        .forum-category-card .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #00FFFF;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .forum-category-card h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #F9FAFB;
        }

        .forum-category-card p {
            font-size: 0.9rem;
            color: #CBD5E0;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .forum-topic-item {
            background-color: #1A202C;
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer;
        }

        .forum-topic-item:hover {
            background-color: #2D3748;
            transform: translateX(5px);
        }

        .forum-topic-item .title {
            font-weight: 600;
            color: #00FFFF;
            font-size: 1.05rem;
            margin-bottom: 0.5rem;
        }

        .forum-topic-item .meta {
            font-size: 0.85rem;
            color: #CBD5E0;
            text-align: left;
            width: 100%;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .forum-topic-item .meta span {
            display: inline-block;
            margin-right: 1rem;
        }

        .new-topic-button {
            background-color: #00FFFF;
            color: #0A0A1A;
            font-weight: bold;
            padding: 0.8rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .new-topic-button:hover {
            background-color: #00BFFF;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.6);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background-color: #1A202C;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
            border: 1px solid #00FFFF;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #00FFFF;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-button:hover {
            color: #00BFFF;
        }

        .modal textarea, .modal input[type="text"], .modal input[type="email"], .modal input[type="password"], .modal input[type="url"], .modal input[type="tel"], .modal input[type="date"], .modal input[type="color"] {
            background-color: #1A202C;
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #F9FAFB;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            margin-bottom: 1rem;
        }

        .modal button[type="submit"] {
            background-color: #00FFFF;
            color: #0A0A1A;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .modal button[type="submit"]:hover {
            background-color: #00BFFF;
        }

        /* User ID display */
        .user-id-display {
            background-color: #1A202C;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #CBD5E0;
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        /* Animations for icons */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        .animate-pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #EF4444; /* Red */
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 9999px; /* Full circle */
            padding: 0.1rem 0.4rem;
            min-width: 1.2rem;
            text-align: center;
            pointer-events: none; /* Allow clicks to pass through to the button */
        }
    </style>
</head>
<body>

    <!-- Video background, visible when not logged in -->
    <video autoplay loop muted playsinline id="video-background" class="absolute inset-0 w-full h-full object-cover z-0">
        <source src="./images/fondo.mp4" type="video/mp4">
        Tu navegador no soporta el video.
    </video>

    <!-- Authentication Modal Overlay -->
    <div id="auth-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40">
        <div class="bg-byte-secondary-dark p-8 rounded-lg shadow-2xl max-w-md w-full text-center relative border border-byte-accent-cyan/50">
            <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-byte-accent-cyan">Iniciar Sesión</h2>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="auth-name" placeholder="Nombre (obligatorio al registrarse)" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan hidden">
                <input type="email" id="auth-email" placeholder="Correo Electrónico" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="password" id="auth-password" placeholder="Contraseña" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="tel" id="auth-phone" placeholder="Número de Teléfono (opcional)" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan hidden">
                
                <div class="flex items-center justify-center text-sm text-gray-400 mt-4 hidden">
                    <input type="checkbox" id="auth-rules-accept" class="mr-2 rounded text-byte-accent-cyan focus:ring-byte-accent-cyan">
                    <label for="auth-rules-accept">Acepto las <a href="#" id="auth-rules-link" class="text-byte-accent-cyan hover:underline">Reglas del Foro</a></label>
                </div>

                <button type="submit" id="auth-submit-button" class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">Iniciar Sesión</button>
                <p class="text-sm text-gray-400 mt-4">
                    <a href="#" id="forgot-password-link" class="text-byte-accent-cyan hover:underline">¿Olvidaste tu contraseña?</a>
                </p>
                <button type="button" id="resend-verification-email-button" class="w-full bg-blue-500 text-white py-3 rounded-md font-semibold hover:bg-blue-600 transition duration-200 mt-2 hidden">
                    Reenviar Correo de Verificación
                </button>
                <p class="text-sm text-gray-400 mt-4">
                    <span id="auth-toggle-text">¿No tienes una cuenta?</span>
                    <button type="button" id="auth-toggle-button" class="text-byte-accent-cyan hover:underline ml-1">Regístrate</button>
                </p>
                <p id="auth-message" class="text-red-400 text-sm mt-2 hidden"></p>
            </form>
        </div>
    </div>

    <header class="bg-byte-dark-bg text-byte-text-light py-4 shadow-lg sticky top-0 z-50 border-b border-byte-accent-cyan">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-byte-accent-cyan">Foro de Byte</h1>
            <div class="flex space-x-4">
                <button id="rules-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-110 text-sm">
                    Reglas
                </button>
                <button id="notifications-button" class="hidden bg-purple-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-110 text-sm flex items-center justify-center relative">
                    <i class="fas fa-bell text-lg"></i>
                    <span id="notification-badge" class="notification-badge hidden">0</span>
                </button>
                <button id="settings-button" class="hidden bg-gray-700 text-white py-2 px-4 rounded-full shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-110 text-sm flex items-center justify-center">
                    <i class="fas fa-cog text-lg"></i>
                </button>
                <button id="admin-chat-view-button" class="hidden bg-orange-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-orange-700 transition duration-300 transform hover:scale-110 text-sm">
                    <i class="fas fa-eye mr-1"></i> Ver Chats
                </button>
                <button id="logout-button-header" class="hidden bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-110 text-sm">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow">
        <!-- Forum content, hidden until logged in -->
        <div id="forum-content-wrapper" class="hidden py-8">
            <section id="top" class="relative bg-byte-dark-bg text-white py-16 md:py-24 overflow-hidden flex items-center justify-center">
                <div class="container mx-auto px-4 relative z-10 text-center">
                    <h1 class="text-3xl md:text-5xl lg:text-4xl font-extrabold leading-tight mb-4 text-white drop-shadow-lg text-stroke-cyan">
                        Bienvenido al Foro de Byte
                    </h1>
                    <p class="text-base md:text-xl lg:text-lg mb-8 max-w-3xl mx-auto text-byte-text-light opacity-90">
                        Un espacio para la comunidad de Byte para discutir, compartir ideas y obtener soporte.
                    </p>
                    <button id="new-topic-button" class="new-topic-button">
                        <i class="fas fa-plus-circle mr-2"></i> Crear Nueva Publicación
                    </button>
                </div>
            </section>

            <section id="forum-posts" class="py-12 lg:py-10 bg-byte-dark-bg text-byte-text-light">
                <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="md:col-span-3">
                        <h2 class="text-2xl md:text-4xl lg:text-3xl font-extrabold text-center mb-10 text-stroke-cyan">Publicaciones Recientes</h2>
                        <div id="posts-container" class="max-w-3xl mx-auto">
                            <!-- Posts will be loaded here dynamically by JavaScript -->
                            <p class="text-center text-gray-400">Cargando publicaciones...</p>
                        </div>
                    </div>
                    <div class="md:col-span-1 flex flex-col gap-8">
                        <div class="bg-byte-secondary-dark p-6 rounded-lg shadow-xl border border-byte-accent-cyan/30 h-fit">
                            <h3 class="text-xl font-bold mb-4 text-byte-accent-cyan text-center">Usuarios en Línea</h3>
                            <div id="online-users-container" class="space-y-3">
                                <!-- Online users will be loaded here dynamically by JavaScript -->
                                <p class="text-sm text-gray-400 text-center">Cargando usuarios...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-byte-secondary-dark text-byte-text-light py-8 text-center border-t border-byte-accent-cyan">
        <div class="container mx-auto px-4">
            <p>© 2025 Byte Foro. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Modals (hidden by default) -->

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="close-create-post-modal">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Crear Nueva Publicación</h2>
            <form id="create-post-form">
                <textarea id="post-content-input" placeholder="Escribe tu publicación aquí..." rows="6" class="w-full p-3 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"></textarea>
                <input type="url" id="post-image-url-input" placeholder="URL de la imagen (opcional)" class="w-full p-3 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="url" id="post-video-url-input" placeholder="URL del video (opcional)" class="w-full p-3 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <button type="submit" class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200 mt-4">Publicar</button>
            </form>
        </div>
    </div>

    <!-- View Post Modal (for comments) -->
    <div id="view-post-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="close-view-post-modal">&times;</button>
            <div id="view-post-content" class="mb-6">
                <!-- Post content will be loaded here -->
            </div>
            <h3 class="text-lg font-bold mb-3 text-byte-accent-cyan">Comentarios</h3>
            <div id="comments-container" class="max-h-60 overflow-y-auto mb-4 p-2 rounded-md bg-gray-900 border border-gray-700">
                <!-- Comments will be loaded here -->
            </div>
            <div class="flex">
                <input type="text" id="comment-input" placeholder="Escribe un comentario..." class="flex-grow p-2 rounded-l-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <button id="add-comment-button" class="bg-blue-600 text-white px-4 rounded-r-md hover:bg-blue-700 transition duration-200">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content text-center">
            <button class="modal-close-button" id="close-settings-modal">&times;</button>
            <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan">Ajustes</h2>
            <ul class="space-y-4">
                <li><a href="#" id="customize-profile-link" class="text-byte-text-light hover:text-byte-accent-cyan transition duration-200 text-lg font-semibold block">Personalizar Perfil</a></li>
                <li><button id="logout-button-modal" class="bg-red-600 text-white py-2 px-6 rounded-full font-semibold hover:bg-red-700 transition duration-200">Cerrar Sesión</button></li>
            </ul>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="close-profile-settings-modal">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Ajustes de Perfil</h2>
            <form id="profile-settings-form" class="space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <img id="profile-photo-preview" src="https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser" alt="Vista previa de la foto de perfil" class="w-24 h-24 rounded-full object-cover border-2 border-byte-accent-cyan mb-2">
                    <input type="url" id="profile-photo-url" placeholder="URL de la foto de perfil" class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                </div>
                <input type="text" id="profile-name" placeholder="Nombre" class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="email" id="profile-email" placeholder="Correo Electrónico" class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="tel" id="profile-phone" placeholder="Número de Teléfono" class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="date" id="profile-dob" class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <textarea id="profile-note-input" placeholder="Tu nota de perfil (máx. 100 caracteres)" maxlength="100" rows="3" class="w-full p-2 rounded-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"></textarea>
                <div class="flex items-center space-x-2">
                    <label for="profile-color-input" class="text-byte-text-light">Color de Perfil:</label>
                    <input type="color" id="profile-color-input" class="w-10 h-10 rounded-md border border-byte-accent-cyan/30 cursor-pointer">
                </div>
                <button type="submit" class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">Guardar Cambios</button>
                <p id="profile-message" class="text-red-400 text-sm mt-2 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="close-rules-modal">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Reglas del Foro</h2>
            <div class="text-byte-text-light text-sm space-y-3">
                <p>1. Sé respetuoso: Trata a los demás miembros con cortesía y respeto.</p>
                <p>2. No spam: Evita publicar contenido repetitivo o irrelevante.</p>
                <p>3. Sin contenido ofensivo: No se permite lenguaje o imágenes ofensivas, discriminatorias o de odio.</p>
                <p>4. Mantén la privacidad: No compartas información personal tuya o de otros.</p>
                <p>5. No promociones ilegales: No publiques enlaces o contenido relacionado con actividades ilegales.</p>
                <p>6. Reporta el mal comportamiento: Si ves algo inapropiado, repórtalo a los administradores.</p>
                <p>7. Los administradores tienen la última palabra: Las decisiones de los administradores son finales.</p>
            </div>
        </div>
    </div>

    <!-- View User Profile Modal -->
    <div id="view-user-profile-modal" class="modal hidden">
        <div id="view-user-profile-modal-content" class="modal-content text-center">
            <button class="modal-close-button" id="close-view-user-profile-modal">&times;</button>
            <img id="view-user-profile-photo" src="https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser" alt="Foto de perfil del usuario" class="w-24 h-24 rounded-full object-cover border-2 border-white mx-auto mb-4">
            <h2 id="view-user-profile-name" class="text-xl font-bold mb-2 text-white">Nombre de Usuario</h2>
            <p id="view-user-profile-note" class="text-sm text-gray-300 mb-4">Nota del usuario.</p>
            <button id="ban-user-button" class="hidden bg-red-600 text-white py-2 px-6 rounded-full font-semibold hover:bg-red-700 transition duration-200">
                Banear Usuario
            </button>
        </div>
    </div>

    <!-- Private Chat Modal -->
    <div id="private-chat-modal" class="modal hidden">
        <div class="modal-content flex flex-col h-[80vh]">
            <button class="modal-close-button" id="close-private-chat-modal">&times;</button>
            <h2 id="private-chat-header-name" class="text-xl font-bold mb-4 text-byte-accent-cyan text-center">Chat Privado</h2>
            <div id="private-chat-messages-container" class="flex-grow overflow-y-auto p-4 bg-gray-900 rounded-md mb-4 space-y-3 border border-gray-700">
                <!-- Messages will be loaded here -->
            </div>
            <div class="flex">
                <input type="text" id="private-chat-input" placeholder="Escribe tu mensaje..." class="flex-grow p-2 rounded-l-md bg-byte-dark-bg border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <button id="send-private-chat-button" class="bg-blue-600 text-white px-4 rounded-r-md hover:bg-blue-700 transition duration-200">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="close-notifications-modal">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Tus Notificaciones</h2>
            <div id="notifications-list-container" class="max-h-80 overflow-y-auto p-2 rounded-md bg-gray-900 border border-gray-700">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Admin Chat View Modal -->
    <div id="admin-chat-view-modal" class="modal hidden">
        <div class="modal-content">
            <button class="modal-close-button" id="close-admin-chat-view-modal">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Todos los Chats Privados (Admin)</h2>
            <div id="admin-chat-list-container" class="max-h-80 overflow-y-auto p-2 rounded-md bg-gray-900 border border-gray-700">
                <!-- List of all private chats will be loaded here for admin -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (moved here for better script loading order) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        // !!! ATENCIÓN: DEBES PEGAR AQUÍ TU OBJETO firebaseConfig DE TU PROYECTO FIREBASE !!!
        // !!! Puedes encontrarlo en la sección "Configuración del proyecto" -> "Tus apps" de tu consola de Firebase. !!!
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global Firebase variables
        window.currentUserId = null;
        window.currentUsername = "Usuario Anónimo"; // Default username
        window.currentUserProfile = {}; // Store additional user profile data
        let activityTimer; // Timer for updating user activity

        // UI Elements
        const authModalOverlay = document.getElementById('auth-modal-overlay');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authNameInput = document.getElementById('auth-name'); // New: Name input
        const authPhoneInput = document.getElementById('auth-phone'); // New: Phone input
        const authRulesAcceptCheckbox = document.getElementById('auth-rules-accept'); // New: Rules acceptance checkbox
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleButton = document.getElementById('auth-toggle-button');
        const authMessage = document.getElementById('auth-message');
        const videoBackground = document.getElementById('video-background');
        const forumContentWrapper = document.getElementById('forum-content-wrapper');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const resendVerificationEmailButton = document.getElementById('resend-verification-email-button'); // New: Resend verification email button
        const logoutButtonHeader = document.getElementById('logout-button-header'); // Logout button in header

        // Header Buttons
        const settingsButton = document.getElementById('settings-button');
        const notificationsButton = document.getElementById('notifications-button'); // New: Notifications button
        const rulesButton = document.getElementById('rules-button'); // New: Rules button
        const notificationBadge = document.getElementById('notification-badge'); // New: Notification badge
        const adminChatViewButton = document.getElementById('admin-chat-view-button'); // New: Admin Chat View button

        // Modals
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalButton = document.getElementById('close-settings-modal');
        const customizeProfileLink = document.getElementById('customize-profile-link');
        const logoutButtonModal = document.getElementById('logout-button-modal'); // Get the logout button

        const profileSettingsModal = document.getElementById('profile-settings-modal');
        const closeProfileSettingsModalButton = document.getElementById('close-profile-settings-modal');
        const profileSettingsForm = document.getElementById('profile-settings-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileEmailInput = document.getElementById('profile-email');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profilePhotoURLInput = document.getElementById('profile-photo-url');
        const profilePhotoPreview = document.getElementById('profile-photo-preview');
        const profileDOBInput = document.getElementById('profile-dob');
        const profileNoteInput = document.getElementById('profile-note-input'); // New: Note input
        const profileColorInput = document.getElementById('profile-color-input'); // New: Color input
        const profileMessage = document.getElementById('profile-message');

        const rulesModal = document.getElementById('rules-modal'); // New: Rules modal
        const closeRulesModalButton = document.getElementById('close-rules-modal'); // New: Close rules modal button

        const onlineUsersContainer = document.getElementById('online-users-container'); // New: Online users container

        // New: View User Profile Modal Elements
        const viewUserProfileModal = document.getElementById('view-user-profile-modal');
        const closeViewUserProfileModalButton = document.getElementById('close-view-user-profile-modal');
        const viewUserProfileModalContent = document.getElementById('view-user-profile-modal-content');
        const viewUserProfilePhoto = document.getElementById('view-user-profile-photo');
        const viewUserProfileName = document.getElementById('view-user-profile-name');
        const viewUserProfileNote = document.getElementById('view-user-profile-note');
        const banUserButton = document.getElementById('ban-user-button'); // New: Ban User button

        // Private Chat elements
        const privateChatModal = document.getElementById('private-chat-modal');
        const closePrivateChatModalButton = document.getElementById('close-private-chat-modal');
        const privateChatHeaderName = document.getElementById('private-chat-header-name');
        const privateChatMessagesContainer = document.getElementById('private-chat-messages-container');
        const privateChatInput = document.getElementById('private-chat-input');
        const sendPrivateChatButton = document.getElementById('send-private-chat-button');
        let currentPrivateChatTargetId = null; // Stores the UID of the user being chatted with
        let currentPrivateChatId = null; // Stores the combined chat ID

        // Notifications elements
        const notificationsModal = document.getElementById('notifications-modal');
        const closeNotificationsModalButton = document.getElementById('close-notifications-modal');
        const notificationsListContainer = document.getElementById('notifications-list-container');

        // Admin Chat View Modal
        const adminChatViewModal = document.getElementById('admin-chat-view-modal');
        const closeAdminChatViewModalButton = document.getElementById('close-admin-chat-view-modal');
        const adminChatListContainer = document.getElementById('admin-chat-list-container');


        let isRegisterMode = false; // State for login/register form

        // Constants for change limits
        const NAME_CHANGE_LIMIT_MS = 25 * 24 * 60 * 60 * 1000; // 25 days in milliseconds
        const EMAIL_CHANGE_LIMIT_MS = 25 * 24 * 60 * 60 * 1000; // 25 days in milliseconds
        const PHONE_CHANGE_LIMIT_MS = 30 * 24 * 60 * 60 * 1000; // 30 days in milliseconds
        const ONLINE_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutes for online status

        // Function to show authentication message
        function showAuthMessage(message, isError = true) {
            authMessage.textContent = message;
            authMessage.classList.remove('hidden');
            if (isError) {
                authMessage.classList.add('text-red-400');
                authMessage.classList.remove('text-green-400');
            } else {
                authMessage.classList.add('text-green-400');
                authMessage.classList.remove('text-red-400');
            }
        }

        // Function to show profile message
        function showProfileMessage(message, isError = true) {
            profileMessage.textContent = message;
            profileMessage.classList.remove('hidden');
            if (isError) {
                profileMessage.classList.add('text-red-400');
                profileMessage.classList.remove('text-green-400');
            } else {
                profileMessage.classList.add('text-green-400');
                profileMessage.classList.remove('text-red-400');
            }
        }

        // Function to toggle between login and register forms
        function toggleAuthMode(toRegisterMode) {
            isRegisterMode = toRegisterMode;
            if (isRegisterMode) {
                authModalTitle.textContent = 'Registrarse';
                authSubmitButton.textContent = 'Registrarse';
                authToggleText.textContent = '¿Ya tienes una cuenta?';
                authToggleButton.textContent = 'Inicia Sesión';
                forgotPasswordLink.classList.add('hidden'); // Hide forgot password in register mode
                resendVerificationEmailButton.classList.add('hidden'); // Hide resend button in register mode
                authNameInput.classList.remove('hidden'); // Show name input
                authPhoneInput.classList.remove('hidden'); // Show phone input
                authRulesAcceptCheckbox.parentElement.classList.remove('hidden'); // Show rules checkbox
            } else {
                authModalTitle.textContent = 'Iniciar Sesión';
                authSubmitButton.textContent = 'Iniciar Sesión';
                authToggleText.textContent = '¿No tienes una cuenta?';
                authToggleButton.textContent = 'Regístrate';
                forgotPasswordLink.classList.remove('hidden'); // Show forgot password in login mode
                // resendVerificationEmailButton visibility handled in onAuthStateChanged
                authNameInput.classList.add('hidden'); // Hide name input
                authPhoneInput.classList.add('hidden'); // Hide phone input
                authRulesAcceptCheckbox.parentElement.classList.add('hidden'); // Hide rules checkbox
            }
            authMessage.classList.add('hidden'); // Clear message on toggle
        }

        authToggleButton.addEventListener('click', () => {
            toggleAuthMode(!isRegisterMode);
        });

        // Handle form submission (login/register)
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const name = authNameInput.value; // Get name
            const phone = authPhoneInput.value; // Get phone

            if (!email || !password) {
                showAuthMessage("Por favor, ingresa correo y contraseña.");
                return;
            }
            if (isRegisterMode) {
                if (!name) {
                    showAuthMessage("Por favor, ingresa tu nombre.");
                    return;
                }
                if (!authRulesAcceptCheckbox.checked) {
                    showAuthMessage("Debes aceptar las reglas del foro para registrarte.");
                    return;
                }
            }

            authMessage.classList.add('hidden'); // Hide previous messages

            try {
                if (isRegisterMode) {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Create user profile in Firestore
                    await setDoc(doc(db, "users", user.uid), {
                        name: name,
                        email: email,
                        phone: phone || '',
                        photo_url: "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser", // Default
                        created_at: new Date().toISOString(),
                        last_name_change_timestamp: new Date().toISOString(),
                        last_email_change_timestamp: new Date().toISOString(),
                        last_phone_change_timestamp: new Date().toISOString(),
                        date_of_birth: '',
                        note: '',
                        profile_color: '#00FFFF',
                        last_activity: new Date().toISOString(),
                        is_admin: false, // Default to not admin
                        is_banned: false // Default to not banned
                    });

                    showAuthMessage("Registro exitoso. Por favor, verifica tu correo electrónico para iniciar sesión (si la verificación está habilitada).", false);
                    // Firebase Auth automatically sends verification email if configured.
                    // For simplicity, we assume email is confirmed or not required for immediate login.
                    // In a real app, you'd check user.emailVerified and potentially sendEmailVerification.
                } else {
                    // Check if user is banned before signing in
                    const userQuery = query(collection(db, "users"), where("email", "==", email));
                    const querySnapshot = await getDocs(userQuery);
                    let isBanned = false;
                    querySnapshot.forEach((doc) => {
                        if (doc.exists() && doc.data().is_banned) {
                            isBanned = true;
                        }
                    });

                    if (isBanned) {
                        showAuthMessage("Tu cuenta ha sido baneada del foro. Contacta a un administrador para más información.", true);
                        return;
                    }

                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged listener will handle UI updates
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = "Ocurrió un error. Intenta de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "El correo electrónico ya está en uso. Por favor, inicia sesión o usa otro correo.";
                    toggleAuthMode(false);
                    authEmailInput.value = email;
                    authPasswordInput.value = '';
                } else if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Correo o contraseña incorrectos.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "La contraseña debe tener al menos 6 caracteres.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Error de conexión a la red. Intenta de nuevo.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Demasiados intentos fallidos. Intenta de nuevo más tarde.";
                }
                showAuthMessage(errorMessage);
            }
        });

        // Handle Forgot Password
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;

            if (!email) {
                showAuthMessage("Por favor, ingresa tu correo electrónico para restablecer la contraseña.");
                return;
            }

            try {
                await sendPasswordResetEmail(auth, email);
                showAuthMessage("Se ha enviado un enlace de restablecimiento de contraseña a tu correo electrónico.", false);
            } catch (error) {
                console.error("Password reset error:", error);
                let errorMessage = "Error al enviar el correo de restablecimiento. Asegúrate de que el correo sea válido y esté registrado.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No se encontró ningún usuario con ese correo electrónico.";
                }
                showAuthMessage(errorMessage);
            }
        });

        // New: Handle Resend Verification Email (Firebase has sendEmailVerification, but it's not directly exposed in simple auth flow)
        resendVerificationEmailButton.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                try {
                    // await user.sendEmailVerification(); // Uncomment if you want to explicitly send verification
                    showAuthMessage("Si tu correo no está verificado, se te enviará un enlace de verificación. Revisa tu bandeja de entrada o spam.", false);
                } catch (error) {
                    console.error("Error al reenviar correo de verificación:", error);
                    showAuthMessage("Error al reenviar el correo de verificación. Intenta de nuevo más tarde.", true);
                }
            } else {
                showAuthMessage("Debes iniciar sesión para reenviar el correo de verificación.", true);
            }
        });

        // Function to update user's last activity timestamp
        async function updateUserActivity() {
            if (window.currentUserId) {
                try {
                    await updateDoc(doc(db, "users", window.currentUserId), {
                        last_activity: new Date().toISOString()
                    });
                } catch (error) {
                    console.error("Error updating user activity:", error);
                }
            }
        }

        // Global logout function
        window.logout = async () => {
            console.log("Attempting to sign out...");
            try {
                if (activityTimer) clearInterval(activityTimer); // Stop activity updates
                await signOut(auth);
                console.log("Sign out successful.");
                // onAuthStateChanged listener will handle UI updates
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Error al cerrar sesión. Intenta de nuevo."); // Consider custom modal
            }
        };

        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            console.log("Firebase Auth State Changed:", user);
            if (user) {
                window.currentUserId = user.uid;

                // Fetch user profile from Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    window.currentUserProfile = userDocSnap.data();
                    // Update currentUsername with Firestore profile name if available
                    if (window.currentUserProfile.name) {
                        window.currentUsername = window.currentUserProfile.name;
                    } else {
                        window.currentUsername = user.email.split('@')[0];
                    }
                } else {
                    console.warn("User profile not found in Firestore for UID:", user.uid);
                    // Handle case where profile might not exist (e.g., if created directly via Firebase Console)
                    // For simplicity, we'll create a basic profile if it doesn't exist.
                    window.currentUserProfile = {
                        name: user.email.split('@')[0],
                        email: user.email,
                        phone: '',
                        photo_url: "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                        created_at: new Date().toISOString(),
                        last_name_change_timestamp: new Date().toISOString(),
                        last_email_change_timestamp: new Date().toISOString(),
                        last_phone_change_timestamp: new Date().toISOString(),
                        date_of_birth: '',
                        note: '',
                        profile_color: '#00FFFF',
                        last_activity: new Date().toISOString(),
                        is_admin: false,
                        is_banned: false
                    };
                    await setDoc(userDocRef, window.currentUserProfile);
                }

                // Hardcode admin UID check for client-side display and logic
                // IMPORTANT: Replace with your actual admin UID if you have one
                if (user.uid === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2") { // Replace with actual admin UID
                    window.currentUserProfile.is_admin = true;
                    console.log("User is hardcoded admin.");
                }

                // Check if banned
                if (window.currentUserProfile.is_banned) {
                    console.warn("User is banned. Signing out.");
                    await signOut(auth); // Force sign out if banned
                    authModalOverlay.classList.remove('hidden');
                    videoBackground.classList.remove('hidden');
                    forumContentWrapper.classList.add('hidden');
                    showAuthMessage("Tu cuenta ha sido baneada del foro. Contacta a un administrador para más información.", true);
                    if (activityTimer) clearInterval(activityTimer);
                    return; // Stop further execution
                }

                // Check email verification status (Firebase's user.emailVerified)
                if (user.emailVerified) {
                    console.log("User email is confirmed. Displaying forum content.");
                    authModalOverlay.classList.add('hidden');
                    videoBackground.classList.add('hidden');
                    forumContentWrapper.classList.remove('hidden');
                    resendVerificationEmailButton.classList.add('hidden'); // Hide resend button
                    loadPosts(); // Load posts after authentication
                    loadOnlineUsers(); // Load online users
                    loadNotifications(); // Load user notifications
                    if (settingsButton) settingsButton.classList.remove('hidden'); // Show settings button
                    if (notificationsButton) notificationsButton.classList.remove('hidden'); // Show notifications button
                    if (adminChatViewButton) { // Show admin chat view button if admin
                        if (window.currentUserProfile.is_admin) {
                            adminChatViewButton.classList.remove('hidden');
                        } else {
                            adminChatViewButton.classList.add('hidden');
                        }
                    }
                    if (logoutButtonHeader) logoutButtonHeader.classList.remove('hidden'); // Show logout button in header

                    // Start periodic activity update
                    if (activityTimer) clearInterval(activityTimer);
                    activityTimer = setInterval(updateUserActivity, 30 * 1000); // Update every 30 seconds
                    updateUserActivity(); // Initial update
                } else {
                    console.log("User email is NOT confirmed. Showing verification message.");
                    authModalOverlay.classList.remove('hidden');
                    videoBackground.classList.remove('hidden');
                    forumContentWrapper.classList.add('hidden');
                    showAuthMessage("Por favor, verifica tu correo electrónico para acceder al foro. Revisa tu bandeja de entrada o spam.", false);
                    resendVerificationEmailButton.classList.remove('hidden'); // Show resend button
                    if (settingsButton) settingsButton.classList.add('hidden'); // Hide settings button
                    if (notificationsButton) notificationsButton.classList.add('hidden'); // Hide notifications button
                    if (adminChatViewButton) adminChatViewButton.classList.add('hidden'); // Hide admin chat view button
                    if (logoutButtonHeader) logoutButtonHeader.classList.add('hidden'); // Hide logout button in header
                    if (activityTimer) clearInterval(activityTimer); // Stop activity updates
                }

            } else {
                // No user authenticated
                window.currentUserId = null;
                window.currentUsername = "Usuario Anónimo";
                window.currentUserProfile = {};
                console.log("onAuthStateChanged: No user authenticated. Updating UI for logged out state.");
                authModalOverlay.classList.remove('hidden');
                videoBackground.classList.remove('hidden');
                forumContentWrapper.classList.add('hidden');
                document.getElementById('posts-container').innerHTML = '<p class="text-center text-gray-400">Inicia sesión para ver las publicaciones.</p>';
                onlineUsersContainer.innerHTML = ''; // Clear online users
                notificationBadge.classList.add('hidden'); // Hide notification badge
                if (settingsButton) settingsButton.classList.add('hidden'); // Hide settings button
                if (notificationsButton) notificationsButton.classList.add('hidden'); // Hide notifications button
                if (adminChatViewButton) adminChatViewButton.classList.add('hidden'); // Hide admin chat view button
                resendVerificationEmailButton.classList.add('hidden'); // Hide resend button
                if (logoutButtonHeader) logoutButtonHeader.classList.add('hidden'); // Hide logout button in header
                if (activityTimer) clearInterval(activityTimer); // Stop activity updates
            }
        });


        // Function to create a new post
        window.createPost = async (content, imageUrl, videoUrl) => {
            if (!db || !window.currentUserId) {
                console.error("Firestore or user not ready for creating post.");
                return;
            }
            if (!content.trim() && !imageUrl.trim() && !videoUrl.trim()) {
                console.warn("Post content, image, or video cannot be empty.");
                return;
            }
            try {
                await addDoc(collection(db, "posts"), {
                    userId: window.currentUserId,
                    username: window.currentUsername,
                    userPhotoURL: window.currentUserProfile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                    content: content.trim(),
                    imageUrl: imageUrl.trim(),
                    videoUrl: videoUrl.trim(),
                    createdAt: new Date().toISOString(),
                    likes: [],
                    dislikes: [],
                    commentsCount: 0
                });
                console.log("Post created successfully!");
            }
            catch (error) {
                console.error("Error creating post:", error);
            }
        };

        // Function to like/dislike a post
        window.toggleReaction = async (postId, type) => {
            if (!db || !window.currentUserId) {
                console.error("Firestore or user not ready for toggling reaction.");
                return;
            }
            try {
                const postRef = doc(db, "posts", postId);
                const postSnap = await getDoc(postRef);

                if (!postSnap.exists()) {
                    console.error("Post not found!");
                    return;
                }

                const postData = postSnap.data();
                let updatedLikes = [...postData.likes || []];
                let updatedDislikes = [...postData.dislikes || []];

                if (type === 'like') {
                    if (updatedLikes.includes(window.currentUserId)) {
                        updatedLikes = updatedLikes.filter(id => id !== window.currentUserId);
                    } else {
                        updatedLikes.push(window.currentUserId);
                        updatedDislikes = updatedDislikes.filter(id => id !== window.currentUserId);
                    }
                } else if (type === 'dislike') {
                    if (updatedDislikes.includes(window.currentUserId)) {
                        updatedDislikes = updatedDislikes.filter(id => id !== window.currentUserId);
                    } else {
                        updatedDislikes.push(window.currentUserId);
                        updatedLikes = updatedLikes.filter(id => id !== window.currentUserId);
                    }
                }

                await updateDoc(postRef, {
                    likes: updatedLikes,
                    dislikes: updatedDislikes
                });
                console.log(`Reaction '${type}' toggled successfully for post ${postId}.`);
            } catch (error) {
                console.error(`Error toggling ${type} for post ${postId}:`, error);
            }
        };

        // Function to add a comment
        window.addComment = async (postId, commentContent) => {
            if (!db || !window.currentUserId) {
                console.error("Firestore or user not ready for adding comment.");
                return;
            }
            if (!commentContent.trim()) {
                console.warn("Comment content cannot be empty.");
                return;
            }
            try {
                const commentRef = await addDoc(collection(db, "posts", postId, "comments"), {
                    userId: window.currentUserId,
                    username: window.currentUsername,
                    userPhotoURL: window.currentUserProfile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                    content: commentContent.trim(),
                    createdAt: new Date().toISOString()
                });

                // Increment commentsCount on the parent post
                const postRef = doc(db, "posts", postId);
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                    const currentCommentsCount = postSnap.data().commentsCount || 0;
                    await updateDoc(postRef, {
                        commentsCount: currentCommentsCount + 1
                    });
                }

                // --- Handle Mentions and Notifications ---
                const mentionRegex = /@([a-zA-Z0-9_.-]+)/g;
                let match;
                const mentionedUsernames = new Set();
                while ((match = mentionRegex.exec(commentContent)) !== null) {
                    mentionedUsernames.add(match[1]); // Add captured username (group 1)
                }

                if (mentionedUsernames.size > 0) {
                    for (const mentionedUsername of mentionedUsernames) {
                        const usersQuery = query(collection(db, "users"), where("name", "==", mentionedUsername));
                        const usersSnapshot = await getDocs(usersQuery);

                        if (!usersSnapshot.empty) {
                            usersSnapshot.forEach(async (userDoc) => {
                                const mentionedUserId = userDoc.id;
                                if (mentionedUserId !== window.currentUserId) { // Don't notify self
                                    await addDoc(collection(db, "users", mentionedUserId, "notifications"), {
                                        recipientId: mentionedUserId,
                                        type: 'mention',
                                        senderId: window.currentUserId,
                                        senderName: window.currentUsername,
                                        postId: postId,
                                        commentId: commentRef.id,
                                        content: commentContent.trim(),
                                        read: false,
                                        createdAt: new Date().toISOString()
                                    });
                                    console.log(`Notification sent to ${mentionedUsername}`);
                                }
                            });
                        } else {
                            console.warn(`Mentioned user "${mentionedUsername}" not found.`);
                        }
                    }
                }
                // --- End Mentions and Notifications ---

                console.log("Comment added successfully!");
            } catch (error) {
                console.error("Error adding comment:", error);
            }
        };

        // Function to load and display posts in real-time
        window.loadPosts = () => {
            if (!db) {
                console.error("Firestore not initialized for loading posts.");
                return;
            }

            const postsContainer = document.getElementById('posts-container');
            const postsColRef = collection(db, "posts");
            const q = query(postsColRef, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                postsContainer.innerHTML = ''; // Clear existing posts
                if (snapshot.empty) {
                    postsContainer.innerHTML = '<p class="text-center text-gray-400">No hay publicaciones aún. ¡Sé el primero en crear una!</p>';
                    return;
                }

                snapshot.forEach(async (doc) => {
                    const post = doc.data();
                    const postId = doc.id;
                    const userDisplayName = post.username || `Usuario_${post.userId.substring(0, 6)}`;
                    const userPhoto = post.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                    const imageUrl = post.imageUrl || '';
                    const videoUrl = post.videoUrl || '';

                    // Fetch user profile to check admin status
                    const userProfileSnap = await getDoc(doc(db, "users", post.userId));
                    const isAuthorAdmin = (userProfileSnap.exists() && userProfileSnap.data().is_admin) || (post.userId === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2"); // Hardcoded admin UID

                    const usernameClass = isAuthorAdmin ? 'text-red-500' : 'text-byte-text-light';
                    const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';

                    let mediaContent = '';
                    if (imageUrl) {
                        mediaContent = `<img src="${imageUrl}" alt="Imagen de la publicación" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/F9FAFB?text=Imagen+no+disponible';">`;
                    } else if (videoUrl) {
                        mediaContent = `<video controls class="w-full h-auto rounded-lg mb-4 max-h-96 object-cover"><source src="${videoUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
                    }

                    const postElement = document.createElement('div');
                    postElement.className = 'bg-byte-secondary-dark p-6 rounded-lg shadow-xl mb-6 border border-byte-accent-cyan/30';
                    postElement.innerHTML = `
                        <div class="flex items-center mb-4">
                            <img src="${userPhoto}" alt="Foto de perfil" class="w-10 h-10 rounded-full mr-3 border border-byte-accent-cyan">
                            <div>
                                <p class="font-bold ${usernameClass}">${userDisplayName} ${adminTag}</p>
                                <p class="text-xs text-gray-500">${new Date(post.createdAt).toLocaleString()}</p>
                            </div>
                            ${window.currentUserProfile.is_admin ? `<button class="text-red-500 hover:text-red-700 ml-auto delete-post-button" data-post-id="${postId}"><i class="fas fa-trash"></i> Eliminar</button>` : ''}
                        </div>
                        ${mediaContent}
                        <p class="text-byte-text-light mb-4">${post.content}</p>
                        <div class="flex items-center justify-between text-gray-400 text-sm">
                            <div class="flex items-center space-x-4">
                                <button class="flex items-center hover:text-byte-accent-cyan transition duration-200 like-button ${post.likes.includes(window.currentUserId) ? 'text-byte-accent-cyan' : ''}" data-post-id="${postId}" data-type="like">
                                    <i class="far fa-thumbs-up mr-1"></i>
                                    <span>${post.likes.length}</span>
                                </button>
                                <button class="flex items-center hover:text-red-400 transition duration-200 dislike-button ${post.dislikes.includes(window.currentUserId) ? 'text-red-400' : ''}" data-post-id="${postId}" data-type="dislike">
                                    <i class="far fa-thumbs-down mr-1"></i>
                                    <span>${post.dislikes.length}</span>
                                </button>
                                <button class="flex items-center hover:text-byte-accent-cyan transition duration-200 comment-button" data-post-id="${postId}">
                                    <i class="far fa-comment mr-1"></i>
                                    <span>${post.commentsCount}</span>
                                </button>
                            </div>
                        </div>
                    `;
                    postsContainer.appendChild(postElement);
                });

                // Attach event listeners for like/dislike/comment/delete buttons after rendering
                document.querySelectorAll('.like-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening post modal
                        window.toggleReaction(button.dataset.postId, 'like');
                    };
                });
                document.querySelectorAll('.dislike-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening post modal
                        window.toggleReaction(button.dataset.postId, 'dislike');
                    };
                });
                document.querySelectorAll('.comment-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening post modal
                        openPostModal(button.dataset.postId);
                    };
                });
                document.querySelectorAll('.delete-post-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation();
                        deletePost(button.dataset.postId);
                    };
                });
            });
        };

        // Function to delete a post (Admin only)
        async function deletePost(postId) {
            if (!db || !window.currentUserId || !window.currentUserProfile.is_admin) {
                console.error("No autorizado para eliminar publicaciones o Firestore/usuario no listo.");
                return;
            }
            if (!confirm("¿Estás seguro de que quieres eliminar esta publicación y todos sus comentarios?")) {
                return; // User cancelled
            }
            try {
                // Delete all comments related to the post first
                const commentsQuery = query(collection(db, "posts", postId, "comments"));
                const commentsSnapshot = await getDocs(commentsQuery);
                const deletePromises = [];
                commentsSnapshot.forEach((commentDoc) => {
                    deletePromises.push(deleteDoc(doc(db, "posts", postId, "comments", commentDoc.id)));
                });
                await Promise.all(deletePromises);
                console.log(`Comments for post ${postId} deleted successfully.`);

                // Then delete the post itself
                await deleteDoc(doc(db, "posts", postId));
                console.log(`Publicación ${postId} eliminada exitosamente.`);
            } catch (error) {
                console.error("Error al eliminar publicación:", error);
            }
        };

        // Function to delete a comment (Admin only)
        async function deleteComment(postId, commentId) {
            if (!db || !window.currentUserId || !window.currentUserProfile.is_admin) {
                console.error("No autorizado para eliminar comentarios o Firestore/usuario no listo.");
                return;
            }
            if (!confirm("¿Estás seguro de que quieres eliminar este comentario?")) {
                return; // User cancelled
            }
            try {
                await deleteDoc(doc(db, "posts", postId, "comments", commentId));

                // Decrement commentsCount on the parent post
                const postRef = doc(db, "posts", postId);
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                    const currentCommentsCount = postSnap.data().commentsCount || 0;
                    await updateDoc(postRef, {
                        commentsCount: Math.max(0, currentCommentsCount - 1) // Ensure count doesn't go below zero
                    });
                }
                console.log(`Comentario ${commentId} de la publicación ${postId} eliminado exitosamente.`);
            } catch (error) {
                console.error("Error al eliminar comentario:", error);
            }
        };

        // Modal elements for post creation/view
        const createPostModal = document.getElementById('create-post-modal');
        const closeCreatePostModalButton = document.getElementById('close-create-post-modal');
        const createPostForm = document.getElementById('create-post-form');
        const postContentInput = document.getElementById('post-content-input');
        const postImageUrlInput = document.getElementById('post-image-url-input'); // New: Image URL input
        const postVideoUrlInput = document.getElementById('post-video-url-input'); // New: Video URL input
        const newTopicButton = document.getElementById('new-topic-button');

        const viewPostModal = document.getElementById('view-post-modal');
        const closeViewPostModalButton = document.getElementById('close-view-post-modal');
        const viewPostContent = document.getElementById('view-post-content');
        const commentsContainer = document.getElementById('comments-container');
        const commentInput = document.getElementById('comment-input');
        const addCommentButton = document.getElementById('add-comment-button');
        let currentViewedPostId = null; // To keep track of the post being viewed

        // Open create post modal
        newTopicButton.addEventListener('click', () => {
            if (window.currentUserId) {
                createPostModal.classList.remove('hidden');
                postContentInput.value = ''; // Clear previous content
                postImageUrlInput.value = ''; // Clear image URL
                postVideoUrlInput.value = ''; // Clear video URL
            } else {
                alert("Debes iniciar sesión para crear una publicación.");
            }
        });

        // Close create post modal
        closeCreatePostModalButton.addEventListener('click', () => {
            createPostModal.classList.add('hidden');
        });

        // Close create post modal when clicking outside
        createPostModal.addEventListener('click', (event) => {
            if (event.target === createPostModal) {
                createPostModal.classList.add('hidden');
            }
        });

        // Submit new post form
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = postContentInput.value;
            const imageUrl = postImageUrlInput.value;
            const videoUrl = postVideoUrlInput.value;
            await window.createPost(content, imageUrl, videoUrl);
            createPostModal.classList.add('hidden');
        });

        // Open view post modal and load comments
        window.openPostModal = async (postId) => {
            currentViewedPostId = postId;
            if (!db) {
                console.error("Firestore not initialized for viewing post.");
                return;
            }

            const postRef = doc(db, "posts", postId);
            const postSnap = await getDoc(postRef);

            if (!postSnap.exists()) {
                console.error("Post not found!");
                alert("Publicación no encontrada.");
                return;
            }

            const post = postSnap.data();
            const userDisplayName = post.username || `Usuario_${post.userId.substring(0, 6)}`;
            const userPhoto = post.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
            const imageUrl = post.imageUrl || '';
            const videoUrl = post.videoUrl || '';

            // Fetch user profile to check admin status
            const userProfileSnap = await getDoc(doc(db, "users", post.userId));
            const isAuthorAdmin = (userProfileSnap.exists() && userProfileSnap.data().is_admin) || (post.userId === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2"); // Hardcoded admin UID
            const usernameClass = isAuthorAdmin ? 'text-red-500' : 'text-byte-text-light';
            const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';


            let mediaContent = '';
            if (imageUrl) {
                mediaContent = `<img src="${imageUrl}" alt="Imagen de la publicación" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/F9FAFB?text=Imagen+no+disponible';">`;
            } else if (videoUrl) {
                mediaContent = `<video controls class="w-full h-auto rounded-lg mb-4 max-h-96 object-cover"><source src="${videoUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
            }

            viewPostContent.innerHTML = `
                <div class="flex items-center mb-4">
                    <img src="${userPhoto}" alt="Foto de perfil" class="w-10 h-10 rounded-full mr-3 border border-byte-accent-cyan">
                    <div>
                        <p class="font-bold ${usernameClass}">${userDisplayName} ${adminTag}</p>
                        <p class="text-xs text-gray-500">${new Date(post.createdAt).toLocaleString()}</p>
                        </div>
                    </div>
                    ${mediaContent}
                    <p class="text-byte-text-light mb-4">${post.content}</p>
                    <div class="flex items-center space-x-4 text-gray-400 text-sm mb-4">
                        <span class="flex items-center"><i class="fas fa-thumbs-up mr-1"></i> ${post.likes.length}</span>
                        <span class="flex items-center"><i class="fas fa-thumbs-down mr-1"></i> ${post.dislikes.length}</span>
                        <span class="flex items-center"><i class="fas fa-comment mr-1"></i> ${post.commentsCount}</span>
                    </div>
                `;
            viewPostModal.classList.remove('hidden');
            loadComments(postId); // Load comments for this post
        };

        // Close view post modal
        closeViewPostModalButton.addEventListener('click', () => {
            viewPostModal.classList.add('hidden');
            commentsContainer.innerHTML = ''; // Clear comments when closing
            currentViewedPostId = null;
        });

        // Close view post modal when clicking outside
        viewPostModal.addEventListener('click', (event) => {
            if (event.target === viewPostModal) {
                viewPostModal.classList.add('hidden');
            }
        });

        // Load and display comments in real-time
        function loadComments(postId) {
            if (!db) {
                console.error("Firestore not initialized for loading comments.");
                return;
            }

            const commentsColRef = collection(db, "posts", postId, "comments");
            const q = query(commentsColRef, orderBy("createdAt", "asc"));

            onSnapshot(q, (snapshot) => {
                commentsContainer.innerHTML = ''; // Clear existing comments
                if (snapshot.empty) {
                    commentsContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">Sé el primero en comentar.</p>';
                    return;
                }

                snapshot.forEach(async (doc) => {
                    const comment = doc.data();
                    const commentId = doc.id;
                    const userDisplayName = comment.username || `Usuario_${comment.userId.substring(0, 6)}`;
                    const userPhoto = comment.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";

                    // Fetch user profile to check admin status
                    const userProfileSnap = await getDoc(doc(db, "users", comment.userId));
                    const isAuthorAdmin = (userProfileSnap.exists() && userProfileSnap.data().is_admin) || (comment.userId === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2"); // Hardcoded admin UID
                    const usernameClass = isAuthorAdmin ? 'text-red-500' : 'font-semibold text-byte-text-light';
                    const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';

                    const commentElement = document.createElement('div');
                    commentElement.className = 'bg-byte-dark-bg p-3 rounded-md mb-3 border border-gray-700';
                    commentElement.innerHTML = `
                        <div class="flex items-center mb-2">
                            <img src="${userPhoto}" alt="Foto de perfil" class="w-8 h-8 rounded-full mr-2 border border-gray-600">
                            <div>
                                <p class="${usernameClass}">${userDisplayName} ${adminTag}</p>
                                <p class="text-xs text-gray-500">${new Date(comment.createdAt).toLocaleString()}</p>
                            </div>
                            ${window.currentUserProfile.is_admin ? `<button class="ml-auto text-red-500 hover:text-red-700 delete-comment-button" data-post-id="${postId}" data-comment-id="${commentId}"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                        <p class="text-byte-text-light text-sm">${comment.content}</p>
                    `;
                    commentsContainer.appendChild(commentElement);
                });

                // Attach event listeners for delete comment buttons
                document.querySelectorAll('.delete-comment-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const postId = e.currentTarget.dataset.postId;
                        const commentId = e.currentTarget.dataset.commentId;
                        deleteComment(postId, commentId);
                    });
                });
            });
        }

        // Add comment button click
        addCommentButton.addEventListener('click', async () => {
            if (currentViewedPostId && commentInput.value.trim()) {
                await window.addComment(currentViewedPostId, commentInput.value);
                commentInput.value = ''; // Clear input after submitting
            } else if (!window.currentUserId) {
                alert("Debes iniciar sesión para comentar.");
            }
        });

        // New: Settings Modal Logic
        settingsButton.addEventListener('click', () => {
            if (window.currentUserId) {
                settingsModal.classList.remove('hidden');
            } else {
                alert("Debes iniciar sesión para acceder a los ajustes.");
            }
        });

        closeSettingsModalButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        // Close settings modal when clicking outside
        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        // New: Logout Button in Settings Modal
        logoutButtonModal.addEventListener('click', () => {
            console.log("Logout button clicked in modal.");
            window.logout(); // Call the global logout function
            settingsModal.classList.add('hidden'); // Close the settings modal
        });

        // New: Logout Button in Header
        logoutButtonHeader.addEventListener('click', () => {
            console.log("Logout button clicked in header.");
            window.logout(); // Call the global logout function
        });

        // New: Customize Profile Link in Settings Modal
        customizeProfileLink.addEventListener('click', async (e) => {
            e.preventDefault();
            settingsModal.classList.add('hidden'); // Close settings modal
            profileSettingsModal.classList.remove('hidden'); // Open profile settings modal

            // Populate profile fields with current data
            profileNameInput.value = window.currentUserProfile.name || '';
            profileEmailInput.value = window.currentUserProfile.email || '';
            profilePhoneInput.value = window.currentUserProfile.phone || '';
            profilePhotoURLInput.value = window.currentUserProfile.photo_url || '';
            profilePhotoPreview.src = window.currentUserProfile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
            profileDOBInput.value = window.currentUserProfile.date_of_birth || '';
            profileNoteInput.value = window.currentUserProfile.note || '';
            profileColorInput.value = window.currentUserProfile.profile_color || '#00FFFF';
            profileMessage.classList.add('hidden'); // Clear previous messages
        });

        // New: Close Profile Settings Modal
        closeProfileSettingsModalButton.addEventListener('click', () => {
            profileSettingsModal.classList.add('hidden');
        });

        // Close profile settings modal when clicking outside
        profileSettingsModal.addEventListener('click', (event) => {
            if (event.target === profileSettingsModal) {
                profileSettingsModal.classList.add('hidden');
            }
        });

        // New: Handle Profile Settings Form Submission
        profileSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = profileNameInput.value.trim();
            const newEmail = profileEmailInput.value.trim();
            const newPhone = profilePhoneInput.value.trim();
            const newPhotoURL = profilePhotoURLInput.value.trim();
            const newDOB = profileDOBInput.value.trim();
            const newNote = profileNoteInput.value.trim();
            const newProfileColor = profileColorInput.value;

            if (!newName) {
                showProfileMessage("El nombre no puede estar vacío.", true);
                return;
            }

            profileMessage.classList.add('hidden');

            try {
                const userRef = doc(db, "users", window.currentUserId);
                const userSnap = await getDoc(userRef);
                const currentProfileData = userSnap.data();

                let profileUpdates = {};
                let changesMade = false;

                const now = new Date().toISOString();

                // Handle Name Change
                if (newName !== currentProfileData.name) {
                    const lastChange = new Date(currentProfileData.last_name_change_timestamp || 0);
                    if (!window.currentUserProfile.is_admin && (new Date() - lastChange < NAME_CHANGE_LIMIT_MS)) {
                        showProfileMessage(`Solo puedes cambiar tu nombre cada ${NAME_CHANGE_LIMIT_MS / (24 * 60 * 60 * 1000)} días.`, true);
                        return;
                    }
                    profileUpdates.name = newName;
                    profileUpdates.last_name_change_timestamp = now;
                    changesMade = true;
                }

                // Handle Email Change (Firebase Auth handles email update separately)
                if (newEmail !== currentProfileData.email) {
                    const lastChange = new Date(currentProfileData.last_email_change_timestamp || 0);
                    if (!window.currentUserProfile.is_admin && (new Date() - lastChange < EMAIL_CHANGE_LIMIT_MS)) {
                        showProfileMessage(`Solo puedes cambiar tu correo electrónico cada ${EMAIL_CHANGE_LIMIT_MS / (24 * 60 * 60 * 1000)} días.`, true);
                        return;
                    }
                    // Update email in Firebase Auth
                    await auth.currentUser.updateEmail(newEmail);
                    profileUpdates.email = newEmail;
                    profileUpdates.last_email_change_timestamp = now;
                    changesMade = true;
                }

                // Handle Phone Change
                if (newPhone !== currentProfileData.phone) {
                    const lastChange = new Date(currentProfileData.last_phone_change_timestamp || 0);
                    if (!window.currentUserProfile.is_admin && (new Date() - lastChange < PHONE_CHANGE_LIMIT_MS)) {
                        showProfileMessage(`Solo puedes cambiar tu número de teléfono cada ${PHONE_CHANGE_LIMIT_MS / (24 * 60 * 60 * 1000)} días.`, true);
                        return;
                    }
                    profileUpdates.phone = newPhone;
                    profileUpdates.last_phone_change_timestamp = now;
                    changesMade = true;
                }

                // Handle Photo URL Change
                if (newPhotoURL !== currentProfileData.photo_url) {
                    profileUpdates.photo_url = newPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                    changesMade = true;
                }

                // Handle Date of Birth Change
                if (newDOB !== currentProfileData.date_of_birth) {
                    profileUpdates.date_of_birth = newDOB;
                    changesMade = true;
                }

                // Handle Note Change
                if (newNote !== currentProfileData.note) {
                    profileUpdates.note = newNote;
                    changesMade = true;
                }

                // Handle Profile Color Change
                if (newProfileColor !== currentProfileData.profile_color) {
                    profileUpdates.profile_color = newProfileColor;
                    changesMade = true;
                }

                if (!changesMade) {
                    showProfileMessage("No hay cambios para guardar.", false);
                    setTimeout(() => {
                        profileSettingsModal.classList.add('hidden');
                    }, 1500);
                    return;
                }

                // Apply Firestore updates
                await updateDoc(userRef, profileUpdates);

                // Update local currentUserProfile with new data
                window.currentUserProfile = { ...window.currentUserProfile, ...profileUpdates };
                window.currentUsername = window.currentUserProfile.name; // Ensure username is updated

                showProfileMessage("Perfil actualizado exitosamente.", false);
                setTimeout(() => {
                    profileSettingsModal.classList.add('hidden');
                }, 1500);
            } catch (error) {
                console.error("Error updating profile:", error);
                let errorMessage = "Error al actualizar el perfil. Intenta de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "El nuevo correo electrónico ya está en uso.";
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Por favor, inicia sesión de nuevo para actualizar tu correo electrónico.";
                }
                showProfileMessage(errorMessage, true);
            }
        });

        // Update photo preview on input change
        profilePhotoURLInput.addEventListener('input', () => {
            profilePhotoPreview.src = profilePhotoURLInput.value || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
        });

        // New: Rules Modal Logic
        rulesButton.addEventListener('click', () => {
            rulesModal.classList.remove('hidden');
        });

        closeRulesModalButton.addEventListener('click', () => {
            rulesModal.classList.add('hidden');
        });

        // Close rules modal when clicking outside
        rulesModal.addEventListener('click', (event) => {
            if (event.target === rulesModal) {
                rulesModal.classList.add('hidden');
            }
        });

        // New: Notifications Button Logic
        notificationsButton.addEventListener('click', () => {
            if (window.currentUserId) {
                notificationsModal.classList.remove('hidden');
                markAllNotificationsAsRead();
            } else {
                alert("Debes iniciar sesión para ver las notificaciones.");
            }
        });

        closeNotificationsModalButton.addEventListener('click', () => {
            notificationsModal.classList.add('hidden');
        });

        notificationsModal.addEventListener('click', (event) => {
            if (event.target === notificationsModal) {
                notificationsModal.classList.add('hidden');
            }
        });

        // Add hover animations for settings and notifications buttons
        settingsButton.addEventListener('mouseenter', () => {
            settingsButton.querySelector('i').classList.add('animate-spin-slow');
        });
        settingsButton.addEventListener('mouseleave', () => {
            settingsButton.querySelector('i').classList.remove('animate-spin-slow');
        });

        notificationsButton.addEventListener('mouseenter', () => {
            notificationsButton.querySelector('i').classList.add('animate-shake');
        });
        notificationsButton.addEventListener('mouseleave', () => {
            notificationsButton.querySelector('i').classList.remove('animate-shake');
        });

        // Admin Chat View Button Logic
        if (adminChatViewButton) {
            adminChatViewButton.addEventListener('click', () => {
                if (window.currentUserProfile.is_admin) {
                    adminChatViewModal.classList.remove('hidden');
                    loadAllPrivateChatsForAdmin();
                } else {
                    alert("No tienes permisos de administrador para ver todos los chats.");
                }
            });
        }

        closeAdminChatViewModalButton.addEventListener('click', () => {
            adminChatViewModal.classList.add('hidden');
        });

        adminChatViewModal.addEventListener('click', (event) => {
            if (event.target === adminChatViewModal) {
                adminChatViewModal.classList.add('hidden');
            }
        });


        // Function to load and display online users in real-time
        function loadOnlineUsers() {
            if (!db) {
                console.error("Firestore not initialized for loading online users.");
                return;
            }

            const usersColRef = collection(db, "users");
            // No orderBy for online users, as we'll sort them in JS
            onSnapshot(usersColRef, (snapshot) => {
                const onlineUsersList = [];
                const now = new Date().getTime();

                snapshot.forEach((doc) => {
                    const profile = doc.data();
                    const lastActivityTime = new Date(profile.last_activity).getTime();
                    if (lastActivityTime && (now - lastActivityTime < ONLINE_THRESHOLD_MS)) {
                        onlineUsersList.push({
                            userId: doc.id,
                            name: profile.name || `Usuario_${doc.id.substring(0, 6)}`,
                            photoURL: profile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                            note: profile.note || '',
                            profileColor: profile.profile_color || '#1A202C',
                            isAdmin: profile.is_admin || (doc.id === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2"), // Hardcoded admin UID
                            isBanned: profile.is_banned || false
                        });
                    }
                });
                renderOnlineUsers(onlineUsersList);
            });
        }

        function renderOnlineUsers(users) {
            onlineUsersContainer.innerHTML = ''; // Clear before rendering
            if (users.length === 0) {
                onlineUsersContainer.innerHTML = '<p class="text-sm text-gray-400 text-center">No hay usuarios en línea.</p>';
                return;
            }
            // Sort users alphabetically by name for consistent display, admins first
            users.sort((a, b) => {
                if (a.isAdmin && !b.isAdmin) return -1;
                if (!a.isAdmin && b.isAdmin) return 1;
                return a.name.localeCompare(b.name);
            });

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center p-2 rounded-md hover:bg-gray-700 transition duration-200 cursor-pointer';
                const usernameClass = user.isAdmin ? 'text-red-500' : 'text-byte-text-light';
                const adminTag = user.isAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';
                const bannedIcon = user.isBanned ? '<i class="fas fa-ban text-red-600 ml-1" title="Baneado"></i>' : '';

                userElement.innerHTML = `
                    <img src="${user.photoURL}" alt="${user.name}" class="w-8 h-8 rounded-full mr-2 border border-green-500">
                    <span class="text-sm ${usernameClass}">${user.name}${adminTag}${bannedIcon}</span>
                    <button class="ml-auto text-byte-accent-cyan hover:text-cyan-400 transition duration-200 chat-button" data-user-id="${user.userId}" data-username="${user.name}">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <span class="ml-2 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                `;
                userElement.querySelector('.chat-button').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent opening user profile modal
                    openPrivateChatModal(user.userId, user.name);
                });
                userElement.addEventListener('click', () => openUserProfileModal(user.userId)); // Add click listener for profile
                onlineUsersContainer.appendChild(userElement);
            });
        }

        /**
         * Determines a contrasting text color (black or white) for a given hex background color.
         * Uses the YIQ (luminosity) formula.
         * @param {string} hexcolor - The background color in hex format (e.g., "#RRGGBB").
         * @returns {string} "#F9FAFB" (light text) or "#0A0A1A" (dark text).
         */
        function getContrastColor(hexcolor) {
            if (!/^#([A-Fa-f0-9]{3}){1,2}$/.test(hexcolor)) {
                return '#F9FAFB';
            }

            let r = parseInt(hexcolor.substring(1, 3), 16);
            let g = parseInt(hexcolor.substring(3, 5), 16);
            let b = parseInt(hexcolor.substring(5, 7), 16);

            let yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;

            return (yiq >= 128) ? '#0A0A1A' : '#F9FAFB';
        }


        // New: Function to open user profile modal
        async function openUserProfileModal(userId) {
            if (!db) {
                console.error("Firestore not initialized for viewing user profile.");
                return;
            }

            const userDocRef = doc(db, "users", userId);
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                console.error("User profile not found!");
                alert("Perfil de usuario no encontrado.");
                return;
            }

            const profile = userDocSnap.data();
            viewUserProfilePhoto.src = profile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
            viewUserProfileName.textContent = profile.name || `Usuario_${userId.substring(0, 6)}`;
            viewUserProfileNote.textContent = profile.note || 'Sin nota.';

            const profileBgColor = profile.profile_color || '#1A202C';
            viewUserProfileModalContent.style.backgroundColor = profileBgColor;

            const contrastTextColor = getContrastColor(profileBgColor);
            viewUserProfileName.style.color = contrastTextColor;
            viewUserProfileNote.style.color = contrastTextColor;
            closeViewUserProfileModalButton.style.color = contrastTextColor;

            // Admin Ban/Unban button logic
            if (window.currentUserProfile.is_admin && userId !== window.currentUserId) {
                banUserButton.classList.remove('hidden');
                banUserButton.textContent = profile.is_banned ? 'Desbanear Usuario' : 'Banear Usuario';
                banUserButton.onclick = () => banUser(userId, profile.is_banned);
            } else {
                banUserButton.classList.add('hidden');
            }

            viewUserProfileModal.classList.remove('hidden');
        }

        // New: Close User Profile Modal
        closeViewUserProfileModalButton.addEventListener('click', () => {
            viewUserProfileModal.classList.add('hidden');
        });

        // Close modal when clicking outside of it
        viewUserProfileModal.addEventListener('click', (event) => {
            if (event.target === viewUserProfileModal) {
                viewUserProfileModal.classList.add('hidden');
            }
        });

        // Function to ban/unban a user (Admin only)
        async function banUser(userId, isBannedStatus) {
            if (!db || !window.currentUserId || !window.currentUserProfile.is_admin) {
                console.error("No autorizado para banear usuarios o Firestore/usuario no listo.");
                return;
            }
            if (userId === window.currentUserId) {
                alert("No puedes banearte a ti mismo.");
                return;
            }
            const action = isBannedStatus ? "desbanear" : "banear";
            if (!confirm(`¿Estás seguro de que quieres ${action} a este usuario?`)) {
                return; // User cancelled
            }
            try {
                await updateDoc(doc(db, "users", userId), {
                    is_banned: !isBannedStatus
                });
                console.log(`Usuario ${userId} ${action} exitosamente.`);
                viewUserProfileModal.classList.add('hidden'); // Close modal after action
                // If banning, force sign out the banned user if they are currently logged in
                // This will be handled by the onAuthStateChanged listener on their next activity update or login attempt.
            } catch (error) {
                console.error(`Error al ${action} usuario:`, error);
            }
        }

        // --- Private Chat Functions ---

        /**
         * Generates a consistent chat ID for two users.
         * @param {string} userId1
         * @param {string} userId2
         * @returns {string} Sorted combination of user IDs.
         */
        function generateChatId(userId1, userId2) {
            const sortedIds = [userId1, userId2].sort();
            return sortedIds.join('_');
        }

        /**
         * Opens the private chat modal and loads messages.
         * @param {string} targetUserId - The UID of the user to chat with.
         * @param {string} targetUsername - The display name of the user to chat with.
         */
        async function openPrivateChatModal(targetUserId, targetUsername) {
            if (!db || !window.currentUserId) {
                alert("Debes iniciar sesión para iniciar un chat privado.");
                return;
            }
            if (targetUserId === window.currentUserId && !window.currentUserProfile.is_admin) {
                alert("No puedes iniciar un chat privado contigo mismo.");
                return;
            }

            currentPrivateChatTargetId = targetUserId;
            currentPrivateChatId = generateChatId(window.currentUserId, targetUserId);
            privateChatHeaderName.textContent = `Chat con ${targetUsername}`;
            privateChatModal.classList.remove('hidden');
            privateChatMessagesContainer.innerHTML = '<p class="text-center text-gray-400">Cargando mensajes...</p>';

            // Listen for messages in this chat
            const messagesColRef = collection(db, "privateChats", currentPrivateChatId, "messages");
            const q = query(messagesColRef, orderBy("createdAt", "asc"));

            onSnapshot(q, (snapshot) => {
                privateChatMessagesContainer.innerHTML = '';
                if (snapshot.empty) {
                    privateChatMessagesContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">Aún no hay mensajes. ¡Sé el primero en saludar!</p>';
                } else {
                    snapshot.forEach(async (doc) => {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        const isSender = message.senderId === window.currentUserId;
                        const senderName = message.senderName || `Usuario_${message.senderId.substring(0, 6)}`;
                        const senderPhoto = message.senderPhotoURL || 'https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser';

                        messageElement.className = `flex items-start space-x-2 ${isSender ? 'justify-end' : 'justify-start'}`;
                        messageElement.innerHTML = `
                            ${!isSender ? `<img src="${senderPhoto}" alt="Foto de perfil" class="w-8 h-8 rounded-full border border-byte-accent-cyan">` : ''}
                            <div class="flex flex-col ${isSender ? 'items-end' : 'items-start'} max-w-[80%]">
                                <span class="text-xs font-semibold ${isSender ? 'text-right' : 'text-left'}">${senderName}</span>
                                <div class="${isSender ? 'bg-blue-600' : 'bg-gray-700'} text-white p-2 rounded-lg break-words">
                                    ${message.content}
                                </div>
                                <span class="text-xs text-gray-400 mt-1">${new Date(message.createdAt).toLocaleTimeString()}</span>
                            </div>
                            ${isSender ? `<img src="${senderPhoto}" alt="Foto de perfil" class="w-8 h-8 rounded-full border border-blue-400">` : ''}
                        `;
                        privateChatMessagesContainer.appendChild(messageElement);
                    });
                }
                privateChatMessagesContainer.scrollTop = privateChatMessagesContainer.scrollHeight;
            });
        }

        /**
         * Sends a private message to the currently open chat.
         */
        async function sendPrivateMessage() {
            if (!db || !window.currentUserId || !currentPrivateChatId || !currentPrivateChatTargetId) {
                console.error("Cannot send private message: missing data.");
                return;
            }
            const messageContent = privateChatInput.value.trim();
            if (!messageContent) {
                return;
            }

            try {
                // Ensure the private chat document exists (Firestore will create it if not)
                const chatDocRef = doc(db, "privateChats", currentPrivateChatId);
                await setDoc(chatDocRef, {
                    user1Id: generateChatId(window.currentUserId, currentPrivateChatTargetId).split('_')[0],
                    user2Id: generateChatId(window.currentUserId, currentPrivateChatTargetId).split('_')[1],
                    lastMessageAt: new Date().toISOString()
                }, { merge: true }); // Use merge: true to avoid overwriting existing chat data

                await addDoc(collection(db, "privateChats", currentPrivateChatId, "messages"), {
                    chatId: currentPrivateChatId,
                    senderId: window.currentUserId,
                    senderName: window.currentUsername,
                    senderPhotoURL: window.currentUserProfile.photo_url || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                    recipientId: currentPrivateChatTargetId,
                    content: messageContent,
                    createdAt: new Date().toISOString()
                });
                privateChatInput.value = '';
                console.log("Private message sent successfully!");
            } catch (error) {
                console.error("Error sending private message:", error);
            }
        }

        // Event listeners for private chat
        closePrivateChatModalButton.addEventListener('click', () => {
            privateChatModal.classList.add('hidden');
            currentPrivateChatTargetId = null;
            currentPrivateChatId = null;
        });

        privateChatModal.addEventListener('click', (event) => {
            if (event.target === privateChatModal) {
                privateChatModal.classList.add('hidden');
                currentPrivateChatTargetId = null;
                currentPrivateChatId = null;
            }
        });

        sendPrivateChatButton.addEventListener('click', sendPrivateMessage);
        privateChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendPrivateMessage();
            }
        });

        // --- Notification Functions ---

        /**
         * Loads and displays notifications for the current user.
         */
        function loadNotifications() {
            if (!db || !window.currentUserId) {
                console.error("Firestore or user not ready for notifications.");
                return;
            }

            const notificationsColRef = collection(db, "users", window.currentUserId, "notifications");
            const q = query(notificationsColRef, orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                notificationsListContainer.innerHTML = '';
                let unreadCount = 0;

                if (snapshot.empty) {
                    notificationsListContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">No tienes notificaciones.</p>';
                    notificationBadge.classList.add('hidden');
                    return;
                }

                snapshot.forEach((doc) => {
                    const notification = doc.data();
                    if (!notification.read) {
                        unreadCount++;
                    }

                    const notificationElement = document.createElement('div');
                    notificationElement.className = `p-3 rounded-md mb-2 border border-gray-700 ${notification.read ? 'bg-gray-800 text-gray-400' : 'bg-blue-900/50 text-white font-semibold'} flex items-center justify-between`;
                    notificationElement.innerHTML = `
                        <div>
                            <p class="text-sm">
                                <span class="font-bold">${notification.senderName}</span> te mencionó en un comentario:
                                <span class="italic text-gray-300">"${notification.content.substring(0, Math.min(notification.content.length, 50))}..."</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">${new Date(notification.createdAt).toLocaleString()}</p>
                        </div>
                        ${!notification.read ? `<button class="ml-4 text-byte-accent-cyan hover:text-cyan-400 transition-colors mark-read-button" data-notification-id="${doc.id}"><i class="fas fa-check-circle"></i></button>` : ''}
                    `;
                    notificationsListContainer.appendChild(notificationElement);
                });

                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }

                document.querySelectorAll('.mark-read-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const notifId = e.currentTarget.dataset.notificationId;
                        markNotificationAsRead(notifId);
                    });
                });
            });
        }

        /**
         * Marks a specific notification as read.
         * @param {string} notificationId - The ID of the notification to mark as read.
         */
        async function markNotificationAsRead(notificationId) {
            if (!db || !window.currentUserId) {
                console.error("Firestore or user not ready to mark notification as read.");
                return;
            }
            try {
                await updateDoc(doc(db, "users", window.currentUserId, "notifications", notificationId), {
                    read: true
                });
                console.log(`Notification ${notificationId} marked as read.`);
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        /**
         * Marks all unread notifications for the current user as read.
         */
        async function markAllNotificationsAsRead() {
            if (!db || !window.currentUserId) {
                console.error("Firestore or user not ready to mark all notifications as read.");
                return;
            }
            try {
                const notificationsQuery = query(
                    collection(db, "users", window.currentUserId, "notifications"),
                    where("read", "==", false)
                );
                const snapshot = await getDocs(notificationsQuery);
                const updatePromises = [];
                snapshot.forEach((doc) => {
                    updatePromises.push(updateDoc(doc.ref, { read: true }));
                });
                await Promise.all(updatePromises);
                console.log("All unread notifications marked as read.");
            } catch (error) {
                console.error("Error marking all notifications as read:", error);
            }
        }

        // --- Admin Chat View Functions ---

        /**
         * Loads and displays all private chat IDs for an admin.
         */
        async function loadAllPrivateChatsForAdmin() {
            if (!db || !window.currentUserProfile.is_admin) {
                console.error("No autorizado para ver todos los chats o Firestore/usuario no listo.");
                adminChatListContainer.innerHTML = '<p class="text-center text-red-400 text-sm">No tienes permisos para ver todos los chats.</p>';
                return;
            }

            try {
                const privateChatsColRef = collection(db, "privateChats");
                const q = query(privateChatsColRef); // No orderBy here, sort in JS if needed
                const querySnapshot = await getDocs(q);

                adminChatListContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    adminChatListContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">No hay chats privados creados aún.</p>';
                    return;
                }

                for (const chatDoc of querySnapshot.docs) {
                    const chatId = chatDoc.id;
                    const chatData = chatDoc.data();
                    const userIds = [chatData.user1Id, chatData.user2Id];
                    let user1Name = 'Cargando...';
                    let user2Name = 'Cargando...';

                    const user1Snap = await getDoc(doc(db, "users", userIds[0]));
                    if (user1Snap.exists()) user1Name = user1Snap.data().name || `Usuario_${userIds[0].substring(0, 6)}`;

                    const user2Snap = await getDoc(doc(db, "users", userIds[1]));
                    if (user2Snap.exists()) user2Name = user2Snap.data().name || `Usuario_${userIds[1].substring(0, 6)}`;

                    const chatElement = document.createElement('div');
                    chatElement.className = 'p-3 rounded-md mb-2 bg-gray-800 hover:bg-gray-700 transition duration-200 cursor-pointer flex justify-between items-center';
                    chatElement.innerHTML = `
                        <span class="text-byte-text-light text-sm">${user1Name} & <span class="font-bold">${user2Name}</span></span>
                        <button class="text-byte-accent-cyan hover:text-cyan-400 view-chat-button" data-chat-id="${chatId}" data-user1-id="${userIds[0]}" data-user2-id="${userIds[1]}" data-user1-name="${user1Name}" data-user2-name="${user2Name}">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    `;
                    adminChatListContainer.appendChild(chatElement);
                }

                document.querySelectorAll('.view-chat-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const user1Id = e.currentTarget.dataset.user1Id;
                        const user2Id = e.currentTarget.dataset.user2Id;
                        const user1Name = e.currentTarget.dataset.user1Name;
                        const user2Name = e.currentTarget.dataset.user2Name;

                        const targetUserForModalId = (user1Id === window.currentUserId) ? user2Id : user1Id;
                        const targetUserForModalName = (user1Id === window.currentUserId) ? user2Name : user1Name;

                        adminChatViewModal.classList.add('hidden');
                        openPrivateChatModal(targetUserForModalId, targetUserForModalName);
                    });
                });

            } catch (error) {
                console.error("Error fetching all private chats for admin:", error);
                adminChatListContainer.innerHTML = '<p class="text-center text-red-400 text-sm">Error al cargar la lista de chats.</p>';
            }
        }
    </script>
</body>
</html>
