<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foro de Byte - Tu comunidad digital</title>

    <link rel="icon" type="image/png" href="logo.png">
    <meta name="description" content="Foro oficial de Byte - Conéctate con nuestra comunidad, comparte ideas y obtén soporte.">
    <meta name="keywords" content="Byte, foro, comunidad, soporte, preguntas, respuestas, tecnología, diseño web, Venezuela">
    <meta name="author" content="Byte">
    <meta property="og:title" content="Foro de Byte - Comunidad y Soporte">
    <meta property="og:description" content="Un espacio para discutir, aprender y colaborar con la comunidad de Byte.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'byte-dark-bg': '#0A0A1A',
                        'byte-secondary-dark': '#1A202C',
                        'byte-text-light': '#F9FAFB',
                        'byte-accent-cyan': '#00FFFF',
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, signOut, sendPasswordResetEmail, updateProfile, updateEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, updateDoc, doc, arrayUnion, arrayRemove, getDoc, setDoc, where, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.currentUsername = "Usuario Anónimo"; // Default username
        window.currentUserProfile = {}; // Store additional user profile data
        let activityTimer; // Timer for updating user activity

        // UI Elements
        const authModalOverlay = document.getElementById('auth-modal-overlay');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authNameInput = document.getElementById('auth-name'); // New: Name input
        const authPhoneInput = document.getElementById('auth-phone'); // New: Phone input
        const authRulesAcceptCheckbox = document.getElementById('auth-rules-accept'); // New: Rules acceptance checkbox
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleButton = document.getElementById('auth-toggle-button');
        const authMessage = document.getElementById('auth-message');
        const videoBackground = document.getElementById('video-background');
        const forumContentWrapper = document.getElementById('forum-content-wrapper');
        const forgotPasswordLink = document.getElementById('forgot-password-link');

        // Header Buttons
        const settingsButton = document.getElementById('settings-button');
        const notificationsButton = document.getElementById('notifications-button'); // New: Notifications button
        const rulesButton = document.getElementById('rules-button'); // New: Rules button
        const notificationBadge = document.getElementById('notification-badge'); // New: Notification badge
        const adminChatViewButton = document.getElementById('admin-chat-view-button'); // New: Admin Chat View button

        // Modals
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalButton = document.getElementById('close-settings-modal');
        const customizeProfileLink = document.getElementById('customize-profile-link');
        const logoutButtonModal = document.getElementById('logout-button-modal'); // Get the logout button

        const profileSettingsModal = document.getElementById('profile-settings-modal');
        const closeProfileSettingsModalButton = document.getElementById('close-profile-settings-modal');
        const profileSettingsForm = document.getElementById('profile-settings-form');
        const profileNameInput = document.getElementById('profile-name');
        const profileEmailInput = document.getElementById('profile-email');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profilePhotoURLInput = document.getElementById('profile-photo-url');
        const profilePhotoPreview = document.getElementById('profile-photo-preview');
        const profileDOBInput = document.getElementById('profile-dob');
        const profileNoteInput = document.getElementById('profile-note-input'); // New: Note input
        const profileColorInput = document.getElementById('profile-color-input'); // New: Color input
        const profileMessage = document.getElementById('profile-message');

        const rulesModal = document.getElementById('rules-modal'); // New: Rules modal
        const closeRulesModalButton = document.getElementById('close-rules-modal'); // New: Close rules modal button

        const onlineUsersContainer = document.getElementById('online-users-container'); // New: Online users container

        // New: View User Profile Modal Elements
        const viewUserProfileModal = document.getElementById('view-user-profile-modal');
        const closeViewUserProfileModalButton = document.getElementById('close-view-user-profile-modal');
        const viewUserProfileModalContent = document.getElementById('view-user-profile-modal-content');
        const viewUserProfilePhoto = document.getElementById('view-user-profile-photo');
        const viewUserProfileName = document.getElementById('view-user-profile-name');
        const viewUserProfileNote = document.getElementById('view-user-profile-note');
        const banUserButton = document.getElementById('ban-user-button'); // New: Ban User button

        // Private Chat elements
        const privateChatModal = document.getElementById('private-chat-modal');
        const closePrivateChatModalButton = document.getElementById('close-private-chat-modal');
        const privateChatHeaderName = document.getElementById('private-chat-header-name');
        const privateChatMessagesContainer = document.getElementById('private-chat-messages-container');
        const privateChatInput = document.getElementById('private-chat-input');
        const sendPrivateChatButton = document.getElementById('send-private-chat-button');
        let currentPrivateChatTargetId = null; // Stores the UID of the user being chatted with
        let currentPrivateChatId = null; // Stores the combined chat ID

        // Notifications elements
        const notificationsModal = document.getElementById('notifications-modal');
        const closeNotificationsModalButton = document.getElementById('close-notifications-modal');
        const notificationsListContainer = document.getElementById('notifications-list-container');

        // Admin Chat View Modal
        const adminChatViewModal = document.getElementById('admin-chat-view-modal');
        const closeAdminChatViewModalButton = document.getElementById('close-admin-chat-view-modal');
        const adminChatListContainer = document.getElementById('admin-chat-list-container');


        let isRegisterMode = false; // State for login/register form

        // Constants for change limits
        const NAME_CHANGE_LIMIT_MS = 25 * 24 * 60 * 60 * 1000; // 25 days in milliseconds
        const EMAIL_CHANGE_LIMIT_MS = 25 * 24 * 60 * 60 * 1000; // 25 days in milliseconds
        const PHONE_CHANGE_LIMIT_MS = 30 * 24 * 60 * 60 * 1000; // 30 days in milliseconds
        const ONLINE_THRESHOLD_MS = 5 * 60 * 1000; // 5 minutes for online status

        // Function to show authentication message
        function showAuthMessage(message, isError = true) {
            authMessage.textContent = message;
            authMessage.classList.remove('hidden');
            if (isError) {
                authMessage.classList.add('text-red-400');
                authMessage.classList.remove('text-green-400');
            } else {
                authMessage.classList.add('text-green-400');
                authMessage.classList.remove('text-red-400');
            }
        }

        // Function to show profile message
        function showProfileMessage(message, isError = true) {
            profileMessage.textContent = message;
            profileMessage.classList.remove('hidden');
            if (isError) {
                profileMessage.classList.add('text-red-400');
                profileMessage.classList.remove('text-green-400');
            } else {
                profileMessage.classList.add('text-green-400');
                profileMessage.classList.remove('text-red-400');
            }
        }

        // Function to toggle between login and register forms
        authToggleButton.addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            if (isRegisterMode) {
                authModalTitle.textContent = 'Registrarse';
                authSubmitButton.textContent = 'Registrarse';
                authToggleText.textContent = '¿Ya tienes una una cuenta?';
                authToggleButton.textContent = 'Inicia Sesión';
                forgotPasswordLink.classList.add('hidden'); // Hide forgot password in register mode
                authNameInput.classList.remove('hidden'); // Show name input
                authPhoneInput.classList.remove('hidden'); // Show phone input
                authRulesAcceptCheckbox.parentElement.classList.remove('hidden'); // Show rules checkbox
            } else {
                authModalTitle.textContent = 'Iniciar Sesión';
                authSubmitButton.textContent = 'Iniciar Sesión';
                authToggleText.textContent = '¿No tienes una cuenta?';
                authToggleButton.textContent = 'Regístrate';
                forgotPasswordLink.classList.remove('hidden'); // Show forgot password in login mode
                authNameInput.classList.add('hidden'); // Hide name input
                authPhoneInput.classList.add('hidden'); // Hide phone input
                authRulesAcceptCheckbox.parentElement.classList.add('hidden'); // Hide rules checkbox
            }
            authMessage.classList.add('hidden'); // Clear message on toggle
        });

        // Handle form submission (login/register)
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const name = authNameInput.value; // Get name
            const phone = authPhoneInput.value; // Get phone

            if (!email || !password) {
                showAuthMessage("Por favor, ingresa correo y contraseña.");
                return;
            }
            if (isRegisterMode) {
                if (!name) {
                    showAuthMessage("Por favor, ingresa tu nombre.");
                    return;
                }
                if (!authRulesAcceptCheckbox.checked) {
                    showAuthMessage("Debes aceptar las reglas del foro para registrarte.");
                    return;
                }
            }

            authMessage.classList.add('hidden'); // Hide previous messages

            try {
                if (isRegisterMode) {
                    const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                    const user = userCredential.user;

                    // Update user profile with name and default photo (if any)
                    await updateProfile(user, {
                        displayName: name,
                        photoURL: "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser" // Default profile pic
                    });

                    // Save additional user data to Firestore directly on the user document
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const userDocRef = doc(window.db, `artifacts/${appId}/users/${user.uid}`);
                    await setDoc(userDocRef, {
                        name: name,
                        email: email,
                        phone: phone || '', // Save phone number, can be empty
                        photoURL: "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                        createdAt: Date.now(),
                        last_name_change_timestamp: Date.now(),
                        last_email_change_timestamp: Date.now(),
                        date_of_birth: '', // Initialize date of birth
                        note: '', // Initialize note
                        profileColor: '#00FFFF', // Default profile color
                        lastActivity: Date.now(), // Initialize last activity timestamp
                        isAdmin: false, // Default to not admin
                        isBanned: false // Default to not banned
                    });

                    await sendEmailVerification(user);
                    showAuthMessage("Registro exitoso. Por favor, verifica tu correo electrónico.", false);

                } else {
                    // Check if user is banned before signing in
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const usersCollectionRef = collection(window.db, `artifacts/${appId}/users`);
                    const q = query(usersCollectionRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.isBanned) {
                            showAuthMessage("Tu cuenta ha sido baneada del foro. Contacta a un administrador para más información.", true);
                            return;
                        }
                    }

                    await signInWithEmailAndPassword(window.auth, email, password);
                }
            } catch (error) {
                console.error("Authentication error:", error);
                let errorMessage = "Ocurrió un error. Intenta de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "El correo electrónico ya está en uso.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Correo electrónico no válido.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "La contraseña debe tener al menos 6 caracteres.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Correo o contraseña incorrectos.";
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = "Error de conexión a la red. Intenta de nuevo.";
                }
                showAuthMessage(errorMessage);
            }
        });

        // Handle Forgot Password
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;

            if (!email) {
                showAuthMessage("Por favor, ingresa tu correo electrónico para restablecer la contraseña.");
                return;
            }

            try {
                await sendPasswordResetEmail(window.auth, email);
                showAuthMessage("Se ha enviado un enlace de restablecimiento de contraseña a tu correo electrónico.", false);
            } catch (error) {
                console.error("Password reset error:", error);
                let errorMessage = "Error al enviar el correo de restablecimiento. Asegúrate de que el correo sea válido y esté registrado.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "No se encontró un usuario con ese correo electrónico.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Correo electrónico no válido.";
                }
                showAuthMessage(errorMessage);
            }
        });

        // Function to update user's last activity timestamp
        async function updateUserActivity() {
            if (window.db && window.currentUserId) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Update the user's main document directly
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${window.currentUserId}`);
                try {
                    await updateDoc(userDocRef, {
                        lastActivity: Date.now()
                    });
                    console.log(`User ${window.currentUserId} activity updated.`);
                } catch (error) {
                    console.error("Error updating user activity:", error);
                }
            }
        }

        // Global logout function
        window.logout = async () => {
            console.log("Attempting to sign out...");
            try {
                if (activityTimer) clearInterval(activityTimer); // Stop activity updates
                await signOut(window.auth);
                console.log("Sign out successful.");
                // onAuthStateChanged will handle UI updates
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Error al cerrar sesión. Intenta de nuevo."); // Use a custom modal in production
            }
        };

        // Initialize Firebase and authenticate
        async function initFirebase() {
            try {
                // Firebase configuration provided by the user
                const firebaseConfig = {
                    apiKey: "AIzaSyCWZItBsYQqOm3xzp_VKsI3KfhbvVvtMv0",
                    authDomain: "byteforo.firebaseapp.com",
                    projectId: "byteforo",
                    storageBucket: "byteforo.firebasestorage.app",
                    messagingSenderId: "583747734708",
                    appId: "1:583747734708:web:2e9cb5b05060ac0a2c9be1"
                };

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Listen for auth state changes
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        window.currentUsername = user.displayName || user.email || `Usuario_${user.uid.substring(0, 6)}`;
                        console.log("onAuthStateChanged: User is logged in.", user.uid);

                        // Force reload user data to get the latest email verification status
                        // This helps when a user verifies email in a separate tab/process and then logs in.
                        if (!user.emailVerified) {
                            console.log("User email not yet verified. Reloading user data...");
                            try {
                                await user.reload();
                                // Update the user object with the reloaded data
                                user = window.auth.currentUser; // Get the reloaded user object
                                console.log("User data reloaded. New emailVerified status:", user.emailVerified);
                            } catch (reloadError) {
                                console.error("Error reloading user data:", reloadError);
                            }
                        }

                        // Fetch additional user profile data from Firestore (now directly from user document)
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const userDocRef = doc(window.db, `artifacts/${appId}/users/${user.uid}`);
                        const profileSnap = await getDoc(userDocRef);

                        if (profileSnap.exists()) {
                            window.currentUserProfile = profileSnap.data();
                            // Update currentUsername with Firestore name if available and different
                            if (window.currentUserProfile.name) {
                                window.currentUsername = window.currentUserProfile.name;
                            }
                            // Check if banned
                            if (window.currentUserProfile.isBanned) {
                                console.warn("User is banned. Signing out.");
                                await signOut(window.auth); // Force sign out if banned
                                authModalOverlay.classList.remove('hidden');
                                videoBackground.classList.remove('hidden');
                                forumContentWrapper.classList.add('hidden');
                                showAuthMessage("Tu cuenta ha sido baneada del foro. Contacta a un administrador para más información.", true);
                                if (activityTimer) clearInterval(activityTimer);
                                return; // Stop further execution
                            }

                        } else {
                            // If profile doesn't exist, create a basic one (e.g., for users registered before this feature)
                            console.log("User profile not found in Firestore. Creating a new one.");
                            await setDoc(userDocRef, {
                                name: user.displayName || user.email || `Usuario_${user.uid.substring(0, 6)}`,
                                email: user.email,
                                phone: '',
                                photoURL: user.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                                createdAt: Date.now(),
                                last_name_change_timestamp: Date.now(),
                                last_email_change_timestamp: Date.now(),
                                last_phone_change_timestamp: Date.now(),
                                date_of_birth: '',
                                note: '', // Initialize note
                                profileColor: '#00FFFF', // Default profile color
                                lastActivity: Date.now(), // Initialize last activity
                                isAdmin: false, // Default to not admin
                                isBanned: false // Default to not banned
                            });
                            window.currentUserProfile = (await getDoc(userDocRef)).data();
                        }

                        // Hardcode admin UID check for client-side display and logic
                        if (user.uid === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2") { // IMPORTANT: Replace with your actual admin UID
                            window.currentUserProfile.isAdmin = true;
                            console.log("User is hardcoded admin.");
                        }


                        if (user.emailVerified) {
                            // User is logged in and verified
                            console.log("User email is verified. Displaying forum content.");
                            authModalOverlay.classList.add('hidden');
                            videoBackground.classList.add('hidden');
                            forumContentWrapper.classList.remove('hidden');
                            loadPosts(); // Load posts after authentication
                            loadOnlineUsers(); // Load online users
                            loadNotifications(); // Load user notifications
                            if (settingsButton) settingsButton.classList.remove('hidden'); // Show settings button
                            if (notificationsButton) notificationsButton.classList.remove('hidden'); // Show notifications button
                            if (adminChatViewButton) { // Show admin chat view button if admin
                                if (window.currentUserProfile.isAdmin) {
                                    adminChatViewButton.classList.remove('hidden');
                                } else {
                                    adminChatViewButton.classList.add('hidden');
                                }
                            }

                            // Start periodic activity update
                            if (activityTimer) clearInterval(activityTimer);
                            activityTimer = setInterval(updateUserActivity, 30 * 1000); // Update every 30 seconds
                            updateUserActivity(); // Initial update
                        } else {
                            // User is logged in but email not verified
                            console.log("User email is NOT verified. Showing verification message.");
                            authModalOverlay.classList.remove('hidden');
                            videoBackground.classList.remove('hidden');
                            forumContentWrapper.classList.add('hidden');
                            showAuthMessage("Por favor, verifica tu correo electrónico para acceder al foro. Revisa tu bandeja de entrada o spam.", false);
                            if (settingsButton) settingsButton.classList.add('hidden'); // Hide settings button
                            if (notificationsButton) notificationsButton.classList.add('hidden'); // Hide notifications button
                            if (adminChatViewButton) adminChatViewButton.classList.add('hidden'); // Hide admin chat view button
                            if (activityTimer) clearInterval(activityTimer); // Stop activity updates
                        }

                    } else {
                        // No user authenticated
                        window.currentUserId = null;
                        window.currentUsername = "Usuario Anónimo";
                        window.currentUserProfile = {};
                        console.log("onAuthStateChanged: No user authenticated. Updating UI for logged out state.");
                        authModalOverlay.classList.remove('hidden');
                        console.log("authModalOverlay hidden class removed:", authModalOverlay.classList.contains('hidden'));
                        videoBackground.classList.remove('hidden');
                        console.log("videoBackground hidden class removed:", videoBackground.classList.contains('hidden'));
                        forumContentWrapper.classList.add('hidden');
                        console.log("forumContentWrapper hidden class added:", forumContentWrapper.classList.contains('hidden'));
                        document.getElementById('posts-container').innerHTML = '<p class="text-center text-gray-400">Inicia sesión para ver las publicaciones.</p>';
                        onlineUsersContainer.innerHTML = ''; // Clear online users
                        notificationBadge.classList.add('hidden'); // Hide notification badge
                        if (settingsButton) settingsButton.classList.add('hidden'); // Hide settings button
                        if (notificationsButton) notificationsButton.classList.add('hidden'); // Hide notifications button
                        if (adminChatViewButton) adminChatViewButton.classList.add('hidden'); // Hide admin chat view button
                        if (activityTimer) clearInterval(activityTimer); // Stop activity updates
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('posts-container').innerHTML = '<p class="text-center text-red-400">Error al cargar el foro. Intenta de nuevo más tarde.</p>';
                authModalOverlay.classList.remove('hidden'); // Ensure modal is visible on init error
                videoBackground.classList.remove('hidden');
                forumContentWrapper.classList.add('hidden');
                if (activityTimer) clearInterval(activityTimer); // Stop activity updates
            }
        }

        // Function to create a new post
        window.createPost = async (content, imageUrl, videoUrl) => {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or user not ready for creating post.");
                return;
            }
            if (!content.trim() && !imageUrl.trim() && !videoUrl.trim()) {
                console.warn("Post content, image, or video cannot be empty.");
                return;
            }
            try {
                // Use __app_id for Firestore collection path
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const postsCollectionRef = collection(window.db, `artifacts/${appId}/public/data/posts`);
                console.log("Attempting to create post at path:", postsCollectionRef.path);
                await addDoc(postsCollectionRef, {
                    userId: window.currentUserId,
                    username: window.currentUsername, // Use currentUsername (from displayName or profile)
                    userPhotoURL: window.currentUserProfile.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                    content: content.trim(),
                    imageUrl: imageUrl.trim(), // Save image URL
                    videoUrl: videoUrl.trim(), // Save video URL
                    timestamp: Date.now(), // Store as Unix timestamp
                    likes: [], // Array of user IDs who liked the post
                    dislikes: [], // Array of user IDs who disliked the post
                    commentsCount: 0
                });
                console.log("Post created successfully!");
            }
            catch (error) {
                console.error("Error creating post:", error);
            }
        };

        // Function to like/dislike a post
        window.toggleReaction = async (postId, type) => {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or user not ready for toggling reaction.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const postRef = doc(window.db, `artifacts/${appId}/public/data/posts`, postId);
            console.log(`Attempting to toggle reaction '${type}' for post ${postId} at path:`, postRef.path);
            try {
                const postSnap = await getDoc(postRef);
                if (postSnap.exists()) {
                    const postData = postSnap.data();
                    let updatedLikes = [...postData.likes || []];
                    let updatedDislikes = [...postData.dislikes || []];

                    if (type === 'like') {
                        if (updatedLikes.includes(window.currentUserId)) {
                            // User already liked, remove like
                            updatedLikes = updatedLikes.filter(id => id !== window.currentUserId);
                        } else {
                            // Add like, remove dislike if exists
                            updatedLikes.push(window.currentUserId);
                            updatedDislikes = updatedDislikes.filter(id => id !== window.currentUserId);
                        }
                    } else if (type === 'dislike') {
                        if (updatedDislikes.includes(window.currentUserId)) {
                            // User already disliked, remove dislike
                            updatedDislikes = updatedDislikes.filter(id => id !== window.currentUserId);
                        } else {
                            // Add dislike, remove like if exists
                            updatedDislikes.push(window.currentUserId);
                            updatedLikes = updatedLikes.filter(id => id !== window.currentUserId);
                        }
                    }

                    await updateDoc(postRef, {
                        likes: updatedLikes,
                        dislikes: updatedDislikes
                    });
                    console.log(`Reaction '${type}' toggled successfully for post ${postId}.`);
                }
            } catch (error) {
                console.error(`Error toggling ${type} for post ${postId}:`, error);
            }
        };

        // Function to add a comment
        window.addComment = async (postId, commentContent) => {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or user not ready for adding comment.");
                return;
            }
            if (!commentContent.trim()) {
                console.warn("Comment content cannot be empty.");
                return;
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const commentsCollectionRef = collection(window.db, `artifacts/${appId}/public/data/posts/${postId}/comments`);
                console.log("Attempting to add comment to path:", commentsCollectionRef.path);
                const newCommentRef = await addDoc(commentsCollectionRef, {
                    userId: window.currentUserId,
                    username: window.currentUsername, // Use currentUsername
                    userPhotoURL: window.currentUserProfile.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                    content: commentContent.trim(),
                    timestamp: Date.now()
                });

                // Increment commentsCount on the parent post
                const postRef = doc(window.db, `artifacts/${appId}/public/data/posts`, postId);
                await updateDoc(postRef, {
                    commentsCount: (await getDoc(postRef)).data().commentsCount + 1
                });

                // --- Handle Mentions and Notifications ---
                const mentionRegex = /@([a-zA-Z0-9_.-]+)/g;
                let match;
                const mentionedUsernames = new Set();
                while ((match = mentionRegex.exec(commentContent)) !== null) {
                    mentionedUsernames.add(match[1]); // Add captured username (group 1)
                }

                if (mentionedUsernames.size > 0) {
                    const usersCollectionRef = collection(window.db, `artifacts/${appId}/users`);
                    for (const mentionedUsername of mentionedUsernames) {
                        // Query for the user by name
                        const q = query(usersCollectionRef, where("name", "==", mentionedUsername));
                        const querySnapshot = await getDocs(q);

                        if (!querySnapshot.empty) {
                            querySnapshot.forEach(async (userDoc) => {
                                const mentionedUserId = userDoc.id;
                                // Avoid notifying self-mentions
                                if (mentionedUserId !== window.currentUserId) {
                                    const notificationsCollectionRef = collection(window.db, `artifacts/${appId}/users/${mentionedUserId}/notifications`);
                                    await addDoc(notificationsCollectionRef, {
                                        type: 'mention',
                                        senderId: window.currentUserId,
                                        senderName: window.currentUsername,
                                        postId: postId,
                                        commentId: newCommentRef.id,
                                        content: commentContent.trim(), // Store the full comment content
                                        read: false,
                                        timestamp: Date.now()
                                    });
                                    console.log(`Notification sent to ${mentionedUsername}`);
                                }
                            });
                        } else {
                            console.warn(`Mentioned user "${mentionedUsername}" not found.`);
                        }
                    }
                }
                // --- End Mentions and Notifications ---

                console.log("Comment added successfully!");
            } catch (error) {
                console.error("Error adding comment:", error);
            }
        };

        // Function to load and display posts in real-time
        window.loadPosts = () => {
            if (!window.db) {
                console.error("Firestore not initialized for loading posts.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const postsCollectionRef = collection(window.db, `artifacts/${appId}/public/data/posts`);
            const q = query(postsCollectionRef, orderBy("timestamp", "desc")); // Order by latest

            const postsContainer = document.getElementById('posts-container'); // Moved declaration outside

            console.log("Attempting to load posts from path:", postsCollectionRef.path);
            onSnapshot(q, async (snapshot) => {
                postsContainer.innerHTML = ''; // Clear existing posts

                if (snapshot.empty) {
                    postsContainer.innerHTML = '<p class="text-center text-gray-400">No hay publicaciones aún. ¡Sé el primero en crear una!</p>';
                    return;
                }

                for (const postDoc of snapshot.docs) { // Renamed 'doc' to 'postDoc'
                    const post = postDoc.data();
                    const postId = postDoc.id;
                    const userDisplayName = post.username || `Usuario_${post.userId.substring(0, 6)}`;
                    const userPhoto = post.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                    const imageUrl = post.imageUrl || '';
                    const videoUrl = post.videoUrl || '';

                    // Determine if the author is an admin (either hardcoded or by flag in profile)
                    const userDocRef = doc(window.db, `artifacts/${appId}/users/${post.userId}`);
                    const userProfileSnap = await getDoc(userDocRef);
                    const isAuthorAdmin = (userProfileSnap.exists() && userProfileSnap.data().isAdmin) || (post.userId === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2");

                    const usernameClass = isAuthorAdmin ? 'text-red-500' : 'text-byte-text-light';
                    const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';


                    let mediaContent = '';
                    if (imageUrl) {
                        mediaContent = `<img src="${imageUrl}" alt="Imagen de la publicación" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/F9FAFB?text=Imagen+no+disponible';">`;
                    } else if (videoUrl) {
                        mediaContent = `<video controls class="w-full h-auto rounded-lg mb-4 max-h-96 object-cover"><source src="${videoUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
                    }


                    const postElement = document.createElement('div');
                    postElement.className = 'bg-byte-secondary-dark p-6 rounded-lg shadow-xl mb-6 border border-byte-accent-cyan/30';
                    postElement.innerHTML = `
                        <div class="flex items-center mb-4">
                            <img src="${userPhoto}" alt="Foto de perfil" class="w-10 h-10 rounded-full mr-3 border border-byte-accent-cyan">
                            <div>
                                <p class="font-bold ${usernameClass}">${userDisplayName} ${adminTag}</p>
                                <p class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                            </div>
                            ${window.currentUserProfile.isAdmin ? `<button class="text-red-500 hover:text-red-700 ml-auto delete-post-button" data-post-id="${postId}"><i class="fas fa-trash"></i> Eliminar</button>` : ''}
                        </div>
                        ${mediaContent}
                        <p class="text-byte-text-light mb-4">${post.content}</p>
                        <div class="flex items-center justify-between text-gray-400 text-sm">
                            <div class="flex items-center space-x-4">
                                <button class="flex items-center hover:text-byte-accent-cyan transition duration-200 like-button ${post.likes.includes(window.currentUserId) ? 'text-byte-accent-cyan' : ''}" data-post-id="${postId}" data-type="like">
                                    <i class="far fa-thumbs-up mr-1"></i>
                                    <span>${post.likes.length}</span>
                                </button>
                                <button class="flex items-center hover:text-red-400 transition duration-200 dislike-button ${post.dislikes.includes(window.currentUserId) ? 'text-red-400' : ''}" data-post-id="${postId}" data-type="dislike">
                                    <i class="far fa-thumbs-down mr-1"></i>
                                    <span>${post.dislikes.length}</span>
                                </button>
                                <button class="flex items-center hover:text-byte-accent-cyan transition duration-200 comment-button" data-post-id="${postId}">
                                    <i class="far fa-comment mr-1"></i>
                                    <span>${post.commentsCount}</span>
                                </button>
                            </div>
                        </div>
                    `;
                    postsContainer.appendChild(postElement);
                }

                // Attach event listeners for like/dislike/comment/delete buttons after rendering
                document.querySelectorAll('.like-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening post modal
                        window.toggleReaction(button.dataset.postId, 'like');
                    };
                });
                document.querySelectorAll('.dislike-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening post modal
                        window.toggleReaction(button.dataset.postId, 'dislike');
                    };
                });
                document.querySelectorAll('.comment-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening post modal
                        openPostModal(button.dataset.postId);
                    };
                });
                document.querySelectorAll('.delete-post-button').forEach(button => {
                    button.onclick = (e) => {
                        e.stopPropagation();
                        deletePost(button.dataset.postId);
                    };
                });
            }, (error) => {
                console.error("Error fetching posts:", error);
                postsContainer.innerHTML = '<p class="text-center text-red-400">Error al cargar las publicaciones.</p>';
            });
        };

        // Function to delete a post (Admin only)
        async function deletePost(postId) {
            if (!window.db || !window.currentUserId || !window.currentUserProfile.isAdmin) {
                console.error("No autorizado para eliminar publicaciones o Firestore/usuario no listo.");
                return;
            }
            // Using a custom modal/confirmation in production is recommended instead of `confirm`
            if (!confirm("¿Estás seguro de que quieres eliminar esta publicación y todos sus comentarios?")) {
                return; // User cancelled
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const postRef = doc(window.db, `artifacts/${appId}/public/data/posts`, postId);
                console.log(`Attempting to delete post ${postId} at path:`, postRef.path);

                // Create a batch to delete comments and then the post
                const batch = writeBatch(window.db); // Correct usage of writeBatch

                // Delete all comments in the subcollection first
                const commentsCollectionRef = collection(postRef, 'comments');
                const commentsSnapshot = await getDocs(commentsCollectionRef);
                commentsSnapshot.forEach(commentDoc => {
                    batch.delete(commentDoc.ref);
                });
                
                // Then delete the post itself
                batch.delete(postRef);

                await batch.commit(); // Commit the batch operation
                console.log(`Publicación ${postId} eliminada exitosamente.`);
            } catch (error) {
                console.error("Error al eliminar publicación:", error);
            }
        };

        // Function to delete a comment (Admin only)
        async function deleteComment(postId, commentId) {
            if (!window.db || !window.currentUserId || !window.currentUserProfile.isAdmin) {
                console.error("No autorizado para eliminar comentarios o Firestore/usuario no listo.");
                return;
            }
            // Using a custom modal/confirmation in production is recommended instead of `confirm`
            if (!confirm("¿Estás seguro de que quieres eliminar este comentario?")) {
                return; // User cancelled
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const commentRef = doc(window.db, `artifacts/${appId}/public/data/posts/${postId}/comments`, commentId);
                console.log(`Attempting to delete comment ${commentId} for post ${postId} at path:`, commentRef.path);
                await deleteDoc(commentRef);
                // Decrement commentsCount on the parent post
                const postRef = doc(window.db, `artifacts/${appId}/public/data/posts`, postId);
                await updateDoc(postRef, {
                    commentsCount: (await getDoc(postRef)).data().commentsCount - 1
                });
                console.log(`Comentario ${commentId} de la publicación ${postId} eliminado exitosamente.`);
            } catch (error) {
                console.error("Error al eliminar comentario:", error);
            }
        };

        // Modal elements for post creation/view
        const createPostModal = document.getElementById('create-post-modal');
        const closeCreatePostModalButton = document.getElementById('close-create-post-modal');
        const createPostForm = document.getElementById('create-post-form');
        const postContentInput = document.getElementById('post-content-input');
        const postImageUrlInput = document.getElementById('post-image-url-input'); // New: Image URL input
        const postVideoUrlInput = document.getElementById('post-video-url-input'); // New: Video URL input
        const newTopicButton = document.getElementById('new-topic-button');

        const viewPostModal = document.getElementById('view-post-modal');
        const closeViewPostModalButton = document.getElementById('close-view-post-modal');
        const viewPostContent = document.getElementById('view-post-content');
        const commentsContainer = document.getElementById('comments-container');
        const commentInput = document.getElementById('comment-input');
        const addCommentButton = document.getElementById('add-comment-button');
        let currentViewedPostId = null; // To keep track of the post being viewed

        // Open create post modal
        newTopicButton.addEventListener('click', () => {
            if (window.currentUserId) {
                createPostModal.classList.remove('hidden');
                postContentInput.value = ''; // Clear previous content
                postImageUrlInput.value = ''; // Clear image URL
                postVideoUrlInput.value = ''; // Clear video URL
            } else {
                // Using a simple alert for now, consider a custom modal for better UX
                alert("Debes iniciar sesión para crear una publicación.");
            }
        });

        // Close create post modal
        closeCreatePostModalButton.addEventListener('click', () => {
            createPostModal.classList.add('hidden');
        });

        // Close create post modal when clicking outside
        createPostModal.addEventListener('click', (event) => {
            if (event.target === createPostModal) {
                createPostModal.classList.add('hidden');
            }
        });

        // Submit new post form
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = postContentInput.value;
            const imageUrl = postImageUrlInput.value;
            const videoUrl = postVideoUrlInput.value;
            await window.createPost(content, imageUrl, videoUrl);
            createPostModal.classList.add('hidden');
        });

        // Open view post modal and load comments
        window.openPostModal = async (postId) => {
            currentViewedPostId = postId;
            if (!window.db) {
                console.error("Firestore not initialized for viewing post.");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const postRef = doc(window.db, `artifacts/${appId}/public/data/posts`, postId);
            const postSnap = await getDoc(postRef);

            if (postSnap.exists()) {
                const post = postSnap.data();
                const userDisplayName = post.username || `Usuario_${post.userId.substring(0, 6)}`;
                const userPhoto = post.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                const imageUrl = post.imageUrl || '';
                const videoUrl = post.videoUrl || '';

                // Determine if the author is an admin (either hardcoded or by flag in profile)
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${post.userId}`);
                const userProfileSnap = await getDoc(userDocRef);
                const isAuthorAdmin = (userProfileSnap.exists() && userProfileSnap.data().isAdmin) || (post.userId === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2");
                const usernameClass = isAuthorAdmin ? 'text-red-500' : 'text-byte-text-light';
                const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';


                let mediaContent = '';
                if (imageUrl) {
                    mediaContent = `<img src="${imageUrl}" alt="Imagen de la publicación" class="w-full h-auto rounded-lg mb-4 object-cover max-h-96" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1A202C/F9FAFB?text=Imagen+no+disponible';">`;
                } else if (videoUrl) {
                    mediaContent = `<video controls class="w-full h-auto rounded-lg mb-4 max-h-96 object-cover"><source src="${videoUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
                }

                viewPostContent.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${userPhoto}" alt="Foto de perfil" class="w-10 h-10 rounded-full mr-3 border border-byte-accent-cyan">
                        <div>
                            <p class="font-bold ${usernameClass}">${userDisplayName} ${adminTag}</p>
                            <p class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                        ${mediaContent}
                        <p class="text-byte-text-light mb-4">${post.content}</p>
                        <div class="flex items-center space-x-4 text-gray-400 text-sm mb-4">
                            <span class="flex items-center"><i class="fas fa-thumbs-up mr-1"></i> ${post.likes.length}</span>
                            <span class="flex items-center"><i class="fas fa-thumbs-down mr-1"></i> ${post.dislikes.length}</span>
                            <span class="flex items-center"><i class="fas fa-comment mr-1"></i> ${post.commentsCount}</span>
                        </div>
                    `;
                viewPostModal.classList.remove('hidden');
                loadComments(postId); // Load comments for this post
            } else {
                console.error("Post not found.");
            }
        };

        // Close view post modal
        closeViewPostModalButton.addEventListener('click', () => {
            viewPostModal.classList.add('hidden');
            commentsContainer.innerHTML = ''; // Clear comments when closing
            currentViewedPostId = null;
        });

        // Close view post modal when clicking outside
        viewPostModal.addEventListener('click', (event) => {
            if (event.target === viewPostModal) {
                viewPostModal.classList.add('hidden');
            }
        });

        // Load and display comments in real-time
        function loadComments(postId) {
            if (!window.db) {
                console.error("Firestore not initialized for loading comments.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const commentsCollectionRef = collection(window.db, `artifacts/${appId}/public/data/posts/${postId}/comments`);
            const q = query(commentsCollectionRef, orderBy("timestamp", "asc")); // Order by oldest first

            console.log(`Attempting to load comments for post ${postId} from path:`, commentsCollectionRef.path);
            onSnapshot(q, async (snapshot) => {
                commentsContainer.innerHTML = ''; // Clear existing comments

                if (snapshot.empty) {
                    commentsContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">Sé el primero en comentar.</p>';
                    return;
                }

                for (const commentDoc of snapshot.docs) { // Renamed 'doc' to 'commentDoc'
                    const comment = commentDoc.data();
                    const userDisplayName = comment.username || `Usuario_${comment.userId.substring(0, 6)}`;
                    const userPhoto = comment.userPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";

                    // Determine if the author is an admin (either hardcoded or by flag in profile)
                    const userDocRef = doc(window.db, `artifacts/${appId}/users/${comment.userId}`);
                    const userProfileSnap = await getDoc(userDocRef);
                    const isAuthorAdmin = (userProfileSnap.exists() && userProfileSnap.data().isAdmin) || (comment.userId === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2");
                    const usernameClass = isAuthorAdmin ? 'text-red-500' : 'font-semibold text-byte-text-light';
                    const adminTag = isAuthorAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';


                    const commentElement = document.createElement('div');
                    commentElement.className = 'bg-byte-dark-bg p-3 rounded-md mb-3 border border-gray-700';
                    commentElement.innerHTML = `
                        <div class="flex items-center mb-2">
                            <img src="${userPhoto}" alt="Foto de perfil" class="w-8 h-8 rounded-full mr-2 border border-gray-600">
                            <div>
                                <p class="${usernameClass}">${userDisplayName} ${adminTag}</p>
                                <p class="text-xs text-gray-500">${new Date(comment.timestamp).toLocaleString()}</p>
                            </div>
                            ${window.currentUserProfile.isAdmin ? `<button class="ml-auto text-red-500 hover:text-red-700 delete-comment-button" data-post-id="${postId}" data-comment-id="${commentDoc.id}"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                        <p class="text-byte-text-light text-sm">${comment.content}</p>
                    `;
                    commentsContainer.appendChild(commentElement);
                }

                // Attach event listeners for delete comment buttons
                document.querySelectorAll('.delete-comment-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const postId = e.currentTarget.dataset.postId;
                        const commentId = e.currentTarget.dataset.commentId;
                        deleteComment(postId, commentId);
                    });
                });

            }, (error) => {
                console.error("Error fetching comments:", error);
                commentsContainer.innerHTML = '<p class="text-center text-red-400 text-sm">Error al cargar los comentarios.</p>';
            });
        }

        // Add comment button click
        addCommentButton.addEventListener('click', async () => {
            if (currentViewedPostId && commentInput.value.trim()) {
                await window.addComment(currentViewedPostId, commentInput.value);
                commentInput.value = ''; // Clear input after submitting
            } else if (!window.currentUserId) {
                // Using a simple alert for now, consider a custom modal for better UX
                alert("Debes iniciar sesión para comentar.");
            }
        });

        // New: Settings Modal Logic
        settingsButton.addEventListener('click', () => {
            if (window.currentUserId) {
                settingsModal.classList.remove('hidden');
            } else {
                // Using a simple alert for now, consider a custom modal for better UX
                alert("Debes iniciar sesión para acceder a los ajustes.");
            }
        });

        closeSettingsModalButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        // Close settings modal when clicking outside
        settingsModal.addEventListener('click', (event) => {
            if (event.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        // New: Logout Button in Settings Modal
        logoutButtonModal.addEventListener('click', () => {
            console.log("Logout button clicked in modal.");
            window.logout(); // Call the global logout function
            settingsModal.classList.add('hidden'); // Close the settings modal
        });

        // New: Customize Profile Link in Settings Modal
        customizeProfileLink.addEventListener('click', async (e) => {
            e.preventDefault();
            settingsModal.classList.add('hidden'); // Close settings modal
            profileSettingsModal.classList.remove('hidden'); // Open profile settings modal

            // Populate profile fields with current data
            profileNameInput.value = window.currentUserProfile.name || '';
            profileEmailInput.value = window.auth.currentUser.email || ''; // Populate with current auth email
            profilePhoneInput.value = window.currentUserProfile.phone || '';
            profilePhotoURLInput.value = window.currentUserProfile.photoURL || '';
            profilePhotoPreview.src = window.currentUserProfile.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
            profileDOBInput.value = window.currentUserProfile.date_of_birth || '';
            profileNoteInput.value = window.currentUserProfile.note || ''; // Populate note
            profileColorInput.value = window.currentUserProfile.profileColor || '#00FFFF'; // Populate color
            profileMessage.classList.add('hidden'); // Clear previous messages
        });

        // New: Close Profile Settings Modal
        closeProfileSettingsModalButton.addEventListener('click', () => {
            profileSettingsModal.classList.add('hidden');
        });

        // Close profile settings modal when clicking outside
        profileSettingsModal.addEventListener('click', (event) => {
            if (event.target === profileSettingsModal) {
                profileSettingsModal.classList.add('hidden');
            }
        });

        // New: Handle Profile Settings Form Submission
        profileSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newName = profileNameInput.value.trim();
            const newEmail = profileEmailInput.value.trim();
            const newPhone = profilePhoneInput.value.trim();
            const newPhotoURL = profilePhotoURLInput.value.trim();
            const newDOB = profileDOBInput.value.trim();
            const newNote = profileNoteInput.value.trim(); // Get new note
            const newProfileColor = profileColorInput.value; // Get new color

            if (!newName) {
                showProfileMessage("El nombre no puede estar vacío.", true);
                return;
            }

            profileMessage.classList.add('hidden');

            try {
                const user = window.auth.currentUser;
                if (user) {
                    const now = Date.now();
                    let profileUpdates = {};
                    let authUpdates = {};
                    let changesMade = false; // Flag to track if any changes were made

                    // Handle Name Change
                    if (newName !== window.currentUserProfile.name) {
                        const lastChange = window.currentUserProfile.last_name_change_timestamp || 0;
                        // Admins bypass time limit
                        if (!window.currentUserProfile.isAdmin && (now - lastChange < NAME_CHANGE_LIMIT_MS)) {
                            showProfileMessage(`Solo puedes cambiar tu nombre cada ${NAME_CHANGE_LIMIT_MS / (24 * 60 * 60 * 1000)} días.`, true);
                            return;
                        }
                        authUpdates.displayName = newName;
                        profileUpdates.name = newName;
                        profileUpdates.last_name_change_timestamp = now; // Update timestamp even for admins
                        changesMade = true;
                    }

                    // Handle Email Change
                    if (newEmail !== user.email) {
                        const lastChange = window.currentUserProfile.last_email_change_timestamp || 0;
                        // Admins bypass time limit
                        if (!window.currentUserProfile.isAdmin && (now - lastChange < EMAIL_CHANGE_LIMIT_MS)) {
                            showProfileMessage(`Solo puedes cambiar tu correo electrónico cada ${EMAIL_CHANGE_LIMIT_MS / (24 * 60 * 60 * 1000)} días.`, true);
                            return;
                        }
                        await updateEmail(user, newEmail);
                        profileUpdates.email = newEmail;
                        profileUpdates.last_email_change_timestamp = now; // Update timestamp even for admins
                        showProfileMessage("Correo electrónico actualizado. Por favor, verifica tu nuevo correo.", false);
                        changesMade = true;
                    }

                    // Handle Phone Change
                    if (newPhone !== window.currentUserProfile.phone) {
                        const lastChange = window.currentUserProfile.last_phone_change_timestamp || 0;
                        // Admins bypass time limit
                        if (!window.currentUserProfile.isAdmin && (now - lastChange < PHONE_CHANGE_LIMIT_MS)) {
                            showProfileMessage(`Solo puedes cambiar tu número de teléfono cada ${PHONE_CHANGE_LIMIT_MS / (24 * 60 * 60 * 1000)} días.`, true);
                            return;
                        }
                        profileUpdates.phone = newPhone;
                        profileUpdates.last_phone_change_timestamp = now; // Update timestamp even for admins
                        changesMade = true;
                    }

                    // Handle Photo URL Change
                    if (newPhotoURL !== window.currentUserProfile.photoURL) {
                        authUpdates.photoURL = newPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                        profileUpdates.photoURL = newPhotoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                        changesMade = true;
                    }

                    // Handle Date of Birth Change
                    if (newDOB !== window.currentUserProfile.date_of_birth) {
                        profileUpdates.date_of_birth = newDOB;
                        changesMade = true;
                    }

                    // Handle Note Change
                    if (newNote !== window.currentUserProfile.note) {
                        profileUpdates.note = newNote;
                        changesMade = true;
                    }

                    // Handle Profile Color Change
                    if (newProfileColor !== window.currentUserProfile.profileColor) {
                        profileUpdates.profileColor = newProfileColor;
                        changesMade = true;
                    }

                    if (!changesMade) {
                        showProfileMessage("No hay cambios para guardar.", false);
                        setTimeout(() => {
                            profileSettingsModal.classList.add('hidden');
                        }, 1500);
                        return;
                    }

                    // Apply Firebase Auth updates
                    if (Object.keys(authUpdates).length > 0) {
                        await updateProfile(user, authUpdates);
                    }

                    // Apply Firestore user profile updates (now directly on the user document)
                    if (Object.keys(profileUpdates).length > 0) {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const userDocRef = doc(window.db, `artifacts/${appId}/users/${user.uid}`);
                        await updateDoc(userDocRef, profileUpdates);
                        // Update local currentUserProfile with new data
                        window.currentUserProfile = { ...window.currentUserProfile, ...profileUpdates };
                        window.currentUsername = window.currentUserProfile.name; // Ensure username is updated
                    }

                    showProfileMessage("Perfil actualizado exitosamente.", false);
                    // Optionally close modal after a short delay
                    setTimeout(() => {
                        profileSettingsModal.classList.add('hidden');
                    }, 1500);
                }
            } catch (error) {
                console.error("Error updating profile:", error);
                let errorMessage = "Error al actualizar el perfil. Intenta de nuevo.";
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = "Por favor, inicia sesión de nuevo para actualizar tu correo electrónico.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "El nuevo correo electrónico no es válido.";
                } else if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "El nuevo correo electrónico ya está en uso.";
                }
                showProfileMessage(errorMessage, true);
            }
        });

        // Update photo preview on input change
        profilePhotoURLInput.addEventListener('input', () => {
            profilePhotoPreview.src = profilePhotoURLInput.value || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
        });

        // New: Rules Modal Logic
        rulesButton.addEventListener('click', () => {
            rulesModal.classList.remove('hidden');
        });

        closeRulesModalButton.addEventListener('click', () => {
            rulesModal.classList.add('hidden');
        });

        // Close rules modal when clicking outside
        rulesModal.addEventListener('click', (event) => {
            if (event.target === rulesModal) {
                rulesModal.classList.add('hidden');
            }
        });

        // New: Notifications Button Logic
        notificationsButton.addEventListener('click', () => {
            if (window.currentUserId) {
                notificationsModal.classList.remove('hidden');
                // Mark all current notifications as read when opening the modal
                markAllNotificationsAsRead();
            } else {
                alert("Debes iniciar sesión para ver las notificaciones.");
            }
        });

        closeNotificationsModalButton.addEventListener('click', () => {
            notificationsModal.classList.add('hidden');
        });

        notificationsModal.addEventListener('click', (event) => {
            if (event.target === notificationsModal) {
                notificationsModal.classList.add('hidden');
            }
        });

        // Add hover animations for settings and notifications buttons
        settingsButton.addEventListener('mouseenter', () => {
            settingsButton.querySelector('i').classList.add('animate-spin-slow');
        });
        settingsButton.addEventListener('mouseleave', () => {
            settingsButton.querySelector('i').classList.remove('animate-spin-slow');
        });

        notificationsButton.addEventListener('mouseenter', () => {
            notificationsButton.querySelector('i').classList.add('animate-shake');
        });
        notificationsButton.addEventListener('mouseleave', () => {
            notificationsButton.querySelector('i').classList.remove('animate-shake');
        });

        // Admin Chat View Button Logic
        if (adminChatViewButton) {
            adminChatViewButton.addEventListener('click', () => {
                if (window.currentUserProfile.isAdmin) {
                    adminChatViewModal.classList.remove('hidden');
                    loadAllPrivateChatsForAdmin();
                } else {
                    alert("No tienes permisos de administrador para ver todos los chats.");
                }
            });
        }

        closeAdminChatViewModalButton.addEventListener('click', () => {
            adminChatViewModal.classList.add('hidden');
        });

        adminChatViewModal.addEventListener('click', (event) => {
            if (event.target === adminChatViewModal) {
                adminChatViewModal.classList.add('hidden');
            }
        });


        // Function to load and display online users in real-time
        function loadOnlineUsers() {
            if (!window.db) {
                console.error("Firestore not initialized for loading online users.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Listen to the main user collection directly
            const usersCollectionRef = collection(window.db, `artifacts/${appId}/users`);
            console.log("Attempting to load online users from path:", usersCollectionRef.path);

            onSnapshot(usersCollectionRef, (snapshot) => {
                const onlineUsersList = [];
                const now = Date.now();

                // Process each user document from the snapshot
                snapshot.forEach(userDoc => {
                    const profile = userDoc.data(); // Profile data is now directly on the user document
                    // Check if the user is currently online based on lastActivity timestamp
                    if (profile.lastActivity && (now - profile.lastActivity < ONLINE_THRESHOLD_MS)) {
                        onlineUsersList.push({
                            userId: userDoc.id, // Include userId for opening profile modal
                            name: profile.name || `Usuario_${userDoc.id.substring(0, 6)}`,
                            photoURL: profile.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                            note: profile.note || '',
                            profileColor: profile.profileColor || '#1A202C', // Default to secondary dark if not set
                            isAdmin: profile.isAdmin || (userDoc.id === "gEnwfp7imwfgz5H7VdSvCn8Yvnk2"), // Check for hardcoded admin UID
                            isBanned: profile.isBanned || false // Include banned status
                        });
                    }
                });
                renderOnlineUsers(onlineUsersList);
            }, (error) => {
                console.error("Error fetching online users:", error);
                onlineUsersContainer.innerHTML = '<p class="text-sm text-red-400 text-center">Error al cargar usuarios en línea.</p>';
            });
        }

        function renderOnlineUsers(users) {
            onlineUsersContainer.innerHTML = ''; // Clear before rendering
            if (users.length === 0) {
                onlineUsersContainer.innerHTML = '<p class="text-sm text-gray-400 text-center">No hay usuarios en línea.</p>';
                return;
            }
            // Sort users alphabetically by name for consistent display, admins first
            users.sort((a, b) => {
                if (a.isAdmin && !b.isAdmin) return -1;
                if (!a.isAdmin && b.isAdmin) return 1;
                return a.name.localeCompare(b.name);
            });

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center p-2 rounded-md hover:bg-gray-700 transition duration-200 cursor-pointer';
                const usernameClass = user.isAdmin ? 'text-red-500' : 'text-byte-text-light';
                const adminTag = user.isAdmin ? '<span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full font-normal">ADMIN</span>' : '';
                const bannedIcon = user.isBanned ? '<i class="fas fa-ban text-red-600 ml-1" title="Baneado"></i>' : '';

                userElement.innerHTML = `
                    <img src="${user.photoURL}" alt="${user.name}" class="w-8 h-8 rounded-full mr-2 border border-green-500">
                    <span class="text-sm ${usernameClass}">${user.name}${adminTag}${bannedIcon}</span>
                    <button class="ml-auto text-byte-accent-cyan hover:text-cyan-400 transition duration-200 chat-button" data-user-id="${user.userId}" data-username="${user.name}">
                        <i class="fas fa-comment-dots"></i>
                    </button>
                    <span class="ml-2 w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                `;
                userElement.querySelector('.chat-button').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent opening user profile modal
                    openPrivateChatModal(user.userId, user.name);
                });
                userElement.addEventListener('click', () => openUserProfileModal(user.userId)); // Add click listener for profile
                onlineUsersContainer.appendChild(userElement);
            });
        }

        /**
         * Determines a contrasting text color (black or white) for a given hex background color.
         * Uses the YIQ (luminosity) formula.
         * @param {string} hexcolor - The background color in hex format (e.g., "#RRGGBB").
         * @returns {string} "#F9FAFB" (light text) or "#0A0A1A" (dark text).
         */
        function getContrastColor(hexcolor) {
            // If hexcolor is not a valid hex, default to a safe value
            if (!/^#([A-Fa-f0-9]{3}){1,2}$/.test(hexcolor)) {
                return '#F9FAFB'; // Default to light text for invalid colors
            }

            // Convert hex to RGB
            let r = parseInt(hexcolor.substring(1, 3), 16);
            let g = parseInt(hexcolor.substring(3, 5), 16);
            let b = parseInt(hexcolor.substring(5, 7), 16);

            // Calculate YIQ value
            // (R*299 + G*587 + B*114) / 1000
            let yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;

            // Return black or white based on YIQ value
            return (yiq >= 128) ? '#0A0A1A' : '#F9FAFB'; // Dark text for light colors, light text for dark colors
        }


        // New: Function to open user profile modal
        async function openUserProfileModal(userId) {
            if (!window.db) {
                console.error("Firestore not initialized for viewing user profile.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // Fetch profile directly from the user document
            const userDocRef = doc(window.db, `artifacts/${appId}/users/${userId}`);
            console.log(`Attempting to load user profile for ${userId} from path:`, userDocRef.path);

            try {
                const profileSnap = await getDoc(userDocRef);
                if (profileSnap.exists()) {
                    const profile = profileSnap.data();
                    viewUserProfilePhoto.src = profile.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser";
                    viewUserProfileName.textContent = profile.name || `Usuario_${userId.substring(0, 6)}`;
                    viewUserProfileNote.textContent = profile.note || 'Sin nota.';
                    // Removed viewUserProfileId.textContent = userId; as per user request

                    // Set background color of the modal content
                    const profileBgColor = profile.profileColor || '#1A202C'; // Default to secondary dark if not set
                    viewUserProfileModalContent.style.backgroundColor = profileBgColor;

                    // Determine and set text color for contrast
                    const contrastTextColor = getContrastColor(profileBgColor);
                    viewUserProfileName.style.color = contrastTextColor;
                    viewUserProfileNote.style.color = contrastTextColor;
                    closeViewUserProfileModalButton.style.color = contrastTextColor; // Apply to close button as well

                    // Admin Ban/Unban button logic
                    if (window.currentUserProfile.isAdmin && userId !== window.currentUserId) {
                        banUserButton.classList.remove('hidden');
                        banUserButton.textContent = profile.isBanned ? 'Desbanear Usuario' : 'Banear Usuario';
                        banUserButton.onclick = () => banUser(userId, profile.isBanned);
                    } else {
                        banUserButton.classList.add('hidden');
                    }


                    viewUserProfileModal.classList.remove('hidden');
                } else {
                    console.error("User profile not found.");
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
            }
        }

        // New: Close User Profile Modal
        closeViewUserProfileModalButton.addEventListener('click', () => {
            viewUserProfileModal.classList.add('hidden');
        });

        // Close modal when clicking outside of it
        viewUserProfileModal.addEventListener('click', (event) => {
            if (event.target === viewUserProfileModal) {
                viewUserProfileModal.classList.add('hidden');
            }
        });

        // Function to ban/unban a user (Admin only)
        async function banUser(userId, isBannedStatus) {
            if (!window.db || !window.currentUserId || !window.currentUserProfile.isAdmin) {
                console.error("No autorizado para banear usuarios o Firestore/usuario no listo.");
                return;
            }
            if (userId === window.currentUserId) {
                alert("No puedes banearte a ti mismo.");
                return;
            }
            const action = isBannedStatus ? "desbanear" : "banear";
            // Using a custom modal/confirmation in production is recommended instead of `confirm`
            if (!confirm(`¿Estás seguro de que quieres ${action} a este usuario?`)) {
                return; // User cancelled
            }
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${userId}`);
                console.log(`Attempting to ${action} user ${userId} at path:`, userDocRef.path);
                await updateDoc(userDocRef, {
                    isBanned: !isBannedStatus // Toggle the banned status
                });
                console.log(`Usuario ${userId} ${action} exitosamente.`);
                viewUserProfileModal.classList.add('hidden'); // Close modal after action
                // If banning, force sign out the banned user if they are currently logged in
                // This will be handled by the onAuthStateChanged listener on their next activity update or login attempt.
            } catch (error) {
                console.error(`Error al ${action} usuario:`, error);
            }
        }

        // --- Private Chat Functions ---

        /**
         * Generates a consistent chat ID for two users.
         * @param {string} userId1
         * @param {string} userId2
         * @returns {string} Sorted combination of user IDs.
         */
        function generateChatId(userId1, userId2) {
            const sortedIds = [userId1, userId2].sort();
            return sortedIds.join('_');
        }

        /**
         * Opens the private chat modal and loads messages.
         * @param {string} targetUserId - The UID of the user to chat with.
         * @param {string} targetUsername - The display name of the user to chat with.
         */
        async function openPrivateChatModal(targetUserId, targetUsername) {
            if (!window.db || !window.currentUserId) {
                alert("Debes iniciar sesión para iniciar un chat privado.");
                return;
            }
            // Admins can open private chats with themselves to view history if needed
            if (targetUserId === window.currentUserId && !window.currentUserProfile.isAdmin) {
                alert("No puedes iniciar un chat privado contigo mismo.");
                return;
            }

            currentPrivateChatTargetId = targetUserId;
            currentPrivateChatId = generateChatId(window.currentUserId, targetUserId);
            privateChatHeaderName.textContent = `Chat con ${targetUsername}`;
            privateChatModal.classList.remove('hidden');
            privateChatMessagesContainer.innerHTML = '<p class="text-center text-gray-400">Cargando mensajes...</p>';

            // Load private chat messages
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const messagesCollectionRef = collection(window.db, `artifacts/${appId}/public/data/privateChats/${currentPrivateChatId}/messages`);
            const q = query(messagesCollectionRef, orderBy("timestamp", "asc"));

            console.log(`Attempting to load private chat messages for chat ID: ${currentPrivateChatId} from path:`, messagesCollectionRef.path);
            onSnapshot(q, async (snapshot) => {
                privateChatMessagesContainer.innerHTML = '';
                if (snapshot.empty) {
                    privateChatMessagesContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">Aún no hay mensajes. ¡Sé el primero en saludar!</p>';
                } else {
                    for (const doc of snapshot.docs) {
                        const message = doc.data();
                        const messageElement = document.createElement('div');
                        const isSender = message.senderId === window.currentUserId;
                        const senderName = message.senderName || `Usuario_${message.senderId.substring(0, 6)}`;
                        const senderPhoto = message.senderPhotoURL || 'https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser';

                        messageElement.className = `flex items-start space-x-2 ${isSender ? 'justify-end' : 'justify-start'}`;
                        messageElement.innerHTML = `
                            ${!isSender ? `<img src="${senderPhoto}" alt="Foto de perfil" class="w-8 h-8 rounded-full border border-byte-accent-cyan">` : ''}
                            <div class="flex flex-col ${isSender ? 'items-end' : 'items-start'} max-w-[80%]">
                                <span class="text-xs font-semibold ${isSender ? 'text-right' : 'text-left'}">${senderName}</span>
                                <div class="${isSender ? 'bg-blue-600' : 'bg-gray-700'} text-white p-2 rounded-lg break-words">
                                    ${message.content}
                                </div>
                                <span class="text-xs text-gray-400 mt-1">${new Date(message.timestamp).toLocaleTimeString()}</span>
                            </div>
                            ${isSender ? `<img src="${senderPhoto}" alt="Foto de perfil" class="w-8 h-8 rounded-full border border-blue-400">` : ''}
                        `;
                        privateChatMessagesContainer.appendChild(messageElement);
                    }
                }
                privateChatMessagesContainer.scrollTop = privateChatMessagesContainer.scrollHeight; // Scroll to bottom
            }, (error) => {
                console.error("Error loading private chat messages:", error);
                privateChatMessagesContainer.innerHTML = '<p class="text-center text-red-400">Error al cargar los mensajes.</p>';
            });
        }

        /**
         * Sends a private message to the currently open chat.
         */
        async function sendPrivateMessage() {
            if (!window.db || !window.currentUserId || !currentPrivateChatId || !currentPrivateChatTargetId) {
                console.error("Cannot send private message: missing data.");
                return;
            }
            const messageContent = privateChatInput.value.trim();
            if (!messageContent) {
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const messagesCollectionRef = collection(window.db, `artifacts/${appId}/public/data/privateChats/${currentPrivateChatId}/messages`);
                console.log(`Attempting to send private message to chat ID: ${currentPrivateChatId} at path:`, messagesCollectionRef.path);
                await addDoc(messagesCollectionRef, {
                    senderId: window.currentUserId,
                    senderName: window.currentUsername,
                    senderPhotoURL: window.currentUserProfile.photoURL || "https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser",
                    recipientId: currentPrivateChatTargetId,
                    content: messageContent,
                    timestamp: Date.now()
                });
                privateChatInput.value = ''; // Clear input
                console.log("Private message sent successfully!"); // Added log
            } catch (error) {
                console.error("Error sending private message:", error);
            }
        }

        // Event listeners for private chat
        closePrivateChatModalButton.addEventListener('click', () => {
            privateChatModal.classList.add('hidden');
            currentPrivateChatTargetId = null;
            currentPrivateChatId = null;
        });

        privateChatModal.addEventListener('click', (event) => {
            if (event.target === privateChatModal) {
                privateChatModal.classList.add('hidden');
                currentPrivateChatTargetId = null;
                currentPrivateChatId = null;
            }
        });

        sendPrivateChatButton.addEventListener('click', sendPrivateMessage);
        privateChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendPrivateMessage();
            }
        });

        // --- Notification Functions ---

        /**
         * Loads and displays notifications for the current user.
         */
        function loadNotifications() {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or user not ready for notifications.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const notificationsCollectionRef = collection(window.db, `artifacts/${appId}/users/${window.currentUserId}/notifications`);
            const q = query(notificationsCollectionRef, orderBy("timestamp", "desc"));

            console.log(`Attempting to load notifications for user ${window.currentUserId} from path:`, notificationsCollectionRef.path);
            onSnapshot(q, (snapshot) => {
                notificationsListContainer.innerHTML = '';
                let unreadCount = 0;

                if (snapshot.empty) {
                    notificationsListContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">No tienes notificaciones.</p>';
                    notificationBadge.classList.add('hidden');
                    return;
                }

                snapshot.forEach((doc) => {
                    const notification = doc.data();
                    const notificationId = doc.id;
                    if (!notification.read) {
                        unreadCount++;
                    }

                    const notificationElement = document.createElement('div');
                    notificationElement.className = `p-3 rounded-md mb-2 border border-gray-700 ${notification.read ? 'bg-gray-800 text-gray-400' : 'bg-blue-900/50 text-white font-semibold'} flex items-center justify-between`;
                    notificationElement.innerHTML = `
                        <div>
                            <p class="text-sm">
                                <span class="font-bold">${notification.senderName}</span> te mencionó en un comentario:
                                <span class="italic text-gray-300">"${notification.content.substring(0, Math.min(notification.content.length, 50))}..."</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">${new Date(notification.timestamp).toLocaleString()}</p>
                        </div>
                        ${!notification.read ? `<button class="ml-4 text-byte-accent-cyan hover:text-cyan-400 transition-colors mark-read-button" data-notification-id="${notificationId}"><i class="fas fa-check-circle"></i></button>` : ''}
                    `;
                    notificationsListContainer.appendChild(notificationElement);
                });

                // Update badge
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }

                // Attach event listeners for mark as read buttons
                document.querySelectorAll('.mark-read-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const notifId = e.currentTarget.dataset.notificationId;
                        markNotificationAsRead(notifId);
                    });
                });

            }, (error) => {
                console.error("Error fetching notifications:", error);
                notificationsListContainer.innerHTML = '<p class="text-center text-red-400 text-sm">Error al cargar las notificaciones.</p>';
                notificationBadge.classList.add('hidden');
            });
        }

        /**
         * Marks a specific notification as read.
         * @param {string} notificationId - The ID of the notification to mark as read.
         */
        async function markNotificationAsRead(notificationId) {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or user not ready to mark notification as read.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const notificationRef = doc(window.db, `artifacts/${appId}/users/${window.currentUserId}/notifications`, notificationId);
            console.log(`Attempting to mark notification ${notificationId} as read at path:`, notificationRef.path);
            try {
                await updateDoc(notificationRef, {
                    read: true
                });
                console.log(`Notification ${notificationId} marked as read.`);
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        /**
         * Marks all unread notifications for the current user as read.
         */
        async function markAllNotificationsAsRead() {
            if (!window.db || !window.currentUserId) {
                console.error("Firestore or user not ready to mark all notifications as read.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const notificationsCollectionRef = collection(window.db, `artifacts/${appId}/users/${window.currentUserId}/notifications`);
            const q = query(notificationsCollectionRef, where("read", "==", false));

            console.log(`Attempting to mark all unread notifications for user ${window.currentUserId} from path:`, notificationsCollectionRef.path);
            try {
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(window.db); // Correct usage of writeBatch
                querySnapshot.forEach((doc) => {
                    batch.update(doc.ref, { read: true });
                });
                await batch.commit();
                console.log("All unread notifications marked as read.");
            } catch (error) {
                console.error("Error marking all notifications as read:", error);
            }
        }

        // --- Admin Chat View Functions ---

        /**
         * Loads and displays all private chat IDs for an admin.
         */
        async function loadAllPrivateChatsForAdmin() {
            if (!window.db || !window.currentUserProfile.isAdmin) {
                console.error("No autorizado para ver todos los chats o Firestore/usuario no listo.");
                adminChatListContainer.innerHTML = '<p class="text-center text-red-400 text-sm">No tienes permisos para ver todos los chats.</p>';
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const privateChatsCollectionRef = collection(window.db, `artifacts/${appId}/public/data/privateChats`);
            console.log("Attempting to load all private chats for admin from path:", privateChatsCollectionRef.path);

            try {
                const querySnapshot = await getDocs(privateChatsCollectionRef);
                adminChatListContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    adminChatListContainer.innerHTML = '<p class="text-center text-gray-400 text-sm">No hay chats privados creados aún.</p>';
                    return;
                }

                for (const docSnap of querySnapshot.docs) {
                    const chatId = docSnap.id;
                    const userIds = chatId.split('_');
                    let user1Name = 'Cargando...';
                    let user2Name = 'Cargando...';

                    // Fetch usernames for display
                    const user1DocRef = doc(window.db, `artifacts/${appId}/users/${userIds[0]}`);
                    const user2DocRef = doc(window.db, `artifacts/${appId}/users/${userIds[1]}`);

                    const [user1Snap, user2Snap] = await Promise.all([getDoc(user1DocRef), getDoc(user2DocRef)]);

                    if (user1Snap.exists()) {
                        user1Name = user1Snap.data().name || `Usuario_${userIds[0].substring(0, 6)}`;
                    }
                    if (user2Snap.exists()) {
                        user2Name = user2Snap.data().name || `Usuario_${userIds[1].substring(0, 6)}`;
                    }

                    const chatElement = document.createElement('div');
                    chatElement.className = 'p-3 rounded-md mb-2 bg-gray-800 hover:bg-gray-700 transition duration-200 cursor-pointer flex justify-between items-center';
                    chatElement.innerHTML = `
                        <span class="text-byte-text-light text-sm">${user1Name} & <span class="font-bold">${user2Name}</span></span>
                        <button class="text-byte-accent-cyan hover:text-cyan-400 view-chat-button" data-chat-id="${chatId}" data-user1-id="${userIds[0]}" data-user2-id="${userIds[1]}" data-user1-name="${user1Name}" data-user2-name="${user2Name}">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    `;
                    adminChatListContainer.appendChild(chatElement);
                }

                // Attach event listeners for view chat buttons
                document.querySelectorAll('.view-chat-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const user1Id = e.currentTarget.dataset.user1Id;
                        const user2Id = e.currentTarget.dataset.user2Id;
                        const user1Name = e.currentTarget.dataset.user1Name;
                        const user2Name = e.currentTarget.dataset.user2Name;

                        // Determine which user is the target for the private chat modal
                        // If current admin is user1, target is user2, else target is user1
                        const targetUserForModalId = (user1Id === window.currentUserId) ? user2Id : user1Id;
                        const targetUserForModalName = (user1Id === window.currentUserId) ? user2Name : user1Name;

                        adminChatViewModal.classList.add('hidden'); // Close admin chat list
                        openPrivateChatModal(targetUserForModalId, targetUserForModalName);
                    });
                });

            } catch (error) {
                console.error("Error fetching all private chats for admin:", error);
                adminChatListContainer.innerHTML = '<p class="text-center text-red-400 text-sm">Error al cargar la lista de chats.</p>';
            }
        }


        // Initialize Firebase when the window loads
        window.addEventListener('load', initFirebase);
    </script>

    <style>
        /* Box-Sizing universal para un modelo de caja consistente */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        /* Estilos base para HTML y Body */
        html {
            height: 100%; /* Asegura que HTML tenga altura completa */
            width: 100%; /* Asegura que HTML tenga ancho completo */
        }
        body {
            min-height: 100vh; /* Asegura que el body ocupe al menos la altura completa del viewport, permitiendo el scroll */
            width: 100%; /* Asegura que el body ocupe el ancho completo */
            overflow-x: hidden; /* Previene el scroll horizontal no deseado */
            background-color: #0A0A1A; /* Color de fondo oscuro principal */
            font-family: 'Inter', sans-serif; /* Fuente principal */
            color: #F9FAFB; /* Color de texto principal */
            margin: 0;
            padding: 0;
            /* Deshabilita la selección de texto para una experiencia más similar a una aplicación */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Estilos para encabezados (h1-h6) */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif; /* Fuente para encabezados */
            color: #00FFFF; /* Cian eléctrico para acentos */
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5); /* Sombra para un efecto de brillo */
        }

        /* Estilo de contorno de texto */
        .text-stroke-cyan {
            -webkit-text-stroke: 1.5px #00FFFF; /* Contorno cian para navegadores WebKit */
            text-stroke: 1.5px #00FFFF; /* Contorno cian estándar */
            color: #FFFFFF; /* Color de relleno del texto */
            text-shadow: none; /* Asegura que no haya sombras de texto que interfieran */
        }

        /* Animación "Fall-in" al hacer scroll para AOS (se mantiene la definición pero no se usará si AOS.init se elimina) */
        @keyframes fall-in {
            0% {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Clase aplicada por AOS.js para animar elementos (se mantiene la definición pero no se usará si AOS.init se elimina) */
        .aos-animate {
            animation-name: fall-in;
            animation-duration: 1s;
            animation-fill-mode: forwards;
            animation-timing-function: cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        /* Estilos para el texto del menú de navegación con contorno cian */
        /* Fuente Montserrat aplicada directamente aquí para asegurar su visualización */
        .nav-menu-text-stroke-cyan {
            color: #E0E0E0; /* Color base plateado para el texto */
            -webkit-text-stroke-width: 0.7px; /* Contorno cian más delgado para texto pequeño */
            -webkit-text-stroke-color: #A0A0A0; /* Contorno gris más oscuro para efecto plateado */
            text-shadow: 0 0 5px rgba(224, 224, 224, 0.3), 0 0 10px rgba(160, 160, 160, 0.2); /* Sombra para profundidad */
            transition: color 0.3s ease-in-out, -webkit-text-stroke-color 0.3s ease-in-out, text-shadow 0.3s ease-in-out;
            font-family: 'Montserrat', sans-serif; /* APLICADO DIRECTAMENTE AQUÍ */
        }

        /* Efecto de brillo y elevación en los enlaces del menú al pasar el ratón */
        .menu-link-hover-effect { /* Nueva clase para efectos hover */
            position: relative;
            transition: color 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .menu-link-hover-effect::before {
            content: '';
            position: absolute;
            bottom: -5px; /* Posición de la línea debajo del texto */
            left: 0; /* Comienza desde el inicio del texto */
            width: 0; /* La línea comienza con ancho cero */
            height: 3px; /* Grosor de la línea */
            background-color: #00FFFF; /* Color cian */
            border-radius: 2px;
            transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out; /* Transición para el ancho y la opacidad */
            opacity: 0; /* Inicialmente invisible */
        }
        .menu-link-hover-effect:hover::before {
            width: 100%; /* La línea se expande al 100% del ancho del elemento padre */
            opacity: 1; /* Se vuelve visible */
            background-color: #00FFFF; /* Asegura que el subrayado sea cian al pasar el ratón */
        }
        .menu-link-hover-effect:hover .nav-menu-text-stroke-cyan {
            color: #00FFFF; /* Cian eléctrico al pasar el ratón */
            -webkit-text-stroke-color: #00BFFF; /* Cian más oscuro para el contorno al pasar el ratón */
            text-shadow: 0 0 8px #00FFFF, 0 0 15px rgba(0, 255, 255, 0.6); /* Brillo intenso al pasar el ratón */
        }
        .menu-link-hover-effect:hover {
            transform: translateY(-5px); /* Eleva el enlace ligeramente más para un "salto" notable */
        }

        /* Animación de rebote sutil para el icono de flecha */
        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        /* Clase para activar la rotación y el rebote de la flecha */
        .js-arrow-icon.arrow-active, .js-arrow-icon-mobile.arrow-active {
            transform: rotate(180deg);
            animation: bounce-subtle 0.5s ease-in-out infinite alternate;
        }

        /* Estilos de las tarjetas de servicio */
        .service-card {
            background: linear-gradient(145deg, #1A202C, #0A0A1A); /* Gradiente sutil para el fondo */
            border-radius: 1rem; /* Esquinas más redondeadas */
            padding: 2rem; /* Relleno reducido */
            box-shadow: 0 10px 25px rgba(0, 255, 255, 0.2); /* Sombra con color de acento */
            transition: all 0.3s ease-in-out; /* Transición suave para todos los cambios */
            border: 1px solid rgba(0, 255, 255, 0.3); /* Borde sutil */
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .service-card:hover {
            transform: translateY(-8px) scale(1.03); /* Elevación y ligero aumento de tamaño al pasar el ratón */
            box-shadow: 0 15px 35px rgba(0, 255, 255, 0.4); /* Sombra más pronunciada al pasar el ratón */
            border-color: #00FFFF; /* Borde más visible al pasar el ratón */
        }

        .service-card .icon {
            font-size: 3.5rem; /* Tamaño de icono reducido */
            margin-bottom: 1rem; /* Margen reducido */
            color: #E0E0E0; /* Color gris claro para los iconos de servicio (blanco y negro) */
            transition: transform 0.3s ease-in-out, color 0.3s ease-in-out; /* Transición para el hover del icono */
        }
        .service-card:hover .icon {
            transform: rotate(10deg) scale(1.1); /* Efecto de rotación y escala al pasar el ratón */
            color: #FFFFFF; /* Blanco puro al pasar el ratón para un contraste más fuerte */
        }

        .service-card h3 {
            color: #F9FAFB; /* Texto del título más claro */
            font-size: 1.5rem; /* Tamaño del título reducido */
            margin-bottom: 0.75rem; /* Margen reducido */
            font-weight: 700; /* Más negrita */
        }

        .service-card p {
            color: #CBD5E0; /* Texto de párrafo más suave */
            font-size: 0.95rem; /* Tamaño de párrafo reducido */
            line-height: 1.6;
        }

        /* Estilos específicos para las tarjetas de servicio en pantallas pequeñas (celulares) */
        @media (max-width: 768px) { /* Para pantallas de hasta 768px (md breakpoint) */
            .service-card {
                padding: 1.2rem; /* Reduce el padding para hacer las tarjetas más compactas */
            }
            .service-card .icon {
                font-size: 2.8rem; /* Reduce el tamaño del icono */
                margin-bottom: 0.8rem;
            }
            .service-card h3 {
                font-size: 1.3rem; /* Reduce el tamaño del título */
                margin-bottom: 0.6rem;
            }
            .service-card p {
                font-size: 0.85rem; /* Reduce el tamaño del párrafo */
            }
        }

        /* Estilos específicos de la sección de contacto */
        .contact-section {
            background: linear-gradient(180deg, #1A202C, #0A0A1A); /* Gradiente de fondo */
            padding: 4rem 0; /* Relleno reducido */
            position: relative;
            overflow: hidden;
        }

        .contact-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate-gradient 20s linear infinite; /* Animación de rotación para el fondo */
            z-index: 0;
        }

        @keyframes rotate-gradient {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .contact-content {
            position: relative;
            z-index: 1;
            background: rgba(10, 10, 26, 0.85); /* Fondo semi-transparente para el contenido */
            border-radius: 1.5rem;
            padding: 2.5rem; /* Relleno reducido */
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px); /* Efecto de desenfoque */
        }

        /* Ajuste de relleno para tarjetas de contacto - AHORA MANEJADO EN HTML CON TAILWIND */
        .contact-form-card,
        .contact-info-card {
            background: #1A202C; /* Fondo oscuro para tarjetas internas */
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
        }
        .contact-form-card:hover, .contact-info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 255, 255, 0.3);
        }

        .contact-form-card input,
        .contact-form-card textarea {
            background-color: #0A0A1A; /* Usar el color de fondo primario */
            border: 1px solid rgba(0, 255, 255, 0.3); /* Borde cian sutil */
            color: #F9FAFB; /* Color de texto claro */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .contact-form-card input::placeholder,
        .contact-form-card textarea::placeholder {
            color: #b0b0b0; /* Color del placeholder */
        }
        .contact-form-card input:focus,
        .contact-form-card textarea:focus {
            border-color: #00FFFF; /* Cian al enfocar */
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.5);
        }
        .social-icon-link {
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
            color: #F9FAFB; /* Color de icono predeterminado */
        }
        .social-icon-link:hover {
            transform: translateY(-3px) scale(1.1);
            color: #00FFFF; /* Cian al pasar el ratón */
        }
        .map-container {
            overflow: hidden;
            border-radius: 1rem;
            margin-top: 2rem; /* Margen reducido */
            width: 100%;
            /* Altura del mapa - AHORA CONTROLADA POR TAILWIND EN HTML */
        }
        .map-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Estilo de enlace deshabilitado */
        .disabled-link {
            opacity: 0.6; /* Opacidad reducida para indicar deshabilitado */
            cursor: not-allowed; /* Cursor de "no permitido" */
        }

        /* Estilos del menú desplegable de escritorio */
        .js-dropdown-menu {
            position: absolute;
            top: 100%; /* Justo debajo del botón padre */
            left: 50%;
            transform: translateX(-50%);
            /* min-width: 180px; Ajustado via Tailwind classes */
            background-color: #1A202C; /* Color oscuro secundario */
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            overflow: hidden; /* Para que las esquinas redondeadas funcionen bien con los elementos */
            border: 1px solid rgba(0, 255, 255, 0.3); /* Borde cian sutil */
        }

        /* Hover de subcategoría en verde aqua para escritorio */
        .js-dropdown-menu a {
            display: block;
            padding: 0.75rem 1.25rem;
            color: #F9FAFB; /* Color de texto claro */
            text-align: center; /* Centrar texto en el desplegable */
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .js-dropdown-menu a:hover {
            background-color: #00FFFF; /* Cian eléctrico para el fondo */
            color: #0A0A1A; /* Texto oscuro al pasar el ratón */
        }

        /* Animación de vibración para el botón de WhatsApp */
        @keyframes shake {
            10%, 90% {
                transform: translate3d(-1px, 0, 0);
            }
            20%, 80% {
                transform: translate3d(2px, 0, 0);
            }
            30%, 50%, 70% {
                transform: translate3d(-4px, 0, 0);
            }
            40%, 60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* Animación de brillo de pulso para el botón de WhatsApp */
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(37, 211, 102, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }

        /* Estilos del menú desplegable móvil */
        .js-dropdown-menu-mobile {
            background-color: #1A202C; /* Color oscuro secundario */
            border-radius: 0.5rem;
            margin-top: 0.5rem; /* Espacio entre el enlace padre y el submenú */
            padding: 0.5rem 0; /* Relleno dentro del desplegable */
            position: relative; /* Necesario para el centrado absoluto */
            left: 50%; /* Centrado horizontal */
            transform: translateX(-50%); /* Centrado horizontal */
            width: 90%; /* Ajustar el ancho para que no sea fijo a 40 y sea más adaptable */
            max-width: 200px; /* Ancho máximo para evitar que sea demasiado grande */
        }

        /* Hover de subcategoría en verde aqua para móvil */
        .js-dropdown-menu-mobile a {
            padding: 0.75rem 1.5rem; /* Indentar sub-elementos */
            text-align: center; /* CENTRADO DE SUBCATEGORÍAS EN MÓVIL */
            border-radius: 0; /* Eliminar bordes redondeados para elementos individuales */
        }

        .js-dropdown-menu-mobile a:hover {
            background-color: #00FFFF; /* Cian eléctrico para el fondo */
            color: #0A0A1A; /* Texto oscuro al pasar el ratón */
        }

        /* Nuevo estilo para enlaces de menú móvil activos (subrayado y color de texto) */
        .mobile-menu-link-active::before {
            width: 100% !important; /* Fuerza el ancho a 100% */
            opacity: 1 !important; /* Fuerza la visibilidad */
            background-color: #00FFFF !important; /* Asegura el color cian */
        }

        .mobile-menu-link-active {
            transform: translateY(-5px) !important; /* Eleva el enlace */
        }

        /* --- Estilos para reducción de tamaño en PC y pantallas grandes --- */
        @media (min-width: 1024px) { /* Ajusta este breakpoint según sea necesario (lg en Tailwind) */
            .header-nav-item {
                font-size: 0.95rem; /* Fuente más pequeña para enlaces de navegación */
            }

            .main-cta-button {
                padding: 0.6rem 1.5rem; /* Relleno de botón ligeramente más pequeño */
                font-size: 0.9rem; /* Fuente más pequeña para el botón CTA */
            }

            .hero-section-padding {
                padding-top: 6rem; /* Ajusta el relleno superior para la sección hero */
                padding-bottom: 6rem; /* Ajusta el relleno inferior para la sección hero */
            }

            .hero-heading {
                font-size: 3.5rem; /* Encabezado más pequeño para la sección hero */
            }

            .hero-subheading {
                font-size: 1.1rem; /* Subencabezado más pequeño para la sección hero */
            }

            .section-heading {
                font-size: 2.5rem; /* Encabezados de sección generales más pequeños */
            }

            .service-card {
                padding: 1.5rem; /* Relleno más pequeño para tarjetas de servicio */
            }

            .service-card .icon {
                font-size: 3rem; /* Tamaño de icono más pequeño en tarjetas de servicio */
            }

            .service-card h3 {
                font-size: 1.3rem; /* Título más pequeño en tarjetas de servicio */
            }

            .service-card p {
                font-size: 0.85rem; /* Texto de párrafo más pequeño en tarjetas de servicio */
            }

            .contact-section {
                padding: 3rem 0; /* Relleno más pequeño para la sección de contacto */
            }

            .contact-content {
                padding: 2rem; /* Relleno más pequeño para la tarjeta de contenido de contacto */
            }

            .contact-form-card,
            .contact-info-card {
                padding: 1.5rem; /* Relleno más pequeño para tarjetas de contacto internas */
            }

            .contact-form-card input,
            .contact-form-card textarea {
                font-size: 0.8rem; /* Fuente más pequeña para campos de formulario */
            }

            .social-icon-link svg {
                width: 24px; /* Iconos sociales más pequeños */
                height: 24px;
            }

        }

        /* Estilos del pie de página */
        .footer {
            background-color: #1A202C; /* Fondo oscuro secundario */
            color: #F9FAFB; /* Texto claro */
            padding: 2rem 0; /* Relleno para el pie de página */
            border-top: 1px solid rgba(0, 255, 255, 0.3); /* Borde superior cian sutil */
        }

        .footer a {
            color: #00FFFF; /* Cian para enlaces */
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #00BFFF; /* Cian más oscuro al pasar el ratón */
        }

        .footer-heading {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.25rem; /* Fuente más grande para encabezados */
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #00FFFF; /* Color cian para encabezados */
        }

        .footer-link-item {
            margin-bottom: 0.5rem; /* Espacio entre elementos de la lista */
        }

        .footer-social-icon {
            font-size: 1.75rem; /* Tamaño de los iconos sociales */
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .footer-social-icon:hover {
            color: #00FFFF; /* Cian al pasar el ratón */
            transform: translateY(-3px) scale(1.1);
        }

        /* Animación para la imagen del icono de precios */
        @keyframes rotate-3d {
            /* Modificado para rotar solo en el eje Y */
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }

        .price-icon-animated {
            animation: rotate-3d 12s linear infinite; /* Animación de rotación 3D, más lenta */
            transform-style: preserve-3d; /* Necesario para que la rotación 3D funcione */
        }


        /* Animación de giro para el texto del encabezado */
        @keyframes text-flip-out {
            0% {
                opacity: 1;
                transform: rotateY(0deg);
            }
            50% {
                opacity: 0;
                transform: rotateY(90deg);
            }
            100% {
                opacity: 0;
                transform: rotateY(180deg);
            }
        }

        @keyframes text-flip-in {
            0% {
                opacity: 0;
                transform: rotateY(-90deg);
            }
            50% {
                opacity: 0;
                transform: rotateY(0deg);
            }
            100% {
                opacity: 1;
                transform: rotateY(0deg);
            }
        }

        .text-flip-out {
            animation: text-flip-out 0.8s ease-in-out forwards;
        }

        .text-flip-in {
            animation: text-flip-in 0.8s ease-in-out forwards;
        }

        /* Estilos para asegurar que el h1 mantenga su altura y centrado */
        #hero-heading-text {
            height: 8rem; /* Altura fija para acomodar el texto más largo en varias líneas */
            display: flex; /* Habilitar flexbox */
            align-items: center; /* Centrar verticalmente el contenido */
            justify-content: center; /* Centrar horizontalmente el contenido */
            perspective: 1000px; /* Necesario para la animación 3D de giro */
        }

        /* Ajustes para pantallas más pequeñas si el texto se desborda */
        @media (max-width: 768px) {
            #hero-heading-text {
                height: 7rem; /* Altura fija para pantallas móviles */
            }
        }

        /* Estilos para deshabilitar la selección de texto y eventos de puntero en imágenes */
        img {
            pointer-events: none;
        }
        p, h1, h2, h3, h4, h5, h6, span, div:not(.map-container):not(.payment-card) {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        /* Estilos específicos del foro */
        .forum-category-card {
            background: linear-gradient(145deg, #1A202C, #0A0A1A);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.15);
            border: 1px solid rgba(0, 255, 255, 0.2);
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .forum-category-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 30px rgba(0, 255, 255, 0.3);
            border-color: #00FFFF;
        }

        .forum-category-card .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #00FFFF;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .forum-category-card h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #F9FAFB;
        }

        .forum-category-card p {
            font-size: 0.9rem;
            color: #CBD5E0;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .forum-topic-item {
            background-color: #1A202C;
            border: 1px solid rgba(0, 255, 255, 0.15);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            flex-direction: column; /* Changed to column for better responsiveness */
            justify-content: space-between;
            align-items: flex-start; /* Align items to start */
            transition: background-color 0.2s ease, transform 0.2s ease;
            cursor: pointer; /* Indicate clickable */
        }

        .forum-topic-item:hover {
            background-color: #2D3748;
            transform: translateX(5px);
        }

        .forum-topic-item .title {
            font-weight: 600;
            color: #00FFFF;
            font-size: 1.05rem;
            margin-bottom: 0.5rem; /* Space between title and meta */
        }

        .forum-topic-item .meta {
            font-size: 0.85rem;
            color: #CBD5E0;
            text-align: left; /* Align meta text to left */
            width: 100%; /* Take full width */
            display: flex; /* Use flex for meta items */
            justify-content: space-between; /* Distribute meta items */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .forum-topic-item .meta span {
            display: inline-block; /* Changed to inline-block */
            margin-right: 1rem; /* Space between meta items */
        }

        .new-topic-button {
            background-color: #00FFFF;
            color: #0A0A1A;
            font-weight: bold;
            padding: 0.8rem 2rem;
            border-radius: 9999px; /* Fully rounded */
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .new-topic-button:hover {
            background-color: #00BFFF;
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.6);
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal-content {
            background-color: #1A202C; /* Changed to byte-secondary-dark */
            padding: 2rem;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
            border: 1px solid #00FFFF;
            position: relative;
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling within modal */
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #00FFFF;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .modal-close-button:hover {
            color: #00BFFF;
        }

        .modal textarea, .modal input[type="text"], .modal input[type="email"], .modal input[type="password"], .modal input[type="url"], .modal input[type="tel"], .modal input[type="date"], .modal input[type="color"] {
            background-color: #1A202C; /* Changed to byte-secondary-dark */
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #F9FAFB;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            margin-bottom: 1rem;
        }

        .modal button[type="submit"] {
            background-color: #00FFFF;
            color: #0A0A1A;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .modal button[type="submit"]:hover {
            background-color: #00BFFF;
        }

        /* User ID display */
        .user-id-display {
            background-color: #1A202C;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: #CBD5E0;
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        /* Header hiding/showing styles */
        .header-main {
            transition: transform 0.3s ease-out; /* Smooth transition for hiding/showing */
        }
        .header-main.header-hidden {
            transform: translateY(-100%); /* Move completely out of view upwards */
        }

        /* New: Animations for icons */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.7; }
        }
        .animate-pulse {
            animation: pulse 1.5s infinite ease-in-out;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #EF4444; /* Red */
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            border-radius: 9999px; /* Full circle */
            padding: 0.1rem 0.4rem;
            min-width: 1.2rem;
            text-align: center;
            pointer-events: none; /* Allow clicks to pass through to the button */
        }
    </style>

</head>
<body class="relative">
    <!-- Video background, visible when not logged in -->
    <video autoplay loop muted playsinline id="video-background" class="absolute inset-0 w-full h-full object-cover z-0 hidden">
        <source src="./images/fondo.mp4" type="video/mp4">
        Tu navegador no soporta el video.
    </video>

    <!-- Authentication Modal Overlay -->
    <div id="auth-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40 hidden">
        <div class="bg-byte-secondary-dark p-8 rounded-lg shadow-2xl max-w-md w-full text-center relative border border-byte-accent-cyan/50">
            <h2 id="auth-modal-title" class="text-2xl font-bold mb-6 text-byte-accent-cyan">Iniciar Sesión</h2>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="auth-name" placeholder="Nombre (obligatorio al registrarse)" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan hidden">
                <input type="email" id="auth-email" placeholder="Correo Electrónico" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="password" id="auth-password" placeholder="Contraseña" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="tel" id="auth-phone" placeholder="Número de Teléfono (opcional)" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan hidden">
                
                <!-- New: Rules Acceptance Checkbox -->
                <div class="flex items-center justify-center text-sm text-gray-400 mt-4 hidden">
                    <input type="checkbox" id="auth-rules-accept" class="mr-2 rounded text-byte-accent-cyan focus:ring-byte-accent-cyan">
                    <label for="auth-rules-accept">Acepto las <a href="#" id="auth-rules-link" class="text-byte-accent-cyan hover:underline">Reglas del Foro</a></label>
                </div>

                <button type="submit" id="auth-submit-button" class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">Iniciar Sesión</button>
                <p class="text-sm text-gray-400 mt-4">
                    <a href="#" id="forgot-password-link" class="text-byte-accent-cyan hover:underline">¿Olvidaste tu contraseña?</a>
                </p>
                <p class="text-sm text-gray-400 mt-4">
                    <span id="auth-toggle-text">¿No tienes una cuenta?</span>
                    <button type="button" id="auth-toggle-button" class="text-byte-accent-cyan hover:underline ml-1">Regístrate</button>
                </p>
                <p id="auth-message" class="text-red-400 text-sm mt-2 hidden"></p>
            </form>
        </div>
    </div>

    <header id="main-header" class="header-main bg-byte-dark-bg text-byte-text-light py-2 shadow-lg sticky top-0 z-50 border-b border-byte-accent-cyan">
        <div class="w-full px-4 md:px-8 flex justify-between items-center gap-8">
            <div class="flex items-center justify-start ml-0">
                <img src="./images/logo.ico" alt="Logo de Byte" class="h-16 w-auto object-contain">
            </div>

            <nav class="flex items-center space-x-4">
                <div class="flex flex-col items-end space-y-2">
                    <a href="index.html#inicio" class="hidden sm:inline-block bg-yellow-500 text-black font-bold py-2 px-4 rounded-full
                                                 shadow-lg hover:bg-yellow-600 transition duration-300 transform hover:scale-110 text-sm main-cta-button">
                        Volver al Inicio
                    </a>
                    <div class="flex space-x-2">
                        <button id="rules-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-110 text-sm">
                            Reglas
                        </button>
                        <button id="notifications-button" class="hidden bg-purple-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-110 text-sm flex items-center justify-center relative">
                            <i class="fas fa-bell text-lg"></i>
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        </button>
                        <button id="settings-button" class="hidden bg-gray-700 text-white py-2 px-4 rounded-full shadow-lg hover:bg-gray-600 transition duration-300 transform hover:scale-110 text-sm flex items-center justify-center">
                            <i class="fas fa-cog text-lg"></i>
                        </button>
                        <button id="admin-chat-view-button" class="hidden bg-orange-600 text-white py-2 px-4 rounded-full shadow-lg hover:bg-orange-700 transition duration-300 transform hover:scale-110 text-sm">
                            <i class="fas fa-eye mr-1"></i> Ver Chats
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Forum content, hidden until logged in -->
    <div id="forum-content-wrapper" class="hidden">
        <main class="flex-grow">
            <section id="top" class="relative bg-byte-dark-bg text-white py-16 md:py-24 overflow-hidden flex items-center justify-center">
                <div class="container mx-auto px-4 relative z-10 text-center">
                    <h1 class="text-3xl md:text-5xl lg:text-4xl font-extrabold leading-tight mb-4 text-white drop-shadow-lg text-stroke-cyan hero-heading">
                        Bienvenido al Foro de Byte
                    </h1>
                    <p class="text-base md:text-xl lg:text-lg mb-8 max-w-3xl mx-auto text-byte-text-light opacity-90">
                        Un espacio para la comunidad de Byte para discutir, compartir ideas y obtener soporte.
                    </p>
                    <button id="new-topic-button" class="new-topic-button">
                        <i class="fas fa-plus-circle mr-2"></i> Crear Nueva Publicación
                    </button>
                </div>
            </section>

            <section id="forum-posts" class="py-12 lg:py-10 bg-byte-dark-bg text-byte-text-light">
                <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="md:col-span-3">
                        <h2 class="text-2xl md:text-4xl lg:text-3xl font-extrabold text-center mb-10 section-heading text-stroke-cyan">Publicaciones Recientes</h2>
                        <div id="posts-container" class="max-w-3xl mx-auto">
                            <!-- Posts will be loaded here dynamically by JavaScript -->
                            <p class="text-center text-gray-400">Cargando publicaciones...</p>
                        </div>
                    </div>
                    <div class="md:col-span-1 flex flex-col gap-8"> <!-- Flex column for right sidebar -->
                        <div class="bg-byte-secondary-dark p-6 rounded-lg shadow-xl border border-byte-accent-cyan/30 h-fit">
                            <h3 class="text-xl font-bold mb-4 text-byte-accent-cyan text-center">Usuarios en Línea</h3>
                            <div id="online-users-container" class="space-y-3">
                                <!-- Online users will be loaded here dynamically by JavaScript -->
                                <p class="text-sm text-gray-400 text-center">Cargando usuarios...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <footer class="footer bg-byte-secondary-dark text-byte-text-light py-8">
            <div class="container mx-auto px-4 grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left">
                <div class="md:col-span-3 flex justify-center space-x-4 mt-3">
                    <a href="https://www.instagram.com/byteweb_design?igsh=ZTI4NDE2eWptMThu" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
                        <i class="fab fa-instagram footer-social-icon text-byte-text-light"></i>
                    </a>
                    <a href="https://wa.me/584125646608" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
                        <i class="fab fa-whatsapp footer-social-icon text-byte-text-light"></i>
                    </a>
                </div>
            </div>
            <div class="container mx-auto px-4 text-center text-xs text-gray-400 mt-8 border-t border-gray-700 pt-4">
                <p class="mb-2">
                    Al navegar en la página de Byte, aceptas nuestros
                    <a href="#" class="text-byte-accent-cyan hover:underline">Términos de Servicio</a> y
                    <a href="#" class="text-byte-accent-cyan hover:underline">Condiciones</a>.
                </p>
                <p>© 2025 Byte. Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Create Post Modal -->
    <div id="create-post-modal" class="modal hidden">
        <div class="modal-content">
            <button id="close-create-post-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Crear Nueva Publicación</h2>
            <form id="create-post-form">
                <textarea id="post-content-input" class="w-full h-32 p-3 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="¿Qué tienes en mente?"></textarea>
                <input type="url" id="post-image-url-input" placeholder="URL de la Imagen (opcional)" class="w-full p-3 rounded-md mb-4 bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <input type="url" id="post-video-url-input" placeholder="URL del Video (opcional)" class="w-full p-3 rounded-md mb-4 bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <button type="submit" class="w-full bg-byte-accent-cyan text-byte-dark-bg py-2 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">Publicar</button>
            </form>
        </div>
    </div>

    <!-- View Post Modal -->
    <div id="view-post-modal" class="modal hidden">
        <div class="modal-content">
            <button id="close-view-post-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-byte-accent-cyan">Publicación</h2>
            <div id="view-post-content" class="mb-6">
                <!-- Post content will be loaded here -->
            </div>
            <h3 class="text-lg font-semibold mb-3 text-byte-accent-cyan">Comentarios</h3>
            <div id="comments-container" class="max-h-60 overflow-y-auto mb-4 p-2 border border-gray-700 rounded-md">
                <!-- Comments will be loaded here -->
            </div>
            <div class="flex items-center">
                <input type="text" id="comment-input" class="flex-grow p-3 rounded-l-md focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan" placeholder="Añadir un comentario...">
                <button id="add-comment-button" class="bg-byte-accent-cyan text-byte-dark-bg p-3 rounded-r-md font-semibold hover:bg-cyan-400 transition duration-200">Comentar</button>
            </div >
        </div >
    </div >

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <button id="close-settings-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan text-center">Ajustes</h2>
            <div class="flex flex-col space-y-4">
                <button id="customize-profile-link" class="w-full bg-byte-secondary-dark text-byte-text-light py-3 rounded-md font-semibold border border-byte-accent-cyan/30 hover:bg-byte-accent-cyan hover:text-byte-dark-bg transition duration-200">
                    Personalizar mi perfil
                </button>
                <button id="logout-button-modal" class="w-full bg-red-500 text-white py-3 rounded-md font-semibold hover:bg-red-600 transition duration-200">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="modal hidden">
        <div class="modal-content max-w-md">
            <button id="close-profile-settings-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan text-center">Personalizar mi perfil</h2>
            <form id="profile-settings-form" class="space-y-4">
                <div class="flex flex-col items-center mb-4">
                    <img id="profile-photo-preview" src="https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser" alt="Foto de perfil" class="w-24 h-24 rounded-full object-cover border-2 border-byte-accent-cyan mb-3">
                    <input type="url" id="profile-photo-url" placeholder="URL de la Foto de Perfil" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                </div>
                <label for="profile-name" class="text-byte-text-light block text-left mb-1">Nombre:</label>
                <input type="text" id="profile-name" placeholder="Tu Nombre" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">

                <label for="profile-email" class="text-byte-text-light block text-left mb-1">Correo Electrónico:</label>
                <input type="email" id="profile-email" placeholder="Tu Correo Electrónico" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">

                <label for="profile-phone" class="text-byte-text-light block text-left mb-1">Número de Teléfono:</label>
                <input type="tel" id="profile-phone" placeholder="Tu Número de Teléfono" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">

                <label for="profile-dob" class="text-byte-text-light block text-left mb-1">Fecha de Nacimiento:</label>
                <input type="date" id="profile-dob" class="w-full p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                
                <label for="profile-note-input" class="text-byte-text-light block text-left mb-1">Nota de Perfil (visible para otros):</label>
                <textarea id="profile-note-input" placeholder="Escribe una nota corta sobre ti..." class="w-full h-20 p-3 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan"></textarea>

                <label for="profile-color-input" class="text-byte-text-light block text-left mb-1">Color de Perfil (visible para otros):</label>
                <input type="color" id="profile-color-input" class="w-full h-12 p-1 rounded-md bg-byte-secondary-dark border border-byte-accent-cyan/30 focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">

                <button type="submit" class="w-full bg-byte-accent-cyan text-byte-dark-bg py-3 rounded-md font-semibold hover:bg-cyan-400 transition duration-200">Guardar Cambios</button>
                <p id="profile-message" class="text-sm mt-2 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <button id="close-rules-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan text-center">Reglas Claras del Foro Académico de Byte</h2>
            <div class="text-byte-text-light text-left space-y-4">
                <p>Para mantener nuestro foro como un espacio de aprendizaje y colaboración efectivo, te pedimos que sigas estas reglas simples:</p>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">1. Respeto Ante Todo</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>Trata a todos con amabilidad y profesionalismo.</li>
                    <li>Los comentarios deben ser constructivos. Evita ofensas, acoso o ataques personales.</li>
                </ul>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">2. Contenido Relevante</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>Publica solo sobre temas académicos y tecnológicos.</li>
                    <li>No uses el foro para asuntos personales o no relacionados.</li>
                </ul>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">3. Prohibido lo Inapropiado</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>Está prohibido cualquier contenido sexual, violento, discriminatorio, ilegal o que incite al daño.</li>
                </ul>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">4. Veracidad y Fuentes</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>Comparte información precisa y, si es posible, con fuentes.</li>
                    <li>No difundas rumores ni información falsa.</li>
                </ul>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">5. Originalidad (No Plagio)</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>Asegúrate de que tu contenido sea original.</li>
                    <li>Si usas ideas o textos de otros, siempre cita la fuente.</li>
                </ul>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">6. Privacidad y Datos Personales</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>No compartas información personal tuya ni de otros (direcciones, teléfonos, etc.).</li>
                </ul>

                <h3 class="text-lg font-semibold text-byte-accent-cyan">7. Moderación y Sanciones</h3>
                <ul class="list-disc list-inside space-y-1 pl-4">
                    <li>Los moderadores tienen la última palabra.</li>
                    <li>El incumplimiento de las reglas puede llevar a la edición, eliminación de contenido o suspensión de la cuenta.</li>
                </ul>

                <p class="text-sm italic mt-6">Al participar en este foro, aceptas estas reglas. ¡Gracias por contribuir a una comunidad positiva!</p>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal hidden">
        <div class="modal-content max-w-lg">
            <button id="close-notifications-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan text-center">Tus Notificaciones</h2>
            <div id="notifications-list-container" class="max-h-96 overflow-y-auto p-2 border border-gray-700 rounded-md">
                <!-- Notifications will be loaded here -->
                <p class="text-center text-gray-400 text-sm">Cargando notificaciones...</p>
            </div>
        </div>
    </div>

    <!-- Private Chat Modal -->
    <div id="private-chat-modal" class="modal hidden">
        <div class="modal-content max-w-md">
            <button id="close-private-chat-modal" class="modal-close-button">&times;</button>
            <h2 id="private-chat-header-name" class="text-xl font-bold mb-4 text-byte-accent-cyan text-center">Chat Privado</h2>
            <div id="private-chat-messages-container" class="max-h-80 overflow-y-auto space-y-4 p-3 rounded-md bg-byte-dark-bg border border-gray-700 mb-4">
                <!-- Private messages will be loaded here -->
            </div>
            <div class="flex">
                <input type="text" id="private-chat-input" placeholder="Escribe tu mensaje..." class="flex-grow p-3 rounded-l-md bg-byte-secondary-dark border border-byte-accent-cyan/30 text-byte-text-light focus:outline-none focus:ring-2 focus:ring-byte-accent-cyan">
                <button id="send-private-chat-button" class="bg-byte-accent-cyan text-byte-dark-bg p-3 rounded-r-md font-semibold hover:bg-cyan-400 transition duration-200">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- View User Profile Modal -->
    <div id="view-user-profile-modal" class="modal hidden">
        <div id="view-user-profile-modal-content" class="modal-content max-w-xs text-center">
            <button id="close-view-user-profile-modal" class="modal-close-button text-byte-text-light">&times;</button>
            <img id="view-user-profile-photo" src="https://placehold.co/150x150/0A0A1A/00FFFF?text=ByteUser" alt="Foto de perfil" class="w-24 h-24 rounded-full object-cover border-2 border-byte-accent-cyan mx-auto mb-4">
            <h2 id="view-user-profile-name" class="text-xl font-bold mb-2 text-byte-text-light">Nombre de Usuario</h2>
            <p id="view-user-profile-note" class="text-gray-300 text-sm italic mb-4">Nota del usuario.</p>
            <!-- <p id="view-user-profile-id" class="text-gray-400 text-xs mb-4">ID: </p> -->
            <button id="ban-user-button" class="hidden bg-red-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-600 transition duration-200 mt-4">
                Banear Usuario
            </button>
        </div>
    </div>

    <!-- Admin Chat View Modal -->
    <div id="admin-chat-view-modal" class="modal hidden">
        <div class="modal-content max-w-md">
            <button id="close-admin-chat-view-modal" class="modal-close-button">&times;</button>
            <h2 class="text-xl font-bold mb-6 text-byte-accent-cyan text-center">Todos los Chats Privados (Admin)</h2>
            <div id="admin-chat-list-container" class="max-h-96 overflow-y-auto p-2 border border-gray-700 rounded-md">
                <!-- List of all private chats will be loaded here -->
                <p class="text-center text-gray-400 text-sm">Cargando chats...</p>
            </div>
        </div>
    </div>

</body>
</html>
