<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Foro de Byte</title>
<!-- TailwindCSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            heading: ['Montserrat', 'sans-serif'],
          },
          colors: {
            'byte-dark-bg': '#0A0A1A',
            'byte-accent-cyan': '#00FFFF',
            'byte-text-light': '#F9FAFB',
            'byte-secondary-dark': '#1A202C',
          }
        }
      }
    }
  </script>
<style>
    .overlay-bg { background-color: rgba(0,0,0,0.7); }
    .fullscreen { position: fixed; top:0; left:0; width:100%; height:100%; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(-10px);} to {opacity:1; transform:translateY(0);} }
  </style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/><style>body { font-family: 'Inter', sans-serif; }</style><style>
@media (max-width: 640px) {
  .feed-card { padding: 1rem; border-radius: 1rem; }
}
.shadow-xl { box-shadow: 0 8px 30px rgba(0,0,0,0.4); }
</style></head>
<!-- Mensaje de confirmación -->
<div class="hidden fixed top-6 inset-x-6 z-50 bg-emerald-400 text-black text-sm text-center py-3 rounded-lg shadow-lg font-medium" id="correo-verif-msg">
  Se ha enviado un correo de verificación. Por favor, revisa tu bandeja de entrada.
</div>
<body class="bg-gradient-to-b from-[#0a0f1f] via-[#101625] to-[#0a0f1f] text-white font-sans relative min-h-screen">
<!-- Video de fondo -->
<video autoplay="" class="fullscreen object-cover -z-10" loop="" muted="" playsinline="">
<source src="./images/fondo.mp4" type="video/mp4"/>
    Tu navegador no soporta la etiqueta de video.
  </video>
<!-- Botón Volver al inicio -->
<a class="fixed top-4 left-4 bg-yellow-500 text-black font-bold py-2 px-4 rounded-full shadow-lg hover:bg-yellow-600 transition animate-bounce" href="index.html">
    Volver al inicio
  </a>
<!-- Contenedor de autenticación -->
<div class="flex items-center justify-center min-h-screen px-4" id="auth-container">
<div class="bg-byte-secondary-dark bg-opacity-80 p-4 sm:p-8 rounded-lg w-full max-w-sm sm:max-w-md fade-in backdrop-blur">
<!-- Login -->
<div id="login-container">
<h2 class="text-2xl font-heading font-bold mb-4 text-byte-accent-cyan text-center">Inicia Sesión</h2>
<form class="space-y-4" id="login-form">
<div>
<label class="block mb-1" for="login-email">Correo Electrónico</label>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="login-email" required="" type="email"/>
</div>
<div>
<label class="block mb-1" for="login-password">Contraseña</label>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="login-password" required="" type="password"/>
</div>
<button class="w-full bg-byte-accent-cyan text-black font-bold py-2 rounded hover:bg-cyan-400 transition" type="submit">Entrar</button>
</form>
<p class="mt-4 text-center">¿No tienes cuenta? 
          <button class="text-byte-accent-cyan hover:underline" id="toggle-to-register">Regístrate</button>
</p>
</div>
<!-- Registro -->
<div class="hidden" id="register-container">
<h2 class="text-2xl font-heading font-bold mb-4 text-byte-accent-cyan text-center">Regístrate</h2>
<!-- Reglas editables -->
<div class="mb-4" id="rules-section">
<div class="max-h-40 overflow-auto p-2 bg-byte-dark-bg rounded mb-2" id="rules-text-display">
<!-- Texto de reglas cargado dinámicamente -->
</div>
<label class="inline-flex items-center">
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="accept-rules" type="checkbox"/>
<span class="ml-2 text-byte-text-light">He leído y acepto las reglas</span>
</label>
</div>
<form class="space-y-4" id="register-form">
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="register-name" placeholder="Nombre completo" required="" type="text"/>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="register-email" placeholder="Correo electrónico" required="" type="email"/>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="register-password" placeholder="Contraseña" required="" type="password"/>
<p class="text-sm text-white" id="password-strength-text"></p>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="register-confirm-password" placeholder="Confirmar contraseña" required="" type="password"/>
<div>
<label class="block mb-1" for="profile-bio">Biografía (opcional)</label>
<textarea class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="profile-bio" placeholder="Escribe algo sobre ti..." rows="2"></textarea>
</div>
<div>
<label class="block mb-1" for="profile-avatar">Avatar (imagen)</label>
<input accept="image/*" class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="profile-avatar" type="file"/>
</div>
<!-- Checkboxes privacidad -->
<div>
<span class="text-byte-text-light">Información pública:</span>
<div class="space-x-2 mt-1">
<label class="inline-flex items-center">
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="public-role" type="checkbox"/>
<span class="ml-1 text-gray-300">Mostrar rol</span>
</label>
<label class="inline-flex items-center">
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="public-email" type="checkbox"/>
<span class="ml-1 text-gray-300">Mostrar correo</span>
</label>
<label class="inline-flex items-center">
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="public-bio" type="checkbox"/>
<span class="ml-1 text-gray-300">Mostrar biografía</span>
</label>
</div>
</div>
<button class="w-full bg-byte-accent-cyan text-black font-bold py-2 rounded hover:bg-cyan-400 transition disabled:opacity-50" disabled="" id="register-btn" type="submit">Crear cuenta</button>
</form>
<p class="mt-4 text-center">¿Ya tienes cuenta? 
          <button class="text-byte-accent-cyan hover:underline" id="toggle-to-login">Inicia Sesión</button>
</p>
</div>
</div>
</div>
<!-- Contenedor principal del Foro -->
<div class="hidden flex flex-col gap-4 fade-in max-w-3xl mx-auto px-4 py-6" id="forum-container">
<!-- Sidebar izquierdo: Usuarios conectados, solicitudes y panel admin -->
<aside class="fixed sm:relative sm:block hidden top-0 left-0 w-64 h-full bg-byte-secondary-dark p-4 z-40 sm:z-0 shadow-xl transform sm:transform-none -translate-x-full transition-transform duration-300" id="users-aside">
<h3 class="text-lg font-bold font-heading text-byte-accent-cyan mb-2">Conectados</h3>
<ul class="space-y-2 mb-4" id="users-list"></ul>
<h3 class="text-lg font-bold font-heading text-byte-accent-cyan mb-2">Solicitudes</h3>
<ul class="space-y-2 mb-4" id="requests-list"></ul>
<!-- Panel Admin -->
<div class="hidden" id="admin-panel">
<h3 class="text-lg font-bold font-heading text-byte-accent-cyan mb-2">Panel Admin</h3>
<!-- Editar reglas -->
<div class="mb-4">
<label class="block font-bold mb-1">Editar Reglas</label>
<textarea class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="edit-rules-text"></textarea>
<button class="mt-2 w-full bg-green-500 text-white py-1 rounded hover:bg-green-600" id="save-rules-btn">Guardar Reglas</button>
</div>
<!-- Crear roles -->
<div class="mb-4">
<label class="block font-bold mb-1">Crear Nuevo Rol</label>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="new-role-name" placeholder="Nombre del rol" type="text"/>
<button class="mt-2 w-full bg-blue-500 text-white py-1 rounded hover:bg-blue-600" id="create-role-btn">Crear Rol</button>
</div>
<!-- Lista de usuarios para promover o banear -->
<h4 class="font-bold mb-2">Gestionar Usuarios</h4>
<ul class="space-y-2" id="ban-list"></ul>
</div>
</aside>
<!-- Área central: Publicaciones -->
<main class="flex-1 flex flex-col">
<!-- Header con bienvenida, rol, notificaciones, perfil -->
<header class="bg-byte-dark-bg py-4 px-6 flex justify-between items-center border-b border-byte-accent-cyan">
<div class="flex items-center space-x-4">
<h1 class="text-xl font-heading font-bold text-byte-accent-cyan" id="welcome-text"></h1>
<span class="ml-2 bg-gray-500 text-white text-xs font-bold px-2 py-1 rounded" id="role-tag"></span>
<button class="bg-byte-accent-cyan text-black px-2 py-1 rounded hover:bg-cyan-400" id="profile-btn">Perfil</button>
</div>
<div class="flex items-center space-x-4">
<button class="hidden bg-yellow-500 text-black px-2 py-1 rounded hover:bg-yellow-600" id="send-notif-btn">Enviar Notif.</button>
<div class="relative">
<button class="relative" id="notifications-btn">
<svg class="w-6 h-6 text-byte-text-light" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15 17h5l-1.405-1.405M19 13V8a7 7 0 10-14 0v5l-1.405 1.405M6 17h12" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full px-1" id="notif-count">0</span>
</button>
<div class="hidden absolute right-0 mt-2 w-64 bg-byte-secondary-dark border border-byte-accent-cyan rounded shadow-lg overflow-auto max-h-64 z-50" id="notifications-dropdown">
<ul id="notifications-list"></ul>
</div>
</div>
<button class="text-red-500 hover:underline" id="logout-btn">Cerrar sesión</button>
</div>
</header>
<!-- Formulario publicación con archivos -->
<div class="bg-white/5 backdrop-blur-lg rounded-2xl shadow-xl p-6 flex flex-col space-y-3 w-full max-w-md mx-auto">
<form class="flex space-x-2" enctype="multipart/form-data" id="post-form">
<textarea class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="post-input" placeholder="¿Qué estás pensando?" required="" rows="2"></textarea>
<input accept="image/*,video/*" class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="post-media" type="file"/>
<button class="bg-byte-accent-cyan text-black px-4 py-2 rounded" type="submit">Publicar</button>
</form>
</div>
<!-- Lista de publicaciones -->
<div class="p-4 overflow-auto flex-1 space-y-4" id="posts-list"></div>
</main>
<!-- Sidebar derecho: Chat privado -->
<aside class="fixed sm:relative sm:block hidden top-0 right-0 w-80 h-full bg-byte-secondary-dark p-4 flex flex-col z-40 sm:z-0 shadow-xl transform sm:transform-none translate-x-full transition-transform duration-300" id="chat-aside">
<h3 class="text-lg font-bold font-heading text-byte-accent-cyan mb-2">Chat Privado</h3>
<ul class="space-y-2 mb-4 flex-1 overflow-auto" id="conversations-list"></ul>
<div class="hidden flex flex-col border-t border-byte-accent-cyan pt-2" id="chat-box">
<div class="flex-1 overflow-auto mb-2 space-y-2" id="chat-messages"></div>
<form class="flex space-x-2" id="message-form">
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="message-input" placeholder="Escribe un mensaje..." required="" type="text"/>
<button class="bg-byte-accent-cyan text-black px-4 py-2 rounded" type="submit">Enviar</button>
</form>
</div>
</aside>
</div>
<!-- Modal perfil de usuario -->
<div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden" id="profile-modal">
<div class="bg-byte-secondary-dark p-6 rounded-lg w-full max-w-sm fade-in">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold text-byte-accent-cyan" id="profile-name"></h2>
<button class="text-gray-400 hover:text-white" id="close-profile">×</button>
</div>
<p class="text-gray-300 mb-1" id="profile-role"></p>
<p class="text-gray-300 mb-1" id="profile-email"></p>
<p class="text-gray-300 mb-1" id="profile-bio"></p>
<div class="mt-2" id="profile-media"></div>
</div>
</div>
<!-- Modal enviar notificación -->
<div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden" id="notif-modal">
<div class="bg-byte-secondary-dark p-6 rounded-lg w-full max-w-sm fade-in">
<h2 class="text-xl font-bold text-byte-accent-cyan mb-4">Enviar Notificación</h2>
<form class="space-y-4" id="notif-form">
<div>
<label class="block mb-1" for="notif-user">Usuario (UID)</label>
<input class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="notif-user" required="" type="text"/>
</div>
<div>
<label class="block mb-1" for="notif-content">Contenido</label>
<textarea class="bg-white/10 border border-white/20 text-white px-3 py-2 rounded w-full placeholder-white/60 focus:outline-none" id="notif-content" required="" rows="3"></textarea>
</div>
<button class="w-full bg-byte-accent-cyan text-black py-2 rounded hover:bg-cyan-400" type="submit">Enviar</button>
</form>
</div>
</div>
<!-- Firebase SDK y lógica -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      sendEmailVerification,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      updateProfile,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      addDoc,
      collection,
      query,
      orderBy,
      onSnapshot,
      updateDoc,
      serverTimestamp,
      getDoc,
      getDocs,
      deleteDoc,
      where
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage,
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCYpAKjzz-rUBlZYkaEPiZMawfAM8-nQ3Y",
      authDomain: "byteweb-13a12.firebaseapp.com",
      projectId: "byteweb-13a12",
      storageBucket: "byteweb-13a12.appspot.com",
      messagingSenderId: "827941655623",
      appId: "1:827941655623:web:887b7a5220fd416eeccd62"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elementos DOM
    const authContainer = document.getElementById('auth-container');
    const forumContainer = document.getElementById('forum-container');
    const loginContainer = document.getElementById('login-container');
    const registerContainer = document.getElementById('register-container');
    const acceptRules = document.getElementById('accept-rules');
    const registerBtn = document.getElementById('register-btn');
    const publicRole = document.getElementById('public-role');
    const publicEmail = document.getElementById('public-email');
    const publicBio = document.getElementById('public-bio');
    const usersList = document.getElementById('users-list');
    const requestsList = document.getElementById('requests-list');
    const banList = document.getElementById('ban-list');
    const conversationsList = document.getElementById('conversations-list');
    const chatBox = document.getElementById('chat-box');
    const chatMessages = document.getElementById('chat-messages');
    const notificationsBtn = document.getElementById('notifications-btn');
    const notificationsDropdown = document.getElementById('notifications-dropdown');
    const notificationsList = document.getElementById('notifications-list');
    const notifCount = document.getElementById('notif-count');
    const postForm = document.getElementById('post-form');
    const postInput = document.getElementById('post-input');
    const postMedia = document.getElementById('post-media');
    const postsList = document.getElementById('posts-list');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const logoutBtn = document.getElementById('logout-btn');
    const welcomeText = document.getElementById('welcome-text');
    const roleTag = document.getElementById('role-tag');
    const adminTag = document.getElementById('admin-tag');
    const profileModal = document.getElementById('profile-modal');
    const profileName = document.getElementById('profile-name');
    const profileEmail = document.getElementById('profile-email');
    const profileRole = document.getElementById('profile-role');
    const profileBio = document.getElementById('profile-bio');
    const profileMedia = document.getElementById('profile-media');
    const closeProfile = document.getElementById('close-profile');
    const adminPanel = document.getElementById('admin-panel');
    const editRulesText = document.getElementById('edit-rules-text');
    const saveRulesBtn = document.getElementById('save-rules-btn');
    const newRoleName = document.getElementById('new-role-name');
    const createRoleBtn = document.getElementById('create-role-btn');
    const sendNotifBtn = document.getElementById('send-notif-btn');
    const notifModal = document.getElementById('notif-modal');
    const notifForm = document.getElementById('notif-form');
    const notifUser = document.getElementById('notif-user');
    const notifContent = document.getElementById('notif-content');

    let currentUser = null;
    let currentUserData = null;
    let currentChatUser = null;
    let isAdmin = false;
    let userRoles = [];

    // Cargar roles al inicio
    async function loadRoles() {
      const rolesSnapshot = await getDocs(collection(db, 'roles'));
      userRoles = [];
      rolesSnapshot.forEach(docSnap => userRoles.push(docSnap.data().name));
    }
    loadRoles();

    // Cargar reglas
    async function loadRules() {
      const rulesDoc = await getDoc(doc(db, 'settings', 'business_rules'));
      if (rulesDoc.exists()) {
        const text = rulesDoc.data().text;
        document.getElementById('rules-text-display').textContent = text;
        editRulesText.value = text;
      }
    }
    loadRules();

    // Habilitar botón de registro al aceptar reglas
    acceptRules.addEventListener('change', () => {
      registerBtn.disabled = !acceptRules.checked;
    });

    // Toggle UI
    document.getElementById('toggle-to-register').onclick = () => {
      loginContainer.classList.add('hidden');
      registerContainer.classList.remove('hidden');
    };
    document.getElementById('toggle-to-login').onclick = () => {
      registerContainer.classList.add('hidden');
      loginContainer.classList.remove('hidden');
    };

    // Medidor de contraseña
    const passwordInput = document.getElementById('register-password');
    const passwordStrengthText = document.getElementById('password-strength-text');
    passwordInput.addEventListener('input', () => {
      const val = passwordInput.value;
      let strength = 0;
      if (val.length >= 8) strength++;
      if (/[A-Z]/.test(val)) strength++;
      if (/[0-9]/.test(val)) strength++;
      if (/[^A-Za-z0-9]/.test(val)) strength++;
      if (strength <= 1) {
        passwordStrengthText.textContent = 'Débil';
        passwordStrengthText.className = 'text-red-500 text-sm';
      } else if (strength <= 3) {
        passwordStrengthText.textContent = 'Medio';
        passwordStrengthText.className = 'text-yellow-400 text-sm';
      } else {
        passwordStrengthText.textContent = 'Fuerte';
        passwordStrengthText.className = 'text-green-500 text-sm';
      }
    });

    // Registro
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('register-confirm-password').value;
      const bio = document.getElementById('profile-bio').value.trim();
      const avatarFile = document.getElementById('profile-avatar').files[0];
      if (!name || !email || !password || !confirmPassword) {
        alert('Completa todos los campos.');
        return;
      }
      if (password !== confirmPassword) {
        alert('Las contraseñas no coinciden.');
        return;
      }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        await sendEmailVerification(user);
        mostrarMensajeVerificacionCorreo();
await updateProfile(user, { displayName: name });
        let avatarURL = '';
        if (avatarFile) {
          const storageRef = sRef(storage, `avatars/${user.uid}`);
          await uploadBytes(storageRef, avatarFile);
          avatarURL = await getDownloadURL(storageRef);
        }
        await setDoc(doc(db, 'users', user.uid), {
          name,
          email,
          role: 'Cliente',
          userId: user.uid,
          online: false,
          banned: false,
          publicRole: publicRole.checked,
          publicEmail: publicEmail.checked,
          publicBio: publicBio.checked,
          bio,
          avatarURL
        });
        alert('Registro exitoso! Verifica tu correo.');
        registerContainer.classList.add('hidden');
        loginContainer.classList.remove('hidden');
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    // Login
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        if (!user.emailVerified) {
          alert('Verifica tu correo antes de iniciar sesión.');
          await sendEmailVerification(user);
          mostrarMensajeVerificacionCorreo();
return;
        }
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const data = userDoc.data();
        if (data.banned) {
          alert('Has sido baneado.');
          await signOut(auth);
          return;
        }
        currentUser = user;
        currentUserData = data;
        isAdmin = (data.role === 'Admin');
        await updateDoc(doc(db, 'users', user.uid), { online: true });
        welcomeText.textContent = data.name;
        roleTag.textContent = data.role;
        if (isAdmin) {
          adminTag.classList.remove('hidden');
          adminPanel.classList.remove('hidden');
          sendNotifBtn.classList.remove('hidden');
        }
        authContainer.classList.add('hidden');
        forumContainer.classList.remove('hidden');
        setupForum();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });

    // Estado auth
    onAuthStateChanged(auth, async (user) => {
      if (user && user.emailVerified) {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const data = userDoc.data();
        if (data.banned) {
          await signOut(auth);
          return;
        }
        currentUser = user;
        currentUserData = data;
        isAdmin = (data.role === 'Admin');
        await updateDoc(doc(db, 'users', user.uid), { online: true });
        welcomeText.textContent = data.name;
        roleTag.textContent = data.role;
        if (isAdmin) {
          adminTag.classList.remove('hidden');
          adminPanel.classList.remove('hidden');
          sendNotifBtn.classList.remove('hidden');
        }
        authContainer.classList.add('hidden');
        forumContainer.classList.remove('hidden');
        setupForum();
      } else {
        if (currentUser) {
          await updateDoc(doc(db, 'users', currentUser.uid), { online: false });
          currentUser = null;
          currentUserData = null;
          isAdmin = false;
        }
        forumContainer.classList.add('hidden');
        authContainer.classList.remove('hidden');
        adminTag.classList.add('hidden');
        adminPanel.classList.add('hidden');
        sendNotifBtn.classList.add('hidden');
      }
    });

    // Logout
    logoutBtn.onclick = async () => {
      if (currentUser) {
        await updateDoc(doc(db, 'users', currentUser.uid), { online: false });
        await signOut(auth);
      }
    };

    // Setup foro
    async function setupForum() {
      await loadRoles();
      loadUsers();
      loadRequests();
      loadBanList();
      loadPosts();
      loadNotifications();
      loadConversations();
      loadRules(); // refresh rules display
    }

    // Load users
    function loadUsers() {
      const q = query(collection(db, 'users'));
      onSnapshot(q, (snapshot) => {
        usersList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.online && data.userId !== currentUser.uid) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center';
            let userInfo = data.name;
            if (data.publicRole) userInfo += ` (${data.role})`;
            li.innerHTML = `
              <span class="cursor-pointer text-byte-accent-cyan view-profile-btn" data-id="${data.userId}">${userInfo}</span>
              <div class="flex space-x-1">
                <button data-id="${data.userId}" class="send-request-btn bg-byte-accent-cyan text-black px-2 py-1 rounded text-sm">Chat</button>
                ${isAdmin ? `<select data-id="${data.userId}" class="role-select bg-byte-dark-bg text-white px-2 py-1 rounded text-sm"></select><button data-id="${data.userId}" class="ban-btn bg-red-500 text-white px-2 py-1 rounded text-sm">Banear</button>` : ''}
              </div>
            `;
            usersList.appendChild(li);
            li.querySelector('.send-request-btn').onclick = () => sendRequest(data.userId);
            li.querySelector('.view-profile-btn').onclick = () => viewProfile(data.userId);
            if (isAdmin) {
              const selectElem = li.querySelector('.role-select');
              userRoles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                if (r === data.role) opt.selected = true;
                selectElem.appendChild(opt);
              });
              selectElem.onchange = async (e) => {
                await updateDoc(doc(db, 'users', data.userId), { role: e.target.value });
                if (data.userId === currentUser.uid) roleTag.textContent = e.target.value;
              };
              li.querySelector('.ban-btn').onclick = () => banUser(data.userId);
            }
          }
        });
      });
    }

    // View profile
    async function viewProfile(userId) {
      const userDoc = await getDoc(doc(db, 'users', userId));
      const data = userDoc.data();
      profileName.textContent = data.name;
      profileRole.textContent = data.publicRole ? `Rol: ${data.role}` : '';
      profileEmail.textContent = data.publicEmail ? `Correo: ${data.email}` : '';
      profileBio.textContent = data.publicBio ? `Bio: ${data.bio}` : '';
      profileMedia.innerHTML = '';
      if (data.avatarURL) {
        const img = document.createElement('img');
        img.src = data.avatarURL;
        img.alt = "Avatar";
        img.className = 'w-24 h-24 object-cover rounded mb-2';
        profileMedia.appendChild(img);
      }
      profileModal.classList.remove('hidden');
    }
    closeProfile.onclick = () => profileModal.classList.add('hidden');

    // Ban user
    async function banUser(userId) {
      if (confirm('¿Seguro que quieres banear a este usuario?')) { 
        await updateDoc(doc(db, 'users', userId), { banned: true, online: false }); 
      }
    }

    // Load roles for selects
    

    // Create new role
    createRoleBtn.onclick = async () => {
      const name = newRoleName.value.trim();
      if (!name) return;
      await addDoc(collection(db, 'roles'), { name });
      newRoleName.value = '';
      await loadRoles();
      loadUsers();
    };

    // Load ban list
    function loadBanList() {
      if (!isAdmin) return;
      const q = query(collection(db, 'users'));
      onSnapshot(q, (snapshot) => {
        banList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.userId !== currentUser.uid) {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center';
            li.innerHTML = `
              <span>${data.name} (${data.role}) ${data.banned ? '- Baneado' : ''}</span>
              ${data.banned ? `<button data-id="${data.userId}" class="unban-btn bg-green-500 text-white px-2 py-1 rounded text-sm">Desbanear</button>` : `<button data-id="${data.userId}" class="ban-btn bg-red-500 text-white px-2 py-1 rounded text-sm">Banear</button>`}
            `;
            banList.appendChild(li);
            if (data.banned) {
              li.querySelector('.unban-btn').onclick = async () => {
                await updateDoc(doc(db, 'users', data.userId), { banned: false });
              };
            } else {
              li.querySelector('.ban-btn').onclick = () => banUser(data.userId);
            }
          }
        });
      });
    }

    // Load requests
    function loadRequests() {
      const q = query(collection(db, 'message_requests'), orderBy('timestamp', 'desc'));
      onSnapshot(q, (snapshot) => {
        requestsList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const data = docSnap.data(), id = docSnap.id;
          if (data.recipientId === currentUser.uid && data.status === 'pending') {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center';
            li.innerHTML = `
              <span>Solicitud de <strong>${data.senderId}</strong></span>
              <div>
                <button data-id="${id}" data-sender="${data.senderId}" class="accept-request-btn bg-green-500 px-2 py-1 rounded text-white text-sm mr-1">Aceptar</button>
                <button data-id="${id}" class="decline-request-btn bg-red-500 px-2 py-1 rounded text-white text-sm">Rechazar</button>
              </div>
            `;
            requestsList.appendChild(li);
            li.querySelector('.accept-request-btn').onclick = (e) => acceptRequest(e.target.dataset.id, e.target.dataset.sender);
            li.querySelector('.decline-request-btn').onclick = (e) => declineRequest(e.target.dataset.id);
          }
        });
      });
    }

    async function acceptRequest(requestId, senderId) {
      await updateDoc(doc(db, 'message_requests', requestId), { status: 'accepted' });
      openChat(senderId);
    }
    async function declineRequest(requestId) {
      await deleteDoc(doc(db, 'message_requests', requestId));
    }

    // Load conversations
    function loadConversations() {
      const q1 = query(collection(db, 'message_requests'));
      onSnapshot(q1, (snapshot) => {
        conversationsList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if ((data.senderId === currentUser.uid || data.recipientId === currentUser.uid) && data.status === 'accepted') {
            const otherId = (data.senderId === currentUser.uid) ? data.recipientId : data.senderId;
            const li = document.createElement('li');
            li.className = 'p-2 bg-byte-dark-bg rounded cursor-pointer hover:bg-byte-secondary-dark';
            li.textContent = 'Chat con ' + otherId;
            li.onclick = () => openChat(otherId);
            conversationsList.appendChild(li);
          }
        });
      });
    }

    // Open chat
    function openChat(otherId) {
      currentChatUser = otherId;
      chatBox.classList.remove('hidden');
      chatMessages.innerHTML = '';
      const chatQuery = query(collection(db, 'messages'), orderBy('timestamp'));
      onSnapshot(chatQuery, (snapshot) => {
        chatMessages.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const m = docSnap.data();
          if ((m.senderId === currentUser.uid && m.receiverId === otherId) ||
              (m.senderId === otherId && m.receiverId === currentUser.uid) || isAdmin) {
            const div = document.createElement('div');
            div.className = m.senderId === currentUser.uid ? 'text-right' : 'text-left';
            div.innerHTML = `
              <span class="block inline-block px-3 py-1 rounded ${m.senderId === currentUser.uid ? 'bg-byte-accent-cyan text-black' : 'bg-byte-secondary-dark text-white'}">
                ${m.content}
              </span>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        });
      });
    }

    // Send message
    messageForm.onsubmit = async (e) => {
      e.preventDefault();
      const content = messageInput.value.trim();
      if (!content || !currentChatUser) return;
      await addDoc(collection(db, 'messages'), {
        senderId: currentUser.uid,
        receiverId: currentChatUser,
        content,
        timestamp: serverTimestamp()
      });
      messageInput.value = '';
    };

    // Create post with media
    postForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = postInput.value.trim();
      if (!content && !postMedia.files.length) return;
      // IA verific: reject if "mal"
      if (/\bmal\b/i.test(content)) {
        alert('Contenido no permitido.');
        return;
      }
      const postRef = await addDoc(collection(db, 'posts'), {
        userId: currentUser.uid,
        userName: currentUserData.name,
        role: currentUserData.role,
        content,
        timestamp: serverTimestamp(),
        likes: 0,
        media: []
      });
      // Subir media si existe
      if (postMedia.files.length) {
        const file = postMedia.files[0];
        // IA check nombre
        if (/\bmal\b/i.test(file.name)) {
          alert('Archivo no permitido.');
        } else {
          const storageRef = sRef(storage, `posts/${postRef.id}/${file.name}`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          await updateDoc(postRef, { media: [url] });
        }
      }
      postInput.value = '';
      postMedia.value = '';
    });

    // Load posts
    function loadPosts() {
      const postsQuery = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
      onSnapshot(postsQuery, (snapshot) => {
        postsList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const post = docSnap.data(), postId = docSnap.id;
          const postDiv = document.createElement('div');
          postDiv.className = 'bg-byte-secondary-dark p-4 rounded fade-in';
          let deleteBtnHTML = '';
          if (isAdmin || post.userId === currentUser.uid) {
            deleteBtnHTML = `<button data-id="${postId}" class="delete-post-btn text-red-500 text-sm">Borrar</button>`;
          }
          let roleLabel = post.role ? `<span class="text-xs text-gray-400">(${post.role})</span>` : '';
          let mediaHTML = '';
          if (post.media && post.media.length) {
            post.media.forEach(url => {
              if (url.match(/\.(mp4|webm)$/i)) {
                mediaHTML += ``;
              } else {
                mediaHTML += `<img src="${url}" class="max-w-full rounded mb-2">`;
              }
            });
          }
          postDiv.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="font-bold text-byte-accent-cyan view-profile-btn cursor-pointer" data-id="${post.userId}">${post.userName}</span>${roleLabel}
              <span class="text-gray-400 text-xs">${post.timestamp ? new Date(post.timestamp.seconds*1000).toLocaleString() : ''}</span>
            </div>
            <p class="text-white mb-2">${post.content}</p>
            ${mediaHTML}
            <div class="flex items-center space-x-4">
              <button data-id="${postId}" class="like-btn flex items-center space-x-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-byte-accent-cyan" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 9l-3 3m0 0l-3-3m3 3V3" />
                </svg>
                <span class="like-count">${post.likes}</span>
              </button>
              <button data-id="${postId}" class="comment-toggle-btn text-byte-accent-cyan text-sm">Comentarios</button>
              ${deleteBtnHTML}
            </div>
            <div id="comments-${postId}" class="mt-2 hidden">
              <div id="comments-list-${postId}" class="mb-2 space-y-1"></div>
              <form data-id="${postId}" class="comment-form flex space-x-2">
                <input type="text" placeholder="Comentario..." class="flex-grow p-2 rounded bg-byte-dark-bg text-white comment-input" required />
                <button type="submit" class="bg-byte-accent-cyan text-black px-3 py-1 rounded text-sm">Enviar</button>
              </form>
            </div>
          `;
          postsList.appendChild(postDiv);

          // profile link
          postDiv.querySelector('.view-profile-btn').onclick = () => viewProfile(post.userId);

          // delete
          if (deleteBtnHTML) {
            postDiv.querySelector('.delete-post-btn').onclick = async () => {
              if (confirm('¿Eliminar esta publicación?')) {
                await deleteDoc(doc(db, 'posts', postId));
              }
            };
          }

          // like
          postDiv.querySelector('.like-btn').onclick = async () => {
            await updateDoc(doc(db, 'posts', postId), { likes: post.likes + 1 });
            if (currentUser.uid !== post.userId) {
              await addDoc(collection(db, 'notifications'), {
                userId: post.userId,
                content: `${currentUserData.name} le gustó tu publicación.`,
                timestamp: serverTimestamp(),
                read: false
              });
            }
          };

          // toggle comments
          const commentToggleBtn = postDiv.querySelector('.comment-toggle-btn');
          const commentsContainer = postDiv.querySelector(`#comments-${postId}`);
          commentToggleBtn.onclick = () => {
            commentsContainer.classList.toggle('hidden');
            if (!commentsContainer.classList.contains('hidden')) {
              loadComments(postId);
            }
          };

          // submit comment
          postDiv.querySelector('.comment-form').onsubmit = async (e) => {
            e.preventDefault();
            const commentInput = e.target.querySelector('.comment-input');
            const text = commentInput.value.trim();
            if (!text) return;
            // IA check
            if (/\bmal\b/i.test(text)) {
              alert('Contenido no permitido.');
              return;
            }
            await addDoc(collection(db, 'posts', postId, 'comments'), {
              userId: currentUser.uid,
              userName: currentUserData.name,
              role: currentUserData.role,
              content: text,
              timestamp: serverTimestamp()
            });
            if (currentUser.uid !== post.userId) {
              await addDoc(collection(db, 'notifications'), {
                userId: post.userId,
                content: `${currentUserData.name} comentó tu publicación.`,
                timestamp: serverTimestamp(),
                read: false
              });
            }
            commentInput.value = '';
          };
        });
      });
    }

    // load comments
    function loadComments(postId) {
      const commentsQuery = query(collection(db, 'posts', postId, 'comments'), orderBy('timestamp', 'asc'));
      onSnapshot(commentsQuery, (snapshot) => {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        commentsList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const c = docSnap.data();
          const div = document.createElement('div');
          div.className = 'bg-byte-dark-bg p-2 rounded flex justify-between fade-in';
          let deleteCommentBtn = '';
          if (isAdmin || c.userId === currentUser.uid) {
            deleteCommentBtn = `<button data-id="${docSnap.id}" data-post="${postId}" class="delete-comment-btn text-red-500 text-xs ml-2">Borrar</button>`;
          }
          let commenterInfo = c.userName;
          if (c.publicRole) commenterInfo += ` (${c.role})`;
          div.innerHTML = `
            <div>
              <span class="font-bold text-byte-accent-cyan view-profile-btn cursor-pointer" data-id="${c.userId}">${commenterInfo}:</span>
              <span class="ml-2 text-white">${c.content}</span>
              <span class="text-gray-400 text-xs ml-2">(${c.timestamp ? new Date(c.timestamp.seconds*1000).toLocaleTimeString() : ''})</span>
            </div>
            ${deleteCommentBtn}
          `;
          commentsList.appendChild(div);

          div.querySelector('.view-profile-btn').onclick = () => viewProfile(c.userId);

          if (deleteCommentBtn) {
            div.querySelector('.delete-comment-btn').onclick = async (e) => {
              const commentId = e.target.dataset.id;
              const parentPost = e.target.dataset.post;
              if (confirm('¿Eliminar este comentario?')) {
                await deleteDoc(doc(db, 'posts', parentPost, 'comments', commentId));
              }
            };
          }
        });
      });
    }

    // load notifications
    function loadNotifications() {
      const notifQuery = query(collection(db, 'notifications'), orderBy('timestamp', 'desc'));
      onSnapshot(notifQuery, (snapshot) => {
        let count = 0;
        notificationsList.innerHTML = '';
        snapshot.forEach((docSnap) => {
          const n = docSnap.data();
          if (n.userId === currentUser.uid) {
            if (!n.read) count++;
            const li = document.createElement('li');
            li.className = 'p-2 hover:bg-byte-dark-bg';
            li.textContent = n.content + ' - ' + new Date(n.timestamp.seconds*1000).toLocaleString();
            notificationsList.appendChild(li);
          }
        });
        notifCount.textContent = count;
      });

      notificationsBtn.onclick = () => {
        notificationsDropdown.classList.toggle('hidden');
        (async () => {
          const snapshot = await getDocs(collection(db, 'notifications'));
          snapshot.forEach(async (docSnap) => {
            const n = docSnap.data();
            if (n.userId === currentUser.uid && !n.read) {
              await updateDoc(doc(db, 'notifications', docSnap.id), { read: true });
            }
          });
        })();
      };
    }

    // upload and send notifications (admin)
    sendNotifBtn.onclick = () => {
      notifModal.classList.remove('hidden');
    };
    notifForm.onsubmit = async (e) => {
      e.preventDefault();
      const uid = notifUser.value.trim();
      const content = notifContent.value.trim();
      if (!uid || !content) return;
      await addDoc(collection(db, 'notifications'), {
        userId: uid,
        content,
        timestamp: serverTimestamp(),
        read: false
      });
      notifModal.classList.add('hidden');
      notifUser.value = '';
      notifContent.value = '';
    };

    // Load rules for editing
    

    // Save rules (admin)
    saveRulesBtn.onclick = async () => {
      const text = editRulesText.value.trim();
      if (!text) return;
      await setDoc(doc(db, 'settings', 'business_rules'), { text });
      document.getElementById('rules-text-display').textContent = text;
    };

  </script>
<!-- Botones móviles flotantes -->
<div class="sm:hidden fixed bottom-4 left-4 z-50 space-y-2">
<button class="bg-emerald-500 hover:bg-emerald-600 transition text-white font-bold px-4 py-2 rounded-xl shadow" id="toggle-users-btn">Usuarios</button>
<button class="bg-blue-500 text-white font-bold px-4 py-2 rounded shadow" id="toggle-chat-btn">Chat</button>
</div>
<!-- Modal de perfil -->
<div class="fixed inset-0 z-50 bg-black bg-opacity-70 hidden flex items-center justify-center" id="perfil-modal">
<div class="bg-[#1A2238] p-6 rounded-lg w-11/12 max-w-md">
<h2 class="text-xl font-bold mb-4">Perfil</h2>
<div class="space-y-2 text-sm" id="perfil-info">
<!-- Portada y avatar -->
<div class="relative">
<div class="h-24 bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-t-lg"></div>
<img class="w-16 h-16 rounded-full border-4 border-[#1A2238] absolute -bottom-8 left-1/2 transform -translate-x-1/2" src="https://ui-avatars.com/api/?name=Admin&amp;background=0D8ABC&amp;color=fff&amp;rounded=true&amp;size=64"/>
</div>
<div class="mt-10 text-center space-y-1">
<h3 class="text-lg font-bold">Admin</h3>
<p class="text-sm text-white/70">Rol: Administrador</p>
</div>
<!-- Estadísticas -->
<div class="flex justify-around text-sm mt-4">
<div class="text-center">
<div class="font-bold text-white">124</div>
<div class="text-white/60">Publicaciones</div>
</div>
<div class="text-center">
<div class="font-bold text-white">302</div>
<div class="text-white/60">Comentarios</div>
</div>
<div class="text-center">
<div class="font-bold text-white">12</div>
<div class="text-white/60">Roles creados</div>
</div>
</div>
</div>
<button class="bg-emerald-500 hover:bg-emerald-600 transition text-white font-bold px-4 py-2 rounded-xl shadow" onclick="document.getElementById('perfil-modal').classList.add('hidden')">Cerrar</button>
</div>
</div>
<!-- Modal de notificaciones -->
<div class="fixed inset-0 z-50 bg-black bg-opacity-70 hidden flex items-center justify-center" id="notificaciones-modal">
<div class="bg-[#1A2238] p-6 rounded-lg w-11/12 max-w-md">
<h2 class="text-xl font-bold mb-4">Notificaciones</h2>
<ul class="space-y-2 text-sm" id="notificaciones-lista">
<!-- notificaciones se cargan dinámicamente -->
</ul>
<button class="bg-emerald-500 hover:bg-emerald-600 transition text-white font-bold px-4 py-2 rounded-xl shadow" onclick="document.getElementById('notificaciones-modal').classList.add('hidden')">Cerrar</button>
</div>
</div>
<!-- Barra de navegación inferior -->
<nav class="fixed bottom-0 inset-x-0 z-50 bg-white/10 backdrop-blur-md border-t border-white/10 flex justify-around items-center text-sm text-white py-2 sm:hidden">
<button class="flex flex-col items-center gap-1" id="nav-feed">
<span>📰</span>
<span>Muro</span>
</button>
<button class="flex flex-col items-center gap-1" id="nav-profile">
<span>👤</span>
<span>Perfil</span>
</button>
<button class="flex flex-col items-center gap-1" id="nav-notif">
<span>🔔</span>
<span>Alertas</span>
</button>
</nav>
<script>
document.getElementById('nav-profile')?.addEventListener('click', () => {
  document.getElementById('perfil-modal')?.classList.remove('hidden');
});
document.getElementById('nav-notif')?.addEventListener('click', () => {
  document.getElementById('notificaciones-modal')?.classList.remove('hidden');
});
document.getElementById('nav-feed')?.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>
</body>
<script>
  const usersAside = document.getElementById('users-aside');
  const chatAside = document.getElementById('chat-aside');
  const toggleUsersBtn = document.getElementById('toggle-users-btn');
  const toggleChatBtn = document.getElementById('toggle-chat-btn');

  toggleUsersBtn?.addEventListener('click', () => {
    usersAside.classList.toggle('-translate-x-full');
  });

  toggleChatBtn?.addEventListener('click', () => {
    chatAside.classList.toggle('translate-x-full');
  });
</script>
<script>
  document.getElementById('perfil-btn')?.addEventListener('click', () => {
    document.getElementById('perfil-modal').classList.remove('hidden');
  });

  document.getElementById('notif-btn')?.addEventListener('click', () => {
    document.getElementById('notificaciones-modal').classList.remove('hidden');
  });
</script>
<script>
  function mostrarMensajeVerificacionCorreo() {
    const msg = document.getElementById('correo-verif-msg');
    if (msg) {
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 6000);
    }
  }
</script>
</html>
